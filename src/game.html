<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TARDQUEST</title>
    <style>
        /* ===== Scrollbar CSS ===== */
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #fff #000;
        }

        /* Chrome, Edge, and Safari */
        *::-webkit-scrollbar {
            width: 12px;
        }

        *::-webkit-scrollbar-track {
            background: #000;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #000;
            border-radius: 0px;
            border: 0px solid #fff;
        }

        @font-face {
            font-family: 'DejaVuSansMono';
            src: url('fonts/DejaVuSansMono.woff') format('woff');
        }

        * {
            font-family: "DejaVuSansMono", monospace;
        }

        body {
            background: #000;
            color: #fff;
            font-size: 10px;
            padding: 20px;
            display: flex;
            box-sizing: content-box;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }

        button {
            color: #fff;
            background-color: #000;
            cursor: pointer;
            height: 20px;
        }

        button:hover {
            background-color: #fff;
            color: #000;
        }

        button.release:hover {
            background-color: #f00;
            color: #fff;
        }

        button:disabled,
        button:disabled:hover {
            color: #999;
            border-color: #999;
            cursor: not-allowed;
        }

        .strikethrough {
            text-decoration: line-through;
        }

        a:visited,
        a:link {
            color: #fff;
        }

        #ui {
            display: flex;
        }

        @keyframes darken {
            from {
                filter: brightness(1);
            }

            to {
                filter: brightness(0);
            }
        }

        @keyframes lighten {
            from {
                filter: brightness(0);
            }

            to {
                filter: brightness(1);
            }
        }

        #titleScreen {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            z-index: 999;
            font-family: monospace;
            font-size: 15px;
            white-space: pre;
            user-select: none;
            -webkit-user-select: none;
            padding: 5px;
        }
        #titleScreen .content{
            position: absolute;
            left: 0px;
            top: 0px;

        }
        #titleScreen a:link, #titleScreen a:visited {
            color: #fff;
            text-decoration: underline;
        }
        #titleScreen .logo {
            position: absolute;
            left: 0px;
            top: 0px;
            padding: 3px;
            font-size: 9px;
        }

        #titleScreen .startgame {
            cursor: pointer;
            position: absolute;
            left: 50px;
            top: 170px;
            padding: 8px;
            text-align: center;
            line-height: 0%;
            white-space: nowrap;
            align-content: center;
            border-style: solid;
            border-width: 2px;
            border-top-width: 10px;
            border-color: #ffffff;
            background-color: #000000;
            z-index: 999;

            &:hover {
                border-color: #090;
                color: #0f0;
            }
        }

        #titleScreen .artwork {
            position: absolute;
            left: 270px;
            top: 220px;
            font-size: 9px;
        }

        #titleScreen .credits {
            position: absolute;
            top: 554px;
            left: 30px;
            border-style: solid;
            border-width: 2px;
            border-top-width: 10px;
            border-color: #ffffff;
            background-color: #000000;
            padding: 9px;
            z-index: 999;
        }

        #screenWipe {
            position: fixed;
            left: 0; bottom: 0; top: auto;
            width: 100vw;
            height: 0vh;
            background: #000;
            z-index: 10000;
            pointer-events: none;
            transition: height 0.5s cubic-bezier(.77,0,.18,1);
        }
        #screenWipe.active {
            height: 100vh;
            transition: height 0.5s cubic-bezier(.77,0,.18,1);
        }
        #screenWipe.reveal {
            height: 0vh;
            transition: height 0.5s cubic-bezier(.77,0,.18,1);
        }

        #game {
            width: 100%;
            height: 100%;
            white-space: pre;
            margin-bottom: auto;
            align-content: center;

            font-size: unset;
            margin-top: unset;
            /* Blue sky, dirt ground */
            /*
            background: linear-gradient(
                180deg,
                rgb(48, 89, 105) 0%,
                rgb(48, 89, 105) 50%,
                rgb(71, 54, 19) 50%,
                rgb(71, 54, 19) 100%
            );*/
            /* Bruised sky, gradient dirt ground */
            /*
            background: linear-gradient(
                180deg,
                #950913 0%,
                #060d40 50%,
                #000 50%,
                #513805 100%
            );
            */
            background: linear-gradient(180deg,rgba(97, 0, 10, 1) 0%, rgba(0, 0, 0, 1) 30%, rgba(0, 0, 0, 1) 70%, rgba(117, 62, 0, 1) 100%);
        }

        #game.terrain_iceCavern {
            background: linear-gradient(
                180deg,
                rgb(100, 113, 182) 0%,
                rgb(0, 0, 0) 30%,
                rgb(0, 0, 0) 70%,
                rgb(49, 41, 106) 100%
            );
        }

        @keyframes torchFlicker {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1.14);
            }
            25%, 86% {
                opacity: 0.25;
                transform: scale(1.31);
            }
            50% {
                opacity: 0.325;
                transform: scale(1);
            }
            17%, 75% {
                opacity: 0.275;
                transform: scale(1.22);
            }
        }

        #game.torch::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            pointer-events: none;
            background: radial-gradient(circle, #fff0 30%, #f2bb20cc 80%);
            mix-blend-mode: screen;
            animation: torchFlicker 3s infinite ease-in-out;
        }

        #game:not(.sightliness) {
            filter: saturate(0.6);
        }

        #game > .layer {
            position: absolute;
            margin-left: 3.5px;
            top: 0;
            left: 0;
        }

        #game > .layer.dark {
            filter: brightness(0);
        }

        #game > .layer.darkening,
        #game > .layer.lightening {
            animation-name: darken;
            animation-duration: .5s;
            animation-fill-mode: forwards;
            animation-timing-function: ease;
        }

        #game > .layer.lightening {
            animation-name: lighten;
        }

        #game > .layer.enemy > span {
            color: #fff;
        }

        .layer.enemy {
            position: absolute !important;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex !important;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 10;
        }
        .layer.enemy pre {
            margin: 0;
            line-height: 1;
            display: inline-block;
            white-space: pre;
            font-size: 12px;
            transform: scale(0.5);
            transform-origin: center center;
            color: #fff;
        }

        @keyframes layerHealingAnimation {
            from { transform: translateY(0); }
            to { transform: translateY(-100%) };
        }

        #game > .layer.healing {
            background: linear-gradient(
                0deg,
                #0b00 0%,
                #0b00 10%,
                #0b0f 50%,
                #ffff 55%,
                #080f 60%,
                #0800 90%,
                #0800 100%
            );
            animation-name: layerHealingAnimation;
            animation-duration: 0.76s;
            animation-fill-mode: forwards;
            animation-timing-function: ease;
            mix-blend-mode: screen;
            width: 100%;
            height: 1000%;
        }

        #game .layer,
        #game span {
            display: inline-block;
            font-size: 12px;
            line-height: 12px;
        }

        #animTorch {
            width: 110px;
            height: 256px;
            image-rendering: pixelated;
            left: 0;
            bottom: 0;
            background-image: url(assets/fp-anim/fp-torch.gif);
            transform: translate(-55px, 256px);
            transition: transform .5s steps(8, jump-end);
        }

        #animTorch.onscreen {
            transform: translate(0, 0);
        }

        #animTrombone {
            position: absolute;
            background-repeat: no-repeat;
            width: 300px;
            height: 300px;
            image-rendering: pixelated;
            left: 0;
            bottom: 0;
            background-image: url(assets/fp-anim/fp-trombone.gif);
            transform: translate(250px, 356px);
            transition: transform .5s steps(8, jump-end);
        }

        #animTrombone.onscreen {
            transform: translate(200px, 100px);
        }

        #viewport #mouseControl {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        #mouseControl * {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        #mouseControl .turn-left {
            clip-path: polygon(0 0, 25% 25%, 25% 75%, 0 75%);
            cursor: url(assets/cursors/turn-left.cur), nw-resize;
        }

        #mouseControl .forward {
            clip-path: polygon(0 0, 100% 0, 100% 75%, 0 75%);
            cursor: url(assets/cursors/up.cur), n-resize;
        }

        #mouseControl .turn-right {
            clip-path: polygon(75% 25%, 100% 0, 100% 75%, 75% 75%);
            cursor: url(assets/cursors/turn-right.cur), ne-resize;
        }

        #mouseControl .strafe-left {
            clip-path: polygon(0 75%, 25% 75%, 25% 85%, 0 100%);
            cursor: url(assets/cursors/left.cur), w-resize;
        }

        #mouseControl .backward {
            clip-path: polygon(25% 85%, 25% 75%, 75% 75%, 75% 85%, 100% 100%, 0 100%);
            cursor: url(assets/cursors/down.cur), s-resize;
        }

        #mouseControl .strafe-right {
            clip-path: polygon(75% 75%, 100% 75%, 100% 100%, 75% 85%);
            cursor: url(assets/cursors/right.cur), e-resize;
        }

        #mouseControl .touch {
            clip-path: polygon(10% 15%, 90% 15%, 90% 85%, 10% 85%);
            cursor: url(assets/cursors/touch.cur), grab;
        }

        #mouseControl .touch:active {
            cursor: url(assets/cursors/grab.cur), grabbing;
        }

        #mouseControl .attack {
            cursor: url(assets/cursors/attack.cur), crosshair;
        }

        /** Menu Styles **/
        #menu:not(.hidden) {
            background: #000;
            height: 315px;
            width: 360px;
            white-space: pre-wrap;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 4px solid #000;
            padding-bottom: 10px;
            z-index: 9;
        }

        #menu .landing {
            display: flex;
            flex-direction: column;
        }

        #menu .title {
            display: none !important;
        }

        #menu .list {
            display: flex;
            flex-direction: column;
            flex-grow: 2;
            margin-bottom: auto;
            padding-left: 1em;
            min-height: 150px;
            z-index: 9;
        }

        #menu .option {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        #menu .option:not(.selected)::before {
            content: "  ";
        }

        #menu .option.selected::before {
            content: "▶ ";
        }

        #menu .selectionDescription {
            flex-grow: 1;
        }

        #menu .escapeMessage {
            position: absolute;
            bottom: 0;
            width: 100%;
            text-align: end;
        }
        /** End of Menu Styles **/

        #animation:not(.hidden) {
            white-space: pre;
            overflow: hidden;
            text-align: initial;
            width: 100%;
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9;
        }

        @keyframes explosionColors {
            0% {
                background-color: #FFF5AD;
                opacity: 1;
            }

            32% {
                background-color: #F00;
                opacity: 1;
            }

            38% {
                background-color: #FFBC14;
                opacity: 1;
            }

            45% {
                background-color: #FFF;
                opacity: 1;
            }

            50% {
                background-color: #464FFC;
                opacity: 1;
            }

            100% {
                background-color: #000;
                opacity: 0;
            }
        }

        #animation.explosion {
            font-size: 12px;
            mix-blend-mode: lighten;
            animation-name: explosionColors;
            animation-duration: 240ms;
            animation-iteration-count: 1;
            animation-direction: forwards;
            animation-timing-function: linear;
        }

        @keyframes fadeGradient {
            0% {
                opacity: 0;
            }
            1% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        #viewport.playerFellIntoAPitAndDied::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #900 40%, #0000 100%);
            opacity: 0;
            pointer-events: none;
            animation: fadeGradient 1s ease-out forwards;
            animation-delay: 2s;
        }

        #sidePanel {
            margin-left: 0px;
            display: flex;
            flex-direction: column;
        }

        #battleLog {
            padding: 10px;
            text-overflow: ellipsis;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-y: scroll;
        }

        #battleLog > * {
            filter: brightness(.5) saturate(.5);
        }

        #battleLog > :nth-child(1) {
            filter: brightness(1) saturate(1);
        }

        #battleLog > :nth-child(2) {
            filter: brightness(.8) saturate(.8);
        }

        #battleLog > :nth-child(3) {
            filter: brightness(.7) saturate(.7);
        }

        #battleLog > :nth-child(4) {
            filter: brightness(.6) saturate(.6);
        }

        @keyframes textReveal {
            from { width: 0; }
            to { width: 100%; }
        }
        #battleLog > div.revealing {
            overflow: hidden;
            white-space: nowrap;
            width: 0;
            animation: textReveal var(--reveal-duration, 1s) steps(var(--char-count, 50), end) forwards;
        }

        #minimap,
        #portraitArtOverlay {
            padding: 2px;
            white-space: pre;
            font-size: 12px;
        }

        #minimap {
            border-top: 0;
        }

        #minimap > span {
            cursor: help;
        }

        #minimap > span:hover {
            color: #000;
            background-color: #fff;
        }

        #minimap .crackedFloorSlight,
        #minimap .crackedFloor,
        #minimap .crackedFloorSevere {
            color: #f00;
        }

        #portraitArtOverlay.portrait-art {
            position: absolute;
            top: 135px;
            pointer-events: none;
            font-size: 5px;
            line-height: 1;
        }

        #portraitArtOverlay.chest {
            color: #FAEB4A;
        }

        #portraitArtOverlay.settings {
            color: #eef;
        }

        #portraitArtOverlay.inventory {
            color: #fc8;
        }

        .hidden {
            display: none !important;
        }

        #inputBox {
            display: none;
            position: absolute;
            top: 117px;
            left: 28px;
            width: 692px;
            height: 2px;
            border: 2px solid #fff;
            z-index: 9;
        }

        #inputBox input {
            flex-grow: 1;
            color: #fff;
            background-color: #000;
            font-size: 13px;
            padding: 10px;
            font-size: 16px;
            text-align: left;
            outline: none;
            border: unset;
        }

        #inputBox input::placeholder {
            color: #d8d8d8;
        }

        #confirmInputBox,
        #closeInputBox {
            border-color: transparent;

            &:hover {
                color: #fff;
                background-color: #090;
                border-color: #3c3 #090 #090 #3c3;
            }

            &:not(:disabled):active {
                background-position: calc(50% + 2px) calc(50% + 2px);
                &::after {
                    top: 1px;
                    left: 1px;
                }
            }

            &::after {
                content: "✔";
                position: relative;
            }
        }

        #closeInputBox {
            &:hover {
                background-color: #f00;
                border-color: #f99 #c00 #c00 #f99;
            }

            &::after {
                content: "×";
            }
        }

        #interface {
            display: grid;
            width: 692px;
            height: 611px;
            gap: 2px;
            padding: 2px;
            background: white;

            grid-template-columns: 220px 368px 100px;
            grid-template-rows: 110px 184px 162px 148px;
            grid-template-areas:
                "battleLog  battleLog   battleLog"
                "topLeft    viewport    inventory"
                "stats      viewport    inventory"
                "controls   party       playerInput";
        }

        #interface > div {
            background-color: #000;
        }

        .ui-header {
            display: flex;
            flex-direction: row;
            background-color: #fff;
            color: #000;
            margin: 1px;
            padding: 0 4px;
        }

        .ui-header.space-between {
            justify-content: space-between;
        }

        .ui-header.space-around {
            justify-content: space-around;
        }

        #battleLog      { grid-area: battleLog; }
        #topLeft        { grid-area: topLeft; }
        #stats          { grid-area: stats; }
        #controls       { grid-area: controls; }
        #viewport       { grid-area: viewport; }
        #party          { grid-area: party; }
        #inventory      { grid-area: inventory; }
        #playerInput    { grid-area: playerInput; }

        #viewport {
            position: relative;
            overflow: hidden;
        }

        #infoContainer {
            display: grid;
            gap: 2px;
            padding: 4px;
            grid-template-columns: 1fr 3fr;
            margin-bottom: 2px;
        }

        #infoContainer > *,
        #statContainer > * {
            height: 14px;
            line-height: 14px;
        }

        #infoContainer > :nth-child(2n) {
            text-align: right;
        }

        #infoContainer > .BTC {
            padding-right: 1em;
        }

        #statContainer {
            display: grid;
            gap: 4px;
            padding: 4px;

            grid-template-columns: 3fr 1fr 3fr 1fr;
        }

        #statContainer > div {
            width: 50%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        #statContainer > :nth-child(2n) {
            justify-content: right;
        }

        #partyMembers {
            display: flex;
            flex-direction: column;
            padding: 4px;
            margin-top: 2px;
        }

        #partyMembers:empty::after {
            content: "You ain't got no party. Go persuade some fools!";
            display: block;
            margin-top: 50px;
            text-align: center;
            color: #fff6;
            font-style: italic;
        }

        #partyMembers > [data-partyMemberId] {
            background-color: #000;
            clip-path: rect(0 100% 100% 0);
            height: 35px;
            margin-bottom: 8px;
            overflow: hidden;
            transition:
                background-color .5s linear,
                clip-path .5s linear,
                height .5s linear .5s,
                margin-bottom .5s linear .5s;
        }

        #partyMembers > [data-partyMemberId].sweepItUp {
            background-color: #900;
            clip-path: rect(0 0% 100% 0);
            height: 0;
            margin-bottom: 0;
        }

        #viewport > .layer,
        #viewport > #animation,
        #viewport > #animTorch,
        #viewport > #menu,
        #viewport > #mouseControl {
            position: absolute;
        }

        #controls {
            display: flex;
            flex-direction: column;
        }

        .control-list:not(.hidden) {
            display: grid;
            gap: 4px;
            padding: 4px;
            grid-template-columns: 1fr 2fr;
            margin: 4px 2px;
        }

        #controlsMenu .control-list {
            grid-template-columns: 1fr 1fr;
        }

        #playerInput {
            background: orange;
        }

        #playerInput .section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .grid-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #navigationInput {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        #battleInput {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 1fr 1fr 1fr;
        }

        #playerInput button {
            background-position: 50% 50%;
            background-size: contain;
            background-repeat: no-repeat;
            border-width: 2px;
            min-width: 30px;
            min-height: 30px;

            &:disabled:hover {
                background-color: unset;
            }

            &:not(:disabled):hover {
                background-color: #00f;
                border-color: #99f #00c #00c #99f;
            }

            &:not(:disabled):active {
                background-position: calc(50% + 2px) calc(50% + 2px);
            }

            &:disabled {
                opacity: 0.25;
            }
        }

        #navigationInput button {
            image-rendering: pixelated;
        }

        #battleInput button {
            width: initial;
            height: initial;
        }

        #playerInput button[name="turn-left"] {
            background-image: url(assets/interface/ui/turn-left.png);
        }

        #playerInput button[name="forward"] {
            background-image: url(assets/interface/ui/up.png);
        }

        #playerInput button[name="turn-right"] {
            background-image: url(assets/interface/ui/turn-right.png);
        }

        #playerInput button[name="strafe-left"] {
            background-image: url(assets/interface/ui/left.png);
        }

        #playerInput button[name="backward"] {
            background-image: url(assets/interface/ui/down.png);
        }

        #playerInput button[name="strafe-right"] {
            background-image: url(assets/interface/ui/right.png);
        }

        #playerInput button[name="attack"] {
            background-image: url(assets/interface/ui/attack.gif);

            &:not(:disabled):hover {
                background-color: #f00;
                border-color: #f99 #c00 #c00 #f99;
            }

            &:not(:disabled):active {
                background-color: #f00;
                border-color: #c00 #f99 #f99 #c00;
            }
        }

        #playerInput button[name="persuade"] {
            background-image: url(assets/interface/ui/persuade.gif);

            &:not(:disabled):hover {
                background-color: #A23AB4;
                border-color: #d6f #90c #90c #d6f;
            }

            &:not(:disabled):active {
                background-color: #A23AB4;
                border-color: #90c #d6f #d6f #90c;
            }
        }

        #playerInput button[name="run"] {
            background-image: url(assets/interface/ui/run.gif);

            &:not(:disabled):hover {
                background-color: #00f;
                border-color: #99f #00c #00c #99f;
            }

            &:not(:disabled):active {
                background-color: #00f;
                border-color: #00c #99f #99f #00c;
            }
        }

        /** @TODO: Simplify/specify this */
        #playerInput .section.menu .grid-container {
            & > * {
                flex-grow: 1;
            }

            & > div {
                height: 100%;
                display: flex;
                flex-direction: column;

                & button {
                    flex-grow: 1;
                }

                & button[name="up"] {
                    background-image: url(assets/interface/ui/up.png);
                }

                & button[name="confirm"] {
                    background-image: url(assets/interface/ui/confirm.png);

                    &:not(:disabled):hover {
                        background-color: #090;
                        border-color: #3c3 #090 #090 #3c3;
                    }

                    &:not(:disabled):active {
                        background-color: #090;
                        border-color: #090 #3c3 #3c3 #090;
                    }
                }

                & button[name="down"] {
                    background-image: url(assets/interface/ui/down.png);
                }
            }
        }

        #playerInput button[name="previous-page"] {
            height: 100%;
            background-image: url(assets/interface/ui/previous.png);
        }

        #playerInput button[name="next-page"] {
            height: 100%;
            background-image: url(assets/interface/ui/next.png);
        }

        .party-member {
            gap: 2px;
            display: flex;
            flex-direction: column;
        }

        .party-member > .info {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }

        .party-member > .info > progress-bar {
            flex-grow: 1;
        }

        .party-member > .info > .buttons {
            display: flex;
            flex-direction: row;
            gap: 4px;
        }

        #animEatRat {
            position: absolute;
            bottom: 0;
            right: 0;
            z-index: 9;
        }

        .player {
            color: #2aff00;
        }
        .healingTile {
            color: #6cff74;
        }
        .treasureChest {
            color: #f19b32;
        }
        .wall,
        .gloryWall,
        .noboWall {
            color: #e9ff00;
        }
        .floor {
            color: #fff;
        }
        .unexplored {
            color: #545454;
        }
        .exit {
            color: #f00;
        }
        .merchant {
            color: #f7f;
        }
        .gambler {
            color: #ffd700;
        }
        .muted {
            color: #666;
            text-decoration: line-through;
        }
        .tooExpensive {
            color: #f00;
        }

        .alignRight {
            text-align: right;
        }
        .friendly {
            color: #61C9F6;
        }
        .enemy {
            color: #EC4134;
        }
        .EXP {
            color: #6EBD70;
        }
        .LV {
            color: #6EBD70;
        }
        .BTC {
            color: #FAEB4A;
        }
        .HP {
            color: #F1483D;
        }
        .DEF {
            color: #0ff;
        }
        .STR {
            color: #f7603b;
        }
        .PRS {
            color: #A23AB4;
        }
        .END {
            color: #89f39a;
        }
        .SPD {
            color: #7ec5ee;
        }
        .LUK {
            color: #f5b609;
        }
        .LOAD {
            color: #f8d46f;
        }
        .action {
            color: #EC4134;
        }

        /**
         * Rendered scene class names
         * These are derived from the names in sceneRenderer.getEntityName()
         * which is also used to identify specific pieces of sceneArt
         *
         * The renderer adds <span> elements around each rendered character with
         * a "scene_character_" prefix. So for example, a "wall"
         */
        .scene_character_darkness {
            color: #0009 !important;
            filter: blur(2px);
        }

        .scene_character_void {
            color: #000 !important;
        }

        .scene_character_iceWall {
            color: #e8e8ff !important;
            opacity: .8;
        }

        .scene_character_crackedFloorSlight,
        .scene_character_crackedFloor,
        .scene_character_crackedFloorSevere {
            color: #000;
        }

        .layer:not(.darkening):not(.dark):not(.lightening) > .scene_character_rubble1,
        .layer:not(.darkening):not(.dark):not(.lightening) > .scene_character_rubble2 {
            display: initial;
        }

        .scene_character_rubble1,
        .scene_character_rubble2 {
            display: none;
            background-color: transparent !important;
            mix-blend-mode: lighten;
            opacity: .2;
        }

        @keyframes scene_healingTileGlow {
            0% {
                color: #6CFF74;
            }
            25% {
                color: #02B60E;
            }
            50% {
                color: #02868C;
            }
            75% {
                color: #00920A;
            }
            100% {
                color: #8DD702;
            }
        }

        .scene_character_healingTile {
            animation-name: scene_healingTileGlow;
            animation-duration: 5s;
            animation-iteration-count: infinite;
            animation-direction: alternate;
            animation-timing-function: linear;
        }

        @keyframes scene_exitGlow {
            0% {
                color: #FFF000;
            }
            25% {
                color: #FF7400;
            }
            50% {
                color: #FFF000;
            }
            75% {
                color: #CD0074;
            }
            100% {
                color: #FF0000;
            }
        }

        .scene_character_exit {
            animation-name: scene_exitGlow;
            animation-duration: 5s;
            animation-iteration-count: infinite;
            animation-direction: alternate;
            animation-timing-function: linear;
        }

        @keyframes scene_treasureChestGlow {
            0% {
                color: #FFD700;
            }
            100% {
                color: #FFF;
            }
        }

        .scene_character_treasureChest {
            animation-name: scene_treasureChestGlow;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-direction: alternate;
            animation-timing-function: ease-out;
            background-color: #793311;
            color: #ffd700;
        }

        .scene_character_tardspireBanner {
            color: #edc949 !important;
            background: #000;
            mix-blend-mode: luminosity;
        }

        .scene_character_crater {
            color: #0009 !important;
            background-color: transparent !important;
        }

        .scene_character_bloodyCrater {
            color: #9009 !important;
            background-color: #3003 !important;
        }

        /* Tooltip styles */
        [role="tooltip"] {
            opacity: 0;
            position: absolute;
            width: auto;
            height: auto;
            min-height: 25px;
            line-height: 25px;
            font-size: 1rem;
            background-color: #000d;
            color: #fff;
            margin-top: 10px;
            padding: 4px;
            transform: translateX(-50%);
            z-index: 100; /* Appear over everything except title screen items */
        }

        [role="tooltip"].top {
            transform: translateX(calc(-50% + 4.5px)) translateY(calc(-100% - 20px));
        }

        [role="tooltip"].bottom {
            transform: translateX(calc(-50% + 4.5px)) translateY(15px);
        }

        [role="tooltip"].left {
            transform: translateX(calc(-100% - 10px)) translateY(calc(-50% - 2.5px));
        }

        [role="tooltip"].right {
            transform: translateX(18px) translateY(calc(-50% - 2.5px));
        }

        [role="tooltip"].active {
            opacity: 1;
            transition: opacity 0.1s;
        }

        [role="tooltip"]::before {
            content: "";
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top: 0;
            position: absolute;
            margin-top: -20px;
            transform: translateX(-50%);
            left: 50%;
        }

        .mapCellDetails {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 10px;
            border: 2px solid #fff;
        }

        .mapCellDetails .enlargedTile {
            height: 40px;
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            border: 2px solid #fff;
        }

        .mapCellDetails .details {
            display: flex;
            flex-direction: column;
            height: 44px;
        }

        .mapCellDetails .details .coordinates {
            font-size: 12px;
            font-style: italic;
            line-height: 16px;
        }

        .mapCellDetails .details .name {
            font-size: 18px;
        }

        @keyframes letsGo {
            0%      { transform: scaleX(1) translateY(2px); }
            24.9%   { transform: scaleX(1) translateY(2px); }

            25%     { transform: scaleX(1) translateY(-2px); }
            49.9%   { transform: scaleX(1) translateY(-2px); }

            50%     { transform: scaleX(-1) translateY(2px); }
            74.9%   { transform: scaleX(-1) translateY(2px); }

            75%     { transform: scaleX(-1) translateY(-2px); }
            99.9%   { transform: scaleX(-1) translateY(-2px); }

            100%    { transform: scaleX(1) translateY(2px); }
        }

        .player.lets-go {
            display: inline-block;
            animation: letsGo .8s linear infinite;
        }
    </style>
</head>
<body>

<!-- Title screen -->
    <div id="titleScreen">
        <div id="content">
            <pre class="logo">
                                                         ▄▄
▄                                                ▄         ▀█
 ▀▀██████████████▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀██████           ▀█         █░                        ▀▀▀▀▀▀▀▀▄
     ████░            ██████    █▀░░░█            █         █░▄███████▄     ▄█▄ ▄▄█████████▀▀▀
     ██░░     ██████  █░░░██    █░  ██      ▄    ▄█        ██░██░░░░░▀█   ███░ █    █████░
     ██░     ██░   █░ █████░    █░  █░ ▄█████░   █  █     ██░██████▄  ▀  ██░░       ███░░
    ███░     ███████░ █░░███░ █░█░ ██░ █░░░██░   █  █░   ██░ █░     ▄▄    ███▄      ██░░
    ██░      █░░░░░█░██░   ████░████░░ ▀█████░   █  ██░███░  █▄   ███░   ████▀      ██░
     █░       ░     ░  ░       ░░░░░░       █░  ██   ███░░   ██████░░ ████░░░      ██░
     █░                             ░     ▄██░███░    ░░░     ░░░░░████▄▄▄▄▄▄▄▄▄▄▄▄██░
     █░                             ░     █░░██░░                 ██░░░░░░░░░░░░░░░░░
     █░                                   ▀███░░                  █░
     ░░                                     ░░░                   █░
     ░                                                           ██░
     ░                                                           █░
     ░                                                           ░░
     ░                                                           ░
     ░
     ░
     ░
     ░
     ░
     ░
     ░
     ░
</pre>

            <div class="startgame" onclick="hideTitleScreen()">
            Press [ENTER]
            <p>to begin your descent into</p>
            <p>the TardSpire...</p>
            </div>

            <pre class="artwork">
                ║═════════║  ╪    ║            ╪
   ╪ ║══║       ║         ║  ║    ║║═════║     ║
   ║ ║  ║║══║   ║         ║ ║║    ║║     ║    ║║
  ║║ ║  ║║  ║   ║         ║ ║║║══║║║     ║   ║║║║
 ██████████████████■■████████████████████████████████
█ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓■■■  ▓▓▓▓▓▓▓▓  ▓▓▓▓▓▓▓▓ ▓▓ ▓  ▓██
██ ▓▓ ▓▓▓▓▓▓▓▓▓▓ ▓▓▓▓ ■■  ▓▓▓  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓ ▓▓▓ ██
 █ ▓▓▓■■▓▓▓▓▓▓ ▓▓▓▓▓▓▓▓■■■▓▓▓▓▓▓▓▓▓▓▓▓▓▓ ▓▓▓▓▓▓ ▓██
 ██▓▓   ■■■■■▓▓▓▓▓▓▓▓ ▓▓▓■■ ▓▓▓  ■■■■■ ▓▓▓▓▓▓▓ ███
  █▓▓    ▓▓▓▓▓  ▓▓▓ ▓▓▓ ▓▓■ ■■■■■■ ▓▓▓▓▓ ▓▓ ████
  █▓▓▓▓ ▓▓▓▓▓▓▓▓▓▓▓▓▓   ■■■■▓▓▓▓▓▓▓▓▓▓▓▓▓▓███
  █▓  ▓    ▓▓▓   ▓▓ ■■■■▓▓▓▓▓ ▓  ▓ ▓▓▓  ███
  ██  ▓▓      ■■■■■■■   ▓▓▓▓▓   ▓▓▓ ▓ ██■
   ██  ▓■■■■■■■ ▓▓▓▓▓■■■■■■■■■■■▓ ▓▓███■■
  ■■██ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓ ▓▓▓  ▓▓▓▓   █■■  ■
  ■■ ██  ▓▓■■■■ ▓▓▓▓▓▓▓ ▓▓▓▓    ██■■   ■
   ■■ █ ▓▓▓▓▓▓■■■■ ▓▓▓▓▓▓▓▓▓   ██ ■    ■
    ■■██  ▓▓ ▓▓  ■■■■■■■■■■   ██  ■   ■■
     ■ ██  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ ██    ■
     ■■ ██  ▓▓  ▓▓     ▓▓  ██■   ■■
     ■■  █     ▓  ■■■■▓ ▓▓██ ■   ■
     ■   ██■■■■■■■   ▓▓ ▓ █ ■■  ■■
          █▓▓▓▓▓▓■■■■ ▓ ▓██ ■   ■
          ■█ ▓▓▓ ▓▓▓■▓▓  █  ■■■
         ■■██ ▓▓ ▓■■■■■ ██    ■
        ■■  █ ▓▓■■■▓▓▓▓ █     ■■
        ■   ██▓■■▓▓▓▓▓ ██■
        ■    ██▓▓■■■▓  █ ■
              ██ ▓▓■■ ██ ■
               ██▓▓▓ ██  ■
                ██ ▓██   ■
                 ██ █
                  ███
                   ██
            </pre>

            <pre class="credits">
A Javascript game by <a href="https://milklounge.wang/tardquest/" target="_blank">Xx_TheMilkMan69_xX</a> and <a href="https://packardbell95.com/" target="_blank">MySpace Tom</a>
     TardQuest™ (2025) || <a href="https://github.com/packardbell95/tardquest" target="_blank">GitHub</a> || <a href="https://milklounge.wang/tardquest/gamedata/game_preview.html">Preview Build</a>
            </pre>
        </div>
    </div>
    <div id="screenWipe"></div>

<!-- In-game -->
    <div id="interface">
        <div id="battleLog"></div>
        <div id="topLeft">
            <div id="minimapContainer">
                <div id="minimapHeader" class="ui-header space-around">Dungeon Floor --</div>
                <div id="minimap"></div>
            </div>
            <pre id="portraitArtOverlay" class="portrait-art hidden"></pre>
        </div>
        <div id="inputBox">
            <input type="text" id="persuadeInput" placeholder="Say your piece...">
            <button
                id="confirmInputBox"
                title="Confirm"
                onclick="submitPersuasion()"
            ></button>
            <button
                id="closeInputBox"
                title="Close"
                onclick="GameControl.closePersuasionInputBox()"
            ></button>
        </div>
        <div id="stats">
            <div class="ui-header space-between">
                <span>Player</span>
                <span>Level <span id="playerLevel">1</span></span>
            </div>
            <div id="infoContainer">
                <div>
                    HP
                </div>
                <progress-bar
                    id="statHp"
                    cautionBelowPercentage="26"
                    dangerBelowPercentage="11"
                ></progress-bar>

                <div>
                    EXP
                </div>
                <progress-bar
                    id="statExp"
                    emptyColor="#000"
                    filledColor="#009"
                ></progress-bar>

                <div>
                    Load
                </div>
                <progress-bar
                    id="statLoad"
                    cautionAbovePercentage="50"
                    dangerAbovePercentage="80"
                    emptyColor="#000"
                    filledColor="#f04"
                ></progress-bar>

                <div>
                    Bitcoins
                </div>
                <div class="BTC">
                    ₿ <span id="playerBitcoins">0</span>
                </div>
            </div>
            <div class="ui-header">
                Stats
            </div>
            <div id="statContainer">
                <div>Strength</div><div id="statStrength" class="STR">4</div>
                <div>Defense</div><div id="statDefense" class="DEF">7</div>
                <div>Persuasion</div><div id="statPersuasion" class="PRS">15</div>
                <div>Endurance</div><div id="statEndurance" class="END">4</div>
                <div>Speed</div><div id="statSpeed" class="SPD">13</div>
                <div>Luck</div><div id="statLuck" class="LUK">2</div>
            </div>
        </div>
        <div id="controls">
            <div id="controlsExploration">
                <div class="ui-header">Navigation Controls</div>
                <div class="control-list">
                    <div>↑/W:</div><div>Move Forward</div>
                    <div>↓/S:</div><div>Move Backward</div>
                    <div>←/A, →/D:</div><div>Turn</div>
                    <div>Q, E:</div><div>Strafe</div>
                    <div>T:</div><div>Talk</div>
                    <div>I:</div><div>Inventory</div>
                    <div>Escape:</div><div>Game Menu</div>
                </div>
            </div>
            <div id="controlsCombat" class="hidden">
                <div class="ui-header">Combat Controls</div>
                <div class="control-list">
                    <div>A:</div><div>Attack</div>
                    <div>P:</div><div>Persuade</div>
                    <div>R:</div><div>Run</div>
                    <div>I:</div><div>Inventory</div>
                    <div>Escape:</div><div>Game Menu</div>
                </div>
            </div>
            <div id="controlsMenu" class="hidden">
                <div class="ui-header">Menu Controls</div>
                <div class="control-list">
                    <div>↑/W:</div><div>Previous Option</div>
                    <div>↓/S:</div><div>Next Option</div>
                    <div>←/A:</div><div>Previous Page</div>
                    <div>→/D:</div><div>Next Page</div>
                    <div>Enter/Space/E:</div><div>Select</div>
                    <div>Escape:</div><div>Close Menu</div>
                </div>
            </div>
        </div>
        <div id="viewport">
            <div class="ui-header space-between">Viewport</div>
            <div id="game" class="render"></div>
            <div id="animation" class="hidden"></div>
            <div id="animTorch" class="offscreen"></div>
            <div id="animTrombone" class="offscreen"></div>
            <div id="menu"></div>
            <div id="mouseControl">
                <div class="navigation">
                    <div class="forward" onclick="move('forward')"></div>
                    <div class="backward" onclick="move('backward')"></div>
                    <div class="turn-left" onclick="turnLeft()"></div>
                    <div class="turn-right" onclick="turnRight()"></div>
                    <div class="strafe-left" onclick="move('strafeLeft')"></div>
                    <div class="strafe-right" onclick="move('strafeRight')"></div>
                    <div class="touch" onclick="move('forward')"></div>
                </div>
                <div class="combat">
                    <div class="attack" onclick="playerAttack()"></div>
                </div>
            </div>
        </div>
        <div id="party">
            <div class="ui-header">
                Party
                (<span id="totalPartyMembers">0</span>/<span id="maxPartyMembers">3</span>)
            </div>
            <div id="partyMembers"></div>
        </div>
        <div id="inventory">
            <!--div class="ui-header space-around">Inventory</div-->
        </div>
        <div id="playerInput">
            <div class="section navigation hidden">
                <div class="ui-header">Navigation</div>
                <div class="grid-container">
                    <div id="navigationInput">
                        <button
                            name="turn-left"
                            title="Turn Left"
                            onclick="turnLeft()"
                        ></button>
                        <button
                            name="forward"
                            title="Move Forward"
                            onclick="move('forward')"
                        ></button>
                        <button
                            name="turn-right"
                            title="Turn Right"
                            onclick="turnRight()"
                        ></button>
                        <button
                            name="strafe-left"
                            title="Strafe Left"
                            onclick="move('strafeLeft')"
                        ></button>
                        <button
                            name="backward"
                            title="Move Backward"
                            onclick="move('backward')"
                        ></button>
                        <button
                            name="strafe-right"
                            title="Strafe Right"
                            onclick="move('strafeRight')"
                        ></button>
                    </div>
                </div>
            </div>
            <div class="section battle">
                <div class="ui-header">Battle</div>
                <div class="grid-container">
                    <div id="battleInput">
                        <button
                            name="attack"
                            title="KILL THAT SUCKA!"
                            onclick="playerAttack()"
                        ></button>
                        <button
                            name="persuade"
                            title="Persuade the enemy to join your party"
                            onclick="tryPersuade()"
                        ></button>
                        <button
                            name="run"
                            title="Run away like a coward"
                            onclick="tryRun()"
                        ></button>
                    </div>
                </div>
            </div>
            <div class="section menu">
                <div class="ui-header">Menu</div>
                <div class="grid-container">
                    <button
                        name="previous-page"
                        title="Previous Page"
                        onclick="menu.previousPage()"
                        disabled="disabled"
                    ></button>
                    <div>
                        <button
                            name="up"
                            title="Previous Option"
                            onclick="menu.handleInput('arrowup')"
                        ></button>
                        <button
                            name="confirm"
                            title="Confirm Selection"
                            onclick="menu.handleInput('enter')"
                        ></button>
                        <button
                            name="down"
                            title="Next Option"
                            onclick="menu.handleInput('arrowdown')"
                        ></button>
                    </div>
                    <button
                        name="next-page"
                        title="Next Page"
                        onclick="menu.nextPage()"
                        disabled="disabled"
                    ></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://vocapepper.com/tardquest/mods/tardboard.js"></script>
    <script src="scripts/no-arrow-key-scroll.js"></script>
    <script src="scripts/progress-bar.js"></script>
    <script src="scripts/Map.js"></script>
    <script src="scripts/Menu.js"></script>
    <script src="scripts/sam.js"></script>
    <script src="scripts/Tooltip.js"></script>
    <script src="data/portraits.js"></script>
    <script src="data/enemyart.js"></script>
    <script>
        /**
         * ASCII art that the sceneRenderer uses to draw scenes
         *
         * Each entry here has a name (eg: "wall", "healingTile", etc) which is
         * used to identify the map object that is being rendered
         *
         * Each sceneArt entry is an object that points to art for that thing.
         * The object is broken into positions relative to the viewport of the
         * rendered scene. Positions are denoted as "p#_#" where "p" means
         * "position". The first # is the distance (or depth, or Z-coordinate,
         * however you want to think of it). The second "#" is the X-coordinate
         * of what the player is currently seeing, going from left to right.
         *
         * For example, the player is seeing everything in the triangle in this
         * map, including the spaces to the immediate left and right (p0_0 and
         * p0_2 respectively):
         *
         * Distance 5   \........./
         * Distance 4   .\......./.
         * Distance 3   ..\...../..
         * Distance 2   ...\.../...
         * Distance 1   ....\./....
         * Distance 0   .....↑.....
         *            Player ⤴
         *
         * Each cell is numbered this way (with "X" meaning 10):

         * Distance 5   0123456789X
         * Distance 4   .012345678.
         * Distance 3   ..0123456..
         * Distance 2   ...01234...
         * Distance 1   ....012....
         * Distance 0   ....012....
         *            Player ⤴
         *
         * So if the player's vision spots a wall at distance 3, position 4,
         * we would want to render the wall with the art referenced by entry
         * "p3_4"
         *
         * The whitespace for each piece of art is automatically trimmed from
         * the left side. This is to preserve formatting in the code (JavaScript
         * does not support heredocs unfortunately). But sometimes spaces are
         * desired as part of the art. So, a spaceBoundaryCharacter might be set
         * which will stop the whitespace from trimming into the art. This
         * character will be replaced with a space during rendering
         *
         * Each object also has an x and y value. This is the character offset
         * of where the art will start to be drawn
         *
         * Art may also have a transparentCharacter defined which will simply
         * not draw anything for that character when rendered
         */
        const sceneArt = {
            tardspireBanner: {
                positions: {
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 6, y: 4 },
                    },
                },
                art: [
                    {
                        data: `
                            ▛▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▜
                            ▌       W E L C O M E    T O . . .   ▐
                            ▌T ▀█▀▄▀▄ █▀▙ █▀▄ ▄▀▀ █▀▄▀█▀ █▀▙ █▀▀ ▐
                            ▌H  █ █▄█ █▄▛ █ █  ▀▄ █▄▀ █  █▄▛ █▄▄ ▐
                            ▌E  █ █ █ █ █ █▄▀ ▄▄▀ █  ▄█▄ █ █ █▄▄ ▐
                            ▙▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▟
                        `,
                    },
                ],
            },
            wall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ██████▒█▄
                            ██████▒███▄
                            ██████▒█████▄
                            ██████▒███████▄
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒███████▀
                            ██████▒█████▀
                            ██████▒███▀
                            ██████▒█▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ███████████████▒▄
                            ███████████████▒██▄
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒██▀
                            ███████████████▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            ████
                            ████
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████▓▄
                            ███████████▓██▄
                            ███████████▓███
                            ███████████▓███
                            ███████████▓██▀
                            ███████████▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ██████▓▄
                            ██████▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████▄
                            ███████▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ██████
                            ██████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            darkness: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ████████▄
                            ██████████▄
                            ████████████▄
                            ██████████████▄
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ██████████████▀
                            ████████████▀
                            ██████████▀
                            ████████▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ████████████████▄
                            ██████████████████▄
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ██████████████████▀
                            ████████████████▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            ████
                            ████
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████▄
                            ██████████████▄
                            ███████████████
                            ███████████████
                            ██████████████▀
                            ████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████▄
                            ███████▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████▄
                            ███████▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ██████
                            ██████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            void: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 14 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 45, y: 14 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 14 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 14 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 14 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 14 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 14 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 14 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 31, y: 14 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 14 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 14 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 14 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 14 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 14 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 28, y: 14 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 14 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 47, y: 14 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 14 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 14 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 14 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 14 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 14 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 14 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 31, y: 14 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 14 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 14 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████████████
                            ██████████████
                            ██████████████
                            ██████████████
                            ██████████████
                            ██████████████
                            ████████████▀
                            ██████████▀
                            ████████▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████
                            ████████
                            ████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████████████
                            ███████████████████
                            ███████████████████
                            ██████████████████▀
                            ████████████████▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███
                            ██▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████████████
                            ██████████████
                            ████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████
                            ▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀
                        `,
                    },
                ],
            },

            iceWall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                             ▀▄
                               ▀▄
                            ▝▘▝▘ █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                            ▗▖▗▖ █
                               ▄▀
                             ▄▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀▀▀▀▀▄
                                  ▒▀▄
                                  ▒  ▀▄
                                  ▒    ▀▄
                            ▖  ▗▖ ▒▗▖  ▗▖▀▄
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                            ▘  ▝▘ ▒▝▘  ▝▘▄▀
                                  ▒    ▄▀
                                  ▒  ▄▀
                                  ▒▄▀
                            ▄▄▄▄▄▄▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
                            █▝▘                                  ▝▘█
                            █  ▝▘                              ▝▘  █
                            █    ▝▘                          ▝▘    █
                            █      ▝▘                      ▝▘      █
                            █        ▝▘  ▝▘  ▝▘  ▝▘  ▝▘  ▝▘        █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖  ▗▖  ▗▖  ▗▖  ▗▖  ▗▖        █
                            █      ▗▖                      ▗▖      █
                            █    ▗▖                          ▗▖    █
                            █  ▗▖                              ▗▖  █
                            █▗▖                                  ▗▖█
                            █▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                              ▀▀▀▄▄▄
                                    █
                                    █
                                    █
                                    █
                                    █
                                    █
                              ▄▄▄▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                                           ▒▄
                             .             ▒ ▀▄
                              .  .  .  .  .▒ . █
                             .             ▒   █
                                           ▒   █
                                           ▒   █
                             .             ▒   █
                              .  .  .  .  .▒ . █
                             .             ▒ ▄▀
                                           ▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            █ .                . █
                            █   .   .    .   .   █
                            █                    █
                            █   .            .   █
                            █                    █
                            █                    █
                            █   .            .   █
                            █                    █
                            █   .   .    .   .   █
                            █ .                . █
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀▄▄
                               █
                               █
                            ▄▄▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █▀▀▀▀▀▀▀▀▀▀▓▄
                            █          ▓ ▀▄
                            █          ▓  █
                            █          ▓  █
                            █          ▓ ▄▀
                            █▄▄▄▄▄▄▄▄▄▄▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █▀▀▀▀▀▀▀▀▀▀█
                            █          █
                            █          █
                            █          █
                            █          █
                            █▄▄▄▄▄▄▄▄▄▄█
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █     ▓▄
                            █     ▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █     █▄
                            █     █▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █     █
                            █     █
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █    █
                            █    █
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            rubble1: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_1: {
                        artIndex: 11,
                        drawAt: { x: 5, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            '  .'   .  '    ..   '   .
                            %%%%% .;' .   '   . ' .
                            %%%%'   .    ;'  ' '  , '
                            %%%%%%. '. .'   ,'  ;.
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%    . '     ;'  '   . ,
                            %%%%%'  ..    ',.    .  '   ';,
                            %%%%'   ;' ,' . .  .  , ,       .
                            %%% , .   .    '   ;  ' .'   '
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %.  .; '
                            .'
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%. ,  . ,
                            . ;'  ,. .  :,
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%% ;'.   .  ,
                            %% , . '    '  .
                        `,
                    },
                    {
                        data: `
                            .  ,.  .  ,
                             '    ',  . , .
                        `,
                    },
                    {
                        data: `
                            '. ;. :  .'  '
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%.'  ';
                        `,
                    },
                    {
                        data: `
                            ' "' '
                        `,
                    },
                    {
                        data: `
                            --
                        `,
                    },
                    {
                        data: `
                            . ,' '"  '
                        `,
                    },
                    {
                        data: `
                             ' .  ' .   '   ' ,.     ;   .  , ' .  '
                            '    ,'  ;          .;                .
                              ,'  ,'.  ' .,   '    ; '.    '     ' .
                            .  '      ' . '      '    . ',  ; .
                        `,
                    },
                ],
            },

            rubble2: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_1: {
                        artIndex: 11,
                        drawAt: { x: 5, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        data: `
                             '   , ' .   .  ' ,  , ' .
                            .  ;  '        '    ' .
                                 .   ;   '     .    ,
                                   '       : '   . '
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%'      .   ;   '      '
                            %%%%%,  ; , ' .   .  ' ,  ,   .
                            %%%%    .   ;   '       : '.   ,
                            %%% '  .  '   ,    ;  .         '
                        `,
                    },
                    {
                        data: `
                             '  ; '
                            ,
                        `,
                    },
                    {
                        data: `
                            '    .      ,
                             .  ';  '  .  '
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%.  '   .  ,
                            % '    ,   .    ;
                        `,
                    },
                    {
                        data: `
                            '  . '  ;  .
                             ,    '   '   .
                        `,
                    },
                    {
                        data: `
                            . '    . ;  '
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%'.  ;.
                        `,
                    },
                    {
                        data: `
                            .'  ',
                        `,
                    },
                    {
                        data: `
                            --
                        `,
                    },
                    {
                        data: `
                            '  ; ..  ,
                        `,
                    },
                    {
                        data: `
                            .  '      ' . '      '    . ',  ; .
                              ,'  ,'.  ' .,   '    ; '.    '     ' .
                            '    ,'  ;          .;                .
                             ' .  ' .   '   ' ,.     ;   .  , ' .  '
                        `,
                    },
                ],
            },

            gloryWall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ██████▒█▄
                            ██████▒███▄
                            ██████▒█████▄
                            ██████▒███████▄
                            ██████▒█▒▒█████
                            ██████▒█▒█▒▒███
                            ██████▒███▒█▒██
                            ██████▒████▒███
                            ██████▒██▒█████
                            ██████▒█████▒██
                            ██████▒███░▒███
                            ██████▒██▒▒████
                            ██████▒████████
                            ██████▒███▒████
                            ██████▒███████▀
                            ██████▒█████▀
                            ██████▒███▀
                            ██████▒█▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: false,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ██████████▀█████████▀███████████████████
                            █████▀▄▄█▀▄▀▄▄▀█▀▄▄█▄▀ █████████████████
                            ████ █▄ █ █▄▀▀▄█ ██▀▀▀▄█████████████████
                            █████▄▄█████████████████████████████████
                            ██████████▀██▀██████ ███████████████████
                            █████████ ▀▀ █▀▄▄▀█ ██▀▄▄▀██████████████
                            ████████ ███ █▄▀▀▄█ █ █▄▄███████████████
                            ██████████████████████▄▄███▀▀▀██████████
                            ██████████████████████████████▄▄▀███████
                            ████████████████████████████████ ███████
                            ████████████████▀▀██▓██▀ ████▀▀▄████████
                            ███████████████    ███▄  ▄▄▄▄███████████
                            █████████████▓██▄▄████▓█▄███████████████
                            ████████████████▒░█▓████████████████████
                            ██████████████▒██▒██████████████████████
                            ████████████████▓███████████████████████
                            █████████████████▓██████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █████████
                            ██▓▓▓▓███
                            █▓█▓█▓███
                            ████▓████
                            ██▒▒█████
                            █████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ███████████████▒▄
                            ██▓█▓██████████▒██▄
                            █▓█▓█▓█▓█▓█████▒████
                            ██▓█▓█████▓████▒████
                            █████████▓█████▒████
                            ████████▓██████▒████
                            ████▒▒█████████▒████
                            ███████████████▒████
                            ████▓██████████▒██▀
                            ███████████████▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ████▓▓██▓██▓██████████
                            ███▓██▓▓█▓██▓█▓███████
                            ██████████▓████▓▓█████
                            ██████████████▓███████
                            ████████▒▒▓█▓█████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            █▓██
                            ██▓█
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████▓▄
                            ██▓█▓█▓████▓██▄
                            ███▓███▓███▓███
                            ███▓▒▓█████▓███
                            ███████████▓██▀
                            ███████████▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ██▓█▓█▓█████
                            ████████▓███
                            ███▓▒▓▓█████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓█▓▄
                            ██▓▓███▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓██▄
                            ██▓▓███▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓██
                            ██▓▓███
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓█
                            ██▓▓██
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            noboWall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 15,
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 14,
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ▒▒████
                            ▒▒▒███
                            █▒▒███
                            ███░██
                            ████░█
                            █████░
                            ██████
                            ██████
                            ██████
                            ████░█
                            ██░░░█
                            ░░░░░█
                            ░░░░░█
                            ░░░█▀
                            ░█▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ██████▒█▄
                            ██████▒███▄
                            ██████▒█████▄
                            ██████▒███████▄
                            ▓▓▓▓██▒█▒▒█████
                            ▓▓████▒█▒▒▒▒███
                            █▓▓▓██▒██▒▒█▒▒█
                            ▓▓████▒█▒▒▓▓▒▒█
                            ██████▒█▒▒▒█▒▒█
                            ██████▒███▓▓▒▒█
                            ██████▒████▓▓▒█
                            ██████▒█████▒▒█
                            ██████▒████▓▓██
                            ██████▒████████
                            ██████▒███████▀
                            ██████▒█████▀
                            ██████▒███▀
                            ██████▒█▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: false,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            █▀███▀██▀▀██▀▀▀███▀▀████████████████████
                            █ ▄▀█ █ ██ █ ▀▀▄█ ██ ████████▀▀▀▀▀▀▀████
                            █ ██▄ █ ██ █ ██ █ ██ ████ ▄▄▄██████ ████
                            █▄███▄██▄▄██▄▄▄███▄▄█████ ▀▀▀▀▄▀▀▀▀ ████
                            ███ ███ █▀▄▄▀█▀▄▄▄███████   ▀███▀   ████
                            ███ █ █ █ ▄▄ ██▄▄▄▀███▀▀▀   ▀▀ ▀▀   ▀▀██
                            ████▄█▄██▄██▄█▄▄▄▄███ ▀▀▀▀▀██████████▀ █
                            █ ███ █ ▄▄▄█ ▄▄▀█ ▄▄▄█▒▒▒▄    ▄     ▒▒▒█
                            █ ▄▄▄ █ ▄▄▄█ ▄▄▀█ ▄▄▄██▒▒▒███ █████ ▒▒██
                            █▄███▄█▄▄▄▄█▄██▄█▄▄▄▄█▀▀▒▒███▄▀▄██▀ ▒▀██
                            ██████████████████▀▀▄▄████ ██▀▀▀█  ███ ▀
                            █████████████████ █████████▄ ▀▀▀   █████
                            █████████████████ █████████▀▀██   ██████
                            █████████████████ ████████ ██ █  ███████
                            ████████████████ ███████  █▄▄█▄▀█▀████▀█
                            ████████████████ ██████   ██▄▄▄ █      █
                            █████████████████ ███▀    ██▄▄ ▄▀      █
                            █████████████████ ██        ▄▄█ 6/22/25 
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █▓▓██████
                            ██▓▓▓▓▓▓█
                            ██████▓▓█
                            █████▓▓▓▓
                            █████▓▓▓▓
                            █████▓▓██
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ███████████████▒▄
                            ███████████████▒██▄
                            █▒▒▒▒▒▒███▓▓███▒████
                            ███▓▓▓██▒▒▒▒▒▒█▒█▓▓█
                            █▒▒▒▒▒▒██▓▓▓███▒██▓█
                            ████████▒▓▓▓▓▓█▒█▓▓█
                            ██████▒▓▓▓▓▓▓▓█▒█▓▓█
                            ██████▒▓▓▓▓▓▓▓█▒██▓█
                            ███████▓▒▒▒▒▒▒█▒██▀
                            ███████████████▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ██▒▒▒▒▒▒▒▒████▓▓██████
                            ███▓▓▓▓▓▓███▒▒▒▒▒▒████
                            ██▒▒▒▒▒▒▒▒███▒▒▒▒█████
                            ██████████▒▒▒▒▒▒▒▒████
                            ██████████▒▒▒▒▒▒▒▒▒███
                            ███████████▒▒▒▒▒▒▒▒███
                            ████████████▓▓▓▓▓▓▓███
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            █▓▓█
                            ██▓█
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████▓▄
                            ██▓▓▓██▓▓██▓██▄
                            ██▓▓▓█▓▓▓▓█▓█▓█
                            ███▓█▓█▓▓██▓█▓█
                            ███████████▓██▀
                            ███████████▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ██▓▓▓█▓▓▓███
                            ██▓▓▓█▓▓▓▓██
                            ███▓█▓▓▓▓▓██
                            ██████▓▓▓▓██
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓█▓▄
                            ██▓▓▓██▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓██▄
                            ██▓▓▓██▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓██
                            ██▓▓▓██
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓█
                            ██▓▓▓█
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            %%%▄▒███████████████
                            %▄██▒███████████████
                            ████▒█▒▒▒▒▒▒███▓▓███
                            █▓▓█▒███▓▓▓██▒▒▒▒▒▒█
                            ▓▓▓█▒█▒▒▒▒▒▒██▓▓▓███
                            █▓▓█▒████████▒▓▓▓▓▓█
                            █▓▓█▒██████▒▓▓▓▓▓▓▓█
                            ██▓█▒██████▒▓▓▓▓▓▓▓█
                            %▀██▒███████▓▒▒▒▒▒▒█
                            %%%▀▒███████████████
                            %%%%%▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄
                            %%%▄██
                            %▄████
                            ██████
                            █████░
                            ██░░█░
                            ██░█░░
                            ██░██░
                            █████░
                            ██████
                            ███░█░
                            ████░█
                            ██████
                            █████░
                            ██░██░
                            ██░░░░
                            ██░██░
                            █████░
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            %▀████
                            %%%▀██
                            %%%%%▀
                        `,
                    },
                ],
            },

            healingTile: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▀██████████████████████▀
                            %%▀██████████████████▀
                            %%%%▀██████████████▀
                            %%%%%%▀▀▀▀▀▀▀▀▀▀▀▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄██████████████████████▄
                            %%%▄██████████████████████████▄
                            %▄██████████████████████████████▄
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▄▄▄▄▄▄▄▄▄▄▄
                            ▄▄███████████▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ▄████████████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄
                            %▀███████████▄▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▀████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╼╾
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄██████▀▀
                        `,
                    },
                ],
            },

            crackedFloorSlight: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀█▀▀▄%%▄▄
                            ▀▀▀▀%%%%%%%%%%%%▀▄
                            %%%%%%%%%%%%%%%%%%▀▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄
                            %%%%%%%%%▀▀█▀▀▄
                            %%%%%%%▀▀▀▀%%%%%%%%%%%%%%▀▀▄
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▘%▗▄▖
                            %▀▘%%▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%▄%%%%%▖
                            %%%▀▀▀%%%%%%▝▄
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▄▄%%%%▗▄▖
                            %▀▀▀%%%%%%%%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄%%%▗▄▖
                            %%%▀▀▀%%%%%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %░░%░%%%░░%%░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %░░%░░%%░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▔%%▔
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╶╴
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▒░▒▒░▒
                        `,
                    },
                ],
            },

            crackedFloor: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀█▀▀▄▄▄▄▄%%▄▀
                            ▀▀▀▀%%%%%%▄▄▄▀▀▀▀▄
                            %%%%%%%%%%%%%%%%%%▀▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄
                            %%%%%%%%%▀▀█▀▀▄▄▄▄▄%%%%%▄▀
                            %%%%%%%▀▀▀▀%%%%%%%%%▄▄▄▀▀▀▀▄
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▘%▗▟▖
                            %▀▘%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▀▀▄▄▘%▗▟▖
                            %%%▀▀▀%%%▀▘%▝▄
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀▄▄▘%%%▗▟▖
                            %▀▀▀%%%%%▀▘%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%▀▀▄▄▘%▗▟▖
                            %%%▀▀▀%%%▀▘▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▒▒%▒░░%▒▒░░▒%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▒▒░▒▒░░▒%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▔▔%%▔
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╶╴
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▒░▒▒░▒
                        `,
                    },
                ],
            },

            crackedFloorSevere: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀█▀▀▄▄▄▄▄%%▄▀▀▀▄▀
                            ▀█▀▀%▀▄%▄%▄▄▄▀▀▀▀▄
                            %%▀▀%▀%▀▀%%▀%▀▀%%%█▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄
                            %%%%%%%%%▀▀█▀▀▄▄▄▄▄%%%%%▄▀▀▀▄▀
                            %%%%%%%▀█▀▀%▀▄%▄%▄%%▄▄▄▀▀▀▀▄
                            %%%%%%%%%▀▀%▀%▀▀%%▀%%▀%▀▀%%%█▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▀%▗▟▞▞
                            %▜▚▚▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▀▀▄▄▀%▗▟▞▞
                            %%%▜▜▀▞%%▜▚▚▝▄
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀▄▄▀%%%▗▟▞▞
                            %▜▜▀▞%▚%%▜▚▚▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%▀▀▄▄▀%▗▟▞▞
                            %▜▜▀▞%▚%▜▚▚▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ░▓▓░▓▒▒░▓▓▒▒▓░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ░▓▓▒▓▓▒▒▓░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▔▀▔▘
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╺╸
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ░░▓▒▓▓▒▓
                        `,
                    },
                ],
            },

            exit: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 7 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 7 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 4 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 4 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 4 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 14 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 9 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 16, y: 9 },
                    },
                    p2_3: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 9 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 10 },
                    },
                    p3_0: {
                        artIndex: 4,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 4,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 4,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 11 },
                    },
                    p3_4: {
                        artIndex: 6,
                        drawAt: { x: 29, y: 11 },
                    },
                    p3_5: {
                        artIndex: 6,
                        drawAt: { x: 36, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 7,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 7,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 7,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 7,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 7,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 7,
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 7,
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 7,
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 7,
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 8,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 8,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 8,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 8,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 8,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 8,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 8,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 8,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 8,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%▄▄▄▄
                            %%%%%%%%%%██
                            ▀██▄%%%%%%██
                            %%%▀██▄%%%██
                            %%%%%%▀██▄▄▀
                            %%%%%%%%%▀██▄
                            %%%%%%%%%% ▀██▄
                            %%%%%%%%%%▄ %▀██▄
                            %%%%%%%%%%██%%%▀██▄%▄█
                            %%%%%%%%%%██%%%%▄████▀
                            %%%%%%%%%%██%%%▀▀█████
                            %%%%%%%%%%██%%%%%%%%▀▀
                            %%%%%%%%%%██
                            %%%%%%%%%%██
                            %%%%%%%%%%██
                            %%%%%%%%%%▀▀
                            %%%%%%▄▀▀▀▀▀▀▀▀██████████████▄
                            %%%%▄█████████ ▀▀▀▀▀▀▀▀▀▀██████▄
                            %%▄█████████▀▄ ███████▀▄ ████████▄
                            %▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▗▄▖
                            %%%▝▚▖█
                            %%%%%▝█
                            %%%%%%█▚
                            %%%%%%█%▚▐▖
                            %%%%%%█▝▀█▌
                            %%%%%%█
                            %%%%%%█
                            %%%%▄▄▄▄▄▄▄▄▄▄▄
                            ▄▄███████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▗▄▖
                            %%▝▚▖█
                            %%%%▝█
                            %%%%%█▚
                            %%%%%█%▚▐▖
                            %%%%%█▝▀█▌
                            %%%%%█
                            %%%%%█
                            %%▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ▄████████████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▗▄▖
                            ▝▚▖█
                            %%▝█
                            %%%█▚
                            %%%█%▚▐▖
                            %%%█▝▀█▌
                            %%%█
                            %%%█
                            %%▄▄▄▄▄▄▄▄▄▄▄
                            %%%▀███████████▄▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%╲▂▖
                            %%%▐╲
                            %%%▐%╲▖
                            %%%▐%▀▘
                            %%%▝
                            ████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %╲▂▖
                            %%▐╲
                            %%▐%╲▖
                            %%▐%▀▘
                            %%▝
                            ▄████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                          ╲▂▖
                          %▐╲
                          %▐%╲▖
                          %▐%▀▘
                          %▝
                          ▀████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %┬
                            %│╲▎
                            %│▔
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ↘
                            ╼╾
                        `,
                    },
                ],
            },

            treasureChest: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 22 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 48, y: 22 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: -14 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 14, y: 16 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 16 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -8, y: 15 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 16 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 16 },
                    },
                    p2_3: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 16 },
                    },
                    p3_0: {
                        artIndex: 3,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_1: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 15 },
                    },
                    p3_2: {
                        artIndex: 3,
                        drawAt: { x: 13, y: 15 },
                    },
                    p3_3: {
                        artIndex: 3,
                        drawAt: { x: 23, y: 15 },
                    },
                    p3_4: {
                        artIndex: 3,
                        drawAt: { x: 33, y: 15 },
                    },
                    p3_5: {
                        artIndex: 3,
                        drawAt: { x: 39, y: 15 },
                    },
                    p3_6: {
                        artIndex: 3,
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 4,
                        drawAt: { x: 6, y: 14 },
                    },
                    p4_1: {
                        artIndex: 4,
                        drawAt: { x: 11, y: 14 },
                    },
                    p4_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p4_3: {
                        artIndex: 4,
                        drawAt: { x: 21, y: 14 },
                    },
                    p4_4: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p4_5: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p4_6: {
                        artIndex: 4,
                        drawAt: { x: 33, y: 14 },
                    },
                    p4_7: {
                        artIndex: 4,
                        drawAt: { x: 38, y: 14 },
                    },
                    p4_8: {
                        artIndex: 4,
                        drawAt: { x: 43, y: 14 },
                    },
                    p5_0: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 5,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 5,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 5,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 5,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 5,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 5,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 5,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 5,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %▄██████████████████▄
                            █▀   █          █   ▀█
                            █    █          █    █
                            █▀▀▀▀█▀▀▀▀██▀▀▀▀█▀▀▀▀█
                            █    █    ▀▀    █    █
                            █    █          █    █
                            █▄▄▄▄█▄▄▄▄▄▄▄▄▄▄█▄▄▄▄█
                        `,
                    },
                    {
                        data: `
                            ▄▀▀▀▀▀▀█▀▄
                            █▀▀██▀▀█▄█
                            █      █ █
                            ▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        data: `
                            ▄▀▀▀▀▀▀▀▀▄
                            █▀▀▀██▀▀▀█
                            █        █
                            ▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        data: `
                            ▞▜▛▚
                            ▙▄▄▟
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▆▆
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▗▖
                        `,
                    },
                ],
            },

            merchant: {
                relativeColor: { r: 247, g: 119, b: 247 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 14 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 14 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 16, y: 10 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 33, y: 10 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 11 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 10 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 20, y: 10 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 32, y: 10 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 43, y: 11 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -5, y: 13 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 12 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 12 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 27, y: 12 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 34, y: 12 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 4, y: 13 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 9, y: 13 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 14, y: 13 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 19, y: 13 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 24, y: 13 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 28, y: 13 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 32, y: 13 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 37, y: 13 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 13 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%█▀▄▄
                            %%%%%%%%▌  ▀▀▄▀
                            %%%%%%%▄▄▄▀▀▀
                            %%%%%%▀▄    ▀▀▀
                            %%%%%▄▀    █▄
                            %%%%%█      █
                            %%%%%█      ▀█%%%▄▀
                            %%%%█       ▀▄▄▄▀
                            %%%%█        ▄▀
                            %%%▀▄▄▄▀▀▀▄▄▀
                            %%%%%%█  ▄▀█
                            %%%%%%█ █▀  ▀▄
                            ▀%▀▀%▀▀▀▀▀▀▀▀▀▀▀%%▀
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%█▄
                            %%%█▄██▀
                            %%▀▀   ▀
                            %%█   █
                            %█     █%▄▀
                            █      ▄▀
                            %▀▄▀▀▄█
                            %%█ █  █
                            %▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%▟▄▂
                            %▝▛▀▂
                            %▞ ▚%%╱
                            ▝▚▁▁▀╱
                            %%▌▙╱
                        `,
                    },
                    {
                        data: `
                            ☻
                            ╦╱
                            ╫
                        `,
                    },
                    {
                        data: `
                            ♣
                        `,
                    },
                ],
            },

            gambler: {
                relativeColor: { r: 255, g: 215, b: 0 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -14, y: 15 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 13 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 17, y: 12 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 36, y: 12 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 14 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 13 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 19, y: 13 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 33, y: 13 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 44, y: 14 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -3, y: 14 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 1, y: 13 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 13 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 13 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 28, y: 13 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 35, y: 13 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 8, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 13, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 18, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 23, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 27, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 31, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 36, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 41, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄%▄
                            ▌%%%%%%%█▀▄▀▄
                            █%%%%%%▄▀  ▀▀▀▀▄
                            █%%%%%█      ╼╸ ▀▀▄
                            █%%%%▄▀       ▄▄▄▄▄▀
                            █%%%█      ▀█▀
                            █%%█     ▀▀▄▄▀▄
                            █%%█         ▀██▄
                            %█▄█          █
                            %%▀▄▄▄▄▄▄▄▄▄▄▀
                            %%%%%▀▀▀%%%▀▀▀▀
                            %
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            ▌%%%█▄█▄
                            █%%%█  ╼▀▀▄
                            █%%█   ▄▀▀▀
                            ▀▄█   ▀▀█▀
                            %%▀▄▄▄▄▄▀
                            %%%▀▀%%▀▀
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            ▌%▙▙▂
                            ▌▟█▞▀▀
                            ▚▜██▞
                            %▀%▀
                        `,
                    },
                    {
                        data: `
                            ▌▙▖
                            ▝▀
                        `,
                    },
                    {
                        data: `
                            ♠
                        `,
                    },
                ],
            },

            crater: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 23 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 23 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 20 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 20 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 22 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 30, y: 17 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 42, y: 22 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -9, y: 19 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 8, y: 15 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 15 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 29, y: 15 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 36, y: 15 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 19 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 7, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 12, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 17, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 22, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 26, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 35, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 40, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄▄▄▄████████████▄▄▄▄
                            %%%%%▄████▛██▞█▞██▟▛▟██▚█▜████▄
                            %%%%▀██▟███▛███▀▀▀▀▀▀██▜███▟███▀
                            %%%%%%▀▀▀▀████████████████▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▃▄▄▄▄▄▄▄▄▃
                            %▀▀████▄▄▄▄████▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▁▂▂▂▂▂▂▁
                            ▀████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▂▂▂▂
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╼╾
                        `,
                    },
                ],
            },

            bloodyCrater: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 23 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 23 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 20 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 20 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 22 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 30, y: 17 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 42, y: 22 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -9, y: 19 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 8, y: 15 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 15 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 29, y: 15 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 36, y: 15 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 19 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 7, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 12, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 17, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 22, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 26, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 35, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 40, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%▘%▄▄▄▄████████████▄▄▄▄%▘
                            %%%%%▄██▘ ▀▝▞██▟▛██▛██▀████▀██▄▗
                            %%%%▀███▖ ▄▗▚██▀▀▀▀▀▀█▀▄▄▄▄▀███▀
                            %%%▝%%▀▀▀▀████▟████▟██████▀▀▀▀%%▗
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▃▄▄▄▄▄▄▄▄▃
                            %▀▀████▄▄▄▄████▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▁▂▂▂▂▂▂▁
                            ▀████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▂▂▂▂
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╼╾
                        `,
                    },
                ],
            },
        };

        const Portrait = {
            activeFrame: 0,
            timer: null,
            hide: () => {
                clearTimeout(Portrait.timer);
                document.getElementById('portraitArtOverlay').classList.add('hidden');
                document.getElementById('minimapContainer').classList.remove('hidden');
            },
            show: (portraitName) => {
                const $overlay = document.getElementById('portraitArtOverlay');
                if (!$overlay) {
                    console.error("Could not find portraitArtOverlay");
                    return;
                }

                const animation = Portrait.animations = window.PORTRAIT_ANIMATIONS[portraitName];
                if (typeof animation !== 'object') {
                    console.error("Could not find specified portrait", {
                        portraitName,
                    });
                    return;
                }

                document.getElementById('minimapContainer').classList.add('hidden');

                clearTimeout(Portrait.timer);
                Portrait.activeFrame = 0;
                $overlay.className = `portrait-art ${portraitName}`

                function drawFrame() {
                    const formattedFrame =
                        ('\n'.repeat(animation.padding.y)) +
                        (animation.frames[Portrait.activeFrame]
                            .split("\n")
                            .map((l) => " ".repeat(animation.padding.x || 0) + l)
                            .join('\n')
                    );

                    $overlay.innerText = formattedFrame;
                    Portrait.activeFrame++;

                    if (Portrait.activeFrame < animation.frames.length) {
                        Portrait.timer = setTimeout(
                            drawFrame,
                            animation.frameDelayMs
                        );
                    } else {
                        if (animation.playbackMode === "repeat") {
                            Portrait.activeFrame = 0;
                            Portrait.timer = setTimeout(
                                drawFrame,
                                animation.frameDelayMs
                            );
                        }
                    }
                }
                drawFrame();
            },
        };

        const SpeechSynthesizer = {
            isSpeaking: false,
            speak: (sentence, voiceOptions, onEnded) => {
                // Don't speak a new line if one is currently playing
                if (!speechEnabled || SpeechSynthesizer.isSpeaking) {
                    onEnded?.();
                    return;
                }

                if (!voiceOptions) {
                    console.error("No voice options provided", { sentence });
                    return;
                }

                SpeechSynthesizer.isSpeaking = true;
                const options = structuredClone(voiceOptions);
                options.singmode = Math.random() < 0.5;
                options.reverb = {
                    wetGain: 0.05,
                    dryGain: 0.85,
                    delayTimeSeconds: 0.02,
                    decay: 0.3,
                    totalDelays: 5,
                    lowpassFilterCutoffHz: 1760,
                };
                options.onEnded = () => {
                    SpeechSynthesizer.isSpeaking = false;
                    onEnded?.();
                }

                new SamJs(options).speak(sentence);
            },
        };

        const sceneRenderer = {
            displayWidth: 50,
            displayHeight: 28,
            maxViewDepth: 5,

            render: (x, y, direction, viewDepth, maxBrightness = 255) => {
                const maxPlayerVisibilityDepth = viewDepth || sceneRenderer.maxViewDepth;
                const view = sceneRenderer.getView(x, y, direction, maxPlayerVisibilityDepth);
                const layerClasses = sceneRenderer.getLayerClasses();
                let scene = '';

                for (let depth = view.length - 1; depth >= 0; depth--) {
                    let sceneLayer = Array.from({ length: sceneRenderer.displayHeight }, () =>
                        Array.from({ length: sceneRenderer.displayWidth }, () => ' ')
                    );

                    for (let i = 0; i < view[depth].length; i++) {
                        // Render the scene from the sides towards the middle
                        const index = i % 2 === 0 ? i - (i / 2) : view[depth].length - Math.floor(i / 2) - 1;
                        const isCentered = i === view[depth].length - 1;

                        sceneLayer = sceneRenderer.draw(
                            sceneLayer,
                            view[depth][index],
                            depth,
                            maxPlayerVisibilityDepth,
                            index,
                            isCentered,
                            maxBrightness
                        );
                    }

                    scene +=
                        `<div class="${layerClasses}">` +
                            sceneLayer.map(row => row.join('')).join('\n') +
                        '</div>';
                }

                return scene;
            },

            getLayerClasses: () => {
                const layerClasses = ['layer'];
                if (player.enteringCombat) {
                    layerClasses.push('darkening');
                } else if (player.leavingCombat) {
                    layerClasses.push('lightening');
                } else if (player.inCombat) {
                    layerClasses.push('dark');
                }

                return layerClasses.join(' ');
            },

            getView: (x, y, direction, viewDepth) => {
                const fixedViewDepth = Math.min(viewDepth, sceneRenderer.maxViewDepth);
                const grid = [];

                const directionVectors = {
                    N: { dx: 0, dy: -1, lateral: { dx: 1, dy: 0 }, flip: 1 },
                    S: { dx: 0, dy: 1, lateral: { dx: 1, dy: 0 }, flip: -1 },
                    E: { dx: 1, dy: 0, lateral: { dx: 0, dy: 1 }, flip: 1 },
                    W: { dx: -1, dy: 0, lateral: { dx: 0, dy: 1 }, flip: -1 }
                };

                const dir = directionVectors[direction];
                if (!dir) {
                    console.error("Invalid direction");
                    return [];
                }

                for (let depth = 0; depth <= sceneRenderer.maxViewDepth; depth++) {
                    const row = [];
                    const offsetStart = depth === 0 ? -1 : -depth;
                    const offsetEnd = depth === 0 ? 1 : depth;

                    for (let offset = offsetStart; offset <= offsetEnd; offset++) {
                        if (depth > fixedViewDepth) {
                            row.push(new MapCell('darkness'));
                            continue;
                        }
                        const lateralOffset = offset * dir.flip;
                        const tx = x + dir.dx * depth + dir.lateral.dx * lateralOffset;
                        const ty = y + dir.dy * depth + dir.lateral.dy * lateralOffset;
                        row.push(MAP.getCell(tx, ty));
                    }

                    grid.push(row);
                }

                return grid;
            },

            draw: (scene, subject, depth, maxPlayerVisibilityDepth, index, isCentered, maxBrightness) => {
                if (typeof subject?.isVisible === 'function' && !subject.isVisible()) {
                    return scene;
                }

                const entityName = sceneRenderer.getEntityName(subject);
                const sceneEntity = sceneArt[entityName];
                const key = `p${depth}_${index}`;
                const entry = sceneEntity?.positions?.[key] || null;
                if (!entry) {
                    return scene;
                }

                const indexedArt = sceneEntity.art[entry.artIndex] || null;
                if (!indexedArt) {
                    return scene;
                }

                const art = sceneRenderer.formatArt(indexedArt);
                const transparentCharacter = indexedArt.transparentCharacter || null;
                const className = `class="scene_character_${entityName}"`;
                const longestLine = Math.max(...art.split("\n").map((l) => l.length)) - 1;

                const drawOptions = {
                    flippedX: entry?.drawOptions?.flippedX || false,
                };

                let xPosition = entry.drawAt.x + (drawOptions.flippedX ? longestLine : 0);
                let yPosition = entry.drawAt.y;

                for (const character of art) {
                    if (character === "\n") {
                        xPosition = entry.drawAt.x + (drawOptions.flippedX ? longestLine : 0);
                        yPosition++;
                        continue;
                    }

                    // Draw only if in bounds
                    if (typeof scene[yPosition]?.[xPosition] !== 'undefined') {
                        if (character !== transparentCharacter) {
                            const automask =
                                (indexedArt?.automaskBlockCharacters || false) &&
                                [
                                    '▀', '▁', '▂', '▃', '▄', '▅', '▆', '▇', '█',
                                    '▉', '▊', '▋', '▌', '▍', '▎', '▏', '▐', '▔',
                                    '▕', '▖', '▗', '▘', '▙', '▚', '▛', '▜', '▝',
                                    '▞', '▟'
                                ].includes(character);


                            let characterStyle = '';

                            if (sceneEntity.relativeColor) {
                                const entityColor = sceneEntity.relativeColor;
                                // Make the spaces directly in front of the
                                // player fully bright
                                const adjustedDepth = depth - (isCentered ? 1 : 0);

                                const characterColor = {
                                    r: sceneRenderer.getCharacterColor(entityColor.r, adjustedDepth, maxPlayerVisibilityDepth, maxBrightness),
                                    g: sceneRenderer.getCharacterColor(entityColor.g, adjustedDepth, maxPlayerVisibilityDepth, maxBrightness),
                                    b: sceneRenderer.getCharacterColor(entityColor.b, adjustedDepth, maxPlayerVisibilityDepth, maxBrightness),
                                };
                                characterStyle += `color: rgb(${characterColor.r}, ${characterColor.g}, ${characterColor.b}); `;
                            }

                            // TODO: Fix this weird logic. This works best for
                            // walls, but isn't great for floors or much else
                            if (!automask) {
                                characterStyle += 'background-color: #000; ';
                            }
                            if (
                                ['treasureChest', 'healingTile', 'exit'].includes(entityName)
                            ) {
                                // Calculate brightness based on view distance (depth) for the chest, heatile, and exit
                                const adjustedDepth = depth - (isCentered ? 1 : 0);
                                const ratio = Math.max(0, Math.min(1, adjustedDepth / maxPlayerVisibilityDepth));
                                // Exponential falloff, tweak as needed
                                const brightness = 1 - ratio * 0.7;
                                characterStyle += `filter: brightness(${brightness}); `;
                            }

                            const styleHtml = characterStyle !== '' ? ` style="${characterStyle.trim()}"` : '';
                            scene[yPosition][xPosition] =
                                `<span ${className}${styleHtml}>${character}</span>`;
                        }
                    }

                    xPosition += drawOptions.flippedX ? -1 : 1;
                }

                return scene;
            },

            getCharacterColor: (value, depth, maxPlayerVisibilityDepth, maxBrightness = 255) => {
                if (depth <= 0) {
                    return Math.min(value, maxBrightness);
                }

                if (depth >= maxPlayerVisibilityDepth) {
                    return 0;
                }

                const brightnessFalloffRate = 4;
                const ratio = depth / maxPlayerVisibilityDepth;
                const brightnessFactor = Math.exp(-brightnessFalloffRate * ratio);
                const normalizedValue = (value / 255) * maxBrightness;
                const adjustedValue = Math.round(normalizedValue * brightnessFactor);

                return Math.max(0, Math.min(maxBrightness, adjustedValue));
            },

            getEntityName: (entity) => {
                if (entity?.type === 'mimic') {
                    return 'treasureChest';
                }

                return entity?.type || 'void';
            },

            formatArt: (art) => {
                // Trim any whitespace from the template literal
                const formattedArt = art.data.replace(/^ *\n|\n *$/g, '');
                const lines = formattedArt.split("\n");
                // Safely handle lines with no leading spaces
                const shortestLeadingWhitespace = Math.min(
                    ...lines
                        .filter(line => line.trim().length > 0)
                        .map(line => {
                            const match = line.match(/^ +/);
                            return match ? match[0].length : 0;
                        })
                );
                const trimmedArt = lines.map(line => line.substr(shortestLeadingWhitespace)).join("\n");

                return (
                    typeof art.spaceBoundaryCharacter !== 'undefined'
                        ? trimmedArt.replaceAll(art.spaceBoundaryCharacter, ' ')
                        : trimmedArt
                );
            },

            drawEnemyLayer: (enemyId) => {
                const indexedArt = window.ENEMY_ART[enemyId] || null;
                if (!indexedArt) {
                    console.error("Could not find enemy art entry", { enemyId });
                    return null;
                }

                let art = sceneRenderer.formatArt(indexedArt);

                // Apply horizontal offset if specified
                if (indexedArt.offsetX) {
                    art = art
                        .split('\n')
                        .map(line => ' '.repeat(indexedArt.offsetX) + line)
                        .join('\n');
                }

                // Apply vertical offset if specified
                if (indexedArt.offsetY) {
                    art = '\n'.repeat(indexedArt.offsetY) + art;
                }

                return `<div class="layer enemy">
                    <pre>${art}</pre>
                </div>`;
            },

            drawHealingLayer: () => '<div class="layer healing"></div>',
        };

        const GameControl = {
            mode: null,
            enabled: true,
            awaitingPersuasionText: false,

            enableControls: () => {
                GameControl.enabled = true;
                GameControl.update();
            },

            disableControls: () => {
                GameControl.enabled = false;
                GameControl.update();
            },

            updateMode: () => {
                const skipModeUpdate =
                    ( GameControl.mode === "menu" && menu.isOpen()) ||
                    ! menu.isOpen() && (
                        ( GameControl.mode === "navigation" && !player.inCombat ) ||
                        ( GameControl.mode === "combat" && player.inCombat )
                    );

                if (skipModeUpdate) {
                    return;
                }

                GameControl.mode = menu.isOpen()
                    ? "menu"
                    : (player.inCombat ? "combat" : "navigation");

                // Update the displayed buttons based on the mode
                document.querySelectorAll(`
                    #playerInput .section.navigation,
                    #mouseControl .navigation
                `).forEach($element => {
                    $element.classList.toggle(
                        "hidden",
                        GameControl.mode !== "navigation"
                    );
                });

                document.querySelectorAll(`
                    #playerInput .section.battle,
                    #mouseControl .combat
                `).forEach($element => {
                    $element.classList.toggle(
                        "hidden",
                        GameControl.mode !== "combat"
                    );
                });

                document.querySelectorAll(`
                    #playerInput .section.menu
                `).forEach($element => {
                    $element.classList.toggle(
                        "hidden",
                        GameControl.mode !== "menu"
                    );
                });

                // Update the keyboard control display based on the mode
                const $controlsExploration =
                    document.getElementById("controlsExploration");
                const $controlsCombat =
                    document.getElementById("controlsCombat");
                const $controlsMenu =
                    document.getElementById("controlsMenu");

                if (GameControl.mode === "menu") {
                    $controlsMenu.classList.remove("hidden");
                    $controlsExploration.classList.add("hidden");
                    $controlsCombat.classList.add("hidden");
                } else if (GameControl.mode === "combat") {
                    if (!GameControl.awaitingPersuasionText) {
                        $controlsCombat.classList.remove("hidden");
                        $controlsExploration.classList.add("hidden");
                        $controlsMenu.classList.add("hidden");
                    }
                } else {
                    $controlsExploration.classList.remove("hidden");
                    $controlsCombat.classList.add("hidden");
                    $controlsMenu.classList.add("hidden");
                }
            },

            update: () => {
                GameControl.updateMode();

                switch (GameControl.mode) {
                    case "navigation":
                        GameControl.updateNavigationControls();
                        break;
                    case "menu":
                        GameControl.updateMenuControls();
                        break;
                    case "combat":
                        GameControl.updateCombatControls();
                        break;
                    default:
                        console.error(
                            "Unknown GameControl mode",
                            { mode: GameControl.mode }
                        );
                        break;
                }
            },

            updateNavigationControls: () => {
                const $playerInput = document.getElementById("playerInput");
                const $mouseControl = document.getElementById("mouseControl");

                // Move Forward
                const frontX = player.x + DX[player.dir];
                const frontY = player.y + DY[player.dir];
                const cellInFrontOfPlayer = MAP.getCell(frontX, frontY);
                const controlsEnabled =
                    GameControl.enabled &&
                    !player.movementDisabled;
                const touchEnabled =
                    controlsEnabled &&
                    typeof cellInFrontOfPlayer?.onTouch === "function";
                const moveForwardEnabled =
                    controlsEnabled &&
                    !touchEnabled &&
                    cellInFrontOfPlayer?.isSolid === false;

                // No "Touch" or "Interact" on the button menu yet since
                // it's the same as moving forward anyways
                if (moveForwardEnabled) {
                    $playerInput.querySelector('[name="forward"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="forward"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".touch")?.classList
                    .toggle("hidden", !touchEnabled);
                $mouseControl.querySelector(".forward")?.classList
                    .toggle("hidden", !moveForwardEnabled);

                // Move Left
                const leftX = player.x + DX[(player.dir + 3) % 4];
                const leftY = player.y + DY[(player.dir + 3) % 4];
                const cellLeftOfPlayer = MAP.getCell(leftX, leftY);
                const strafeLeftEnabled =
                    controlsEnabled &&
                    cellLeftOfPlayer?.isSolid === false;
                if (strafeLeftEnabled) {
                    $playerInput.querySelector('[name="strafe-left"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="strafe-left"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".strafe-left")?.classList
                    .toggle("hidden", !strafeLeftEnabled);

                // Move Right
                const rightX = player.x + DX[(player.dir + 1) % 4];
                const rightY = player.y + DY[(player.dir + 1) % 4];
                const cellRightOfPlayer = MAP.getCell(rightX, rightY);
                const strafeRightEnabled =
                    controlsEnabled &&
                    cellRightOfPlayer?.isSolid === false;
                if (strafeRightEnabled) {
                    $playerInput.querySelector('[name="strafe-right"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="strafe-right"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".strafe-right")?.classList
                    .toggle("hidden", !strafeRightEnabled);

                // Move Backward
                const backX = player.x - DX[player.dir];
                const backY = player.y - DY[player.dir];
                const cellBehindPlayer = MAP.getCell(backX, backY);
                const moveBackwardEnabled =
                    controlsEnabled &&
                    cellBehindPlayer?.isSolid === false;
                if (moveBackwardEnabled) {
                    $playerInput.querySelector('[name="backward"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="backward"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".backward")?.classList
                    .toggle("hidden", !moveBackwardEnabled);

                // Turn Left and Right
                $playerInput
                    .querySelectorAll('[name="turn-left"], [name="turn-right"]')
                    .forEach(($button) => controlsEnabled
                        ? $button.removeAttribute("disabled")
                        : $button.setAttribute("disabled", "true")
                );
            },

            updateMenuControls: () => {
                const pagination = menu.getPagination();

                document
                    .querySelectorAll('#playerInput .section.menu [name]')
                    .forEach(($button) => {
                        let enabled = true;
                        switch ($button.getAttribute('name')) {
                            case "up":
                            case "down":
                                enabled = pagination.itemsOnCurrentPage > 1;
                                break;
                            case "previous-page":
                                enabled = pagination.hasPreviousPage;
                                break;
                            case "next-page":
                                enabled = pagination.hasNextPage;
                                break;
                        }

                        GameControl.enabled && enabled
                            ? $button.removeAttribute("disabled")
                            : $button.setAttribute("disabled", "true");
                    });
            },

            updateCombatControls: () => {
                const hasPersuasionAttempts =
                    persuasionAttempts < getEffectiveStat('persuasionAttempts');

                document
                    .querySelectorAll('#playerInput .section.battle [name]')
                    .forEach(($button) => {
                        const enabled =
                            GameControl.enabled && (
                                $button.getAttribute('name') !== "persuade" ||
                                hasPersuasionAttempts
                            );

                        enabled
                            ? $button.removeAttribute("disabled")
                            : $button.setAttribute("disabled", "true");
                    });
            },

            openPersuasionInputBox: () => {
                GameControl.awaitingPersuasionText = true;
                GameControl.disableControls();
                const $inputBox = document.getElementById("inputBox");
                const $input = document.getElementById("persuadeInput");
                $inputBox.style.display = "flex";
                $input.value = "";

                // Delay the focus to ensure it's applied after rendering
                setTimeout(() => $input.focus(), 10);
            },

            closePersuasionInputBox: () => {
                document.getElementById("inputBox").style.display = "none";
                setTimeout(() => {
                    GameControl.awaitingPersuasionText = false;
                    GameControl.enableControls();
                }, 200);
            },
        };

        const
            WIDTH = 30,
            HEIGHT = 11;
        const DIRECTIONS = ['N', 'E', 'S', 'W'];
        const DX = [0, 1, 0, -1];
        const DY = [-1, 0, 1, 0];
        let lastFloorBoostNotice = 0;

        const baseStats = {
            maxHp: 20,
            defense: 5,
            strength: 1,
            persuasion: 15,
            endurance: 0,
            speed: 12,
            luck: 17,
        };
        const player = {
            x: 1,
            y: 1,
            bitcoins: 0,
            dir: 0,
            hp: baseStats.maxHp,
            maxHp: baseStats.maxHp,
            defense: baseStats.defense,
            strength: baseStats.strength,
            persuasion: baseStats.persuasion,
            endurance: baseStats.endurance,
            speed: baseStats.speed,
            luck: baseStats.luck,
            exp: 0,
            level: 1,
            inCombat: false,
            isHoldingTorch: false,
            enteringCombat: false,
            leavingCombat: false,
            steppingOnHealingTile: false,
            inventory: {
                canOfHamms: 2,
                cupOfLean: 2,
                torch: 2,
                brickOfC4: 2,
                dowsingRod: 2,
                fingerNail: 1, //Start game with this in inventory
                pectoralMass: 1, //Start game with this in inventory
            },
            weapon: 'fingerNail', //Start game with this equipped
            armor: 'pectoralMass', //Start game with this equipped
            ring1: null,
            ring2: null,
            movementDisabled: false,
            getDisplayCharacter: () => ["↑", "→", "↓", "←"][player.dir] || "?",
            say: function(str) {
                const message = str.trim();
                if (message) {
                    updateBattleLog(`<span class="player">&lt;YOU&gt;</span> "${message}"`);
                    return;
                }

                if (Math.random() < 0.25) {
                    player.say("DUHHH BUH BUH DURRRR I AM A BIG FAT DUMB MORON BUUUUHHHHH");
                    return;
                }

                updateBattleLog(randomEntry([
                    "With glassy eyes and a slack jaw, you vacantly stare " +
                        "off into the distance",
                    "Shh... listen. <em>The wind!</em>",
                    "This message was intentionally left blank",
                ]));
            },
            // Resets event flags that are used during rendering. Called after every render
            resetEventFlags: () => {
                player.enteringCombat = false;
                player.leavingCombat = false;
                player.steppingOnHealingTile = false;
            },
            enterCombat: () => {
                persuasionAttempts = 0;
                maxPersuasionAttempts = player.hasEquippedRing('ringOfAmplifiedAudio') ? 3 : 2;
                player.enteringCombat = true;
                player.inCombat = true;
                player.party.prepareForBattle();
                GameControl.update();
            },
            leaveCombat: () => {
                player.leavingCombat = true;
                player.inCombat = false;
                currentEnemy = null;
                resumeExplorationMusic();
                player.party.purgeDeadMembers();
                GameControl.update();
            },
            heal: (hp) => {
                player.hp = Math.min(getEffectiveStat('maxHp'), player.hp + hp);
                player.refreshStats();
                player.checkForDeath();
            },
            damage: (hp) => {
                player.hp = Math.max(player.hp - hp, 0);
                player.refreshStats();
                player.checkForDeath();
            },
            setHp: (hp) => {
                player.hp = hp;
                player.refreshStats();
                player.checkForDeath();
            },
            checkForDeath: () => {
                if (player.hp <= 0) {
                    GameControl.disableControls();
                    gameOver = true;
                }
            },
            getEffectiveStats: () => {
                const equippedArmor = armor[player.armor];
                const equippedRing1 = player.ring1 ? rings[player.ring1] : null;
                const equippedRing2 = player.ring2 ? rings[player.ring2] : null;

                function getRingEffect(stat) {
                    return (equippedRing1?.effects?.[stat] || 0) + (equippedRing2?.effects?.[stat] || 0);
                }

                return {
                    hp: player.hp,
                    maxHp: player.maxHp + getRingEffect('maxHp'),
                    defense:
                        player.defense +
                        (equippedArmor ? equippedArmor.defense : 0) +
                        getRingEffect('defense'),
                    strength: player.strength,
                    persuasion: getEffectiveStat('persuasion'),
                    speed: player.speed + getRingEffect('speed'),
                    luck: player.luck + getRingEffect('luck'),
                    endurance: player.endurance,
                    carryWeight: player.getCarryWeight(),
                    carryWeightLimit: player.getCarryWeightLimit(),
                };
            },
            refreshStats: () => {
                const stats = player.getEffectiveStats();

                const $hp = document.getElementById('statHp');
                $hp.setAttribute('value', stats.hp);
                $hp.setAttribute('max', stats.maxHp);

                const $exp = document.getElementById('statExp');
                $exp.setAttribute('value', player.exp);
                $exp.setAttribute('max', player.getExpRequiredForLevelUp());

                const $load = document.getElementById('statLoad');
                $load.setAttribute('value', stats.carryWeight.toFixed(1));
                $load.setAttribute('max', stats.carryWeightLimit.toFixed(1));

                const $strength = document.getElementById('statStrength');
                $strength.innerText = stats.strength;

                const $defense = document.getElementById('statDefense');
                $defense.innerText = stats.defense;

                const $persuasion = document.getElementById('statPersuasion');
                $persuasion.innerText = stats.persuasion;

                const $endurance = document.getElementById('statEndurance');
                $endurance.innerText = stats.endurance;

                const $speed = document.getElementById('statSpeed');
                $speed.innerText = stats.speed;

                const $luck = document.getElementById('statLuck');
                $luck.innerText = stats.luck;

                player.party.refresh();
            },
            equipRing: (slotNumber, ringId) => {
                if (![1, 2].includes(slotNumber)) {
                    console.error("Ring slot number is out of range", { slotNumber });
                    return false;
                }

                // Prevent equipping the same ring in both slots
                const ringIsAlreadyEquippedOnOppositeHand =
                    ringId && (
                        (slotNumber === 1 && ringId === player.ring2) ||
                        (slotNumber === 2 && ringId === player.ring1)
                    );

                if (ringIsAlreadyEquippedOnOppositeHand) {
                    updateBattleLog("You can't equip the same ring in both slots!");
                    return false;
                }

                if (slotNumber === 1) {
                    player.ring1 = ringId || null;
                } else if (slotNumber === 2) {
                    player.ring2 = ringId || null;
                }

                const ringDisplayName = rings[ringId]?.name || "no ring";
                updateBattleLog(
                    `You equipped <span class="friendly">${ringDisplayName}` +
                    `</span> in Ring ${slotNumber} slot.`
                );
                if (player.hp > getEffectiveStat('maxHp')) {
                    player.hp = getEffectiveStat('maxHp');
                }

                const $game = document.getElementById('game');
                if (player.hasEquippedRing('ringOfSightliness')) {
                    $game.classList.add('sightliness');
                } else {
                    $game.classList.remove('sightliness');
                }

                return true;
            },
            hasEquippedRing: (ringId) => [player.ring1, player.ring2].includes(ringId),
            getViewDepth: () => {
                if (player.hasEquippedRing('ringOfSightliness')) {
                    return 5;
                }

                if (player.isHoldingTorch) {
                    return 3;
                }

                return 2;
            },
            getMaxBrightness: () =>
                player.hasEquippedRing('ringOfSightliness') || player.isHoldingTorch
                    ? 255
                    : 192,
            getExpRequiredForLevelUp: () => player.level * 10,
            levelUp: () => {
                const rolledOverExp = Math.max(0, player.exp - player.getExpRequiredForLevelUp());
                player.level++;
                player.exp = rolledOverExp;
                player.hp = getEffectiveStat('maxHp');
                document.getElementById('playerLevel').innerText = player.level;
            },
            getCarryWeight: () => {
                let total = 0;

                // 1. Consumables
                for (const itemId in player.inventory) {
                    if (weapons[itemId] || armor[itemId] || rings[itemId]) {
                        continue;
                    }

                    const item = items[itemId];
                    if (typeof item?.weight === "number") {
                        total += item.weight * player.inventory[itemId];
                    }
                }

                // 2. Weapons
                for (const weaponId in weapons) {
                    let count = player.inventory[weaponId] || 0;
                    if (player.weapon === weaponId && count === 0) {
                        count = 1;
                    }
                    total += weapons[weaponId].weight * count;
                }

                // 3. Armor
                for (const armorId in armor) {
                    let count = player.inventory[armorId] || 0;
                    if (player.armor === armorId && count === 0) {
                        count = 1;
                    }
                    total += armor[armorId].weight * count;
                }

                // 4. Rings
                for (const ringId in rings) {
                    let count = player.inventory[ringId] || 0;
                    if (player.ring1 === ringId && count === 0) {
                        count += 1;
                    }
                    if (player.ring2 === ringId && count === 0 && player.ring1 !== ringId) {
                        count += 1;
                    }
                    total += rings[ringId].weight * count;
                }

                return total;
            },
            getCarryWeightLimit: () => {
                // Example: 35 base + 0.6 per END point
                return 35 + (player.endurance * 0.4);
            },
            // Returns "normal", "warning", or "danger" depending on load
            getWeightLevel: () => {
                const percentage =
                    player.getCarryWeight() / player.getCarryWeightLimit();

                return percentage < 0.5
                    ? "normal"
                    : (percentage < 0.8 ? "warning" : "danger");
            },
            fallThroughFloorAndDie: () => {
                setTimeout(() => {
                    stopAllMusic();
                    animTorchEnd();
                    Portrait.show('death');
                    window._inputBlocked = true;
                    document.getElementById('game').style =
                        "transition: opacity 1.2s linear, transform 1.2s linear; " +
                        "opacity: 0; transform: translateY(-400px);";
                    document.getElementById('viewport')
                        .classList.add('playerFellIntoAPitAndDied');
                    updateBattleLog(
                        '<span class="action">AUUUUUGH!</span> You scream out as ' +
                        'the flimsy floor collapses beneath your feet and you ' +
                        'plunge into a pit of spikes waiting beneath!'
                    );
                    playSFX('floorBreakScreamDie');
                    player.damage(player.maxHp);
                    setTimeout(() => render(), 2000);
                }, 100);
            },
            giveBitcoins: (num) => {
                player.bitcoins += num;
                player.refreshBitcoins();
            },
            takeBitcoins: (num) => {
                player.bitcoins -= num;
                player.refreshBitcoins();
            },
            refreshBitcoins: () => {
                const $playerBitcoins = document.getElementById('playerBitcoins');
                $playerBitcoins.innerText = player.bitcoins.toLocaleString(undefined);
            },

            // Party members
            party: {
                maxMembers: 3,
                seenMembers: 0,
                members: [],
                isFull: () =>
                    player.party.members.length >= player.party.maxMembers,
                add: (enemyId, name, hp, maxHp) => {
                    const partyMemberId = player.party.seenMembers;

                    player.party.members.push({
                        id: partyMemberId,
                        enemyId,
                        name,
                        hp,
                        maxHp,
                        healedThisBattle: false,
                    });

                    const $partyMember = document.createElement('div');
                    $partyMember.classList.add('party-member');
                    $partyMember.setAttribute(
                        'data-partyMemberId',
                        partyMemberId
                    );

                    const $allyName = document.createElement('div');
                    $allyName.classList.add('name');
                    $allyName.innerText = name;
                    $partyMember.appendChild($allyName);

                    const $info = document.createElement('div');
                    $info.classList.add('info');

                    const $healthBar = document.createElement('progress-bar');
                    $healthBar.classList.add('health-bar');
                    $healthBar.setAttribute('height', 20);
                    $healthBar.setAttribute('value', hp);
                    $healthBar.setAttribute('max', maxHp);
                    $healthBar.setAttribute('cautionBelowPercentage', 26);
                    $healthBar.setAttribute('dangerBelowPercentage', 11);

                    $info.appendChild($healthBar);

                    const $talkButton = document.createElement('button');
                    $talkButton.classList.add('talk');
                    $talkButton.innerText = 'Talk';
                    $talkButton.onclick = () => player.party.talk(partyMemberId);
                    $info.appendChild($talkButton);

                    const $releaseButton = document.createElement('button');
                    $releaseButton.classList.add('release');
                    $releaseButton.innerText = 'Release';
                    $releaseButton.onclick = () => player.party.release(partyMemberId);
                    $info.appendChild($releaseButton);

                    $partyMember.appendChild($info);

                    document.getElementById('partyMembers').appendChild($partyMember);

                    player.party.seenMembers++;
                },
                refresh: () => {
                    for (let i=0; i<player.party.members.length; i++) {
                        const partyMember = player.party.members[i];
                        const selector =
                            `#partyMembers [data-partyMemberId="${partyMember.id}"]`;

                        const $partyMember = document.querySelector(selector);
                        if (!$partyMember) {
                            console.error(
                                "Could not find party member's element",
                                { partyMember }
                            );
                            continue;
                        }

                        if (partyMember.hp <= 0) {
                            $partyMember.querySelector('.name')
                                .classList.add('strikethrough');
                            player.party.disableButtons(partyMember.id);
                        }

                        const $healthBar = $partyMember
                            .querySelector(`progress-bar.health-bar`);
                        $healthBar.setAttribute('value', partyMember.hp);
                    }

                    player.party.refreshPartyCount();
                },
                purgeDeadMembers: () => {
                    const aliveMembers = [];
                    for (let i=0; i<player.party.members.length; i++) {
                        const partyMember = player.party.members[i];

                        if (partyMember.hp > 0) {
                            aliveMembers.push(partyMember);
                            continue;
                        }

                        const id = partyMember.id;
                        const selector =
                            `#partyMembers [data-partyMemberId="${id}"]`;

                        const $partyMember = document.querySelector(selector);
                        $partyMember.classList.add('sweepItUp');

                        $partyMember.addEventListener('transitionend', function onTransitionEnd(e) {
                            if (e.propertyName === 'height') {
                                $partyMember.removeEventListener('transitionend', onTransitionEnd);
                                $partyMember.remove();
                            }
                        });
                    }

                    player.party.members = aliveMembers;
                    player.party.refreshPartyCount();
                },
                talk: (partyMemberId) => {
                    const responder = partyMemberId === undefined
                        ? randomEntry(player.party.members)
                        : player.party.members.find((e) => e.id === partyMemberId );

                    if (!responder) {
                        console.warn("Party member not found", {
                            partyMembers: player.party.members,
                            partyMemberId,
                        });
                        return;
                    }

                    if (responder.hp <= 0) {
                        updateBattleLog(`${responder.name} is dead, bub`);
                        return;
                    }

                    const enemyDefinition = enemies.find(e => e.id === responder.enemyId);
                    const talkSlots = enemyDefinition?.talkSlots || [
                        ["You", "I", "What", "Hey", "Listen here, you", "They", "He", "She"],
                        ["are", "can't", "should", "will", "must", "need to", "need", "needs", "needed"],
                        ["go", "find a", "smack a", "kill the", "eat a", "snack on a", "pick my", "pick your", "obey my", "obey your"],
                        ["pot roast", "many pot roasts", "total dumbass", "gay", "friend", "sandwich", "nose", "orbital laser", "Burnout Revenge on the PS2", "one big dandruff"],
                        ["?", "!", "!!!", "?!", "...", ".",]
                    ];

                    // Sentence assembly - also removes the space before the punctuation slot
                    const chosen = talkSlots.map(slot => randomEntry(slot));
                    const sentence =
                        chosen.length > 1
                            ? chosen.slice(0, -1).join(" ") + chosen[chosen.length - 1]
                            : chosen[0];

                    updateBattleLog(
                        `<span class="friendly">&lt;${responder.name}&gt;</span> ` +
                        `<span class="player">--you pull out your translator--</span> ` +
                        `"${sentence}"`
                    );

                    player.party.disableButtons();

                    SpeechSynthesizer.speak(
                        sentence,
                        enemyDefinition.voice,
                        () => player.party.enableButtons()
                    );
                },
                disableButtons: (partyMemberId) => {
                    const $container = document.getElementById("partyMembers");
                    const selector =
                        (typeof partyMemberId === "number"
                            ? `[data-partyMemberId="${partyMemberId}"] `
                            : ""
                        ) + "button";

                    $container.querySelectorAll(selector).forEach(
                        (button) => button.disabled = true
                    );
                },
                enableButtons: () => {
                    const $container = document.getElementById("partyMembers");

                    for (let i=0; i<player.party.members.length; i++) {
                        const partyMember = player.party.members[i];
                        if (partyMember.hp <= 0) {
                            continue;
                        }

                        const selector =
                            `[data-partyMemberId="${partyMember.id}"] button`;
                        $container.querySelectorAll(selector).forEach(
                            (button) => button.disabled = false
                        );
                    }
                },
                release: (partyMemberId) => {
                    // @TODO: Make a confirmation prompt before releasing
                    const partyMember = player.party.members.find((e) => e.id === partyMemberId);
                    if (!partyMember) {
                        console.error("Party member not found", { partyMemberId });
                        return;
                    }

                    updateBattleLog(
                        `You booted <span class="friendly">` +
                        `${partyMember.name}</span> to the curb. ` +
                        `<span class="action">SEE YA!</span>`
                    );
                    player.party.members = player.party.members.filter((e) => e.id !== partyMemberId);
                    document.querySelector(`#partyMembers [data-partyMemberId="${partyMemberId}"]`).remove();
                    player.party.refreshPartyCount();
                },
                refreshPartyCount: () => {
                    document.getElementById("totalPartyMembers").innerText =
                        player.party.members.length.toLocaleString(undefined);
                    document.getElementById("maxPartyMembers").innerText =
                        player.party.maxMembers.toLocaleString(undefined);
                },
                get: () => player.party.members.filter((e) => e.hp > 0),
                prepareForBattle: () => player.party.members
                    .forEach(member => member.healedThisBattle = false),
            },
        };

        const merchant = {
            isAlive: true,
            isActiveOnFloor: false,
            items: [],
            voice: {
                pitch: 48,
                speed: 45,
                mouth: 163,
                throat: 160,
            },
            say: function(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, merchant.voice);
                }
                updateBattleLog(`<span class="merchant">&lt;MERCHANT&gt;</span> "${str}"`);
            },
            isAt: function(x, y) {
                return (
                    merchant.isAlive &&
                    merchant.isActiveOnFloor &&
                    MAP.getCell(x, y)?.type === 'merchant'
                );
            },
            location: function() {
                return merchant.isAlive && merchant.isActiveOnFloor
                    ? MAP.locate("merchant")
                    : null;
            },
            buy: function(type, key) {
                const merchandise = merchant.getMerchandiseCollection(type)?.[key];
                if (!merchandise) {
                    console.error(`${key} doesn't exist!`);
                    return;
                }

                if (player.bitcoins < merchandise.price) {
                    merchant.say('Too bad, kid. Come back when you get some coin!');
                    return;
                }

                // Prevent buying equipment you already own
                const alreadyOwnedEquipment = type !== 'item' && (player.inventory[key] > 0 || player[type] === key);
                const alreadyOwnedRing = type === 'ring' && player.hasEquippedRing(key);
                const alreadyOwned = alreadyOwnedEquipment || alreadyOwnedRing;
                if (alreadyOwned) {
                    merchant.say("You already own that, stupid!");
                    return;
                }

                player.takeBitcoins(merchandise.price);
                playSFX('kaching');
                // Disable equipment auto equip upon purchase
                player.inventory[key] = (player.inventory?.[key] || 0) + 1;

                merchant.say(randomEntry([
                    "HAHA! You won't regret it!",
                    "Don't forget: NO REFUNDS!",
                    "You won't find a better deal than this!",
                ]));

                merchant.printTransactionMessage('bought', merchandise, merchandise.price);
                render();
            },
            getMerchandiseCollection: function(category) {
                switch (category) {
                    case 'item': return items;
                    case 'weapon': return weapons;
                    case 'armor': return armor;
                    case 'ring': return rings;
                    default:
                        console.error("Unknown merchanidse category", { category });
                        return {};
                }
            },
            set: function () {
                merchant.setWares();
                merchant.setPosition();
            },
            setWares: function(hasEverythingInStock = false) {
                const itemKeys = Object.keys(items);
                const ringKeys = Object.keys(rings);

                if (itemKeys.length === 0) {
                    console.error("No items available in the items object!");
                    return;
                }

                if (ringKeys.length === 0) {
                    console.error("No rings available in the rings object!");
                    return;
                }

                let attempts = 0;
                do {
                    merchant.items = [];
                    merchant.rings = [];

                    itemKeys.forEach((key) => {
                        if (hasEverythingInStock || Math.random() < (items[key].merchantStockChance || 0)) {
                            merchant.items.push(key);
                        }
                    });

                    ringKeys.forEach((key) => {
                        if (hasEverythingInStock || Math.random() < (rings[key].merchantStockChance || 0)) {
                            merchant.rings.push(key);
                        }
                    });

                    attempts++;
                    if (attempts > 100) {
                        console.error(
                            `Failed to generate merchant items after ` +
                            `${attempts} attempts!`
                        );
                        break;
                    }
                } while (merchant.items.length === 0 || merchant.rings.length === 0);
            },

            setPosition: function() {
                const points =
                    shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];

                if (points) {
                    MAP.setCell(points.x, points.y, "merchant");
                }
            },

            getSalePrice: function(itemType, price) {
                if (typeof price !== 'number') {
                    console.error("Price is not a number", { itemType, price });
                    return 0;
                }
                const factors = {
                    weapon: 10,
                    armor: 10,
                    item: 5,
                    ring: 5,
                };
                const factor = factors[itemType] || 10; // Default to 10% of the original price
                if (!Object.hasOwn(factors, itemType)) {
                    console.error("Unknown item type", { itemType });
                }
                return Math.max(1, Math.floor(price / factor));
            },

            printTransactionMessage: function(transactionType, merchandise, priceBtc) {
                if (!['bought', 'sold'].includes(transactionType)) {
                    console.error(
                        'Unknown transaction type', {
                            transactionType,
                            merchandise,
                            priceBtc
                        }
                    );
                    return;
                }

                // Add a space if an article is present
                const article =
                    merchandise?.article ? `${merchandise.article} ` : '';

                const message =
                    `You ${transactionType} ${article}` +
                    `<span class="friendly">${merchandise.name}</span> for ` +
                    `<span class="BTC">${priceBtc} BTC</span>.`;
                updateBattleLog(message);
            },
        };

        const gambler = {
            isAlive: true,
            isActiveOnFloor: false,
            selectionIndex: 0,
            options: ['gamble', 'leave'],
            playPrice: 200,
            voice: {
                pitch: 26,
                speed: 55,
                mouth: 162,
                throat: 255,
            },
            say: function(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, gambler.voice);
                }
                updateBattleLog(`<span class="gambler">&lt;GAMBLER&gt;</span> "${str}"`);
            },
            isAt: function(x, y) {
                return (
                    gambler.isAlive &&
                    gambler.isActiveOnFloor &&
                    player.bitcoins >= gambler.playPrice &&
                    MAP.getCell(x, y)?.type === 'gambler'
                );
            },
            location: function() {
                if (!gambler.isAlive || !gambler.isActiveOnFloor || player.bitcoins < gambler.playPrice) {
                    return null;
                }

                return MAP.locate("gambler");
            },
            set: function() {
                const points =
                    shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];

                if (points) {
                    MAP.setCell(points.x, points.y, "gambler");
                }
            }
        };

        const enemies = [
            {
                id: "snailSentinel",
                name: "SNAIL SENTINEL",
                hp: 13,
                attack: [2, 5],
                bitcoins: 4,
                talkSlots: [
                    ["Sss...", "Hrk!", "Glorp", "Snail", "Halt!", "Beware"],
                    ["you", "I", "we", "that guy", "snail", "he", "she", "it", "has"],
                    ["am", "is", "are", "was", "snail", "violated", "trespassing", "guarding"],
                    ["slimy", "slow", "fast", "hungry", "snail", "the law", "Judge Joody", "my antennae", "the shell"],
                    ["?", "!", "!!!", "?!", "...", ".",]
                ],
                voice: {
                    pitch: 38,
                    speed: 153,
                    mouth: 213,
                    throat: 163,
                },
            },
            {
                id: "stupidDog",
                name: "STUPID DOG",
                hp: 9,
                attack: [3, 6],
                bitcoins: 3,
                voice: {
                    pitch: 125,
                    speed: 86,
                    mouth: 165,
                    throat: 102,
                },
            },
            {
                id: "wangRat",
                name: "WANG RAT",
                hp: 8,
                attack: [4, 6],
                bitcoins: 2,
                voice: {
                    pitch: 80,
                    speed: 94,
                    mouth: 152,
                    throat: 188,
                },
            },
            {
                id: "keeperOfTheToiletBowl",
                name: "KEEPER OF THE TOILET BOWL",
                hp: 25,
                attack: [8, 14],
                bitcoins: 5,
                voice: {
                    pitch: 95,
                    speed: 66,
                    mouth: 102,
                    throat: 119,
                },
            },
            {
                id: "mysteriousScooter",
                name: "MYSTERIOUS SCOOTER",
                hp: 17,
                attack: [4, 7],
                bitcoins: 4,
                voice: {
                    pitch: 33,
                    speed: 92,
                    mouth: 70,
                    throat: 105,
                },
            },
            {
                id: "badassFlamingSkeleton",
                name: "BADASS FLAMING SKELETON",
                hp: 23,
                attack: [9, 16],
                bitcoins: 4,
                voice: {
                    pitch: 225,
                    speed: 93,
                    mouth: 148,
                    throat: 111,
                },
            },
            {
                id: "fridgeOfForgottenLeftovers",
                name: "FRIDGE OF FORGOTTEN LEFTOVERS",
                hp: 27,
                attack: [8, 14],
                bitcoins: 3,
                voice: {
                    pitch: 174,
                    speed: 116,
                    mouth: 86,
                    throat: 146,
                },
            },
            {
                id: "lughead",
                name: "LUGHEAD",
                hp: 28,
                attack: [8, 13],
                bitcoins: 4,
                talkSlots: [
                    ["Ugh", "LUG", "Arrgh", "UNG", "Borf", "AHHHHHHH", "Bunginga"],
                    ["smash", "eat", "touch", "rip", "grab", "friend", "befriend", "love", "rock", "dance", "pull teeth", "over there"],
                    ["now", "later", "soon", "maybe", "never", "happy", "punch", "kill", "death", "Phillips CD-i", "Bubsy 3D"],
                    ["?", "!", "!!!", "?!", "...", ".",]
                ],
                voice: {
                    pitch: 110,
                    speed: 127,
                    mouth: 99,
                    throat: 82,
                },
            },
            {
                id: "pissedOffPoultry",
                name: "PISSED-OFF POULTRY",
                hp: 15,
                attack: [4, 7],
                bitcoins: 2,
                voice: {
                    pitch: 42,
                    speed: 79,
                    mouth: 128,
                    throat: 92,
                },
            },
            {
                id: "krampusElf",
                name: "KRAMPUS ELF",
                hp: 14,
                attack: [4, 6],
                bitcoins: 4,
                voice: {
                    pitch: 36,
                    speed: 79,
                    mouth: 255,
                    throat: 194,
                },
            },
            {
                id: "mimic",
                name: "MIMIC",
                hp: 140,
                attack: [10, 16],
                bitcoins: 100,
                voice: {
                    pitch: 142,
                    speed: 80,
                    mouth: 132,
                    throat: 170,
                },
            },
        ];

        const items = {
            canOfHamms: {
                article: 'a',
                name: "CAN OF HAMM'S",
                description: "A warm can of beer. Delicious..? +1 LOAD, +5 HP",
                use: () => {
                    player.heal(5);
                    updateBattleLog("You chug the can, filling your mouth with the flavor of boiled socks. +5 HP");
                },
                merchantStockChance: 0.9,
                weight: 1,
                price: 10,
            },
            cupOfLean: {
                article: 'a',
                name: "CUP OF LEAN",
                description: "A crusty styrofoam cup filled with a strange purple syrup. +1.2 LOAD, +20 HP",
                use: () => {
                    player.heal(20);
                    updateBattleLog("Your stomach feels nauseous, but your head feels great! +20 HP");
                },
                merchantStockChance: 0.5,
                weight: 1.2,
                price: 30,
            },
            glassOfToiletWater: {
                article: 'a',
                name: "GLASS OF TOILET WATER",
                description: "A glass filled to the rim with toilet water, extracted from the toilet bowl belonging to a Keeper. The glass has a rather badass sticker of a skeleton riding a motorcycle neatly applied...  +1.2 LOAD, +50 HP",
                use: () => {
                    player.heal(50);
                    updateBattleLog("Sickeningly delicious...? You question your current state of mind for a moment. +50 HP");
                },
                merchantStockChance: .4,
                weight: 1.2,
                price: 50,
            },
            alaskaRaisins: {
                article: 'some',
                name: "ALASKA RAISINS",
                description: "Holy shit! It's the Alaska Raisins! +1.5 LOAD, +70 HP",
                use: () => {
                    player.heal(70);
                    playSFX('raisins');
                    updateBattleLog("The Alaska Raisins sing a lovely song about how epic igloos are as you pop them into your mouth one by one. You can still hear them singing in your stomach... +70 HP");
                },
                merchantStockChance: .35,
                weight: 1.5,
                price: 80,
            },
            dowsingRod: {
                article: 'a',
                name: "DOWSING ROD",
                description: "A Y-shaped stick. Reveals the exit of the current floor. +1.7 LOAD",
                use: () => {
                    const location = MAP.locate("exit");
                    if (!location) {
                        console.error("No exit exists on this map!");
                        return;
                    }

                    MAP.revealSpot(location.x, location.y, 1);
                    updateBattleLog("The exit has been revealed!");
                },
                merchantStockChance: 0.8,
                weight: 1.7,
                price: 20,
            },
            torch: {
                article: 'a',
                name: "TORCH",
                description: "An unlit torch. Using it will reveal the map of the current floor. +1.2 LOAD",
                use: () => {
                    if (player.isHoldingTorch) {
                        updateBattleLog("Uh, do you not SEE the torch that you are already holding?");
                        return;
                    }
                    playSFX('torch');
                    MAP.reveal();
                    updateBattleLog("Lo, the way has been made clear!");
                    animTorchStart();
                    render();
                },
                merchantStockChance: 0.8,
                weight: 1.2,
                price: 60,
            },
            brickOfC4: {
                article: 'a',
                name: "BRICK OF C-4",
                description: "An incendiary plastic explosive. Great for turning anything into nothing real quick! +3 LOAD",
                use: () => {
                    setTimeout(() => playSFX('explosion'), 50);
                    explosionAnimation(() => {
                        if (player.inCombat) {
                            const dmg = Math.max(20, Math.round(Math.random() * 10) * 5);
                            currentEnemy.hp -= dmg;
                            updateBattleLog(`You exploded the shit out of <span class="enemy">${currentEnemy.name}</span> for <span class="HP">${dmg} HP</span>!!!`);
                            if (currentEnemy.hp <= 0) {
                                playSFX('scream');
                                const nx = player.x + DX[player.dir];
                                const ny = player.y + DY[player.dir];
                                if (['floor', 'rubble1', 'rubble2'].includes(MAP.getCell(nx, ny)?.type)) {
                                    MAP.setCell(nx, ny, "bloodyCrater");
                                }
                            }
                            endOfPlayerTurn();
                        } else {
                            let xMin = player.x, xMax = player.x,
                                yMin = player.y, yMax = player.y;

                            switch (DIRECTIONS[player.dir]) {
                                case 'N':
                                    xMin--;
                                    xMax++;
                                    yMin -= 3;
                                    break;
                                case 'E':
                                    yMin--;
                                    yMax++;
                                    xMax += 3;
                                    break;
                                case 'S':
                                    xMin--;
                                    xMax++;
                                    yMax += 3;
                                    break;
                                case 'W':
                                    yMin--;
                                    yMax++;
                                    xMin -= 3;
                                    break;
                            }

                            for (let y=yMin; y<=yMax; y++) {
                                for (let x=xMin; x<=xMax; x++) {
                                    const cell = MAP.getCell(x, y);
                                    const isVisible =
                                        typeof cell.isVisible !== 'function' ||
                                        cell.isVisible();

                                    if (isVisible) {
                                        cell?.onExplode?.(x, y);
                                    }
                                    cell.isExplored = true;
                                }
                            }

                            updateBattleLog('<span class="action">KABOOM!</span> The dungeon walls crumble like charred toast!');
                            render();
                        }
                    });
                },
                merchantStockChance: 0.5,
                weight: 3,
                price: 300,
            },
            
            tromBone: {
                article: 'a',
                name: "TROM-BONE",
                description: "A trom-BONE. It sounds like a trombone, looks like a trombone, but is somehow... on the bonier side of things. +1.3 LOAD",
                use: () => {
                    stopAllMusic();
                    tromboneIsPlaying = true;
                    tromboneResumeType = player.inCombat ? "battle" : "exploration";
                    animTromboneStart();
                    sfx.tromBone.currentTime = 0;
                    sfx.tromBone.play();
                    sfx.tromBone.onended = () => {
                        tromboneIsPlaying = false;
                        animTromboneEnd();
                        if (musicEnabled) {
                            if (player.inCombat && tromboneResumeType === "battle") {
                                playRandomBattleMusic();
                            } else {
                                resumeExplorationMusic();
                            }
                        }
                        tromboneResumeType = null;
                    };
                    updateBattleLog("You play a trom-BONE. It sounds like a trombone, but somehow... bonier. Not very strong bone though. It shatters in your hands after you play your song. It was good while it lasted.");
                },
                merchantStockChance: 1.0,
                weight: 1.3,
                price: 5,
            },
        };

        const weapons = {
            fingerNail: {
                article: 'a',
                name: "FINGERNAIL",
                description: "Your very own fingernail! Careful not to break it!",
                damage: { base: 1, randomMultiplier: 4 },
                price: 0,
                weight: 0, // No weight
                requiredStr: 0, // No requirement
            },
            pointyStick: {
                article: 'a',
                name: "POINTY STICK",
                description: "A stick that fell off of a tree somewhere",
                damage: { base: 2, randomMultiplier: 5 },
                price: 20,
                weight: 5,
                requiredStr: 7,
            },
            wiffleBallBat: {
                article: 'a',
                name: "WIFFLE BALL BAT",
                description: "A hollow bat made of plastic",
                damage: { base: 3, randomMultiplier: 6 },
                price: 50,
                weight: 6,
                requiredStr: 13,
            },
            nunchucks: {
                article: '',
                name: "NUNCHUCKS",
                description: "Two pieces of wood connected by a chain",
                damage: { base: 6, randomMultiplier: 9 },
                price: 100,
                weight: 8,
                requiredStr: 20,
            },
            atlatlSpear: {
                article: 'an',
                name: "ATLATL SPEAR",
                description: "A spear with a throwing lever",
                damage: { base: 10, randomMultiplier: 11 },
                price: 400,
                weight: 10,
                requiredStr: 25,
            },
            bludgeoningMace: {
                article: 'a',
                name: "BLUDGEONING MACE",
                description: "A stick with a spikey metal ball at the end",
                damage: { base: 10, randomMultiplier: 14 },
                price: 500,
                weight: 11,
                requiredStr: 25,
            },
            danceClub: {
                article: 'a',
                name: "DANCE CLUB",
                description: "A club long enough to pole dance on... maybe it is one? You don't know. Legend has it, an obscure forum user once wielded one...",
                damage: { base: 13, randomMultiplier: 15 },
                price: 800,
                weight: 12,
                requiredStr: 28,
            },
            cathodeRayTubeMonitor: {
                article: 'a',
                name: "CATHODE RAY TUBE MONITOR",
                description: "A CRT monitor. Heavy as piss.",
                damage: { base: 15, randomMultiplier: 17 },
                price: 1000,
                weight: 15,
                requiredStr: 33,
            },
            magicPencil: {
                article: 'a',
                name: "MAGIC PENCIL",
                description: "SpongeBob SquarePants - Season 2, Episode 14B - Frankendoodle",
                damage: { base: 17, randomMultiplier: 18 },
                price: 1400,
                weight: 5,
                requiredStr: 38,
            },
            goldenWang: {
                article: 'a',
                name: "GOLDEN WANG",
                description: "With the power of the Golden Wang, the Discordian parasite shall perish!",
                damage: { base: 69, randomMultiplier: 69 },
                price: 6900,
                weight: 69,
                requiredStr: 69,
            },
        };

        const armor = {
            pectoralMass: {
                article: 'a',
                name: "PECTORAL MASS",
                description: "Your totally big, meaty pectorals! You're not fat at all...'",
                defense: 1,
                price: 0,
                weight: 0,
                requiredEnd: 0,
            },
            graphicTee: {
                article: 'a',
                name: "GRAPHIC TEE",
                description: "A t-shirt that says 'Normal people scare me'",
                defense: 2,
                price: 20,
                weight: 3,
                requiredEnd: 8,
            },
            barrelWithSuspenders: {
                article: 'a',
                name: "BARREL (with suspenders)",
                description: "An empty barrel that sort of covers your torso and legs. Smells like whisky too!",
                defense: 3,
                price: 100,
                weight: 5,
                requiredEnd: 11,
            },
            leatherArmor: {
                article: '',
                name: "LEATHER ARMOR",
                description: "The finest in leather, fitted with a tight top, codpiece, cat o' nine tails... (uh, are you sure this is actually armor?)",
                defense: 6,
                price: 200,
                weight: 6,
                requiredEnd: 15,
            },
            milaneseArmor: {
                article: '',
                name: "MILANESE ARMOR",
                description: "A classic suit of armor. Looks kind of like a Renaissance-era Robocop",
                defense: 12,
                price: 500,
                weight: 9,
                requiredEnd: 18,
            },
            blackPlateArmor: {
                article: '',
                name: "BLACK PLATE ARMOR",
                description: "Literally a giant black dinner plate. Deceptively protective.",
                defense: 16,
                price: 1000,
                weight: 13,
                requiredEnd: 25,
            },
            nokiaMail: {
                article: '',
                name: "NOKIA MAIL",
                description: "A Nokia branded mail. No, not like an email... more like a chainmail. But Nokia.",
                defense: 21,
                price: 2000,
                weight: 18,
                requiredEnd: 34,
            },
        };

        const rings = {
        // PRS Boosters
            ringOfSexyUnderwear: {
                article: 'a',
                name: "RING OF SEXY UNDERWEAR",
                description: "A ring with an engraving of a pair of strangely attractive undergarments. +3 PRS",
                effects: { persuasion: 3 },
                price: 60,
                merchantStockChance: 0.5,
                chestChance: 0.1,
                weight: 1,
            },

            ringOfFrenchAccent: {
                article: 'a',
                name: "FRENCHLY ACCENTED RING",
                description: "A ring that somehow magically forces you to speak in a French accent. VERY sexy! +5 PRS",
                effects: { persuasion: 5 },
                price: 100,
                merchantStockChance: 0.3,
                chestChance: 0.04,
                weight: 1,
            },

        // HP Boosters
            ringValentines: {
                article: 'a',
                name: "VALENTINE'S DAY RING",
                description: "A ring that was given to somebody by their Valentine... and dumped down a hole. You see 'Amy' engraved onto a heart. How sad. +5 HP",
                effects: { maxHp: 5 },
                price: 60,
                merchantStockChance: 0.5,
                chestChance: 0.07,
                weight: 1,
            },
            ringBloodstream: {
                article: 'a',
                name: "BLOODSTREAM NOSERING",
                description: "A nosering that injects blood into your veins. Sounds painful... +8 HP",
                effects: { maxHp: 8 },
                price: 100,
                merchantStockChance: 0.3,
                chestChance: 0.04,
                weight: 1,
            },
        //DEF Boosters
            ringOfHardening: {
                article: 'a',
                name: "COCKRING OF HARDENING",
                description: "A piercing for your cock that doubles as a sort of penis pill. One size fits all! +2 DEF",
                effects: { defense: 2 },
                price: 60,
                merchantStockChance: 0.4,
                chestChance: 0.07,
                weight: 1,
            },
            ringPectoralPiercing: {
                article: 'a',
                name: "PECTORAL PIERCING",
                description: "A piercing that can fit anywhere on your big, juicy pectorals. +5 DEF",
                effects: { defense: 5 },
                price: 100,
                merchantStockChance: 0.3,
                chestChance: 0.04,
                weight: 1,
            },
        // SPD Boosters
            ringPinkyToe: {
                article: 'a',
                name: "PINKY TOE RING",
                description: "A ring for your pinky toe. The only way for this to work is by putting it directly through the toenail... kinda like that SpongeBob episode! +1 SPD",
                effects: { speed: 1 },
                price: 60,
                merchantStockChance: 0.4,
                chestChance: 0.07,
                weight: 1,
            },
            ringCrack: {
                article: 'a',
                name: "CRACK INFUSED RING",
                description: "A ring infused with crack cocaine. +2 SPD",
                effects: { speed: 2 },
                price: 100,
                merchantStockChance: 0.3,
                chestChance: 0.04,
                weight: 1,
            },
        // LUK Boosters
            ringGamble: {
                article: 'the',
                name: "GAMBLER'S RING",
                description: "A cheap looking ring with a 240p image of a slot machine on it. +2 LUK",
                effects: { luck: 2 },
                price: 150,
                merchantStockChance: 0.1,
                chestChance: 0.05,
                weight: 1,
            },
            ringEscobar: {
                article: '',
                name: "PABLO ESCOBAR'S GOLDEN RING",
                description: "A golden ring that once belonged to Pablo Escobar. It smells rather illegal, but who give a shit? +4 LUK",
                effects: { luck: 4 },
                price: 200,
                merchantStockChance: 0.07,
                chestChance: 0.02,
                weight: 1,
            },
        // Special
            ringOfSightliness: {
                article: 'a',
                name: "RING OF SIGHTLINESS",
                description: "A ring with an eyeball so realistic looking, it could actually be real. Allows you to see better in the Tardspire",
                effects: {},
                price: 180,
                merchantStockChance: 0.2,
                chestChance: 0.0,
                weight: 2,
            },
            ringOfStinky: {
                article: 'a',
                name: "RING OF STINKY",
                description: "A ring so stinky, SO putrid, that even monsters will reconsider confronting you. Reduces encounter rate by 30%",
                effects: {},
                price: 200,
                merchantStockChance: 0.2,
                chestChance: 0.0,
                weight: 2,
            },
            ringOfAmplifiedAudio: {
                article: 'a',
                name: "RING OF AMPLIFIED AUDIO",
                description: "A ring with a tiny, yet deceptively loud megaphone. Miniphone? idk. +2 PRS and a PRS attempt",
                effects: { persuasion: 2 },
                price: 130,
                merchantStockChance: 0.2,
                chestChance: 0.00,
                weight: 2,
            },
        };

        function getEffectiveStat(stat) {
            if (stat === "persuasionAttempts") {
                return player.hasEquippedRing('ringOfAmplifiedAudio') ? 3 : 2;
            }

            if (stat === 'speed') {
                const baseSpd = player.speed;
                const carryWeight = player.getCarryWeight();
                const carryLimit = player.getCarryWeightLimit();
                if (carryWeight <= 0) {
                    return baseSpd;
                }
                const percent = carryWeight / carryLimit;
                if (percent <= 0.5) {
                    return baseSpd; // Debuff: 5% at 50%, up to 100% at 100%
                }
                const debuff = Math.min(1, (percent - 0.5) * 2) * 0.95 + 0.05; // Linear from 5% to 100%
                return Math.max(0, Math.floor(baseSpd * (1 - debuff)));
            }

            const ringsEquipped = [player.ring1, player.ring2]
                .map(ringId => ringId ? rings[ringId] : null)
                .filter(Boolean);
            return player[stat] + ringsEquipped.reduce((sum, ring) => sum + (ring.effects?.[stat] || 0), 0);
        }

        const sfx = {
            footstep: new Audio('audio/footsteps.wav'),
            turn: new Audio('audio/turn.wav'),
            attack: new Audio('audio/attack.wav'),
            run: new Audio('audio/run.wav'),
            persuade: new Audio('audio/persuade.wav'),
            explosion: new Audio('audio/explosion.mp3'),
            scream: new Audio('audio/scream.mp3'),
            breathe1: new Audio('audio/breathe1.mp3'),
            breathe2: new Audio('audio/breathe2.mp3'),
            kaching: new Audio('audio/kaching.mp3'),
            torch: new Audio('audio/torch.mp3'),
            gamble: new Audio('audio/gamble.mp3'),
            inventoryOpen: new Audio('audio/inventoryOpen.mp3'),
            uiOption: new Audio('audio/uiOption.wav'),
            uiSelect: new Audio('audio/uiSelect.wav'),
            uiCancel: new Audio('audio/uiCancel.wav'),
            raisins: new Audio('audio/raisins.mp3'),
            floorCrackSlight: new Audio('audio/floorCrackSlight.mp3'),
            floorBreakScreamDie: new Audio('audio/floorBreakScreamDie.mp3'),
            healTile: new Audio('audio/healTile.mp3'),
            tromBone: new Audio('audio/tromBONE.mp3'),
        };

        const music = {
            titleTrack: 
                new Audio("audio/title.wav"), // Title screen
            explorationTracks: [
                new Audio("audio/explore.mp3"),
                new Audio("audio/metalspoons.mp3"), // Metal Spoons - endless_self
                new Audio("audio/tardedwarrior.mp3"), // Tarded Warrior - endless_self
            ],
            battleTracks: [
                new Audio("audio/battle1.mp3"), // battle1
                new Audio("audio/battle2.mp3"), // battle2
                new Audio("audio/battle3.mp3"), // battle3
            ],
        };

        music.explorationTracks.forEach(track => track.loop = true);
        music.battleTracks.forEach(track => track.loop = true);
        music.titleTrack.loop = true;

        function stopAllMusic() {
            [...music.explorationTracks, ...music.battleTracks].forEach(track => {
                track.pause();
                track.currentTime = 0;
            });
            
        }
        function playTitleMusic() {
            stopAllMusic();
            if (!musicEnabled) return;
            currentMusic = music.titleTrack;
            currentMusic.play();
        }

        function stopTitleMusic() {
            if (currentMusic === music.titleTrack) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
                currentMusic = null;
            }
        }

        function playRandomExplorationMusic() {
            stopAllMusic();
            if (!musicEnabled) {
                return;
            }
            currentExplorationTrack = randomEntry(music.explorationTracks);
            currentMusic = currentExplorationTrack;
            currentExplorationTrack.play();
        }

        function playRandomBattleMusic() {
            stopAllMusic();
            if (!musicEnabled) {
                return;
            }
            currentMusic = randomEntry(music.battleTracks);
            currentMusic.play();
        }

        function resumeExplorationMusic() {
            stopAllMusic();
            if (!musicEnabled || !currentExplorationTrack) {
                return;
            }
            currentMusic = currentExplorationTrack;
            currentExplorationTrack.play();
        }

        let currentMusic = null;
        let currentExplorationTrack = null;
        let currentEnemy = null;
        let gameOver = false;
        let persuasionAttempts = 0;
        let maxPersuasionAttempts = 2;
        let speakingOutsideCombat = false;
        let animationActive = false;
        let currentBreathing = null;
        let floor = 1;
        const MAP = new Map();
        MAP.setMinimap(document.getElementById("minimap"));

        MAP.setCellTypes({
            floor: {
                displayName: "Floor",
                mapCharacter: ".",
            },
            healingTile: {
                displayName: "Healing Tile",
                mapCharacter: "H",
                onEnter: function (x, y) {
                    player.steppingOnHealingTile = true;

                    // Heal player
                    const healAmount = Math.ceil(getEffectiveStat('maxHp') * 0.3);
                    player.heal(healAmount);

                    // Heal party
                    let healedAllies = [];
                    player.party.members.forEach(member => {
                        if (member.hp > 0) {
                            const allyHeal = Math.ceil(member.maxHp * 0.1);
                            member.hp = Math.min(member.maxHp, member.hp + allyHeal);
                            healedAllies.push(`<span class="friendly">${member.name}</span> <span class="healingTile">+${allyHeal} HP</span>`);
                        }
                    });

                    let logMsg =
                        `An oddly colored, perfectly square floor ` +
                        `tile <span class="friendly">heals you for ` +
                        `<span class="healingTile">${healAmount} HP</span></span>`;
                    if (healedAllies.length) {
                        logMsg += `<br>Some of that magic was also shared with your party: ${healedAllies.join(', ')}`;
                    }

                    updateBattleLog(logMsg);

                    MAP.setCell(x, y);
                },
            },
            wall: {
                displayName: "Wall",
                mapCharacter: "#",
                isSolid: true,
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            iceWall: {
                displayName: "Wall",
                mapCharacter: '#',
                isSolid: true,
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            crackedFloorSlight: {
                displayName: "Slightly-Cracked Floor",
                mapCharacter: '✕',
                onEnter: function (x, y) {
                    const weightLevel = player.getWeightLevel();

                    if (weightLevel === "normal") {
                        MAP.setCell(x, y, "crackedFloor");
                        playSFX("floorCrackSlight");
                        updateBattleLog(
                            '<span class="action">The floor cracks under ' +
                            'your feet!</span>'
                        );
                    } else if (weightLevel === "warning") {
                        MAP.setCell(x, y, "crackedFloorSevere");
                        playSFX("floorCrackSlight");
                        updateBattleLog(
                            '<span class="action">The floor trembles under ' +
                            'your feet!</span> You might want to lighten ' +
                            'your load and avoid stepping here again!'
                        );
                    } else if (weightLevel === "danger") {
                        player.fallThroughFloorAndDie();
                    }
                },
            },
            crackedFloor: {
                displayName: "Cracked Floor",
                mapCharacter: '✕',
                onEnter: function (x, y) {
                    const weightLevel = player.getWeightLevel();

                    if (weightLevel === "normal") {
                        MAP.setCell(x, y, "crackedFloorSevere");
                        playSFX("floorCrackSlight");
                        updateBattleLog(
                            '<span class="action">The floor cracks under ' +
                            'your feet!</span> It would be a good idea to ' +
                            'avoid stepping here again'
                        );
                    } else if (["warning", "danger"].includes(weightLevel)) {
                        player.fallThroughFloorAndDie();
                    }
                },
            },
            crackedFloorSevere: {
                displayName: "Severely-Cracked Floor",
                mapCharacter: '✖',
                onEnter: function (x, y) {
                    player.fallThroughFloorAndDie();
                },
            },
            rubble1: {
                displayName: "Floor",
                mapCharacter: ".",
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "rubble2");
                },
            },
            rubble2: {
                displayName: "Floor",
                mapCharacter: ".",
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "rubble1");
                },
            },
            gloryWall: {
                displayName: "Wall",
                mapCharacter: "#",
                isSolid: true,
                onTouch: function() {
                    player.say("Uh, no thanks. I'm not THAT brave");
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            noboWall: {
                displayName: "Wall",
                mapCharacter: "#",
                isSolid: true,
                onTouch: function () {
                    player.say(
                        "Who's that? ... Just some nobody, I guess"
                    );
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            crater: {
                displayName: "Floor",
                mapCharacter: ".",
            },
            bloodyCrater: {
                displayName: "Floor",
                mapCharacter: ".",
            },
            exit: {
                displayName: "Exit",
                mapCharacter: "E",
                onEnter: function() {
                    descend();
                }
            },
            merchant: {
                displayName: "Merchant",
                mapCharacter: "M",
                onEnter: function() {
                    menu.open('merchant');
                },
                isVisible: function() {
                    return (
                        merchant.isAlive &&
                        merchant.isActiveOnFloor
                    );
                },
                onExplode: function (x, y) {
                    merchant.isAlive = false;
                    merchant.isActiveOnFloor = false;
                    MAP.setCell(x, y, "bloodyCrater");
                    playSFX('scream');
                    merchant.say('AIEEEEEEEEEEEEEE!', true);
                    updateBattleLog(
                        'HOLY SHIT! The <span class="friendly">' +
                        'merchant</span> has been ' +
                        '<span class="action">vaporized</span> into ' +
                        'a bloody red mist!'
                    );
                },
            },
            gambler: {
                displayName: "Gambler",
                mapCharacter: "G",
                onEnter: function() {
                    menu.open('gambler');
                },
                isVisible: function () {
                    return (
                        gambler.isAlive &&
                        gambler.isActiveOnFloor &&
                        player.bitcoins >= gambler.playPrice
                    );
                },
                onExplode: function (x, y) {
                    gambler.isAlive = false;
                    gambler.isActiveOnFloor = false;
                    MAP.setCell(x, y, "bloodyCrater");

                    // Award between 50 and 100 BTC for the slaughter. I guess that's one way to win
                    const rewardBtc = (5 + Math.round(Math.random() * 5)) * 10;
                    player.giveBitcoins(rewardBtc);
                    playSFX('scream');
                    gambler.say('AUGH!!', true);
                    updateBattleLog(
                        `The <span class="gambler">gambler</span> ` +
                        `has been reduced to a confetti of shrapnel ` +
                        `and bone! You find <span class="BTC">` +
                        `${rewardBtc} BTC</span> among the remains. ` +
                        `Awesome!`
                    );
                },
            },
            tardspireBanner: {
                displayName: "Floor",
                mapCharacter: ".",
                onEnter: function (x, y) {
                    MAP.setCell(x, y);
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y);
                },
            },
            treasureChest: {
                displayName: "Treasure Chest",
                mapCharacter: "T",
                onEnter: function() {
                    menu.open("chest");
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "crater");
                    updateBattleLog(
                        '<span class="action">Gee willikers, you ' +
                        'just destroyed a perfectly good treasure ' +
                        'chest! Oh well...</span><br>'
                    );
                },
            },
            mimic: {
                displayName: "Treasure Chest",
                mapCharacter: "T",
                onEnter: function () {
                    menu.open("chest");
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "bloodyCrater");

                    // Calculate scaled BTC reward
                    const baseMimic = enemies.find(e => e.id === "mimic");
                    const scaledMimic = scaleMimicStats(baseMimic);
                    const mimicBTC = scaledMimic.bitcoins;

                    player.giveBitcoins(mimicBTC); // Reward the player
                    updateBattleLog(
                        `<span class="action">WHAT THE FUCK? That ` +
                        `was a mimic?!</span> You obtained ` +
                        `<span class="BTC">${mimicBTC} BTC</span> ` +
                        `from the intestines spilled from its gaping ` +
                        `maw.`
                    );
                    playSFX('scream');
                },
            },
        });

        let musicEnabled = true;
        let sfxEnabled = true;
        let speechEnabled = true;
        let skipTitleScreen = false;
        let eatRatAnimationEnabled = true;

        // Taken from https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle
        function shuffle(array) {
            if (!Array.isArray(array)) {
                console.error(
                    "Cannot shuffle something that isn't an array",
                    { array }
                );

                return array;
            }

            for (let i = array.length - 1; i >= 1; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Returns a random integer between a minimum and maximum, inclusive
        function numberBetween(min, max) {
            if (typeof min !== "number" || typeof max !== "number") {
                console.error(
                    "The min and max values must be numbers",
                    { min, max }
                );

                return 0;
            }

            if (min > max) {
                [min, max] = [max, min];
            }

            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Returns a random entry from an object or array
        function randomEntry(list) {
            if (Array.isArray(list)) {
                if (list.length < 1) {
                    return null;
                }

                return list[numberBetween(0, list.length - 1)];
            }

            if (typeof list === "object") {
                const key = shuffle(Object.keys(list))?.[0];
                return key ? list[key] : null;
            }

            console.error("Input list is not an array or object", { list });
            return null;
        }

        function generateMap() {
            MAP.generate(WIDTH, HEIGHT, player.x, player.y);

            if (floor === 1) {
                placeWelcomeBanner();
            }

            merchant.isActiveOnFloor =
                merchant.isAlive &&
                (floor === 1 || Math.random() < 0.35);

            if (floor === 40) {
                placeNoboWall();
            }

            if (merchant.isActiveOnFloor) {
                merchant.set();
            }

            gambler.isActiveOnFloor = gambler.isAlive && Math.random() < 0.35;
            if (gambler.isActiveOnFloor) {
                gambler.set();
            }

            spawnTreasureChests();
            spawnHealingTiles();
            spawnCrackedFloors();

            document.getElementById('minimapHeader').innerText =
                `Dungeon Floor ${floor}`;
        }

        function loadSettings() {
            const music = localStorage.getItem("musicEnabled");
            if (music !== null) musicEnabled = music === "true";
            const eatRat = localStorage.getItem("eatRatAnimationEnabled");
            if (eatRat !== null) eatRatAnimationEnabled = eatRat === "true";
            const sfx = localStorage.getItem("sfxEnabled");
            if (sfx !== null) sfxEnabled = sfx === "true";
            const speech = localStorage.getItem("speechEnabled");
            if (speech !== null) speechEnabled = speech === "true";
            const skipTitle = localStorage.getItem("skipTitleScreen");
            if (skipTitle !== null) skipTitleScreen = skipTitle === "true";
        }

        function saveSettings() {
            localStorage.setItem("musicEnabled", musicEnabled);
            localStorage.setItem("eatRatAnimationEnabled", eatRatAnimationEnabled);
            localStorage.setItem("sfxEnabled", sfxEnabled);
            localStorage.setItem("speechEnabled", speechEnabled);
            localStorage.setItem("skipTitleScreen", skipTitleScreen);
        }

        loadSettings();

        function placeWelcomeBanner() {
            if (MAP.getCell(player.x, player.y - 1)?.type === 'floor') {
                // North of player
                MAP.setCell(player.x, player.y - 1, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('N');
            } else if (MAP.getCell(player.x, player.y + 1)?.type === 'floor') {
                // South of player
                MAP.setCell(player.x, player.y + 1, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('S');
            } else if (MAP.getCell(player.x - 1, player.y)?.type === 'floor') {
                // West of player
                MAP.setCell(player.x - 1, player.y, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('W');
            } else if (MAP.getCell(player.x + 1, player.y)?.type === 'floor') {
                // East of player
                MAP.setCell(player.x + 1, player.y, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('E');
            }

            // If there's a wall behind the player, turn it into a glory wall
            const gx = player.x - DX[player.dir];
            const gy = player.y - DY[player.dir];

            if (MAP.getCell(gx, gy)?.type === 'wall') {
                MAP.setCell(gx, gy, 'gloryWall');
            }
        }

        function placeNoboWall() {
            const points = shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];
            if (points) {
                MAP.setCell(points.x, points.y, "noboWall");
            }
        }

        function spawnTreasureChests() {
            const chestCount = numberBetween(1, 4);

            shuffle(MAP.getEmptyCellCoordinates())
                .slice(0, chestCount)
                .forEach((c) => {
                    // 20% chance for mimic
                    const isMimic = Math.random() < 0.2;
                    MAP.setCell(c.x, c.y, isMimic ? 'mimic' : 'treasureChest');
                });
        }

        function spawnHealingTiles() {
            const healingTileCount = numberBetween(1, 6);

            shuffle(MAP.getEmptyCellCoordinates())
                .slice(0, healingTileCount)
                .forEach((c) => MAP.setCell(c.x, c.y, "healingTile"));
        }

        function spawnCrackedFloors() {
            const crackedFloorCount = numberBetween(1, 4);

            shuffle(MAP.getEmptyCellCoordinates())
                .slice(0, crackedFloorCount)
                .forEach((c) => MAP.setCell(c.x, c.y, "crackedFloorSlight"));
        }

        function getRandomMerchantItem() {
            const availableItems = Object.keys(items).filter(itemId => items[itemId].merchantStockChance > 0);
            return randomEntry(availableItems);
        }

        function updateSeenTiles() {
            player.hasEquippedRing('ringOfSightliness')
                ? MAP.revealFOV(player.x, player.y, 2)
                : MAP.revealSpot(player.x, player.y, 1);
        }

        function updateBattleLog(entry) {
            const line = document.createElement('div');
            line.innerHTML = entry;
            document.getElementById("battleLog").prepend(line);
        }

        let textRevealSpeed = 30; // milliseconds per character (adjustable)
        let isRevealingText = false;

        function updateBattleLogWithReveal(entry, callback) {
            if (!player.inCombat) {
                // No combat = display text immediately
                updateBattleLog(entry);
                if (callback) callback();
                return;
            }

            isRevealingText = true;
            const line = document.createElement('div');
            line.innerHTML = entry;
            const textContent = line.textContent || line.innerText || '';
            const charCount = textContent.length;
            const duration = (charCount * textRevealSpeed) / 1000; // Convert to seconds

            line.style.setProperty('--char-count', charCount);
            line.style.setProperty('--reveal-duration', `${duration}s`);
            line.classList.add('revealing');
            
            document.getElementById("battleLog").prepend(line);
            
            setTimeout(() => {
                line.classList.remove('revealing');
                line.style.removeProperty('--char-count');
                line.style.removeProperty('--reveal-duration');
                isRevealingText = false;
                if (callback) callback();
            }, duration * 1000);
        }

        function playSFX(name) {
            if (!sfxEnabled) return;
            if (!sfx[name]) {
                console.error("SFX not found", { name });
                return;
            }
            sfx[name].currentTime = 0;
            sfx[name].play();
        }

        function updateViewportHeader() {
            const $viewportHeader = document.querySelector('#viewport .ui-header');
            if (!$viewportHeader) return;

            if (menu.isOpen()) {
                const currentMenuData = menu.getCurrentMenuData();
                const menuTitle = typeof currentMenuData?.title === 'function' 
                    ? currentMenuData.title() 
                    : currentMenuData?.title || 'MENU';
                $viewportHeader.innerHTML = `<span class="space-between">${menuTitle}</span>`;
            } else {
                $viewportHeader.innerHTML = '<span class="space-between">Viewport</span>';
            }
        }

        function render() {
            MAP.setEntities({
                player: {
                    forceRefresh: true,
                    x: player.x,
                    y: player.y,
                    displayName: `You <span class="player lets-go">ヽ(°٢° )ノ</span>`,
                    isExplored: true,
                    isVisible: true,
                    mapCharacter: player.getDisplayCharacter(),
                    type: "player",
                },
            });
            updateSeenTiles();
            updateBreathingSFX();
            MAP.refreshMinimap();

            // @TODO: Keep this out of render()
            // Stat updates should update the appropriate sections on their own
            player.refreshStats();

            let output = sceneRenderer.render(
                player.x,
                player.y,
                DIRECTIONS[player.dir],
                player.getViewDepth(),
                player.getMaxBrightness()
            );

            if (player.inCombat) {
                output += sceneRenderer.drawEnemyLayer(currentEnemy.id) || '';
            }

            if (player.steppingOnHealingTile) {
                output += sceneRenderer.drawHealingLayer();
                playSFX('healTile');
            }

            if (gameOver) {
                GameControl.disableControls();
                Portrait.show('death');
                updateBattleLog(`Good job! <span class="action">You died</span> on <span class="action">floor ${floor}</span>`);
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }

            document.getElementById('game').innerHTML = output;
            player.resetEventFlags();
            setTorchOverlayVisibility();
        }


        function isEmpty(obj) {
            for (let i in obj) {
                return false;
            }
            return true;
        }

        function animEatRat(callback) {
            const container = document.getElementById('viewport');
            if (!container) return;

            window._inputBlocked = true;

            let overlay = document.getElementById('animEatRat');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'animEatRat';
                container.appendChild(overlay);
            }
            overlay.innerHTML = '';
            const ratVideo = document.createElement('video');
            ratVideo.disablePictureInPicture = true;
            ratVideo.src = 'assets/fp-anim/rat-chomp.webm';
            ratVideo.autoplay = true;
            ratVideo.playsInline = true;

            const gameLayers = container.querySelectorAll('.layer');
            gameLayers.forEach(layer => {
                layer.classList.remove('lightening', 'darkening', 'dark');
                layer.classList.add('dark');
            });

            let finished = false;
            function cleanup() {
                if (finished) return;
                finished = true;
                // Lighten the scene
                gameLayers.forEach(layer => {
                    layer.classList.remove('dark');
                    layer.classList.add('lightening');
                });
                setTimeout(() => {
                    gameLayers.forEach(layer => {
                        layer.classList.remove('lightening');
                    });
                }, 600);

                overlay.style.display = 'none';
                overlay.innerHTML = '';
                window._inputBlocked = false;
                if (typeof callback === 'function') callback();
                ratVideo.remove();
            }

            // Fallback: always cleanup after 3.5 seconds, in case the .webm has some sort of playback error
            let fallbackTimeout = setTimeout(cleanup, 3500);

            ratVideo.addEventListener('ended', () => {
                clearTimeout(fallbackTimeout);
                cleanup();
            });
            ratVideo.addEventListener('error', () => {
                clearTimeout(fallbackTimeout);
                cleanup();
            });

            overlay.appendChild(ratVideo);
            overlay.style.display = 'flex';
        }

        const origKeydown = document.onkeydown;
        document.addEventListener('keydown', function(e) {
            const $titleScreen = document.getElementById('titleScreen');
            if (
                window._inputBlocked &&
                $titleScreen?.style?.display !== 'none' &&
                (e.key === 'Enter' || e.key === ' ')
            ) {
                return;
            }
            if (window._inputBlocked) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
            if (typeof origKeydown === 'function') origKeydown(e);
        }, true);

        function setTorchOverlayVisibility() {
            // Hide torch in combat, resume after battle
            const $torch = document.getElementById('animTorch');
            player.isHoldingTorch && !player.inCombat
                ? $torch.classList.add('onscreen')
                : $torch.classList.remove('onscreen');
        }

        // Update animTorchStart to always use setTorchOverlayVisibility
        function animTorchStart() {
            player.isHoldingTorch = true;
            setTorchOverlayVisibility();
            playSFX('torch');
            document.getElementById('game').classList.add('torch');
        }

        function animTorchEnd() {
            player.isHoldingTorch = false;
            setTorchOverlayVisibility();
            document.getElementById('game').classList.remove('torch');
        }

        function animTromboneStart() {
            const $trombone = document.getElementById('animTrombone');
            $trombone.classList.add('onscreen');
        }

        function animTromboneEnd() {
            const $trombone = document.getElementById('animTrombone');
            $trombone.classList.remove('onscreen');
        }

        function shakeScreen() {
            const $children = document.getElementById('viewport').children;

            // Randomly pick a small vertical offset: -2, -1, 0, 1, or 2px
            const offset = randomEntry([-2, -1, 0, 1, 2]);
            for (let $child of $children) {
                if ($child.classList.contains('ui-header')) continue;
                const childIsVisible =
                    !$child.classList.contains('hidden') &&
                    !$child.classList.contains('offscreen');

                if (!childIsVisible) {
                    continue;
                }

                $child.style.transition = 'transform 0.08s cubic-bezier(.36,.07,.19,.97)';
                $child.style.transform = `translateY(${offset}px)`;
                setTimeout(() => {
                    $child.style.transform = '';
                }, 80);
            }
        }

        function slideScreen(direction) {
            const $children = document.getElementById('viewport').children;
            const offset = direction === 'left' ? -2 : 2; // Slide effect pixel amount (-x is left, x is right)
            for (let $child of $children) {
                if ($child.classList.contains('ui-header')) continue;
                const childIsVisible =
                    !$child.classList.contains('hidden') &&
                    !$child.classList.contains('offscreen');

                if (!childIsVisible) {
                    continue;
                }

                $child.style.transition = 'transform 0.12s cubic-bezier(.36,.07,.19,.97)';
                $child.style.transform = `translateX(${offset}px)`;
                setTimeout(() => {
                    $child.style.transform = '';
                }, 120);
            }
        }

        function move(direction) {
            if (player.inCombat || gameOver || player.movementDisabled) {
                return;
            }
            player.movementDisabled = true;

            playSFX('footstep');
            let nx, ny, randomEncounterChance = 0.25;
            if (direction === 'forward') {
                nx = player.x + DX[player.dir];
                ny = player.y + DY[player.dir];
                shakeScreen();
            } else if (direction === 'strafeLeft') {
                nx = player.x + DX[(player.dir + 3) % 4];
                ny = player.y + DY[(player.dir + 3) % 4];
                slideScreen('left');
            } else if (direction === 'strafeRight') {
                nx = player.x + DX[(player.dir + 1) % 4];
                ny = player.y + DY[(player.dir + 1) % 4];
                slideScreen('right');
            } else {
                nx = player.x - DX[player.dir];
                ny = player.y - DY[player.dir];
                randomEncounterChance = 0.5; // When moving backward
                shakeScreen();
            }

            const hasStinky = player.ring1 === "ringOfStinky" || player.ring2 === "ringOfStinky";
            if (hasStinky) {
                randomEncounterChance *= 0.7; // If Ring of Stinky is equipped, reduce encounter chance by 30%
            }

            const tile = MAP.getCell(nx, ny);
            if (!tile.isSolid) {
                player.x = nx;
                player.y = ny;

                const fireOnEnter =
                    typeof tile.onEnter === "function" &&
                    (typeof tile.isVisible !== "function" || tile.isVisible());

                if (fireOnEnter) {
                    tile.onEnter(nx, ny);
                } else if (Math.random() < randomEncounterChance) {
                    startEncounter();
                }
            } else if (typeof tile.onTouch === "function") {
                tile.onTouch();
            }

            GameControl.update();

            // Set the movement delay range
            const maxDelay = 2000; // Max speed (movement delay) in milliseconds (2s)
            const minDelay = 1;  // Min speed (movement delay) in milliseconds (1/4 of 1s)

            // Calculate movement delay based on speed
            const baseDelay = maxDelay; // Start with the maximum delay
            const speedModifier = getEffectiveStat('speed') * 0.05; // 5% reduction per speed point
            const movementDelay = Math.max(minDelay, baseDelay * (1 - speedModifier)); // Ensure delay is at least minDelay

            setTimeout(() => {
                player.movementDisabled = false;
                GameControl.update();
            }, movementDelay);

            render();
        }

        function turnLeft() {
            if (player.inCombat || gameOver) {
                return;
            }
            playSFX('turn');
            slideScreen('left');
            player.dir = (player.dir + 3) % 4;
            GameControl.update();
            render();
        }

        function turnRight() {
            if (player.inCombat || gameOver) {
                return;
            }
            playSFX('turn');
            slideScreen('right');
            player.dir = (player.dir + 1) % 4;
            GameControl.update();
            render();
        }

        function updateBreathingSFX() {
            // Pause breathing SFX if in battle or killed
            if (player.inCombat || player.hp <= 0) {
                if (currentBreathing) {
                    sfx[currentBreathing].pause();
                    sfx[currentBreathing].currentTime = 0;
                    currentBreathing = null;
                }
                return;
            }

            const weightLevel = player.getWeightLevel();

            // Stop all breathing sounds if below 50%
            if (weightLevel === "normal") {
                if (currentBreathing) {
                    sfx[currentBreathing].pause();
                    sfx[currentBreathing].currentTime = 0;
                    currentBreathing = null;
                }
                return;
            }

            // 50%-80%: Only breathe1, looped
            if (weightLevel === "warning") {
                if (currentBreathing !== "breathe1") {
                    if (currentBreathing) {
                        sfx[currentBreathing].pause();
                        sfx[currentBreathing].currentTime = 0;
                    }
                    sfx.breathe1.loop = true;
                    sfx.breathe1.currentTime = 0;
                    sfx.breathe1.play();
                    currentBreathing = "breathe1";
                }
                return;
            }

            // 80%+: Only breathe2, looped
            if (weightLevel === "danger") {
                if (currentBreathing !== "breathe2") {
                    if (currentBreathing) {
                        sfx[currentBreathing].pause();
                        sfx[currentBreathing].currentTime = 0;
                    }
                    sfx.breathe2.loop = true;
                    sfx.breathe2.currentTime = 0;
                    sfx.breathe2.play();
                    currentBreathing = "breathe2";
                }
                return;
            }
        }

        function startEncounter() {
            // Filter out the mimic from the random enemy pool
            const randomEnemies = enemies.filter(enemy => enemy.id !== "mimic");

            // Pick a random enemy
            currentEnemy = structuredClone(randomEntry(randomEnemies));

            // Scale enemy stats based on floor
            const floorBoost = Math.floor(floor / 2); // Scale every 2 floors
            if (floorBoost > 0) {
                currentEnemy.hp += floorBoost * 7; // +7 HP per scaling
                currentEnemy.attack = [
                    currentEnemy.attack[0] + (floorBoost * 3), // Adjust attack range based on floor scaling
                    currentEnemy.attack[1] + (floorBoost * 3)  // Adjust attack range based on floor scaling
                ];
                currentEnemy.bitcoins += floorBoost; // Increase Bitcoin drop based on floor scaling
            }
            player.enterCombat();
            updateBattleLog(`A wild <span class="enemy">${currentEnemy.name}</span> appears!`);
            playRandomBattleMusic(); // <-- use this
        }


        function playerAttack() {
            if (!player.inCombat || GameControl.awaitingPersuasionText || isRevealingText) {
                return;
            }

            playSFX('attack');
            const playerWeapon = weapons[player.weapon];
            let dmg = Math.floor(Math.random() * playerWeapon.damage.randomMultiplier) + playerWeapon.damage.base;
            dmg += player.strength;

            const critChance = getEffectiveStat('luck') * 0.01;
            let isCrit = Math.random() < critChance;
            
            let attackMessage;
            if (isCrit) {
                dmg = Math.floor(dmg * 1.2);
                attackMessage = 
                    `<span class="LUK">CRITICAL HIT!</span> ` +
                    `<span class="friendly">You</span> dealt ` +
                    `<span class="action">${dmg} HP</span> ` +
                    `to <span class="enemy">${currentEnemy.name}</span>`;
            } else {
                attackMessage = 
                    `<span class="friendly">You</span> deal ` +
                    `<span class="action">${dmg} HP</span> ` +
                    `to <span class="enemy">${currentEnemy.name}</span>`;
            }
            
            currentEnemy.hp -= dmg;
            // Text reveal effect
            updateBattleLogWithReveal(attackMessage, () => {
                setTimeout(() => endOfPlayerTurn(), 300); // Small delay after text finishes
            });
        }

        function endOfPlayerTurn() {
            if (currentEnemy.hp <= 0) {
                if (currentEnemy.id === "mimic") {
                    updateBattleLog(`The <span class="enemy">MIMIC</span> has been defeated! You find <span class="BTC">${currentEnemy.bitcoins} BTC</span> in its remains!`);
                    player.giveBitcoins(currentEnemy.bitcoins); // Award scaled BTC
                } else {
                    const baseExp = 3;
                    const floorBoost = Math.floor(floor / 2);
                    const exp = baseExp + (floorBoost * 3); // +3 EXP per boost
                    const bitcoinsEarned = currentEnemy.bitcoins;
                    const randomMsg = randomEntry([
                        "was beaten to a fucking pulp!",
                        "had their bollocks slammed against the hard " +
                            "concrete wall!",
                        "got their face scraped along the floor!",
                        "died from a nosebleed. Alright then?",
                        "was pulverized before they could activate their " +
                            "anti-retard orbital laser.",
                        "pancaked their diaper and died from embarassment. " +
                            "<em>Gross.</em>",
                        "left the server.",
                        "picked their nose, and died picking their nose.",
                        "got bored and jumped down a 'bottomless' hole. You " +
                            "heard a scream, and the sound was absolutely " +
                            "not faint."
                    ]);

                    updateBattleLog(
                        `<span class="enemy">${currentEnemy.name}</span> ` +
                        `${randomMsg}`
                    );

                    updateBattleLog(
                        `<span class="friendly">You</span> gained ` +
                        `<span class="EXP">+${exp} EXP</span> and ` +
                        `<span class="BTC">${bitcoinsEarned} BTC</span>`
                    );
                    player.giveBitcoins(bitcoinsEarned);
                    player.exp += exp;
                }

                player.leaveCombat();

                setTorchOverlayVisibility();

                if (player.exp >= player.getExpRequiredForLevelUp()) {
                    startLevelUpAllocation();
                }
            } else {
                enemyAttack();
            }

            render();
            setTorchOverlayVisibility();
        }

        function enemyAttack() {
            // Base damage + boost damage, boost damage scaled every 2 floors
            const damage = numberBetween(1, 5) + Math.floor(floor / 2);

            // Calculate damage based on player's defense
            const defense =
                getEffectiveStat('defense') +
                (armor[player.armor]?.defense || 0);

            const totalDamage = Math.max(1, Math.floor(damage - defense / 5));
            const ally = randomEntry(player.party.get());
            const target = ally && Math.random() < 0.5 ? "ally" : "player";

            target === "ally"
                ? ally.hp = Math.max(ally.hp - totalDamage, 0)
                : player.damage(totalDamage);

            const targetLine = target === "ally"
                ? `your <span class="friendly">${ally.name}</span>`
                : `<span class="friendly">you</span>`;

            updateBattleLog(
                `<span class="enemy">${currentEnemy.name}</span> deals ` +
                `<span class="enemy">${totalDamage} HP</span> to ${targetLine}`
            );

            if (ally && ally.hp <= 0) {
                const allyFate = randomEntry([
                    "eviscerated",
                    "butt-blasted into oblivion",
                    "given a fatal atomic wedgie",
                    "spanked into the stratosphere",
                    "knocked into next Tuesday",
                    "given a lesson in pain",
                    "told to quit and go home. And it listened",
                ]);

                updateBattleLog(
                    `Your <span class="friendly">${ally.name}</span> ` +
                    `has been <span class="action">${allyFate}</span>...`
                );
            }
        }



        function tryRun() {
            if (!player.inCombat || GameControl.awaitingPersuasionText || isRevealingText) {
                return;
            }

            playSFX('run');
            if (Math.random() < 0.5) {
                const runMessage = "Gee willikers, I'm outta here!";
                updateBattleLogWithReveal(`<span class="player">&lt;YOU&gt;</span> "${runMessage}"`, () => {
                    player.leaveCombat();
                    render();
                });
            } else {
                updateBattleLogWithReveal("Couldn't escape!", () => {
                    setTimeout(() => enemyAttack(), 300);
                });
            }
        }

        function tryPersuade(e) {
            if (isRevealingText) {
                return;
            }
            e?.preventDefault();
            playSFX('persuade');
            GameControl.openPersuasionInputBox();
        }

        document.getElementById("persuadeInput").addEventListener("keydown", e => {
            if (e.key === "Escape") {
                GameControl.closePersuasionInputBox();
                render();
                return;
            }

            if (e.key === "Enter") {
                submitPersuasion();
            }
        });

        function submitPersuasion() {
            const $input = document.getElementById("persuadeInput");
            const message = $input.value;

            // ======== CHEAT COMMANDS ========
            if (message.startsWith("/")) {
                handleCheatCommand(message);
                $input.value = "";
                GameControl.closePersuasionInputBox();
                render();
                return;
            }

            $input.value = "";
            GameControl.closePersuasionInputBox();

            // ======== Persuasion During Combat ========
            if (player.inCombat) {
                persuasionAttempts++;

                // Check limit FIRST
                if (persuasionAttempts > maxPersuasionAttempts) {
                    updateBattleLogWithReveal(`Your words are no longer being heard... <span class="action">you have run out of persuasion attempts.</span>`, () => {
                        setTimeout(() => enemyAttack(), 300);
                    });
                    render();
                    return;
                }

                const playerMessage = message.trim() || randomEntry([
                    "You're about as ugly as homemade soup!",
                    "Don't you DARE take the name of Texas in vain",
                    "You may be stupid, but you're also dumb",
                    "Join me, and together we can rule the TardSpire as father and son!",
                    "Cake or death?!",
                    "Your mother was a hamster and your father smelt of elderberries!",
                ]);

                const playerSpeakMessage = `<span class="player">&lt;YOU&gt;</span> "${playerMessage}"`;
                
                updateBattleLogWithReveal(playerSpeakMessage, () => {
                    const prsStat = Math.min(getEffectiveStat('persuasion'), 100);
                    const totalChance = prsStat / 100;

                    if (Math.random() < totalChance) {
                        let successMessage;
                        if (!player.party.isFull()) {
                            const enemy = enemies.find((e) => e.id === currentEnemy.id);
                            if (!enemy) {
                                console.error('Could not find enemy by id', { currentEnemy });
                                return;
                            }

                            const enemyHp = Math.max(Math.floor(currentEnemy.hp / 2), 1);
                            const floorBoost = Math.floor(floor / 2);
                            const maxEnemyHp = Math.max(Math.floor((enemy.hp + (floorBoost * 7)) / 2), 1);

                            player.party.add(currentEnemy.id, currentEnemy.name, enemyHp, maxEnemyHp);
                            successMessage = `<span class="friendly">${currentEnemy.name}</span> is now following your trail of sweat.`;
                        } else {
                            successMessage = `<span class="enemy">${currentEnemy.name}</span> was <span class="friendly">spared</span> and went back home...`;
                        }
                        
                        updateBattleLogWithReveal(successMessage, () => {
                            player.leaveCombat();
                            render();
                        });
                    } else {
                        let failMessage = `<span class="enemy">${currentEnemy.name}</span> really, quite genuinely, does not care...`;
                        
                        // If this was the last attempt, show a message
                        if (persuasionAttempts >= maxPersuasionAttempts) {
                            failMessage += `\n<span class="action">You've used your last persuasion attempt for this fight..</span>`;
                        }
                        
                        updateBattleLogWithReveal(failMessage, () => {
                            setTimeout(() => enemyAttack(), 300);
                        });
                    }
                    render();
                });
                return;
            }

            // ======== Speaking Outside Combat ========
            if (speakingOutsideCombat) {
                const speakMessage = `<span class="player">&lt;YOU&gt;</span> "${message}"`;
                updateBattleLog(speakMessage); // Keep this as regular log since it's outside combat
                speakingOutsideCombat = false;

                if (player.party.get().length > 0 && message.trim()) {
                    player.party.talk();
                }

                render();
            }
        }

        function useItem(itemName) {
            if (!player.inventory[itemName] || player.inventory[itemName] <= 0) {
                updateBattleLog("You don't have that item!");
                return;
            }

            typeof items[itemName]?.use === "function"
                ? items[itemName].use()
                : updateBattleLog("You used the item, but nothing happened.");
        
            player.inventory[itemName]--;
            if (player.inventory[itemName] <= 0) {
                delete player.inventory[itemName];
            }
            render();
        }

        function handleCheatCommand(cmd) {
            if (cmd === "/spawn m") {
                let found = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        merchant.isAlive = true;
                        merchant.isActiveOnFloor = true;
                        MAP.setCell(nx, ny, 'merchant');
                        merchant.set();
                        updateBattleLog('<span class="merchant">CHEAT: Merchant spawned</span>');
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    updateBattleLog('<span class="merchant">CHEAT: Merchant not spawned. Try a different spot.</span>');
                }
                return;
            }
            if (cmd === "/spawn g") {
                let found = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        gambler.isAlive = true;
                        gambler.isActiveOnFloor = true;
                        player.bitcoins = Math.max(player.bitcoins, gambler.playPrice);
                        player.refreshBitcoins();
                        MAP.setCell(nx, ny, 'gambler');
                        updateBattleLog('<span class="gambler">CHEAT: Gambler spawned</span>');
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    updateBattleLog('<span class="gambler">CHEAT: Gambler not spawned. Try a different spot.</span>');
                }
                return;
            }
            if (cmd.startsWith("/givebtc ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.giveBitcoins(amount);
                    updateBattleLog(`<span class="BTC">CHEAT: Added ${amount} BTC to your worn out Kamen Rider wallet</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid BTC amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/sethp ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.maxHp = amount;
                    player.hp = amount;
                    updateBattleLog(`<span class="HP">CHEAT: Max HP set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid HP amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setdef ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.defense = amount;
                    updateBattleLog(`<span class="DEF">CHEAT: Defense set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid DEF amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setstr ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.strength = amount;
                    updateBattleLog(`<span class="STR">CHEAT: Strength set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid STR amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setprs ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.persuasion = amount;
                    updateBattleLog(`<span class="PRS">CHEAT: Persuasion set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid PRS amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setend ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.endurance = amount;
                    updateBattleLog(`<span class="END">CHEAT: Endurance set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid END amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setspd ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.speed = amount;
                    updateBattleLog(`<span class="SPD">CHEAT: Speed set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid SPD amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setluk ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.luck = amount;
                    updateBattleLog(`<span class="LUK">CHEAT: Luck set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid LUK amount.</span>`);
                }
                return;
            }

            if (cmd.startsWith("/setlv ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.level = amount;
                    player.exp = 0;
                    updateBattleLog(`<span class="LV">CHEAT: Level set to ${amount}. Cheater.</span>`);
                    render();
                } else {
                    updateBattleLog(`<span class="action">Invalid level number.</span>`);
                }
                return;
            }

            if (cmd === "/debug") {
                const yeahBoiii = 69999;
                player.maxHp = yeahBoiii;
                player.hp = yeahBoiii;
                player.defense = yeahBoiii;
                player.strength = yeahBoiii;
                player.persuasion = yeahBoiii;
                player.endurance = yeahBoiii;
                player.speed = yeahBoiii;
                player.luck = yeahBoiii;
                player.bitcoins = yeahBoiii;
                player.refreshBitcoins();

                let merchantSpawned = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        merchant.isAlive = true;
                        merchant.isActiveOnFloor = true;
                        merchant.setWares(true);
                        MAP.setCell(nx, ny, 'merchant');
                        merchantSpawned = true;
                        break;
                    }
                }

                let gamblerSpawned = false;
                if (merchantSpawned) {
                    for (let i = 0; i < 4; i++) {
                        const merchantPosition = merchant.location();
                        if (merchantPosition === null) {
                            break;
                        }
                        const gx = merchantPosition.x + DX[i];
                        const gy = merchantPosition.y + DY[i];
                        const notPlayer = gx !== player.x || gy !== player.y;
                        const notMerchant = gx !== merchantPosition.x || gy !== merchantPosition.y;
                        if (
                            MAP.getCell(gx, gy)?.type === 'floor' &&
                            notPlayer &&
                            notMerchant
                        ) {
                            gambler.isAlive = true;
                            gambler.isActiveOnFloor = true;
                            MAP.setCell(gx, gy, 'gambler');
                            gamblerSpawned = true;
                            break;
                        }
                    }
                }
                updateBattleLog(
                    `<span class="action">CHEAT: Debug mode activated! All stats and BTC set to ${yeahBoiii}. Merchant${merchantSpawned ? "" : " (FAILED)"} and Gambler${gamblerSpawned ? "" : " (FAILED)"} spawned next to you.</span>`
                );
                render();
                return;
            }


            if (cmd.startsWith("/setfloor ")) {
                const floorNumber = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(floorNumber) && floorNumber > 0) {
                    floor = floorNumber;
                    updateBattleLog(`<span class="action">CHEAT: Moved to Floor ${floorNumber}</span>`);
                    generateMap();
                    render();
                } else {
                    updateBattleLog(`<span class="action">Try an actual floor number, retard.</span>`);
                }
                return;
            }

            updateBattleLog(`<span class="action">RETARD ALERT! INVALID CHEAT: ${cmd}</span>`);
        }

        function gamble() {
            player.takeBitcoins(gambler.playPrice);
            updateBattleLog(`You hand the gambler <span class="tooExpensive">${gambler.playPrice} BTC</span>. Let's hope it was worth it`);

            document.getElementById('menu').classList.add('hidden');

            // LUK affects chance to roll a 12
            // LUK now works like PRS: 0-100% chance to win (roll a 12)
            const lukStat = Math.min(getEffectiveStat('luck'), 100);
            const winChance = lukStat / 100; // example; 32 LUK = 32% chance at success

            let roll12 = Math.random() < winChance;

            let dice;
            if (roll12) {
                dice = [6, 6];
            } else {
                // Roll normally, but avoid double sixes
                do {
                    dice = [
                        numberBetween(1, 6),
                        numberBetween(1, 6),
                    ];
                } while (dice[0] === 6 && dice[1] === 6);
            }

            gambleAnimation(dice, () => {
                gambleOutcome(dice);
            });
            playSFX('gamble');
        }

        function gambleOutcome(dice) {
            const sum = dice[0] + dice[1];
            const win = sum === 12;
            const sumClass = win ? 'friendly' : 'enemy';

            updateBattleLog(
                'You rolled a ' +
                `<span class="gambler">${dice[0]}</span> and a ` +
                `<span class="gambler">${dice[1]}</span> ` +
                `for a sum of <span class="${sumClass}">${sum}</span>`
            );

            if (win) {
                const stat = randomEntry(['hp', 'defense', 'persuasion']);

                switch (stat) {
                    case 'hp': {
                        const healthBoost = 5 + (Math.floor((Math.random() * 2)) * 5);
                        player.maxHp += healthBoost;
                        player.heal(healthBoost);
                        updateBattleLog(
                            `<span class="LV">You scored a health boost! ` +
                            `+${healthBoost} HP!</span>`
                        );
                        break;
                    }
                    case 'defense': {
                        const defenseBoost = 1 + Math.floor((Math.random() * 2));
                        player.defense += defenseBoost;
                        updateBattleLog(
                            `<span class="LV">You won a defense boost! ` +
                            `+${defenseBoost} DEF!</span>`
                        );
                        break;
                    }
                    case 'persuasion': {
                        const persuasionBoost = 1 + Math.floor((Math.random() * 2));
                        player.persuasion += persuasionBoost;
                        updateBattleLog(
                            `<span class="LV">You won a persuasion boost! ` +
                            `+${persuasionBoost} PRS!</span> (Actually the ` +
                            `gambler just handed you a beat-up copy of ` +
                            `"How to Win Friends and Influence People", ` +
                            `but whatever)`
                        );
                        break;
                    }
                }
                gambler.say('Ah, whatever. Fucker. You win this time...');
            } else {
                gambler.say('Tough luck, kid! Heh heh heh!');
            }

            gambler.isActiveOnFloor = false;
            updateBattleLog('The gambler escapes into the shadows');
            render();

            menu.close();
        }

        /**
         * This animates the hand throwing dice when gambling
         *
         * The animation works by calling the gambleFrames in sequence. The
         * number of defined frames is actually more than the number of the
         * available frames in the animation. This is because the final frame is
         * held and displays random digits to emphasize the roll
         */
        function gambleAnimation(dice, callback, frame) {
            const maxFrames = 24;
            const frameNumber = frame || 0;
            const displayFrame = Math.min(frameNumber, gambleFrames.length - 1);
            const isFinalFrame = frameNumber >= maxFrames - 1;

            if (frameNumber === 0) {
                animationActive = true;
                document.getElementById('animation').classList.remove('hidden');
                document.getElementById('menu').classList.add('hidden');
            }

            // Set random dice digits before displaying the actual outcome
            const d = isFinalFrame ? dice : [
                numberBetween(1, 6),
                numberBetween(1, 6),
            ];

            if (frameNumber < maxFrames) {
                // Add some padding to center the animation
                let frameText = gambleFrames[displayFrame].replace(/^/gm, '       ');
                if (frameNumber >= gambleFrames.length - 4) {
                    // Draw digits on the bones
                    frameText = frameText.replace(
                        /(^[ |]+\n^ +\|   ) {5}( +\| +\|   ) {5}(.+\n^ +\|   ) {5}( +\| +\|   ) {5}(.+\n^ +\|   ) {5}( +\| +\|   ) {5}/m,
                        `$1${dieDigit[d[0] - 1][0]}$2${dieDigit[d[1] - 1][0]}$3${dieDigit[d[0] - 1][1]}$4${dieDigit[d[1] - 1][1]}$5${dieDigit[d[0] - 1][2]}$6${dieDigit[d[1] - 1][2]}`,
                    );
                }

                document.getElementById("animation").textContent = frameText;
                setTimeout(() => gambleAnimation(dice, callback, frameNumber + 1), !isFinalFrame ? 50 : 3000);
            } else {
                document.getElementById('animation').classList.add('hidden');
                document.getElementById('menu').classList.remove('hidden');
                animationActive = false;
                typeof callback === 'function' && callback();
            }
        }

        function drawCircle(screen, centerX, centerY, radius, character) {
            const height = sceneRenderer.displayHeight;
            const width = Math.round(sceneRenderer.displayWidth / 2);

            let x = radius;
            let y = 0;
            let decisionOver2 = 1 - x;   // Decision criterion divided by 2

            while (y <= x) {
                const points = [
                    [centerY + y, centerX + x],
                    [centerY + x, centerX + y],
                    [centerY + x, centerX - y],
                    [centerY + y, centerX - x],
                    [centerY - y, centerX - x],
                    [centerY - x, centerX - y],
                    [centerY - x, centerX + y],
                    [centerY - y, centerX + x]
                ];

                // Set pixels if they are within bounds
                for (const [py, px] of points) {
                    if (py >= 0 && py < height && px >= 0 && px < width) {
                        screen[py][px] = character;
                    }
                }

                y++;
                if (decisionOver2 <= 0) {
                    decisionOver2 += 2 * y + 1;
                } else {
                    x--;
                    decisionOver2 += 2 * (y - x) + 1;
                }
            }
        }

        function explosionAnimation(callback, frame) {
            const maxFrames = 32;
            const frameNumber = frame || 0;
            const isCallbackFrame = frameNumber === 4;
            const $animation = document.getElementById('animation');
            $animation.classList.add('explosion');

            if (frameNumber === 0) {
                animationActive = true;
                $animation.classList.remove('hidden');
            }

            let screen = Array.from(
                { length: sceneRenderer.displayHeight },
                () => Array(Math.round(sceneRenderer.displayWidth / 2)).fill(' ')
            );

            const centerX = Math.round(sceneRenderer.displayWidth / 4);
            const centerY = Math.round(sceneRenderer.displayHeight / 2);
            const totalCircles = 8;
            const characters = ['░', '▒', '▓'];

            for (let i=0; i<totalCircles; i++) {
                const radius = frame - i;
                if (radius > 0 && radius <= 18) {
                    drawCircle(screen, centerX, centerY, radius, characters[i % characters.length]);
                }
            }

            let text = '';

            for (let y=0; y<screen.length; y++) {
                for (let x=0; x<screen[y].length; x++) {
                    text += screen[y][x] + screen[y][x];
                }

                if (y < screen.length) {
                    text += "\n";
                }
            }

            $animation.innerText = text;

            const displayFrame = Math.min(frameNumber, gambleFrames.length - 1);

            if (isCallbackFrame && typeof callback === 'function') {
                callback();
            }

            if (frameNumber < maxFrames) {
                setTimeout(() => explosionAnimation(callback, frameNumber + 1), 10);
            } else {
                $animation.classList.add('hidden');
                $animation.classList.remove('explosion');
                animationActive = false;
            }
        }


        function openChest() {
            if (MAP.getCell(player.x, player.y)?.type === 'mimic') {
                // Mimic detected, start a battle
                playSFX('scream');

                // Remove the mimic from the map
                MAP.setCell(player.x, player.y);

                // Spawn mimic and apply scaling
                const baseMimic = enemies.find(e => e.id === "mimic");
                currentEnemy = scaleMimicStats(baseMimic);

                updateBattleLog("Holy shit! It was actually a <span class='enemy'>MIMIC</span>!!!");
                player.enterCombat();
                playRandomBattleMusic();
            } else if (MAP.getCell(player.x, player.y)?.type === 'treasureChest') {
                // Normal chest, provide loot
                const lootTypeRoll = Math.random();
                let chestContents;
                if (lootTypeRoll < 0.4) {
                    chestContents = { type: 'BTC', amount: Math.floor(Math.random() * 10) + 3 };
                } else if (lootTypeRoll < 0.7) {
                    chestContents = { type: 'item', item: getRandomMerchantItem() };
                } else {
                    // Try to spawn a ring based on chestChance
                    const possibleRings = Object.keys(rings).filter(ringId =>
                        Math.random() < (rings[ringId].chestChance || 0)
                    );
                    if (possibleRings.length > 0) {
                        const ringId = randomEntry(possibleRings);
                        chestContents = { type: 'ring', ring: ringId };
                    } else {
                        // fallback to BTC if no ring
                        chestContents = { type: 'BTC', amount: Math.floor(Math.random() * 10) + 3 };
                    }
                }

                if (chestContents.type === 'BTC') {
                    let bonus = Math.floor(chestContents.amount * (getEffectiveStat('luck') * 0.02));
                    let total = chestContents.amount + bonus;
                    player.giveBitcoins(total);
                    updateBattleLog(
                        `You found <span class="BTC">${total} BTC</span> in the chest!`
                    );
                } else if (chestContents.type === 'item') {
                    const itemName = chestContents.item;
                    player.inventory[itemName] = (player.inventory[itemName] || 0) + 1;
                    updateBattleLog(`You found <span class="friendly">${items[itemName].name}</span> in the chest!`);
                } else if (chestContents.type === 'ring') {
                    const ringId = chestContents.ring;
                    player.inventory[ringId] = (player.inventory[ringId] || 0) + 1;
                    updateBattleLog(`You found <span class="friendly">${rings[ringId].name}</span> in the chest!`);
                }

                // Remove the chest from the map
                MAP.setCell(player.x, player.y);
            }

            render();
        }

        function scaleMimicStats(baseMimic) {
            const floorBoost = Math.floor(floor / 2); // Scale every 2 floors
            const scaledMimic = structuredClone(baseMimic);

            if (floorBoost > 0) {
                scaledMimic.hp += floorBoost * 5; // +5 HP per scaling
                scaledMimic.attack = [
                    scaledMimic.attack[0] + (floorBoost * 3), // Adjust attack range
                    scaledMimic.attack[1] + (floorBoost * 3)
                ];
                scaledMimic.bitcoins += floorBoost * 10; // Increase BTC reward
            }

            return scaledMimic;
        }

        document.addEventListener('keydown', e => {
            const key = e.key.toLowerCase();

            if (gameOver) return;
            if (!player.inCombat && key === 't' && !GameControl.awaitingPersuasionText && !menu.isOpen()) {
                speakingOutsideCombat = true;
                tryPersuade(e);
                return;
            }
            if (GameControl.awaitingPersuasionText) {
                return;
            }

            if (menu.isOpen()) {
                if (! animationActive) {
                    menu.handleInput(key);
                }
            } else if (key === 'escape' && !GameControl.awaitingPersuasionText) {
                menu.open('gameSettings');
            } else if (key === 'i') {
                playSFX('inventoryOpen');
                menu.open('inventory');
            } else if (player.inCombat) {
                switch (key) {
                    case 'a':
                        playerAttack();
                        break;
                    case 'r':
                        tryRun();
                        break;
                    case 'p':
                        tryPersuade(e);
                        break;
                }
            } else {
                switch (key) {
                    case 'w':
                    case 'arrowup':
                        e.preventDefault();
                        move('forward');
                        break;
                    case 's':
                    case 'arrowdown':
                        e.preventDefault();
                        move('backward');
                        break;
                    case 'a':
                    case 'arrowleft':
                        e.preventDefault();
                        turnLeft();
                        break;
                    case 'd':
                    case 'arrowright':
                        e.preventDefault();
                        turnRight();
                        break;
                    case 'q':
                        e.preventDefault();
                        move('strafeLeft');
                        break;
                    case 'e':
                        e.preventDefault();
                        move('strafeRight');
                        break;
                    case 't':
                        speakingOutsideCombat = true;
                        tryPersuade(e);
                        break;
                }
            }
        });


        function descend() {
            floor++;
            updateBattleLog(`Descending into floor ${floor}...`);

            const floorBoost = Math.floor(floor / 2);
            if (floorBoost > lastFloorBoostNotice) {
                updateBattleLog(`<span class="action">As you descend deeper into the dungeon, you sense greater danger than before</span>.`);
                lastFloorBoostNotice = floorBoost;
            }

            if (Math.random() < 0.5) {
                updateBattleLog(randomEntry([
                    "The stale air fills your nostrils.",
                    "You feel like you're being watched.",
                    "A chill creeps down your spine.",
                    "Your torch flickers strangely in the windless corridor.",
                    "A draft carries the scent of mildew, ash, and Lemon " +
                        "Pledge.",
                    "You hear a dog yipping in the distance.",
                    "An empty snail shell lies cracked on the stairs.",
                    "A growl echoes through the hallway.",
                    "A faint smell of urinal cake wafts up from below.",
                    "You hear a toilet flush in the distance.",
                    "There's graffiti on the wall: \"Beware the snail!\"",
                    "You smell something pungent. Possibly ancient evil. " +
                        "<em>Possibly cheese.</em>",
                    "You hear a groan, as if the dungeon itself is aware of " +
                        "your presence.",
                    "Somewhere ahead, something clanks. You sincerely hope " +
                        "it's plumbing.",
                    "You hear a plunger plunging menacingly.",
                ]));
            }

            generateMap();
            animTorchEnd();
            playRandomExplorationMusic();
        }


        const menu = new Menu();
        menu.setMenuElement(document.getElementById("menu"));
        menu.setDefaultItemsPerPage(8);
        menu.setOnOpen(() => {
            GameControl.update();
            updateViewportHeader();
        });
        menu.setOnPageChange(() => GameControl.update());
        menu.setOnHighlight(() => playSFX("uiOption"));
        menu.setOnSelect(() => { 
            playSFX("uiSelect"); 
            GameControl.update(); 
            updateViewportHeader();
        });
        menu.setOnCancel(() => { 
            playSFX("uiCancel"); 
            GameControl.update(); 
            updateViewportHeader();
        });
        menu.setOnClose(() => {
            GameControl.update(); 
            updateViewportHeader();
        });

        menu.setMenus({
            gameSettings: {
                title: "GAME SETTINGS",
                onOpen: () => {
                    Portrait.show('settings');
                },
                onClose: () => {
                    Portrait.hide();
                },
                getOptions: () => [
                    {
                        id: "_back",
                        displayText: "Return to the game",
                        description: "Continue your quest",
                    },
                    {
                        id: "toggleMusic",
                        displayText: musicEnabled
                            ? "Disable music"
                            : "Enable music",
                        description: musicEnabled
                            ? "Turn off the in-game music"
                            : "Turn on the in game music",
                    },
                    {
                        id: "toggleSFX",
                        displayText: sfxEnabled ? "Disable SFX" : "Enable SFX",
                        description: sfxEnabled
                            ? "Disable sound effects"
                            : "Enable sound effects",
                    },
                    {
                        id: "toggleSpeech",
                        displayText: speechEnabled ? "Disable speech" : "Enable speech",
                        description:
                            `${speechEnabled ? 'Disable' : 'Enable'} the ` +
                            `party member and NPC speaking voices`,
                    },
                    {
                        id: "toggleSkipTitleScreen",
                        displayText: skipTitleScreen ? "Disable quickstart" : "Enable quickstart",
                        description: skipTitleScreen
                            ? "Skip the title screen automatically upon starting the game"
                            : "Enable the title screen upon starting the game",
                    },
                    {
                        id: "toggleEatRatAnimation",
                        displayText: eatRatAnimationEnabled
                            ? "Disable level up animation"
                            : "Enable level up animation",
                        description: eatRatAnimationEnabled
                            ? "Disable rat consumption animation on level up"
                            : "Enable rat consumption animation on level up",
                    },
                    {
                        id: "resetGame",
                        displayText: "Reset the game",
                        description:
                            "Abandon your current game and return to the " +
                            "title screen",
                    },
                ],
                select: (selectedOptionId) => {
                    switch (selectedOptionId) {
                        case "toggleMusic":
                            musicEnabled = !musicEnabled;
                            saveSettings();
                            stopAllMusic();
                            if (musicEnabled) {
                                player.inCombat
                                    ? playRandomBattleMusic()
                                    : (currentExplorationTrack
                                        ? resumeExplorationMusic()
                                        : playRandomExplorationMusic()
                                    );
                            }
                            break;
                        case "toggleSFX":
                            sfxEnabled = !sfxEnabled;
                            saveSettings();
                            break;
                        case "toggleSpeech":
                            speechEnabled = !speechEnabled;
                            saveSettings();
                            break;
                        case "toggleSkipTitleScreen":
                            skipTitleScreen = !skipTitleScreen;
                            saveSettings();
                            break;
                        case "toggleEatRatAnimation":
                            eatRatAnimationEnabled = !eatRatAnimationEnabled;
                            saveSettings();
                            break;
                        case "resetGame":
                            menu.open("resetGameConfirmation");
                            break;
                    }
                },
            },
            resetGameConfirmation: {
                title: "RESET GAME",
                landingHtml: () =>
                    "Are you sure you want to reset the game?",
                getOptions: () => [
                    {
                        id: "_back",
                        displayText: "NO! Do not reset the game!",
                        description: "Go back to the previous menu",
                    },
                    {
                        id: "reset",
                        displayText: "Yes, waste my progress",
                        description:
                            "Abandon the current game and start again " +
                            "from the first floor",
                    },
                ],
                select: () => window.location.reload(),
            },
            inventory: {
                title: "INVENTORY",
                landingHtml: () => {
                    return isEmpty(player.inventory)
                        ? 'You own nothing. Klaus Schwab would be proud'
                        : null;
                },
                getOptions: () => [
                    {
                        id: "inventoryItems",
                        displayText: "Items",
                        description: "View your consumable items.",
                    },
                    {
                        id: "inventoryEquipment",
                        displayText: "Equipment",
                        description: "View and change your equipped weapon and armor.",
                        className: player.inCombat ? "tooExpensive" : undefined,
                        disabled: player.inCombat,
                    },
                    {
                        id: "_back",
                        displayText: "[Back]",
                        description: "Get back to playing the game",
                    }
                ],
                select: (selectedOptionId) => {
                    // When in battle, disable equipment submenus
                    if (selectedOptionId === "inventoryEquipment" && player.inCombat) {
                        updateBattleLog(
                            `Your foe's <span class="action">deathly ` +
                            `stare</span> prevents you from wanting to strip ` +
                            `down into a new set of equipment!`
                        );
                        return;
                    }
                    menu.open(selectedOptionId);
                },
                onOpen: () => {
                    Portrait.show('inventory');
                },
                onClose: () => {
                    Portrait.hide();
                },
            },
            inventoryItems: {
                title: "INVENTORY > ITEMS",
                landingHtml: () => {
                    return isEmpty(player.inventory)
                        ? 'You own nothing. Klaus Schwab would be proud'
                        : null;
                },
                getOptions: () => {
                    const options = Object.keys(player.inventory)
                        .filter(itemId => items[itemId])
                        .map((itemId) => ({
                            id: itemId,
                            displayText: items[itemId].name,
                            description: items[itemId].description,
                            trailText: `${player.inventory[itemId]}`,
                        }));

                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to the inventory menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    useItem(selectedOptionId);
                    menu.closeAll(); // Close all menus after using an item
                    if (currentEnemy && currentEnemy.hp > 0) {
                        enemyAttack();
                        render();
                    }
                },
            },
            inventoryEquipment: {
                title: "INVENTORY > EQUIPMENT",
                getOptions: () => {
                    const weapon = weapons[player.weapon];
                    const armorPiece = armor[player.armor];
                    const ring1 = player.ring1 ? rings[player.ring1]?.name : "None";
                    const ring2 = player.ring2 ? rings[player.ring2]?.name : "None";
                    return [
                        {
                            id: "equipHand",
                            displayText: `Hand: ${weapon?.name || "None"}`,
                            description: "View and equip your weapons.",
                        },
                        {
                            id: "equipBody",
                            displayText: `Body: ${armorPiece?.name || "None"}`,
                            description: "View and equip your armor.",
                        },
                        {
                            id: "equipRings",
                            displayText: `Rings: ${ring1}\n         ${ring2}`,
                            description: "View and equip your rings.",
                        },
                        {
                            id: "_back",
                            displayText: "[Back]",
                            description: "Return to the inventory menu",
                        }
                    ];
                },
                select: (selectedOptionId) => {
                    menu.open(selectedOptionId);
                },
            },
            equipHand: {
                title: "INVENTORY > EQUIPMENT > EQUIP WEAPON",
                getOptions: () => {
                    const ownedWeapons = Object.keys(weapons).filter(w => player.inventory[w] > 0 || player.weapon === w);
                    return ownedWeapons.map((weaponId) => {
                        const req = weapons[weaponId].requiredStr || 0;
                        const meetsReq = player.strength >= req;
                        const reqStrHtml = `<span class="${meetsReq ? 'friendly' : 'enemy'}">STR ${req}</span>`;
                        return {
                            id: weaponId,
                            displayText: weapons[weaponId].name + (player.weapon === weaponId ? " (Equipped)" : ""),
                            description:
                                `${weapons[weaponId].description}\n` +
                                `Base Damage: ${weapons[weaponId].damage.base}, ` +
                                `Random Multiplier: ${weapons[weaponId].damage.randomMultiplier}\n` +
                                `LOAD: ${weapons[weaponId].weight}\n` +
                                `Stat Requirement: ${reqStrHtml}`,
                            className: !meetsReq ? "tooExpensive" : (player.weapon === weaponId ? "friendly" : undefined),
                            disabled: !meetsReq,
                        };
                    }).concat([{
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to equipment menu",
                    }]);
                },
                select: (selectedOptionId) => {
                    const weapon = weapons[selectedOptionId];
                    if (!weapon) return;
                    const req = weapon.requiredStr || 0;
                    if (player.strength < req) {
                        updateBattleLog(`You require <span class="STR">${req} STR</span> to handle this weapon!`);
                        return;
                    }
                    player.weapon = selectedOptionId;
                    updateBattleLog(`You now wield a mighty <span class="friendly">${weapon.name}</span>!`);
                    menu.close();
                    render();
                },
            },

            equipBody: {
                title: "INVENTORY > EQUIPMENT > EQUIP ARMOR",
                getOptions: () => {
                    const ownedArmor = Object.keys(armor).filter(a => player.inventory[a] > 0 || player.armor === a);
                    return ownedArmor.map((armorId) => {
                        const req = armor[armorId].requiredEnd || 0;
                        const meetsReq = player.endurance >= req;
                        const reqEndHtml = `<span class="${meetsReq ? 'friendly' : 'enemy'}">END ${req}</span>`;
                        return {
                            id: armorId,
                            displayText: armor[armorId].name + (player.armor === armorId ? " (Equipped)" : ""),
                            description:
                                `${armor[armorId].description}\n` +
                                `Defense: ${armor[armorId].defense}\n` +
                                `LOAD: ${armor[armorId].weight}\n` +
                                `Stat Requirement: ${reqEndHtml}`,
                            className: !meetsReq ? "tooExpensive" : (player.armor === armorId ? "friendly" : undefined),
                            disabled: !meetsReq,
                        };
                    }).concat([{
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to equipment menu",
                    }]);
                },
                select: (selectedOptionId) => {
                    const armorPiece = armor[selectedOptionId];
                    if (!armorPiece) return;
                    const req = armorPiece.requiredEnd || 0;
                    if (player.endurance < req) {
                        updateBattleLog(`You need <span class="END">${req} END</span> to wear this garment!`);
                        return;
                    }
                    player.armor = selectedOptionId;
                    updateBattleLog(
                        `You are now wearing ${armorPiece.article} ` +
                        `<span class="friendly">${armorPiece.name}</span>!`
                    );
                    if (player.hp > getEffectiveStat('maxHp')) {
                        player.hp = getEffectiveStat('maxHp');
                    }
                    menu.close();
                    render();
                },
            },
            equipRings: {
                title: "INVENTORY > EQUIPMENT > EQUIP RINGS",
                getOptions: () => {
                    return [
                        {
                            id: "ring1",
                            displayText: `Slot 1: ${player.ring1 ? rings[player.ring1].name + " (Equipped)" : "None"}`,
                            description: "Equip a ring to Slot 1.",
                        },
                        {
                            id: "ring2",
                            displayText: `Slot 2: ${player.ring2 ? rings[player.ring2].name + " (Equipped)" : "None"}`,
                            description: "Equip a ring to Slot 2.",
                        },
                        {
                            id: "_back",
                            displayText: "[Back]",
                            description: "Return to equipment menu",
                        }
                    ];
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "ring1") {
                        menu.open("ring1Select");
                    } else if (selectedOptionId === "ring2") {
                        menu.open("ring2Select");
                    } else {
                        if (player.hp > getEffectiveStat('maxHp')) {
                            player.hp = getEffectiveStat('maxHp');
                        }
                        menu.close();
                        render();
                    }
                },
            },
            ring1Select: {
                title: "INVENTORY > EQUIPMENT > EQUIP RINGS > SLOT 1",
                getOptions: () => {
                    const ownedRings = Object.keys(rings).filter(r => player.inventory[r] > 0 || player.ring1 === r || player.ring2 === r);
                    const options = ownedRings.map((ringId) => ({
                        id: ringId,
                        displayText: rings[ringId].name + (player.ring1 === ringId ? " (Equipped)" : ""),
                        description: rings[ringId].description,
                        className: player.ring1 === ringId
                            ? "friendly"
                            : player.ring2 === ringId
                                ? "muted"
                                : undefined,
                    }));
                    options.unshift({
                        id: null,
                        displayText: "None",
                        description: "Unequip this ring slot.",
                    });
                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to rings menu",
                    });
                    return options;
                },
                select: (selectedOptionId) => {
                    if (player.equipRing(1, selectedOptionId)) {
                        menu.close();
                        render();
                    }
                },
            },

            ring2Select: {
                title: "INVENTORY > EQUIPMENT > EQUIP RINGS > SLOT 2",
                getOptions: () => {
                    const ownedRings = Object.keys(rings).filter(r => player.inventory[r] > 0 || player.ring1 === r || player.ring2 === r);
                    const options = ownedRings.map((ringId) => ({
                        id: ringId,
                        displayText: rings[ringId].name + (player.ring2 === ringId ? " (Equipped)" : ""),
                        description: rings[ringId].description,
                        className: player.ring2 === ringId
                            ? "friendly"
                            : player.ring1 === ringId
                                ? "muted"
                                : undefined,
                    }));
                    options.unshift({
                        id: null,
                        displayText: "None",
                        description: "Unequip this ring slot.",
                    });
                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to rings menu",
                    });
                    return options;
                },
                select: (selectedOptionId) => {
                    if (player.equipRing(2, selectedOptionId)) {
                        menu.close();
                        render();
                    }
                },
            },

            merchant: {
                title: "MERCHANT",
                onOpen: () => {
                    Portrait.show('merchant');
                    merchant.say('Welcome to SlobMart!');
                },
                onClose: () => {
                    merchant.say('Thank you. Come again!');
                    Portrait.hide();
                },
                landingHtml: () => {
                    return player.bitcoins > 0
                        ? `You have <span class="BTC">${player.bitcoins} BTC</span> in your wallet`
                        : "Your wallet is emptier than a lughead's skull. But you can still look around";
                },
                getOptions: () => {
                    return [
                        {
                            id: "merchantItems",
                            displayText: "Items",
                            description: "See what consumable items are for sale",
                        },
                        {
                            id: "merchantWeapons",
                            displayText: "Weapons",
                            description: "Look at some weapon upgrades",
                        },
                        {
                            id: "merchantArmor",
                            displayText: "Armor",
                            description: "Get some thicker skin",
                        },
                        {
                            id: "merchantRings",
                            displayText: "Rings",
                            description: "Jewelry that will probably turn you gay",
                        },
                        {
                            id: "merchantSell",
                            displayText: "Sell",
                            description: "Sell your items, filthy garb, and dangerous arms",
                        },
                        {
                            id: "_back",
                            displayText: "Leave",
                            description: "Get back to spelunking",
                        },
                    ];
                },
                select: (selectedOptionId) => {
                    menu.open(selectedOptionId);
                },
            },
            merchantItems: {
                title: "MERCHANT > ITEMS",
                landingHtml: () => {
                    return player.bitcoins > 0
                        ? `You have <span class="BTC">${player.bitcoins} BTC</span> in your wallet`
                        : "Your wallet is emptier than a lughead's skull. But you can still look around";
                },
                getOptions: () => {
                    const options = merchant.items.map((itemId) => ({
                        id: itemId,
                        displayText: items[itemId].name,
                        description: items[itemId].description,
                        trailText: `${items[itemId].price} BTC`,
                        disabled: items[itemId].price > player.bitcoins,
                        className: items[itemId].price > player.bitcoins ? 'tooExpensive' : undefined,
                    }));

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy('item', selectedOptionId);
                },
            },
            merchantWeapons: {
                title: "MERCHANT > WEAPONS",
                landingHtml: () => {
                    const message = player.bitcoins > 0
                        ? `You have <span class="BTC">${player.bitcoins} BTC</span> in your wallet`
                        : "Your wallet is emptier than a lughead's skull. But you can still look around";

                    const currentWeapon = weapons[player.weapon];
                    const article =
                        currentWeapon?.article ? `${currentWeapon.article} ` : '';
                    const currentWeaponDisplay = article + currentWeapon.name;
                    const wieldingMessage = `You are currently wielding ${currentWeaponDisplay}`;

                    return `${message}\n\n${wieldingMessage}`;
                },
                getOptions: () => {
                    const weaponKeys = Object.keys(weapons);
                    const options = weaponKeys.map((weaponId) => {
                        const tooExpensive = weapons[weaponId].price > player.bitcoins;
                        const alreadyOwned = player.inventory[weaponId] > 0 || player.weapon === weaponId;
                        const reqStr = weapons[weaponId].requiredStr || 0;
                        const meetsReq = player.strength >= reqStr;
                        const reqStrHtml = `<span class="${meetsReq ? 'friendly' : 'enemy'}">STR ${reqStr}</span>`;
                        return {
                            id: weaponId,
                            displayText: weapons[weaponId].name,
                            description:
                                `${weapons[weaponId].description}\n` +
                                `Base Damage: ${weapons[weaponId].damage.base}, ` +
                                `Random Multiplier: ${weapons[weaponId].damage.randomMultiplier}\n` +
                                `LOAD: ${weapons[weaponId].weight}\n` +
                                `Stat Requirement: ${reqStrHtml}`,
                            trailText: `${weapons[weaponId].price} BTC`,
                            disabled: tooExpensive || alreadyOwned,
                            className: alreadyOwned ? 'muted' : (tooExpensive ? 'tooExpensive' : undefined),
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy('weapon', selectedOptionId);
                },
            },
            merchantArmor: {
                title: "MERCHANT > ARMOR",
                landingHtml: () => {
                    const message = player.bitcoins > 0
                        ? `You have <span class="BTC">${player.bitcoins} BTC</span> in your wallet`
                        : "Your wallet is emptier than a lughead's skull. But you can still look around";

                    const currentArmor = armor[player.armor];
                    const article =
                        currentArmor?.article ? `${currentArmor.article} ` : '';
                    const currentArmorDisplay = article + currentArmor.name;
                    const wearingMessage = `You are currently wearing ${currentArmorDisplay}`;

                    return `${message}\n\n${wearingMessage}`;
                },
                getOptions: () => {
                    const armorKeys = Object.keys(armor);
                    const options = armorKeys.map((armorId) => {
                        const tooExpensive = armor[armorId].price > player.bitcoins;
                        const alreadyOwned = player.inventory[armorId] > 0 || player.armor === armorId;
                        const reqEnd = armor[armorId].requiredEnd || 0;
                        const meetsReq = player.endurance >= reqEnd;
                        const reqEndHtml = `<span class="${meetsReq ? 'friendly' : 'enemy'}">END ${reqEnd}</span>`;
                        return {
                            id: armorId,
                            displayText: armor[armorId].name,
                            description:
                                `${armor[armorId].description}\n` +
                                `Defense: ${armor[armorId].defense}\n` +
                                `LOAD: ${armor[armorId].weight}\n` +
                                `Stat Requirement: ${reqEndHtml}`,
                            trailText: `${armor[armorId].price} BTC`,
                            disabled: tooExpensive || alreadyOwned,
                            className: alreadyOwned ? 'muted' : (tooExpensive ? 'tooExpensive' : undefined),
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy('armor', selectedOptionId);
                },
            },
            merchantRings: {
                title: "MERCHANT > RINGS",
                landingHtml: () => {
                    return player.bitcoins > 0
                        ? `You have <span class="BTC">${player.bitcoins} BTC</span> in your wallet`
                        : "Your wallet is emptier than a lughead's skull. But you can still look around";
                },
                getOptions: () => {
                    const options = (merchant.rings || []).map((ringId) => {
                        const tooExpensive = rings[ringId].price > player.bitcoins;
                        const alreadyOwned = player.inventory[ringId] > 0 || player.ring1 === ringId || player.ring2 === ringId;
                        return {
                            id: ringId,
                            displayText: rings[ringId].name,
                            description: rings[ringId].description,
                            trailText: `${rings[ringId].price} BTC`,
                            disabled: tooExpensive || alreadyOwned,
                            className: alreadyOwned ? 'muted' : (tooExpensive ? 'tooExpensive' : undefined),
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    // Buy logic for rings
                    merchant.buy('ring', selectedOptionId);
                    render();
                    menu.render();
                },
            },

            merchantSell: {
                title: "MERCHANT > SELL",
                landingHtml: () => {
                    return `Sell your unwanted inventory for a small sum.\n\nYou have <span class="BTC">${player.bitcoins} BTC</span> in your wallet.`;
                },
                getOptions: () => {
                    const weaponOptions = Object.keys(weapons)
                        .filter(w => player.inventory[w] > 0)
                        .map(weaponId => ({
                            id: `sell_weapon_${weaponId}`,
                            displayText: `[W] ${weapons[weaponId].name}`,
                            description: `Sell for <span class="BTC">₿${Math.max(1, Math.floor(weapons[weaponId].price / 10))}</span>`,
                            trailText: `${player.inventory[weaponId]}`,
                            disabled: player.weapon === weaponId,
                            className: player.weapon === weaponId ? "muted" : undefined,
                        }));
                    const armorOptions = Object.keys(armor)
                        .filter(a => player.inventory[a] > 0)
                        .map(armorId => ({
                            id: `sell_armor_${armorId}`,
                            displayText: `[A] ${armor[armorId].name}`,
                            description: `Sell for <span class="BTC">₿${Math.max(1, Math.floor(armor[armorId].price / 10))}</span>`,
                            trailText: `${player.inventory[armorId]}`,
                            disabled: player.armor === armorId,
                            className: player.armor === armorId ? "muted" : undefined,
                        }));
                    const itemOptions = Object.keys(items)
                        .filter(itemId => player.inventory[itemId] > 0)
                        .map(itemId => ({
                            id: `sell_item_${itemId}`,
                            displayText: `[I] ${items[itemId].name}`,
                            description: `Sell for <span class="BTC">₿${Math.max(1, Math.floor(items[itemId].price / 5))}</span>`,
                            trailText: `${player.inventory[itemId]}`,
                            disabled: false,
                            className: undefined,
                        }));
                    const ringOptions = Object.keys(rings)
                        .filter(ringId => player.inventory[ringId] > 0)
                        .map(ringId => ({
                            id: `sell_ring_${ringId}`,
                            displayText: `[R] ${rings[ringId].name}`,
                            description: `Sell for <span class="BTC">₿${Math.max(1, Math.floor(rings[ringId].price / 5))}</span>`,
                            trailText: `${player.inventory[ringId]}`,
                            disabled: player.ring1 === ringId || player.ring2 === ringId,
                            className: (player.ring1 === ringId || player.ring2 === ringId) ? "muted" : undefined,
                        }));

                    const options = [...weaponOptions, ...armorOptions, ...ringOptions, ...itemOptions];
                    if (options.length === 0) {
                        options.push({
                            id: "_none",
                            displayText: "Nothing to sell",
                            description: "You have no weapons, armor, or items to sell.",
                            disabled: true,
                            className: "muted",
                        });
                    }
                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to the merchant menu",
                    });
                    return options;
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "_back" || selectedOptionId === "_none") {
                        menu.close();
                        return;
                    }

                    const [_, type, itemId] = selectedOptionId.split("_");
                    let soldObject, value = 0;

                    if (type === "weapon") {
                        if (player.weapon === itemId) {
                            merchant.say("You sure you wanna point that thing at me? I've got a 12 gauge hidden under my sleeve, you know...");
                            return;
                        }
                        if (player.inventory[itemId] > 0) {
                            soldObject = weapons[itemId];
                            value = merchant.getSalePrice('weapon', weapons[itemId].price);
                            player.giveBitcoins(value);
                            player.inventory[itemId]--;
                            if (player.inventory[itemId] <= 0) delete player.inventory[itemId];
                        } else {
                            console.error("Tried to sell an item that the player does not have", { itemId });
                            return;
                        }
                    } else if (type === "armor") {
                        if (player.armor === itemId) {
                            merchant.say("What are you, a Lughead? You gotta strip down before you go selling that!");
                            return;
                        }
                        if (player.inventory[itemId] > 0) {
                            soldObject = armor[itemId];
                            value = merchant.getSalePrice('armor', armor[itemId].price);
                            player.giveBitcoins(value);
                            player.inventory[itemId]--;
                            if (player.inventory[itemId] <= 0) delete player.inventory[itemId];
                        } else {
                            console.error("Tried to sell armor that the player does not have", { itemId });
                            return;
                        }
                    } else if (type === "ring") {
                        if (player.hasEquippedRing(itemId)) {
                            merchant.say("I don't swing that way, kid, but if you really wanna propose you gotta take the damn ring off.");
                            return;
                        }
                        if (player.inventory[itemId] > 0) {
                            soldObject = rings[itemId];
                            value = merchant.getSalePrice('ring', rings[itemId].price);
                            player.giveBitcoins(value);
                            player.inventory[itemId]--;
                            if (player.inventory[itemId] <= 0) delete player.inventory[itemId];
                        } else {
                            console.error("Tried to sell a ring that the player does not have", { itemId });
                            return;
                        }
                    } else if (type === "item") {
                        if (player.inventory[itemId] > 0) {
                            soldObject = items[itemId];
                            value = merchant.getSalePrice('item', items[itemId].price);
                            player.giveBitcoins(value);
                            player.inventory[itemId]--;
                            if (player.inventory[itemId] <= 0) delete player.inventory[itemId];
                        } else {
                            console.error("Tried to sell an item that the player does not have", { itemId });
                            return;
                        }
                    }

                    playSFX('kaching');
                    merchant.printTransactionMessage('sold', soldObject, value);
                    menu.render();
                    render();
                },
            },

            gambler: {
                title: "GAMBLER",
                onOpen: () => {
                    Portrait.show('gambler');
                    gambler.say('Place yer bets!');
                },
                onClose: () => {
                    gambler.isActiveOnFloor = false;
                    const gamblerPosition = gambler.location();
                    if (gamblerPosition) {
                        MAP.setCell(gamblerPosition.x, gamblerPosition.y);
                    }
                    Portrait.hide();
                },
                landingHtml: () => {
                    return (
                        `<span class="gambler">&lt;GAMBLER&gt;</span> "Welcome, dungeon dweller! ` +
                        `<span class="friendly">Roll a 12</span> and <span class="BTC">boost one of yer stats.</span> ` +
                        `Just <span class="tooExpensive">${gambler.playPrice}</span> to play!"\n\n` +
                        `You have <span class="BTC">${player.bitcoins} BTC</span> in your wallet`
                    );
                },
                getOptions: () => {
                    return [
                        {
                            id: "play",
                            displayText: "Play the game",
                            trailText: `${gambler.playPrice} BTC`,
                            description: "Take your chance with the gambler",
                        },
                        {
                            id: "_back",
                            displayText: "Leave",
                            description: "Leave this crusty fool",
                        },
                    ];
                },
                select: () => {
                    gamble();
                },
            },
            chest: {
                title: "TREASURE CHEST",
                onOpen: () => {
                    Portrait.show('chest');
                },
                onClose: () => {
                    Portrait.hide();
                },
                landingHtml: () => {
                    return `\n\n\nYou found a treasure chest! Do you want to open it?`;
                },
                getOptions: () => {
                    return [
                        {
                            id: "open",
                            displayText: "Hell yeah! Fondle that booty!",
                            description: "Claim your succulent reward!",
                        },
                        {
                            id: "_back",
                            displayText: "Resist your burning temptation...",
                            description: "DON'T claim your succulent reward!",
                        },
                    ];
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "open") {
                        openChest();
                    }
                    menu.close();
                    render();
                },
            },
            statAllocation: {
                itemsPerPage: 12,
                // Prevent menu from being closed with the Escape key
                escapeDisabled: true,
                title: () => isLevelUpAllocation ? "LEVEL UP" : "STAT ALLOCATION",
                landingHtml: () => {
                    return isLevelUpAllocation
                        ? `You leveled up! Allocate <span class="action">${player.remainingPoints}</span> points to your stats.`
                        : `Build your character using the <span class="action">${player.remainingPoints}</span> points you have been allotted. Use them wisely...`;
                },
                getOptions: () => {
                    // Helper to determine if a stat should be red
                    function isStatCapped(statKey) {
                        return isLevelUpAllocation && levelUpStatPointsAllocated[statKey] >= 2;
                    }
                    return [
                        ...(!isLevelUpAllocation ? [{
                            id: "rollDice",
                            displayText: "[Diceroll]",
                            description: "Randomly allocate your points.",
                        }] : []),
                        {
                            id: "hp",
                            displayText: `HP: ${player.maxHp}`,
                            className: isStatCapped("maxHp") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases Health Points.",
                        },
                        {
                            id: "defense",
                            displayText: `DEF: ${player.defense}`,
                            className: isStatCapped("defense") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases defense against enemy attacks.",
                        },
                        {
                            id: "strength",
                            displayText: `STR: ${player.strength}`,
                            className: isStatCapped("strength") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your base ATK by 1 and allows you to equip higher grade weapons.",
                        },
                        {
                            id: "persuasion",
                            displayText: `PRS: ${player.persuasion}`,
                            className: isStatCapped("persuasion") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your chances at persuading monsters to join your party.",
                        },
                        {
                            id: "endurance",
                            displayText: `END: ${player.endurance}`,
                            className: isStatCapped("endurance") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your carry load and allows you to equip higher grade armor.",
                        },
                        {
                            id: "speed",
                            displayText: `SPD: ${player.speed}`,
                            className: isStatCapped("speed") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your movement speed. Each point allows you to move 5% faster.",
                        },
                        {
                            id: "luck",
                            displayText: `LUK: ${player.luck}`,
                            className: isStatCapped("luck") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases crit rates and BTC rewards from chests.",
                        },
                        {
                            id: "reset",
                            displayText: "[Reset]",
                            description: isLevelUpAllocation
                                ? "Reset your level up stat allocation."
                                : "Reset your stat allocation.",
                        },
                        {
                            id: "confirm",
                            displayText: "[Confirm]",
                            className: player.remainingPoints > 0 ? 'tooExpensive' : undefined,
                            description: isLevelUpAllocation
                                ? "Finish your level up and continue your adventure!"
                                : "Begin YOUR TardQuest!",
                        },
                    ];
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "confirm") {
                        if (player.remainingPoints > 0) {
                            updateBattleLog("You must allocate all points before continuing!");
                            return;
                        }
                        if (isLevelUpAllocation) {
                            isLevelUpAllocation = false;
                            updateBattleLog("Stats increased! You consume an unsuspecting rat to restore your health. Poor feller...");
                        } else {
                            updateBattleLog(
                                `Stat allocation complete! You consume an ` +
                                `unsuspecting rat to ensure you are in good ` +
                                `health, and <span class="friendly">your ` +
                                `adventure begins</span>...`
                            );
                        }
                        menu.close();
                        render();
                        if (eatRatAnimationEnabled) {
                            GameControl.disableControls();
                            animEatRat(() => GameControl.enableControls());
                        }
                    } else if (selectedOptionId === "reset") {
                        if (isLevelUpAllocation) {
                            player.hp = player.maxHp = levelUpAllocatedStats.base.maxHp;
                            player.defense = levelUpAllocatedStats.base.defense;
                            player.strength = levelUpAllocatedStats.base.strength;
                            player.persuasion = levelUpAllocatedStats.base.persuasion;
                            player.endurance = levelUpAllocatedStats.base.endurance;
                            player.speed = levelUpAllocatedStats.base.speed;
                            player.luck = levelUpAllocatedStats.base.luck;
                            player.remainingPoints = 6;
                            // Reset the per-stat allocation tracker
                            levelUpStatPointsAllocated = {
                                maxHp: 0,
                                defense: 0,
                                strength: 0,
                                persuasion: 0,
                                endurance: 0,
                                speed: 0,
                                luck: 0
                            };
                            updateBattleLog("Level up stat allocation has been reset.");
                        } else {
                            resetStats();
                        }
                        menu.render();
                        render();
                    } else if (!isLevelUpAllocation && selectedOptionId === "rollDice") {
                        rollDiceForStats();
                        menu.render();
                        render();
                    } else if (player.remainingPoints > 0) {
                        // Only restrict during level up, not initial allocation
                        if (isLevelUpAllocation) {
                            let statKey = null;
                            switch (selectedOptionId) {
                                case "hp": statKey = "maxHp"; break;
                                case "defense": statKey = "defense"; break;
                                case "strength": statKey = "strength"; break;
                                case "persuasion": statKey = "persuasion"; break;
                                case "endurance": statKey = "endurance"; break;
                                case "speed": statKey = "speed"; break;
                                case "luck": statKey = "luck"; break;
                            }
                            if (statKey && levelUpStatPointsAllocated[statKey] >= 2) {
                                updateBattleLog(`<span class="action">You are only allowed 2 points per stat at a time!</span>`);
                                return;
                            }
                            if (statKey) {
                                player[statKey] += 1;
                                levelUpStatPointsAllocated[statKey]++;
                                if (statKey === "maxHp") player.hp = player.maxHp;
                                player.remainingPoints--;
                                menu.render();
                                render();
                                return;
                            }
                        } else {
                            switch (selectedOptionId) {
                                case "hp":
                                    player.maxHp += 1;
                                    player.hp = player.maxHp;
                                    break;
                                case "defense":
                                case "strength":
                                case "persuasion":
                                case "endurance":
                                case "speed":
                                case "luck":
                                    player[selectedOptionId]++;
                                    break;
                            }
                            player.remainingPoints--;
                            menu.render();
                            render();
                        }
                    } else {
                        updateBattleLog("No points remaining to allocate!");
                    }
                },
            }
        });


        generateMap();
        updateSeenTiles();
        playRandomExplorationMusic();
        render();

        let isLevelUpAllocation = false;
        let levelUpAllocatedStats = {};
        let levelUpStatPointsAllocated = {};

        function startLevelUpAllocation() {
            isLevelUpAllocation = true;
            levelUpAllocatedStats = {};
            player.remainingPoints = 6;
            levelUpAllocatedStats.base = {
                maxHp: player.maxHp,
                defense: player.defense,
                strength: player.strength,
                endurance: player.endurance,
                persuasion: player.persuasion,
                speed: player.speed,
                luck: player.luck
            };
            // Track how many points have been allocated to each stat this level-up
            levelUpStatPointsAllocated = {
                maxHp: 0,
                defense: 0,
                strength: 0,
                persuasion: 0,
                endurance: 0,
                speed: 0,
                luck: 0
            };
            player.levelUp();
            menu.open("statAllocation");
        }

        player.remainingPoints = 12; //Points to allocate at start of game

        function resetStats() {
            player.remainingPoints = 12;
            player.maxHp = baseStats.maxHp;
            player.hp = player.maxHp;
            player.defense = baseStats.defense;
            player.strength = baseStats.strength;
            player.persuasion = baseStats.persuasion;
            player.endurance = baseStats.endurance;
            player.speed = baseStats.speed;
            player.luck = baseStats.luck;
            updateBattleLog("Stat allocation has been reset. Start over!");
        }

        function rollDiceForStats() {
            resetStats();
            const stats = [
                "hp", "defense", "strength", "persuasion", "endurance",
                "speed", "luck"
            ];

            while (player.remainingPoints > 0) {
                const stat = randomEntry(stats);
                switch (stat) {
                    case "hp":
                        player.maxHp++;
                        player.hp = player.maxHp;
                        break;
                    case "defense":
                    case "strength":
                    case "persuasion":
                    case "endurance":
                    case "speed":
                    case "luck":
                        player[stat]++;
                        break;
                }
                player.remainingPoints--;
            }
            updateBattleLog("Points have been randomly allocated. Good luck!");
        }

        menu.open("statAllocation");

        const gambleFrames = [
    `



                  _____
                 /     -.
                 \\____.--


    `,

    `



              _,--.
             ( ;.  \`-.
             (  '    _
              \`-___-'

    `,

    `



           _,-.-.
          (_;.   \`-.
         (__:
          (__.'    _
           \`-____-'

    `,

    `


       _,-.-.
      (_;.   \`-.
      (__:
      (__'
      (__.'    _
       \`-____-'

    `,

    `


     _,--.---.
    (_;-.__   \`-.
    (______)
    (______)
    (_____)     _
     \`-_______-'

    `,

    `

          ____
     ____'._  '.
    (____)_ \`.  \`-.
    (______)\\
     (______)
      (_____)     _
       \`-_______-'

    `,

    `

            ..__
    ________\`.  '-
   (__)______ \`.  '-.
    (__)__/_\\
      (____)
       (___)        _
         \`-_______-'

    `,

    `

              ..__
    __________\`.  '-
   (___________ \`.  '-.
    (______..--.
      (__)_||__|
        (_)_          _
           \`-_______-'

    `,

    `

                ..__
      __________\`.  '-
     (___________ \`.  '-.
      (__________
       (________
       .-'--._ .----_   _
       | |  | |\` ___'.-'
       \`.|..' ' \`    |
               \`|____'

    `,

    `

                      ..__
            __________\`.  '-
           (___________ \`.  '-.
            (__________
             (________
               (____          _
                    \`-______-'
       .-----       .----.
      / \`.   \`.    /      \\
     /    '.___\`. /________\\
     \`.   /    /  \\        /
       \`./____/    \\      /
                    \`----'
    `,

    `

                          ..__
                __________\`.  '-
               (___________ \`.  '-.
                (__________
                 (________
                   (____
                        \`-______-


    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

    `


                         _________
                        (_________
                          (_______
                           (______
                             (____



    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

    `


                                 _
                                (_






    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

    `










    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

];
    const dieDigit = [
        ['▗▄▋  ', ' ▐▋  ', '▝▀▀▘ '], // 1
        ['▄▀▀▄ ', ' ▄▀  ', '▀▀▀▀▘'], // 2
        ['▄▀▀▄ ', '  ▀▄ ', '▀▄▄▀ '], // 3
        ['█  █ ', '▀▀▀█ ', '   ▀ '], // 4
        ['█▀▀▀ ', '▀▀▀▄ ', '▀▄▄▀ '], // 5
        ['▄▀▀▀ ', '█▀▀▄ ', '▀▄▄▀ '], // 6
    ];



    // --- TITLE SCREEN LOGIC ---
    const $titleScreen = document.getElementById('titleScreen');

        function showTitleScreen() {
            playTitleMusic();
            $titleScreen.style.display = 'flex';
            stopAllMusic();
            window._inputBlocked = true;
        }
        function hideTitleScreen() {
            stopTitleMusic();
            // Start wipe-in
            const wipe = document.getElementById('screenWipe');
            wipe.classList.add('active');
            $titleScreen.style.transition = '';
            $titleScreen.style.opacity = 1;

            setTimeout(() => {
                $titleScreen.style.display = 'none';
                window._inputBlocked = false;
                playRandomExplorationMusic();
                render();

                // Start wipe-out (reveal)
                wipe.classList.remove('active');
                wipe.classList.add('reveal');

                setTimeout(() => {
                    wipe.classList.remove('reveal');
                }, 500);
            }, 500);
        }

        document.addEventListener('keydown', function titleScreenHandler(e) {
            if ($titleScreen.style.display !== 'none' && (e.key === 'Enter' || e.key === ' ')) {
                hideTitleScreen();
                document.removeEventListener('keydown', titleScreenHandler);
                e.preventDefault();
                e.stopImmediatePropagation();
            }
        }, true);

        if (skipTitleScreen) {
            hideTitleScreen();
            stopAllMusic();
        } else {
            showTitleScreen();
        }

        GameControl.update();

    </script>


</body></html>