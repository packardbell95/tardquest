<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <link rel="preload" href="scripts/preloader-v2.js" as="script">
    <title>TARDQUEST</title>
    <script>
        // Early SW registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('scripts/sw.js').catch(()=>{});
        }
    </script>
</head>
<body>
    <div id="titleScreen" class="hidden"></div>
    <div id="vampireFocalPoint"></div>
    <div id="vampireFocalPointDesaturationOverlay"></div>
    <div id="interface" class="hidden">
        <div id="animDamageTaken"></div>
        <div id="battleLog"></div>
        <div id="topLeft">
            <pre id="portraitArtOverlay" class="portrait-art hidden"></pre>
            <div id="minimapContainer">
                <div id="minimapHeader" class="ui-header space-between">
                    <span id="dungeonFloor">--</span>
                    <span
                        id="killCounter"
                        data-tooltipposition="top"
                        data-tooltiphtml='
                            <div class="genericTooltip">Total Kills</div>
                        '
                    >0</span>
                </div>
                <div id="minimap"></div>
            </div>
        </div>
        <div id="inputBox">
            <input type="text" id="persuadeInput" placeholder="Say your piece...">
            <button
                id="confirmInputBox"
                title="Confirm"
                onclick="submitPersuasion()"
            ></button>
            <button
                id="closeInputBox"
                title="Close"
                onclick="GameControl.closePersuasionInputBox()"
            ></button>
        </div>
        <div id="stats">
            <div class="ui-header space-between">
                <span>Player</span>
                <span>Level <span id="playerLevel">1</span></span>
            </div>
            <div id="infoContainer">
                <div>
                    HP
                </div>
                <progress-bar
                    id="statHp"
                    cautionAtOrBelowPercentage="25"
                    dangerAtOrBelowPercentage="10"
                ></progress-bar>

                <div>
                    EXP
                </div>
                <progress-bar
                    id="statExp"
                    emptyColor="#000"
                    filledColor="#009"
                ></progress-bar>

                <div>
                    Load
                </div>
                <progress-bar
                    id="statLoad"
                    cautionAtOrAbovePercentage="50"
                    dangerAtOrAbovePercentage="80"
                    emptyColor="#000"
                    filledColor="#f04"
                ></progress-bar>

                <div>
                    Bitcoins
                </div>
                <div class="BTC">
                    ₿ <span id="playerBitcoins">0</span>
                </div>
            </div>
            <div class="ui-header">
                Stats
            </div>
            <div id="statContainer">
                <div>Strength</div><div id="statStrength" class="STR">4</div>
                <div>Defense</div><div id="statDefense" class="DEF">7</div>
                <div>Persuasion</div><div id="statPersuasion" class="PRS">15</div>
                <div>Endurance</div><div id="statEndurance" class="END">4</div>
                <div>Speed</div><div id="statSpeed" class="SPD">13</div>
                <div>Luck</div><div id="statLuck" class="LUK">2</div>
            </div>
        </div>
        <div id="controls">
            <div id="controlsExploration">
                <div class="ui-header">Navigation Controls</div>
                <div class="control-list">
                    <div><span data-control="forward" data-keyboard="↑/W" data-gamepad='<img src="assets/gamepad/generic/d-up.png" alt="D-Pad Up">'></span>:</div><div>Move Forward</div>
                    <div><span data-control="backward" data-keyboard="↓/S" data-gamepad='<img src="assets/gamepad/generic/d-down.png" alt="D-Pad Down">'></span>:</div><div>Move Backward</div>
                    <div><span data-control="turn" data-keyboard="←/A,→/D" data-gamepad='<img src="assets/gamepad/generic/d-left.png" alt="D-Pad Left">/<img src="assets/gamepad/generic/d-right.png" alt="D-Pad Right">'></span>:</div><div>Turn</div>
                    <div><span data-control="strafe" data-keyboard="Q,E" data-gamepad='<img src="assets/gamepad/generic/L1.png" alt="LB">/<img src="assets/gamepad/generic/R1.png" alt="RB">'></span>:</div><div>Strafe</div>
                    <div><span data-control="wait" data-keyboard="Space" data-gamepad='<img src="assets/gamepad/xinput/b.png" alt="X">/<img src="assets/gamepad/playstation/circle.png" alt="SQ">'></span>:</div><div>Wait</div>
                    <div><span data-control="talk" data-keyboard="T" data-gamepad='<img src="assets/gamepad/xinput/x.png" alt="X">/<img src="assets/gamepad/playstation/square.png" alt="SQ">'></span>:</div><div>Talk</div>
                    <div><span data-control="inventory" data-keyboard="I" data-gamepad='<img src="assets/gamepad/xinput/y.png" alt="Y">/<img src="assets/gamepad/playstation/triangle.png" alt="T">'></span>:</div><div>Inventory</div>
                    <div><span data-control="menu" data-keyboard="Esc" data-gamepad='<img src="assets/gamepad/xinput/start.png" alt="Menu">/<img src="assets/gamepad/playstation/start.png" alt="MenuPS">'></span>:</div><div>Game Menu</div>
                </div>
            </div>
            <div id="controlsCombat" class="hidden">
                <div class="ui-header">Combat Controls</div>
                <div class="control-list">
                    <div><span data-control="attack" data-keyboard="A" data-gamepad='<img src="assets/gamepad/xinput/a.png" alt="A">/<img src="assets/gamepad/playstation/cross.png" alt="X">'></span>:</div><div>Attack</div>
                    <div><span data-control="persuade" data-keyboard="P" data-gamepad='<img src="assets/gamepad/xinput/x.png" alt="X">/<img src="assets/gamepad/playstation/square.png" alt="SQ">'></span>:</div><div>Persuade</div>
                    <div><span data-control="run" data-keyboard="R" data-gamepad='<img src="assets/gamepad/xinput/b.png" alt="B">/<img src="assets/gamepad/playstation/circle.png" alt="O">'></span>:</div><div>Run</div>
                    <div><span data-control="inventory" data-keyboard="I" data-gamepad='<img src="assets/gamepad/xinput/y.png" alt="Y">/<img src="assets/gamepad/playstation/triangle.png" alt="T">'></span>:</div><div>Inventory</div>
                    <div><span data-control="menu" data-keyboard="Esc" data-gamepad='<img src="assets/gamepad/xinput/start.png" alt="Menu">/<img src="assets/gamepad/playstation/start.png" alt="MenuPS">'></span>:</div><div>Game Menu</div>
                </div>
            </div>
            <div id="controlsMenu" class="hidden">
                <div class="ui-header">Menu Controls</div>
                <div class="control-list">
                    <div><span data-control="menu-up" data-keyboard="↑/W" data-gamepad='<img src="assets/gamepad/generic/d-up.png" alt="D-Pad Up">'></span>:</div><div>Previous Option</div>
                    <div><span data-control="menu-down" data-keyboard="↓/S" data-gamepad='<img src="assets/gamepad/generic/d-down.png" alt="D-Pad Down">'></span>:</div><div>Next Option</div>
                    <div><span data-control="menu-prev" data-keyboard="←/A" data-gamepad='<img src="assets/gamepad/generic/d-left.png" alt="D-Pad Left">'></span>:</div><div>Previous Page</div>
                    <div><span data-control="menu-next" data-keyboard="→/D" data-gamepad='<img src="assets/gamepad/generic/d-right.png" alt="D-Pad Right">'></span>:</div><div>Next Page</div>
                    <div><span data-control="menu-confirm" data-keyboard="Enter" data-gamepad='<img src="assets/gamepad/xinput/a.png" alt="A">/<img src="assets/gamepad/playstation/cross.png" alt="X">'></span>:</div><div>Select</div>
                    <div><span data-control="menu-close" data-keyboard="Esc" data-gamepad='<img src="assets/gamepad/xinput/b.png" alt="B">/<img src="assets/gamepad/playstation/circle.png" alt="O">'></span>:</div><div>Back</div>
                </div>
            </div>
        </div>
        <div id="viewport">
            <div class="ui-header space-between">Viewport</div>
            <div id="game" class="render"></div>
            <div id="animation" class="hidden"></div>
            <div id="animTorch" class="offscreen"></div>
            <div id="animTrombone" class="offscreen"></div>
            <div id="animBattleTransition" class="offscreen"></div>
            <div id="animBoulderHit" class="fixed"></div>
            <div id="menu"></div>
            <div id="mouseControl">
                <div class="navigation">
                    <div class="forward" onclick="move('forward')"></div>
                    <div class="backward" onclick="move('backward')"></div>
                    <div class="turn-left" onclick="turnLeft()"></div>
                    <div class="turn-right" onclick="turnRight()"></div>
                    <div class="strafe-left" onclick="move('strafeLeft')"></div>
                    <div class="strafe-right" onclick="move('strafeRight')"></div>
                    <div class="touch" onclick="move('forward')"></div>
                </div>
                <div class="combat">
                    <div class="attack" onclick="playerAttack()"></div>
                </div>
            </div>
        </div>
        <div id="party">
            <div class="ui-header">
                Party
                (
                    <span id="totalPartyMembers">0</span>
                    /
                    <span id="maxPartyMembers">3</span>
                )
            </div>
            <div id="partyMembers"></div>
        </div>
        <div id="inventory">
            <div id="inventorySidebarTitle" class="ui-header">Inventory</div>
            <button
                id="inventorySidebarCloseButton"
                class="hidden"
                onclick="InventorySidebar.open('main')"
            ></button>
            <button
                id="inventorySidebarScrollUp"
                class="hidden"
                onClick="InventorySidebar.scrollUp()"
            ></button>
            <div name="main">
                <button
                    class="items"
                    onclick="InventorySidebar.open('items')"
                >
                    <div class="container">
                        <div class="icon"></div>
                        <div class="label">Items</div>
                    </div>
                </button>
                <button
                    class="weapons"
                    onclick="InventorySidebar.open('weapons')"
                >
                    <div class="container">
                        <div class="icon"></div>
                        <div class="label">Weapons</div>
                    </div>
                </button>
                <button
                    class="armor"
                    onclick="InventorySidebar.open('armor')"
                >
                    <div class="container">
                        <div class="icon"></div>
                        <div class="label">Armor</div>
                    </div>
                </button>
                <button
                    class="rings"
                    onclick="InventorySidebar.open('rings')"
                >
                    <div class="container">
                        <div class="icon"></div>
                        <div class="label">Rings</div>
                    </div>
                </button>
            </div>
            <div name="items" class="hidden"></div>
            <div name="weapons" class="hidden"></div>
            <div name="armor" class="hidden"></div>
            <div name="rings" class="hidden"></div>
            <button
                id="inventorySidebarScrollDown"
                class="hidden"
                onClick="InventorySidebar.scrollDown()"
            ></button>
        </div>
        <div id="playerInput">
            <div class="section navigation hidden">
                <div class="ui-header">Navigation</div>
                <div class="grid-container">
                    <div id="navigationInput">
                        <button
                            name="turn-left"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="top end"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Turn Left
                                </div>
                            '
                            onclick="turnLeft()"
                        ></button>
                        <button
                            name="forward"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="top end"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Move Forward
                                </div>
                            '
                            onclick="move('forward')"
                        ></button>
                        <button
                            name="turn-right"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="top end"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Turn Right
                                </div>
                            '
                            onclick="turnRight()"
                        ></button>
                        <button
                            name="strafe-left"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="bottom end"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Strafe Left
                                </div>
                            '
                            onclick="move('strafeLeft')"
                        ></button>
                        <button
                            name="backward"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="bottom end"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Move Backward
                                </div>
                            '
                            onclick="move('backward')"
                        ></button>
                        <button
                            name="strafe-right"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="bottom end"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Strafe Right
                                </div>
                            '
                            onclick="move('strafeRight')"
                        ></button>
                        <button
                            name="wait"
                            onclick="wait()"
                            data-tooltipgroupid="playerInput"
                            data-tooltipposition="left"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Wait for a moment...
                                </div>
                            '
                        ></button>
                    </div>
                </div>
            </div>
            <div class="section battle">
                <div class="ui-header">Battle</div>
                <div class="grid-container">
                    <div id="battleInput">
                        <button
                            name="attack"
                            data-tooltipgroupid="playerInput"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    KILL THAT SUCKA!
                                </div>
                            '
                            onclick="playerAttack()"
                        ></button>
                        <button
                            name="persuade"
                            data-tooltipgroupid="playerInput"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Persuade the enemy to join your party
                                </div>
                            '
                            onclick="tryPersuade()"
                        ></button>
                        <button
                            name="run"
                            data-tooltipgroupid="playerInput"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Run away like a coward
                                </div>
                            '
                            onclick="tryRun()"
                        ></button>
                    </div>
                </div>
            </div>
            <div class="section menu">
                <div class="ui-header">Menu</div>
                <div class="grid-container">
                    <button
                        name="previous-page"
                        data-tooltipgroupid="playerInput"
                        data-tooltiphtml='
                            <div class="genericTooltip">
                                Previous Page
                            </div>
                        '
                        onclick="menu.previousPage()"
                        disabled="disabled"
                    ></button>
                    <div>
                        <button
                            name="up"
                            data-tooltipgroupid="playerInput"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Previous Option
                                </div>
                            '
                            onclick="menu.handleInput('arrowup')"
                        ></button>
                        <button
                            name="confirm"
                            data-tooltipgroupid="playerInput"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Confirm Selection
                                </div>
                            '
                            onclick="menu.handleInput('enter')"
                        ></button>
                        <button
                            name="down"
                            data-tooltipgroupid="playerInput"
                            data-tooltiphtml='
                                <div class="genericTooltip">
                                    Next Option
                                </div>
                            '
                            onclick="menu.handleInput('arrowdown')"
                        ></button>
                    </div>
                    <button
                        name="next-page"
                        data-tooltipgroupid="playerInput"
                        data-tooltiphtml='
                            <div class="genericTooltip">
                                Next Page
                            </div>
                        '
                        onclick="menu.nextPage()"
                        disabled="disabled"
                    ></button>
                </div>
            </div>
        </div>

        <div id="bottomBar">
            <div id="nowPlaying" class="stopped">
                <div class="icon"></div>
                <div class="track-info">
                    No music playing
                </div>
            </div>
            <div class="right-icons">
                <div id="gameSettingsButtonContainer">
                    <button
                        id="gameSettingsButton"
                        onclick="GameSettingsButton.toggle()"
                        data-tooltipGroupId="bottomRightIcons"
                        data-tooltipHtml='
                            <div class="genericTooltip">
                                Game Settings
                            </div>
                        '
                    ></button>
                </div>
                <div id="controllerStatusButtonContainer">
                    <button
                        id="controllerStatusButton"
                        onclick="showControllerStatusModal()"
                        data-tooltipGroupId="bottomRightIcons"
                        data-tooltipHtml='
                            <div class="genericTooltip">
                                <span id="controllerTooltipText">TardPad Status</span>
                            </div>
                        '
                    ></button>
                </div>
            </div>
        </div>

    <script src="scripts/preloader-v2.js"></script>
    <!-- VOCAP: must be loaded before any other API modules! -->
    <script src="scripts/tardAPI.js"></script>
    <script src="scripts/tardboard.js"></script>
    <script src="scripts/pigeon.js"></script>
    <script src="scripts/no-arrow-key-scroll.js"></script>
    <script src="scripts/progress-bar.js"></script>
    <script src="scripts/Inventory.js"></script>
    <script src="scripts/Map.js"></script>
    <script src="scripts/Menu.js"></script>
    <script src="scripts/Modal.js"></script>
    <script src="scripts/Music.js"></script>
    <script src="scripts/sam.js"></script>
    <script src="scripts/Tooltip.js"></script>
    <script src="data/music.js"></script>
    <script src="data/portraits.js"></script>
    <script src="data/enemyart.js"></script>
    <script src="data/title-screen.js"></script>
    <script src="scripts/gamepad.js"></script>
    <script>
        Tooltip.groupSettings = {
            playerInput: {
                delayMs: 800,
                hideAfterInteraction: true,
                position: "left",
            },
            bottomRightIcons: {
                hideAfterInteraction: true,
                position: "top end",
            },
        };
        document.querySelectorAll("[data-tooltiphtml]")
            .forEach(($e) => Tooltip.initialize($e));

        /**
         * ASCII art that the sceneRenderer uses to draw scenes
         *
         * Each entry here has a name (eg: "wall", "healingTile", etc) which is
         * used to identify the map object that is being rendered
         *
         * Each sceneArt entry is an object that points to art for that thing.
         * The object is broken into positions relative to the viewport of the
         * rendered scene. Positions are denoted as "p#_#" where "p" means
         * "position". The first # is the distance (or depth, or Z-coordinate,
         * however you want to think of it). The second "#" is the X-coordinate
         * of what the player is currently seeing, going from left to right.
         *
         * For example, the player is seeing everything in the triangle in this
         * map, including the spaces to the immediate left and right (p0_0 and
         * p0_2 respectively):
         *
         * Distance 5   \........./
         * Distance 4   .\......./.
         * Distance 3   ..\...../..
         * Distance 2   ...\.../...
         * Distance 1   ....\./....
         * Distance 0   .....↑.....
         *            Player ⤴
         *
         * Each cell is numbered this way (with "X" meaning 10):

         * Distance 5   0123456789X
         * Distance 4   .012345678.
         * Distance 3   ..0123456..
         * Distance 2   ...01234...
         * Distance 1   ....012....
         * Distance 0   ....012....
         *            Player ⤴
         *
         * So if the player's vision spots a wall at distance 3, position 4,
         * we would want to render the wall with the art referenced by entry
         * "p3_4"
         *
         * The whitespace for each piece of art is automatically trimmed from
         * the left side. This is to preserve formatting in the code (JavaScript
         * does not support heredocs unfortunately). But sometimes spaces are
         * desired as part of the art. So, a spaceBoundaryCharacter might be set
         * which will stop the whitespace from trimming into the art. This
         * character will be replaced with a space during rendering
         *
         * Each object also has an x and y value. This is the character offset
         * of where the art will start to be drawn
         *
         * Art may also have a transparentCharacter defined which will simply
         * not draw anything for that character when rendered
         */
        const sceneArt = {
            tardspireBanner: {
                positions: {
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 6, y: 4 },
                    },
                },
                art: [
                    {
                        data: `
                            ▛▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▜
                            ▌       W E L C O M E    T O . . .   ▐
                            ▌T ▀█▀▄▀▄ █▀▙ █▀▄ ▄▀▀ █▀▄▀█▀ █▀▙ █▀▀ ▐
                            ▌H  █ █▄█ █▄▛ █ █  ▀▄ █▄▀ █  █▄▛ █▄▄ ▐
                            ▌E  █ █ █ █ █ █▄▀ ▄▄▀ █  ▄█▄ █ █ █▄▄ ▐
                            ▙▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▟
                        `,
                    },
                ],
            },
            wall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ██████▒█▄
                            ██████▒███▄
                            ██████▒█████▄
                            ██████▒███████▄
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒████████
                            ██████▒███████▀
                            ██████▒█████▀
                            ██████▒███▀
                            ██████▒█▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ███████████████▒▄
                            ███████████████▒██▄
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒████
                            ███████████████▒██▀
                            ███████████████▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            ████
                            ████
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████▓▄
                            ███████████▓██▄
                            ███████████▓███
                            ███████████▓███
                            ███████████▓██▀
                            ███████████▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ██████▓▄
                            ██████▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████▄
                            ███████▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ██████
                            ██████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            darkness: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ████████▄
                            ██████████▄
                            ████████████▄
                            ██████████████▄
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ███████████████
                            ██████████████▀
                            ████████████▀
                            ██████████▀
                            ████████▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ████████████████▄
                            ██████████████████▄
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ████████████████████
                            ██████████████████▀
                            ████████████████▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            ████
                            ████
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████▄
                            ██████████████▄
                            ███████████████
                            ███████████████
                            ██████████████▀
                            ████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████▄
                            ███████▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████▄
                            ███████▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ███████
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            ██████
                            ██████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            void: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 14 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 45, y: 14 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 14 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 14 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 14 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 14 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 14 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 14 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 31, y: 14 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 14 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 14 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 14 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 14 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 14 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 28, y: 14 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 14 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 47, y: 14 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 14 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 14 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 14 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 14 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 14 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 14 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 31, y: 14 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 14 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 14 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            █████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████████████
                            ██████████████
                            ██████████████
                            ██████████████
                            ██████████████
                            ██████████████
                            ████████████▀
                            ██████████▀
                            ████████▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████
                            ████████
                            ████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████████████
                            ███████████████████
                            ███████████████████
                            ██████████████████▀
                            ████████████████▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███
                            ██▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████████████
                            ██████████████
                            ████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████
                            ▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀
                        `,
                    },
                ],
            },

            iceWall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                             ▀▄
                               ▀▄
                            ▝▘▝▘ █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                                 █
                            ▗▖▗▖ █
                               ▄▀
                             ▄▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀▀▀▀▀▄
                                  ▒▀▄
                                  ▒  ▀▄
                                  ▒    ▀▄
                            ▖  ▗▖ ▒▗▖  ▗▖▀▄
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                                  ▒       █
                            ▘  ▝▘ ▒▝▘  ▝▘▄▀
                                  ▒    ▄▀
                                  ▒  ▄▀
                                  ▒▄▀
                            ▄▄▄▄▄▄▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
                            █▝▘                                  ▝▘█
                            █  ▝▘                              ▝▘  █
                            █    ▝▘                          ▝▘    █
                            █      ▝▘                      ▝▘      █
                            █        ▝▘  ▝▘  ▝▘  ▝▘  ▝▘  ▝▘        █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖                  ▗▖        █
                            █                                      █
                            █        ▗▖  ▗▖  ▗▖  ▗▖  ▗▖  ▗▖        █
                            █      ▗▖                      ▗▖      █
                            █    ▗▖                          ▗▖    █
                            █  ▗▖                              ▗▖  █
                            █▗▖                                  ▗▖█
                            █▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                              ▀▀▀▄▄▄
                                    █
                                    █
                                    █
                                    █
                                    █
                                    █
                              ▄▄▄▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                                           ▒▄
                             .             ▒ ▀▄
                              .  .  .  .  .▒ . █
                             .             ▒   █
                                           ▒   █
                                           ▒   █
                             .             ▒   █
                              .  .  .  .  .▒ . █
                             .             ▒ ▄▀
                                           ▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            █ .                . █
                            █   .   .    .   .   █
                            █                    █
                            █   .            .   █
                            █                    █
                            █                    █
                            █   .            .   █
                            █                    █
                            █   .   .    .   .   █
                            █ .                . █
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀▄▄
                               █
                               █
                            ▄▄▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █▀▀▀▀▀▀▀▀▀▀▓▄
                            █          ▓ ▀▄
                            █          ▓  █
                            █          ▓  █
                            █          ▓ ▄▀
                            █▄▄▄▄▄▄▄▄▄▄▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █▀▀▀▀▀▀▀▀▀▀█
                            █          █
                            █          █
                            █          █
                            █          █
                            █▄▄▄▄▄▄▄▄▄▄█
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █     ▓▄
                            █     ▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █     █▄
                            █     █▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █     █
                            █     █
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █    █
                            █    █
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            rubble1: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_1: {
                        artIndex: 11,
                        drawAt: { x: 5, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            '  .'   .  '    ..   '   .
                            %%%%% .;' .   '   . ' .
                            %%%%'   .    ;'  ' '  , '
                            %%%%%%. '. .'   ,'  ;.
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%    . '     ;'  '   . ,
                            %%%%%'  ..    ',.    .  '   ';,
                            %%%%'   ;' ,' . .  .  , ,       .
                            %%% , .   .    '   ;  ' .'   '
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %.  .; '
                            .'
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%. ,  . ,
                            . ;'  ,. .  :,
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%% ;'.   .  ,
                            %% , . '    '  .
                        `,
                    },
                    {
                        data: `
                            .  ,.  .  ,
                             '    ',  . , .
                        `,
                    },
                    {
                        data: `
                            '. ;. :  .'  '
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%.'  ';
                        `,
                    },
                    {
                        data: `
                            ' "' '
                        `,
                    },
                    {
                        data: `
                            --
                        `,
                    },
                    {
                        data: `
                            . ,' '"  '
                        `,
                    },
                    {
                        data: `
                             ' .  ' .   '   ' ,.     ;   .  , ' .  '
                            '    ,'  ;          .;                .
                              ,'  ,'.  ' .,   '    ; '.    '     ' .
                            .  '      ' . '      '    . ',  ; .
                        `,
                    },
                ],
            },

            rubble2: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_1: {
                        artIndex: 11,
                        drawAt: { x: 5, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        data: `
                             '   , ' .   .  ' ,  , ' .
                            .  ;  '        '    ' .
                                 .   ;   '     .    ,
                                   '       : '   . '
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%'      .   ;   '      '
                            %%%%%,  ; , ' .   .  ' ,  ,   .
                            %%%%    .   ;   '       : '.   ,
                            %%% '  .  '   ,    ;  .         '
                        `,
                    },
                    {
                        data: `
                             '  ; '
                            ,
                        `,
                    },
                    {
                        data: `
                            '    .      ,
                             .  ';  '  .  '
                        `
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%.  '   .  ,
                            % '    ,   .    ;
                        `,
                    },
                    {
                        data: `
                            '  . '  ;  .
                             ,    '   '   .
                        `,
                    },
                    {
                        data: `
                            . '    . ;  '
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%'.  ;.
                        `,
                    },
                    {
                        data: `
                            .'  ',
                        `,
                    },
                    {
                        data: `
                            --
                        `,
                    },
                    {
                        data: `
                            '  ; ..  ,
                        `,
                    },
                    {
                        data: `
                            .  '      ' . '      '    . ',  ; .
                              ,'  ,'.  ' .,   '    ; '.    '     ' .
                            '    ,'  ;          .;                .
                             ' .  ' .   '   ' ,.     ;   .  , ' .  '
                        `,
                    },
                ],
            },

            gloryWall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 4,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ████▀
                            ██▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ██████▒█▄
                            ██████▒███▄
                            ██████▒█████▄
                            ██████▒███████▄
                            ██████▒█▒▒█████
                            ██████▒█▒█▒▒███
                            ██████▒███▒█▒██
                            ██████▒████▒███
                            ██████▒██▒█████
                            ██████▒█████▒██
                            ██████▒███░▒███
                            ██████▒██▒▒████
                            ██████▒████████
                            ██████▒███▒████
                            ██████▒███████▀
                            ██████▒█████▀
                            ██████▒███▀
                            ██████▒█▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: false,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            ██████████▀█████████▀███████████████████
                            █████▀▄▄█▀▄▀▄▄▀█▀▄▄█▄▀ █████████████████
                            ████ █▄ █ █▄▀▀▄█ ██▀▀▀▄█████████████████
                            █████▄▄█████████████████████████████████
                            ██████████▀██▀██████ ███████████████████
                            █████████ ▀▀ █▀▄▄▀█ ██▀▄▄▀██████████████
                            ████████ ███ █▄▀▀▄█ █ █▄▄███████████████
                            ██████████████████████▄▄███▀▀▀██████████
                            ██████████████████████████████▄▄▀███████
                            ████████████████████████████████ ███████
                            ████████████████▀▀██▓██▀ ████▀▀▄████████
                            ███████████████    ███▄  ▄▄▄▄███████████
                            █████████████▓██▄▄████▓█▄███████████████
                            ████████████████▒░█▓████████████████████
                            ██████████████▒██▒██████████████████████
                            ████████████████▓███████████████████████
                            █████████████████▓██████████████████████
                            ████████████████████████████████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █████████
                            ██▓▓▓▓███
                            █▓█▓█▓███
                            ████▓████
                            ██▒▒█████
                            █████████
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ███████████████▒▄
                            ██▓█▓██████████▒██▄
                            █▓█▓█▓█▓█▓█████▒████
                            ██▓█▓█████▓████▒████
                            █████████▓█████▒████
                            ████████▓██████▒████
                            ████▒▒█████████▒████
                            ███████████████▒████
                            ████▓██████████▒██▀
                            ███████████████▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ████▓▓██▓██▓██████████
                            ███▓██▓▓█▓██▓█▓███████
                            ██████████▓████▓▓█████
                            ██████████████▓███████
                            ████████▒▒▓█▓█████████
                            ██████████████████████
                            ██████████████████████
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            █▓██
                            ██▓█
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████▓▄
                            ██▓█▓█▓████▓██▄
                            ███▓███▓███▓███
                            ███▓▒▓█████▓███
                            ███████████▓██▀
                            ███████████▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ██▓█▓█▓█████
                            ████████▓███
                            ███▓▒▓▓█████
                            ████████████
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓█▓▄
                            ██▓▓███▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓██▄
                            ██▓▓███▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓██
                            ██▓▓███
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓█▓█
                            ██▓▓██
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                ],
            },

            noboWall: {
                relativeColor: { r: 255, g: 255, b: 255 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: 1 },
                    },
                    p0_2: {
                        artIndex: 15,
                        drawAt: { x: 44, y: 1 },
                    },
                    p1_0: {
                        artIndex: 1,
                        drawAt: { x: 0, y: 4 },
                    },
                    p1_1: {
                        artIndex: 2,
                        drawAt: { x: 5, y: 4 },
                    },
                    p1_2: {
                        artIndex: 1,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 4 },
                    },
                    p2_0: {
                        artIndex: 3,
                        drawAt: { x: 0, y: 9 },
                    },
                    p2_1: {
                        artIndex: 4,
                        drawAt: { x: 0, y: 8 },
                    },
                    p2_2: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 8 },
                    },
                    p2_3: {
                        artIndex: 14,
                        drawAt: { x: 30, y: 8 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 41, y: 9 },
                    },
                    p3_0: {
                        artIndex: 6,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_1: {
                        artIndex: 7,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 7,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 8,
                        drawAt: { x: 19, y: 11 },
                    },
                    p3_4: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 27, y: 11 },
                    },
                    p3_5: {
                        artIndex: 7,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 34, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 9,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 9,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 10,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 11,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 12,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 11,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 9,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 13,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 13,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 13,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 13,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 13,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 13,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 13,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 13,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 13,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 13,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 13,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄
                            ██▄
                            ████▄
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            ▒▒████
                            ▒▒▒███
                            █▒▒███
                            ███░██
                            ████░█
                            █████░
                            ██████
                            ██████
                            ██████
                            ████░█
                            ██░░░█
                            ░░░░░█
                            ░░░░░█
                            ░░░█▀
                            ░█▀
                            ▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██████▄
                            ██████▒█▄
                            ██████▒███▄
                            ██████▒█████▄
                            ██████▒███████▄
                            ▓▓▓▓██▒█▒▒█████
                            ▓▓████▒█▒▒▒▒███
                            █▓▓▓██▒██▒▒█▒▒█
                            ▓▓████▒█▒▒▓▓▒▒█
                            ██████▒█▒▒▒█▒▒█
                            ██████▒███▓▓▒▒█
                            ██████▒████▓▓▒█
                            ██████▒█████▒▒█
                            ██████▒████▓▓██
                            ██████▒████████
                            ██████▒███████▀
                            ██████▒█████▀
                            ██████▒███▀
                            ██████▒█▀
                            ██████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: false,
                        data: `
                            ████████████████████████████████████████
                            ████████████████████████████████████████
                            █▀███▀██▀▀██▀▀▀███▀▀████████████████████
                            █ ▄▀█ █ ██ █ ▀▀▄█ ██ ████████▀▀▀▀▀▀▀████
                            █ ██▄ █ ██ █ ██ █ ██ ████ ▄▄▄██████ ████
                            █▄███▄██▄▄██▄▄▄███▄▄█████ ▀▀▀▀▄▀▀▀▀ ████
                            ███ ███ █▀▄▄▀█▀▄▄▄███████   ▀███▀   ████
                            ███ █ █ █ ▄▄ ██▄▄▄▀███▀▀▀   ▀▀ ▀▀   ▀▀██
                            ████▄█▄██▄██▄█▄▄▄▄███ ▀▀▀▀▀██████████▀ █
                            █ ███ █ ▄▄▄█ ▄▄▀█ ▄▄▄█▒▒▒▄    ▄     ▒▒▒█
                            █ ▄▄▄ █ ▄▄▄█ ▄▄▀█ ▄▄▄██▒▒▒███ █████ ▒▒██
                            █▄███▄█▄▄▄▄█▄██▄█▄▄▄▄█▀▀▒▒███▄▀▄██▀ ▒▀██
                            ██████████████████▀▀▄▄████ ██▀▀▀█  ███ ▀
                            █████████████████ █████████▄ ▀▀▀   █████
                            █████████████████ █████████▀▀██   ██████
                            █████████████████ ████████ ██ █  ███████
                            ████████████████ ███████  █▄▄█▄▀█▀████▀█
                            ████████████████ ██████   ██▄▄▄ █      █
                            █████████████████ ███▀    ██▄▄ ▄▀      █
                            █████████████████ ██        ▄▄█ 6/22/25 
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            █████▄▄▄
                            █▓▓██████
                            ██▓▓▓▓▓▓█
                            ██████▓▓█
                            █████▓▓▓▓
                            █████▓▓▓▓
                            █████▓▓██
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ███████████████▒▄
                            ███████████████▒██▄
                            █▒▒▒▒▒▒███▓▓███▒████
                            ███▓▓▓██▒▒▒▒▒▒█▒█▓▓█
                            █▒▒▒▒▒▒██▓▓▓███▒██▓█
                            ████████▒▓▓▓▓▓█▒█▓▓█
                            ██████▒▓▓▓▓▓▓▓█▒█▓▓█
                            ██████▒▓▓▓▓▓▓▓█▒██▓█
                            ███████▓▒▒▒▒▒▒█▒██▀
                            ███████████████▒▀
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ██████████████████████
                            ██████████████████████
                            ██▒▒▒▒▒▒▒▒████▓▓██████
                            ███▓▓▓▓▓▓███▒▒▒▒▒▒████
                            ██▒▒▒▒▒▒▒▒███▒▒▒▒█████
                            ██████████▒▒▒▒▒▒▒▒████
                            ██████████▒▒▒▒▒▒▒▒▒███
                            ███████████▒▒▒▒▒▒▒▒███
                            ████████████▓▓▓▓▓▓▓███
                            ██████████████████████
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ██▄▄
                            █▓▓█
                            ██▓█
                            ██▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ███████████▓▄
                            ██▓▓▓██▓▓██▓██▄
                            ██▓▓▓█▓▓▓▓█▓█▓█
                            ███▓█▓█▓▓██▓█▓█
                            ███████████▓██▀
                            ███████████▓▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ████████████
                            ██▓▓▓█▓▓▓███
                            ██▓▓▓█▓▓▓▓██
                            ███▓█▓▓▓▓▓██
                            ██████▓▓▓▓██
                            ████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓█▓▄
                            ██▓▓▓██▓▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓██▄
                            ██▓▓▓██▀
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓██
                            ██▓▓▓██
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄▄▄▄▄
                            █▓▓▓▓█
                            ██▓▓▓█
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            %%%▄▒███████████████
                            %▄██▒███████████████
                            ████▒█▒▒▒▒▒▒███▓▓███
                            █▓▓█▒███▓▓▓██▒▒▒▒▒▒█
                            ▓▓▓█▒█▒▒▒▒▒▒██▓▓▓███
                            █▓▓█▒████████▒▓▓▓▓▓█
                            █▓▓█▒██████▒▓▓▓▓▓▓▓█
                            ██▓█▒██████▒▓▓▓▓▓▓▓█
                            %▀██▒███████▓▒▒▒▒▒▒█
                            %%%▀▒███████████████
                            %%%%%▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄
                            %%%▄██
                            %▄████
                            ██████
                            █████░
                            ██░░█░
                            ██░█░░
                            ██░██░
                            █████░
                            ██████
                            ███░█░
                            ████░█
                            ██████
                            █████░
                            ██░██░
                            ██░░░░
                            ██░██░
                            █████░
                            ██████
                            ██████
                            ██████
                            ██████
                            ██████
                            %▀████
                            %%%▀██
                            %%%%%▀
                        `,
                    },
                ],
            },

            healingTile: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▀██████████████████████▀
                            %%▀██████████████████▀
                            %%%%▀██████████████▀
                            %%%%%%▀▀▀▀▀▀▀▀▀▀▀▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄██████████████████████▄
                            %%%▄██████████████████████████▄
                            %▄██████████████████████████████▄
                            ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            █████▀▀▀
                            ▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▄▄▄▄▄▄▄▄▄▄▄
                            ▄▄███████████▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ▄████████████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▄▄▄▄▄▄▄▄▄▄▄
                            %▀███████████▄▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▀████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╼╾
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▄▄██████▀▀
                        `,
                    },
                ],
            },

            crackedFloorSlight: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀█▀▀▄%%▄▄
                            ▀▀▀▀%%%%%%%%%%%%▀▄
                            %%%%%%%%%%%%%%%%%%▀▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄
                            %%%%%%%%%▀▀█▀▀▄
                            %%%%%%%▀▀▀▀%%%%%%%%%%%%%%▀▀▄
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▘%▗▄▖
                            %▀▘%%▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%▄%%%%%▖
                            %%%▀▀▀%%%%%%▝▄
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▄▄%%%%▗▄▖
                            %▀▀▀%%%%%%%%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄%%%▗▄▖
                            %%%▀▀▀%%%%%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %░░%░%%%░░%%░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %░░%░░%%░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▔%%▔
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╶╴
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▒░▒▒░▒
                        `,
                    },
                ],
            },

            crackedFloor: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀█▀▀▄▄▄▄▄%%▄▀
                            ▀▀▀▀%%%%%%▄▄▄▀▀▀▀▄
                            %%%%%%%%%%%%%%%%%%▀▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄
                            %%%%%%%%%▀▀█▀▀▄▄▄▄▄%%%%%▄▀
                            %%%%%%%▀▀▀▀%%%%%%%%%▄▄▄▀▀▀▀▄
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▘%▗▟▖
                            %▀▘%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▀▀▄▄▘%▗▟▖
                            %%%▀▀▀%%%▀▘%▝▄
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀▄▄▘%%%▗▟▖
                            %▀▀▀%%%%%▀▘%▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%▀▀▄▄▘%▗▟▖
                            %%%▀▀▀%%%▀▘▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▒▒%▒░░%▒▒░░▒%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▒▒░▒▒░░▒%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▔▔%%▔
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╶╴
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▒░▒▒░▒
                        `,
                    },
                ],
            },

            crackedFloorSevere: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 24 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 24 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -12, y: 20 },
                    },
                    p1_1: {
                        artIndex: 1,
                        drawAt: { x: 8, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 38, y: 20 },
                    },
                    p2_0: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 18 },
                    },
                    p2_1: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 17 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 42, y: 18 },
                    },
                    p3_0: {
                        artIndex: 10,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 10,
                        drawAt: { x: -3, y: 16 },
                    },
                    p3_2: {
                        artIndex: 10,
                        drawAt: { x: 8, y: 16 },
                    },
                    p3_3: {
                        artIndex: 7,
                        drawAt: { x: 20, y: 16 },
                    },
                    p3_4: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 29, y: 16 },
                    },
                    p3_5: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p3_6: {
                        artIndex: 10,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 8,
                        drawAt: { x: 2, y: 15 },
                    },
                    p4_1: {
                        artIndex: 8,
                        drawAt: { x: 7, y: 15 },
                    },
                    p4_2: {
                        artIndex: 8,
                        drawAt: { x: 12, y: 15 },
                    },
                    p4_3: {
                        artIndex: 8,
                        drawAt: { x: 17, y: 15 },
                    },
                    p4_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 15 },
                    },
                    p4_5: {
                        artIndex: 8,
                        drawAt: { x: 27, y: 15 },
                    },
                    p4_6: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 15 },
                    },
                    p4_7: {
                        artIndex: 8,
                        drawAt: { x: 37, y: 15 },
                    },
                    p4_8: {
                        artIndex: 8,
                        drawAt: { x: 42, y: 15 },
                    },
                    p5_0: {
                        artIndex: 9,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 9,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 9,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 9,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 9,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 9,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 9,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 9,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 9,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 9,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 9,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀█▀▀▄▄▄▄▄%%▄▀▀▀▄▀
                            ▀█▀▀%▀▄%▄%▄▄▄▀▀▀▀▄
                            %%▀▀%▀%▀▀%%▀%▀▀%%%█▀
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄
                            %%%%%%%%%▀▀█▀▀▄▄▄▄▄%%%%%▄▀▀▀▄▀
                            %%%%%%%▀█▀▀%▀▄%▄%▄%%▄▄▄▀▀▀▀▄
                            %%%%%%%%%▀▀%▀%▀▀%%▀%%▀%▀▀%%%█▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            ▀%▗▟▞▞
                            %▜▚▚▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▀▀▄▄▀%▗▟▞▞
                            %%%▜▜▀▞%%▜▚▚▝▄
                        `
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▀▀▄▄▀%%%▗▟▞▞
                            %▜▜▀▞%▚%%▜▚▚▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%▀▀▄▄▀%▗▟▞▞
                            %▜▜▀▞%▚%▜▚▚▝▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ░▓▓░▓▒▒░▓▓▒▒▓░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ░▓▓▒▓▓▒▒▓░
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▀▔▀▔▘
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╺╸
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ░░▓▒▓▓▒▓
                        `,
                    },
                ],
            },

            boulder: {
                relativeColor: { r: 199, g: 111, b: 40 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 7 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 7 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 4 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 4 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 4 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 9 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 9 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 16, y: 9 },
                    },
                    p2_3: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 9 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 9 },
                    },
                    p3_0: {
                        artIndex: 4,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 4,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 4,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 11 },
                    },
                    p3_4: {
                        artIndex: 6,
                        drawAt: { x: 29, y: 11 },
                    },
                    p3_5: {
                        artIndex: 6,
                        drawAt: { x: 36, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 7,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 7,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 7,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 7,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 7,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 7,
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 7,
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 7,
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 7,
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 8,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 8,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 8,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 8,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 8,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 8,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 8,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 8,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 8,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%▄▄▄▄▄▄▄▄▄▄▄▄▄%%%%%%%%%%
                            %%%%%%%%%%▄▀             ▀▄%%%%%%%%
                            %%%%%%%%▄▀    ███    ███   ▀▄%%%%%%
                            %%%%%%▄▀      ▀▀▀    ▀▀▀     ▀▄%%%%
                            %%%%▄▀                         ▀▄%%
                            %%%%█                           █%%
                            %%%%█                           █%%
                            %%%%█                           █%%
                            %%%%█                           █%%
                            %%%%█            ███            █%%
                            %%%%▀▄           ▀▀▀           ▄▀%%
                            %%%%%%▀▄                     ▄▀%%%%
                            %%%%%%%%▀▄                 ▄▀%%%%%%
                            %%%%%%%%%%▀▄             ▄▀%%%%%%%%
                            %%%%%%%%%%%%▀▀▀▀▀▀▀▀▀▀▀▀▀%%%%%%%%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%
                            %%%%▄▀▀▀▀▀▀▀▄%%%
                            %%▄▀         ▀▄%
                            %█             █
                            %█   ▄▄   ▄▄   █
                            %█   ▀▀   ▀▀   █
                            %%▀▄         ▄▀%
                            %%%%▀▄▄▄▄▄▄▄▀%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%
                            %%%%▄▀▀▀▀▀▀▀▄%%%
                            %%▄▀         ▀▄%
                            %█             █
                            %█   ▄▄   ▄▄   █
                            %█   ▀▀   ▀▀   █
                            %%▀▄         ▄▀%
                            %%%%▀▄▄▄▄▄▄▄▀%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%
                            %%%%%%%%%%%%%%%%
                            %%%%▄▀▀▀▀▀▀▀▄%%%
                            %%▄▀         ▀▄%
                            %█             █
                            %█   ▄▄   ▄▄   █
                            %█   ▀▀   ▀▀   █
                            %%▀▄         ▄▀%
                            %%%%▀▄▄▄▄▄▄▄▀%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%
                            %%%%%%%%%%%%%
                            %%%▄▄▄%%%%%%%
                            %▄▀ ▄ ▀▄%%%%%
                            %█     █%%%%%
                            %%▀▄▄▄▀%%%%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%
                            %%%%%%%%%%%%%
                            %%%▄▄▄%%%%%%%
                            %▄▀ ▄ ▀▄%%%%%
                            %█     █%%%%%
                            %%▀▄▄▄▀%%%%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%
                            %%%%%%%%%%%%%
                            %%%▄▄▄%%%%%%%
                            %▄▀ ▄ ▀▄%%%%%
                            %█     █%%%%%
                            %%▀▄▄▄▀%%%%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%
                            %%▄▄%%
                            %█ ∞█%
                            %▀▄▄▀%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            %
                            @%
                        `,
                    },
                ],
            },

            roamingEnemy: {
                relativeColor: { r: 255, g: 0, b: 0 }, // Red color
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 7 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 7 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 4 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 4 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 4 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 9 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 9 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 16, y: 9 },
                    },
                    p2_3: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 9 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 9 },
                    },
                    p3_0: {
                        artIndex: 4,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 4,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 4,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 11 },
                    },
                    p3_4: {
                        artIndex: 6,
                        drawAt: { x: 29, y: 11 },
                    },
                    p3_5: {
                        artIndex: 6,
                        drawAt: { x: 36, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 7,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 7,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 7,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 7,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 7,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 7,
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 7,
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 7,
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 7,
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 8,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 8,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 8,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 8,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 8,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 8,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 8,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 8,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 8,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
                            %%%%%%▄▄▄%%%%%%%%▄%%%%%%%%%%%%%%%%%
                            %%%%%%%█▀▀▄%%%%▄█%%%%%%%▄▄▄▄▄%%%%%%
                            %%%%%%%█   █%▄█ ▀▀▄%%%▄▀ ▄▄▀%%%%%%%
                            %%%%%%█     █     █%%▄▀ ▄▀%%%%%%%%%
                            %%%%%%%█   █      ▀▄▀  ▄▀%%%%%%%%%%
                            %%%%%%%%█              █%%%%%%%%%%%
                            %%%%▄▄%█                █%%%%%%%%%%
                            %%%%%%█                  █%%%%%%%%%
                            %%%%%%%█                  █%%%%%%%%
                            %%%%%%█                  █%%%%%%%%%
                            %%%%%█                  █%%%%%%%%%%
                            %%%%█                    █%%%%%%%%%
                            %%%%%█  ▄▄▄           ▄▄▄ ▀▄%%%%%%%
                            %%%%█    █             █    █%%%%%%
                            %%%█          ▄▄▄▄▄▄▄▄▄      █%%%%%
                            %%%█             ▀  ▀         █%%%%
                            %%%█                ▀          █%%%
                            %%%▀▄               ▀         ▄▀%%%
                            %%%%%▀▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▀%%%%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%█%%%%%%%%%%%%
                            %%█ █%%█%%%▄▀%%%
                            %%█ █%█ █%%█%%%%
                            %▄▀  ▀   ▀▄█%%%%
                            %█         ▀▄%%%
                            %█          ▀▄%%
                            ▄▀▄▄▄     ▄▄▄▀▄%
                            █  ▀  ▄▄▄▄ ▀  ▀▄
                            █              █
                            %▀▄▄▄▄▄▄▄▄▄▄▄▄▀%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%█%%%%%%%%%%%%
                            %%█ █%%█%%%▄▀%%%
                            %%█ █%█ █%%█%%%%
                            %▄▀  ▀   ▀▄█%%%%
                            %█         ▀▄%%%
                            %█          ▀▄%%
                            ▄▀▄▄▄     ▄▄▄▀▄%
                            █  ▀  ▄▄▄▄ ▀  ▀▄
                            █              █
                            %▀▄▄▄▄▄▄▄▄▄▄▄▄▀%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%█%%%%%%%%%%%%
                            %%█ █%%█%%%▄▀%%%
                            %%█ █%█ █%%█%%%%
                            %▄▀  ▀   ▀▄█%%%%
                            %█         ▀▄%%%
                            %█          ▀▄%%
                            ▄▀▄▄▄     ▄▄▄▀▄%
                            █  ▀  ▄▄▄▄ ▀  ▀▄
                            █              █
                            %▀▄▄▄▄▄▄▄▄▄▄▄▄▀%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%
                            %%%%▄%%%%%%%%
                            %%%█ ▀▀▄%▄%%%
                            %%%█    ▀ █%%
                            %%%█ T  T █%%
                            %%%▀▄▄▄▄▄▄▀%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%
                            %%%%▄%%%%%%%%
                            %%%█ ▀▀▄%▄%%%
                            %%%█    ▀ █%%
                            %%%█ T  T █%%
                            %%%▀▄▄▄▄▄▄▀%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%
                            %%%%▄%%%%%%%%
                            %%%█ ▀▀▄%▄%%%
                            %%%█    ▀ █%%
                            %%%█ T  T █%%
                            %%%▀▄▄▄▄▄▄▀%%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%%
                            %█▄▄%%
                            %█TT█%
                            %█▄▄█%
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            %
                            @%
                        `,
                    },
                ],
            },

            exit: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 7 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 7 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 4 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 4 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 4 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 14 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 9 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 16, y: 9 },
                    },
                    p2_3: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 9 },
                    },
                    p2_4: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 10 },
                    },
                    p3_0: {
                        artIndex: 4,
                        drawAt: { x: -9, y: 15 },
                    },
                    p3_1: {
                        artIndex: 4,
                        drawAt: { x: -3, y: 11 },
                    },
                    p3_2: {
                        artIndex: 4,
                        drawAt: { x: 8, y: 11 },
                    },
                    p3_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 11 },
                    },
                    p3_4: {
                        artIndex: 6,
                        drawAt: { x: 29, y: 11 },
                    },
                    p3_5: {
                        artIndex: 6,
                        drawAt: { x: 36, y: 11 },
                    },
                    p3_6: {
                        artIndex: 6,
                        drawAt: { x: 46, y: 12 },
                    },
                    p4_0: {
                        artIndex: 7,
                        drawAt: { x: 2, y: 12 },
                    },
                    p4_1: {
                        artIndex: 7,
                        drawAt: { x: 7, y: 12 },
                    },
                    p4_2: {
                        artIndex: 7,
                        drawAt: { x: 12, y: 12 },
                    },
                    p4_3: {
                        artIndex: 7,
                        drawAt: { x: 17, y: 12 },
                    },
                    p4_4: {
                        artIndex: 7,
                        drawAt: { x: 22, y: 12 },
                    },
                    p4_5: {
                        artIndex: 7,
                        drawAt: { x: 26, y: 12 },
                    },
                    p4_6: {
                        artIndex: 7,
                        drawAt: { x: 30, y: 12 },
                    },
                    p4_7: {
                        artIndex: 7,
                        drawAt: { x: 35, y: 12 },
                    },
                    p4_8: {
                        artIndex: 7,
                        drawAt: { x: 40, y: 12 },
                    },
                    p5_0: {
                        artIndex: 8,
                        drawAt: { x: 14, y: 13 },
                    },
                    p5_1: {
                        artIndex: 8,
                        drawAt: { x: 16, y: 13 },
                    },
                    p5_2: {
                        artIndex: 8,
                        drawAt: { x: 18, y: 13 },
                    },
                    p5_3: {
                        artIndex: 8,
                        drawAt: { x: 20, y: 13 },
                    },
                    p5_4: {
                        artIndex: 8,
                        drawAt: { x: 22, y: 13 },
                    },
                    p5_5: {
                        artIndex: 8,
                        drawAt: { x: 24, y: 13 },
                    },
                    p5_6: {
                        artIndex: 8,
                        drawAt: { x: 26, y: 13 },
                    },
                    p5_7: {
                        artIndex: 8,
                        drawAt: { x: 28, y: 13 },
                    },
                    p5_8: {
                        artIndex: 8,
                        drawAt: { x: 30, y: 13 },
                    },
                    p5_9: {
                        artIndex: 8,
                        drawAt: { x: 32, y: 13 },
                    },
                    p5_10: {
                        artIndex: 8,
                        drawAt: { x: 34, y: 13 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%▄▄▄▄
                            %%%%%%%%%%██
                            ▀██▄%%%%%%██
                            %%%▀██▄%%%██
                            %%%%%%▀██▄▄▀
                            %%%%%%%%%▀██▄
                            %%%%%%%%%% ▀██▄
                            %%%%%%%%%%▄ %▀██▄
                            %%%%%%%%%%██%%%▀██▄%▄█
                            %%%%%%%%%%██%%%%▄████▀
                            %%%%%%%%%%██%%%▀▀█████
                            %%%%%%%%%%██%%%%%%%%▀▀
                            %%%%%%%%%%██
                            %%%%%%%%%%██
                            %%%%%%%%%%██
                            %%%%%%%%%%▀▀
                            %%%%%%▄▀▀▀▀▀▀▀▀██████████████▄
                            %%%%▄█████████ ▀▀▀▀▀▀▀▀▀▀██████▄
                            %%▄█████████▀▄ ███████▀▄ ████████▄
                            %▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%%▗▄▖
                            %%%▝▚▖█
                            %%%%%▝█
                            %%%%%%█▚
                            %%%%%%█%▚▐▖
                            %%%%%%█▝▀█▌
                            %%%%%%█
                            %%%%%%█
                            %%%%▄▄▄▄▄▄▄▄▄▄▄
                            ▄▄███████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▗▄▖
                            %%▝▚▖█
                            %%%%▝█
                            %%%%%█▚
                            %%%%%█%▚▐▖
                            %%%%%█▝▀█▌
                            %%%%%█
                            %%%%%█
                            %%▄▄▄▄▄▄▄▄▄▄▄▄▄▄
                            ▄████████████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%▗▄▖
                            ▝▚▖█
                            %%▝█
                            %%%█▚
                            %%%█%▚▐▖
                            %%%█▝▀█▌
                            %%%█
                            %%%█
                            %%▄▄▄▄▄▄▄▄▄▄▄
                            %%%▀███████████▄▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%╲▂▖
                            %%%▐╲
                            %%%▐%╲▖
                            %%%▐%▀▘
                            %%%▝
                            ████████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %╲▂▖
                            %%▐╲
                            %%▐%╲▖
                            %%▐%▀▘
                            %%▝
                            ▄████████▄
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                          ╲▂▖
                          %▐╲
                          %▐%╲▖
                          %▐%▀▘
                          %▝
                          ▀████████████
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %┬
                            %│╲▎
                            %│▔
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ↘
                            ╼╾
                        `,
                    },
                ],
            },

            treasureChest: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 22 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 48, y: 22 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: -14 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 14, y: 16 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 16 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -8, y: 15 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 16 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 16 },
                    },
                    p2_3: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 16 },
                    },
                    p3_0: {
                        artIndex: 3,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_1: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 15 },
                    },
                    p3_2: {
                        artIndex: 3,
                        drawAt: { x: 13, y: 15 },
                    },
                    p3_3: {
                        artIndex: 3,
                        drawAt: { x: 23, y: 15 },
                    },
                    p3_4: {
                        artIndex: 3,
                        drawAt: { x: 33, y: 15 },
                    },
                    p3_5: {
                        artIndex: 3,
                        drawAt: { x: 39, y: 15 },
                    },
                    p3_6: {
                        artIndex: 3,
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 4,
                        drawAt: { x: 6, y: 14 },
                    },
                    p4_1: {
                        artIndex: 4,
                        drawAt: { x: 11, y: 14 },
                    },
                    p4_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p4_3: {
                        artIndex: 4,
                        drawAt: { x: 21, y: 14 },
                    },
                    p4_4: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p4_5: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p4_6: {
                        artIndex: 4,
                        drawAt: { x: 33, y: 14 },
                    },
                    p4_7: {
                        artIndex: 4,
                        drawAt: { x: 38, y: 14 },
                    },
                    p4_8: {
                        artIndex: 4,
                        drawAt: { x: 43, y: 14 },
                    },
                    p5_0: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 5,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 5,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 5,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 5,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 5,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 5,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 5,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 5,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %▄██████████████████▄
                            █▀   █          █   ▀█
                            █    █          █    █
                            █▀▀▀▀█▀▀▀▀██▀▀▀▀█▀▀▀▀█
                            █    █    ▀▀    █    █
                            █    █          █    █
                            █▄▄▄▄█▄▄▄▄▄▄▄▄▄▄█▄▄▄▄█
                        `,
                    },
                    {
                        data: `
                            ▄▀▀▀▀▀▀█▀▄
                            █▀▀██▀▀█▄█
                            █      █ █
                            ▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        data: `
                            ▄▀▀▀▀▀▀▀▀▄
                            █▀▀▀██▀▀▀█
                            █        █
                            ▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        data: `
                            ▞▜▛▚
                            ▙▄▄▟
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▆▆
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▗▖
                        `,
                    },
                ],
            },

            merchant: {
                relativeColor: { r: 247, g: 119, b: 247 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 14 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 14 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 16, y: 10 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 33, y: 10 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 11 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 10 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 20, y: 10 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 32, y: 10 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 43, y: 11 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -5, y: 13 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 12 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 12 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 27, y: 12 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 34, y: 12 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 4, y: 13 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 9, y: 13 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 14, y: 13 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 19, y: 13 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 24, y: 13 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 28, y: 13 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 32, y: 13 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 37, y: 13 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 13 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%█▀▄▄
                            %%%%%%%%▌  ▀▀▄▀
                            %%%%%%%▄▄▄▀▀▀
                            %%%%%%▀▄    ▀▀▀
                            %%%%%▄▀    █▄
                            %%%%%█      █
                            %%%%%█      ▀█%%%▄▀
                            %%%%█       ▀▄▄▄▀
                            %%%%█        ▄▀
                            %%%▀▄▄▄▀▀▀▄▄▀
                            %%%%%%█  ▄▀█
                            %%%%%%█ █▀  ▀▄
                            ▀%▀▀%▀▀▀▀▀▀▀▀▀▀▀%%▀
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%█▄
                            %%%█▄██▀
                            %%▀▀   ▀
                            %%█   █
                            %█     █%▄▀
                            █      ▄▀
                            %▀▄▀▀▄█
                            %%█ █  █
                            %▀▀▀▀▀▀▀▀▀▀
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%▟▄▂
                            %▝▛▀▂
                            %▞ ▚%%╱
                            ▝▚▁▁▀╱
                            %%▌▙╱
                        `,
                    },
                    {
                        data: `
                            ☻
                            ╦╱
                            ╫
                        `,
                    },
                    {
                        data: `
                            ♣
                        `,
                    },
                ],
            },

            gambler: {
                relativeColor: { r: 255, g: 215, b: 0 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -14, y: 15 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 13 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 17, y: 12 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 36, y: 12 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 14 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 13 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 19, y: 13 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 33, y: 13 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 44, y: 14 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -3, y: 14 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 1, y: 13 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 13 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 13 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 28, y: 13 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 35, y: 13 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 8, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 13, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 18, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 23, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 27, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 31, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 36, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 41, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄%▄
                            ▌%%%%%%%█▀▄▀▄
                            █%%%%%%▄▀  ▀▀▀▀▄
                            █%%%%%█      ╼╸ ▀▀▄
                            █%%%%▄▀       ▄▄▄▄▄▀
                            █%%%█      ▀█▀
                            █%%█     ▀▀▄▄▀▄
                            █%%█         ▀██▄
                            %█▄█          █
                            %%▀▄▄▄▄▄▄▄▄▄▄▀
                            %%%%%▀▀▀%%%▀▀▀▀
                            %
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            ▌%%%█▄█▄
                            █%%%█  ╼▀▀▄
                            █%%█   ▄▀▀▀
                            ▀▄█   ▀▀█▀
                            %%▀▄▄▄▄▄▀
                            %%%▀▀%%▀▀
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            ▌%▙▙▂
                            ▌▟█▞▀▀
                            ▚▜██▞
                            %▀%▀
                        `,
                    },
                    {
                        data: `
                            ▌▙▖
                            ▝▀
                        `,
                    },
                    {
                        data: `
                            ♠
                        `,
                    },
                ],
            },

            erok: {
                relativeColor: { r: 255, g: 214, b: 138 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -16, y: 15 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 13 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -15, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 17, y: 12 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 36, y: 12 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -9, y: 14 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 13 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 19, y: 13 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 33, y: 13 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 44, y: 14 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -5, y: 14 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 1, y: 13 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 13 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 13 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 28, y: 13 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 35, y: 13 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 3, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 8, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 13, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 18, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 23, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 27, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 31, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 36, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 41, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%%%%%%%▄▀█
                            %%%%%%%%%%%%%%%%▄▀ ▀▀▄
                            %%%%%%%%%%%%%%%█    ▀ ▀▀▄
                            %▄▀▀▀▄%%%%%%%▄▀      ▄▀▀
                            █  ▀▀ ▀▀▀▀▀▀▀       █
                            ▀▄▄▄▀               █
                            %%█  ▄▄▄▄     ▀▄   █
                            %█  █%%%%▀▀▀▀▀▀█  █
                            %█ █%%%%%%%%%%%█ █
                            %█▄█▄%%%%%%%%%%█▄█▄
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%%%%▄
                            %%%%%%%%%%%█▀▄▄▄
                            %▄▄%%%%%%▄▀     ▀▄
                            █ ▄▀▀▀▀▀▀    ▄▀▀▀
                            ▀▄         ▄▀
                            %%█▄▀▀▀▀▀▄▄█
                            %%█▄%%%%%%%█▄
                            %
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %
                            %%%%%%%%▄
                            %▄%%%%%▄▀▀▀▄
                            ▀▄▀▀▀▀▀  ▄▀
                            %%█▄▀▀▀▀█▄
                            %
                            %
                        `,
                    },
                    {
                        data: `
                            ▌▙▖
                            ▝▀
                        `,
                    },
                    {
                        data: `
                            ♠
                        `,
                    },
                ],
            },

            pigeon: {
                relativeColor: { r: 79, g: 194, b: 146 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 14 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 14 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 16, y: 10 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 33, y: 10 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 11 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 10 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 20, y: 10 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 32, y: 10 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 43, y: 11 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -5, y: 13 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 12 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 12 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 27, y: 12 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 34, y: 12 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 4, y: 13 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 9, y: 13 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 14, y: 13 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 19, y: 13 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 24, y: 13 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 28, y: 13 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 32, y: 13 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 37, y: 13 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 13 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                               ▄▄▄▄▄%%%%%%%%%%
                               %█   █%%%%▄▄%%%
                               %%▀▄  █%▄▀▄ ▀▄▄
                               %%%█   █    ▄▀%
                               %%%%█   ▀  █%%%
                               ▄▀▄▀      █%%%%
                               ▄▀▄     ▄▀%%%%%
                               ▀▀%▀█▀▀▀▄%%%%%%
                               %%%▄▀▄%▀%▀%%%%%
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                              %%█▄%%%%%%
                              %%█ ▀▄▀▀▄▄
                              %%▀▄  ▄▀%%
                              %%%▄▀▀▄%%%
                              %%%%%%%%%%
                              %%%%%%%%%%
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                              %▄%%%
                              %%▀▄▀
                              %%%▀%
                              %%%%%
                        `,
                    },
                    {
                        data: `
                            >▄
                        `,
                    },
                    {
                        data: `
                            ƒ
                        `,
                    },
                ],
            },

            vampire: {
                relativeColor: { r: 247, g: 119, b: 247 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 14 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 14 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -13, y: 12 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 16, y: 10 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 33, y: 10 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 11 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 10 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 20, y: 10 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 32, y: 10 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 43, y: 11 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -5, y: 13 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: 0, y: 12 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 11, y: 12 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 22, y: 12 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 27, y: 12 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 34, y: 12 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 14 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 4, y: 13 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 9, y: 13 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 14, y: 13 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 19, y: 13 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 24, y: 13 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 28, y: 13 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 32, y: 13 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 37, y: 13 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 42, y: 13 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄%▄
                            %%%%%%%%███
                            %%%▄███▄▀█▀▄███▄
                            %%███████████████
                            %%█████▀███▀█████
                            %%██▀%% ▀█▀ %%▀██
                            %%█%%%%▀▀%▀▀%%%%█
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %
                            %
                            %▄██▄█▄██▄
                            ███████████
                            █▀%%▀█▀%%▀█
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                            %
                            %
                            ▄▀▄▀▄
                            ▀%%%▀
                        `,
                    },
                    {
                        data: `
                            π
                        `,
                    },
                    {
                        data: `
                            π
                        `,
                    },
                ],
            },

            crater: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 23 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 23 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 20 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 20 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 22 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 30, y: 17 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 42, y: 22 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -9, y: 19 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 8, y: 15 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 15 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 29, y: 15 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 36, y: 15 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 19 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 7, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 12, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 17, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 22, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 26, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 35, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 40, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%%%▄▄▄▄████████████▄▄▄▄
                            %%%%%▄████▛██▞█▞██▟▛▟██▚█▜████▄
                            %%%%▀██▟███▛███▀▀▀▀▀▀██▜███▟███▀
                            %%%%%%▀▀▀▀████████████████▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▃▄▄▄▄▄▄▄▄▃
                            %▀▀████▄▄▄▄████▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▁▂▂▂▂▂▂▁
                            ▀████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▂▂▂▂
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╼╾
                        `,
                    },
                ],
            },

            bloodyCrater: {
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -28, y: 23 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 23 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: -25, y: 20 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 7, y: 20 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 39, y: 20 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -7, y: 22 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 3, y: 17 },
                    },
                    p2_2: {
                        artIndex: 1,
                        drawAt: { x: 16, y: 17 },
                    },
                    p2_3: {
                        artIndex: 1,
                        drawAt: { x: 30, y: 17 },
                    },
                    p2_4: {
                        artIndex: 1,
                        drawAt: { x: 42, y: 22 },
                    },
                    p3_0: {
                        artIndex: 2,
                        drawAt: { x: -9, y: 19 },
                    },
                    p3_1: {
                        artIndex: 2,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_2: {
                        artIndex: 2,
                        drawAt: { x: 8, y: 15 },
                    },
                    p3_3: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 15 },
                    },
                    p3_4: {
                        artIndex: 2,
                        drawAt: { x: 29, y: 15 },
                    },
                    p3_5: {
                        artIndex: 2,
                        drawAt: { x: 36, y: 15 },
                    },
                    p3_6: {
                        artIndex: 2,
                        drawAt: { x: 46, y: 19 },
                    },
                    p4_0: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 14 },
                    },
                    p4_1: {
                        artIndex: 3,
                        drawAt: { x: 7, y: 14 },
                    },
                    p4_2: {
                        artIndex: 3,
                        drawAt: { x: 12, y: 14 },
                    },
                    p4_3: {
                        artIndex: 3,
                        drawAt: { x: 17, y: 14 },
                    },
                    p4_4: {
                        artIndex: 3,
                        drawAt: { x: 22, y: 14 },
                    },
                    p4_5: {
                        artIndex: 3,
                        drawAt: { x: 26, y: 14 },
                    },
                    p4_6: {
                        artIndex: 3,
                        drawAt: { x: 30, y: 14 },
                    },
                    p4_7: {
                        artIndex: 3,
                        drawAt: { x: 35, y: 14 },
                    },
                    p4_8: {
                        artIndex: 3,
                        drawAt: { x: 40, y: 14 },
                    },
                    p5_0: {
                        artIndex: 4,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 4,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 4,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 4,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 4,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 4,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 4,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 4,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%%▘%▄▄▄▄████████████▄▄▄▄%▘
                            %%%%%▄██▘ ▀▝▞██▟▛██▛██▀████▀██▄▗
                            %%%%▀███▖ ▄▗▚██▀▀▀▀▀▀█▀▄▄▄▄▀███▀
                            %%%▝%%▀▀▀▀████▟████▟██████▀▀▀▀%%▗
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %%%%▃▄▄▄▄▄▄▄▄▃
                            %▀▀████▄▄▄▄████▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▁▂▂▂▂▂▂▁
                            ▀████████▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        transparentCharacter: '%',
                        data: `
                            %▂▂▂▂
                            ▀▀▀▀▀▀
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ╼╾
                        `,
                    },
                ],
            },

            gravestone: {
                relativeColor: { r: 191, g: 191, b: 191 },
                positions: {
                    p0_0: {
                        artIndex: 0,
                        drawAt: { x: -19, y: 22 },
                    },
                    p0_2: {
                        artIndex: 0,
                        drawAt: { x: 48, y: 22 },
                    },
                    p1_0: {
                        artIndex: 0,
                        drawAt: { x: 0, y: -14 },
                    },
                    p1_1: {
                        artIndex: 0,
                        drawAt: { x: 14, y: 16 },
                    },
                    p1_2: {
                        artIndex: 0,
                        drawAt: { x: 45, y: 16 },
                    },
                    p2_0: {
                        artIndex: 1,
                        drawAt: { x: -8, y: 15 },
                    },
                    p2_1: {
                        artIndex: 1,
                        drawAt: { x: 4, y: 16 },
                    },
                    p2_2: {
                        artIndex: 2,
                        drawAt: { x: 20, y: 16 },
                    },
                    p2_3: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 36, y: 16 },
                    },
                    p2_4: {
                        artIndex: 2,
                        drawOptions: { flippedX: true },
                        drawAt: { x: 46, y: 16 },
                    },
                    p3_0: {
                        artIndex: 3,
                        drawAt: { x: -3, y: 15 },
                    },
                    p3_1: {
                        artIndex: 3,
                        drawAt: { x: 2, y: 15 },
                    },
                    p3_2: {
                        artIndex: 3,
                        drawAt: { x: 13, y: 15 },
                    },
                    p3_3: {
                        artIndex: 3,
                        drawAt: { x: 23, y: 15 },
                    },
                    p3_4: {
                        artIndex: 3,
                        drawAt: { x: 33, y: 15 },
                    },
                    p3_5: {
                        artIndex: 3,
                        drawAt: { x: 39, y: 15 },
                    },
                    p3_6: {
                        artIndex: 3,
                        drawAt: { x: 46, y: 15 },
                    },
                    p4_0: {
                        artIndex: 4,
                        drawAt: { x: 6, y: 14 },
                    },
                    p4_1: {
                        artIndex: 4,
                        drawAt: { x: 11, y: 14 },
                    },
                    p4_2: {
                        artIndex: 4,
                        drawAt: { x: 16, y: 14 },
                    },
                    p4_3: {
                        artIndex: 4,
                        drawAt: { x: 21, y: 14 },
                    },
                    p4_4: {
                        artIndex: 4,
                        drawAt: { x: 24, y: 14 },
                    },
                    p4_5: {
                        artIndex: 4,
                        drawAt: { x: 28, y: 14 },
                    },
                    p4_6: {
                        artIndex: 4,
                        drawAt: { x: 33, y: 14 },
                    },
                    p4_7: {
                        artIndex: 4,
                        drawAt: { x: 38, y: 14 },
                    },
                    p4_8: {
                        artIndex: 4,
                        drawAt: { x: 43, y: 14 },
                    },
                    p5_0: {
                        artIndex: 5,
                        drawAt: { x: 14, y: 14 },
                    },
                    p5_1: {
                        artIndex: 5,
                        drawAt: { x: 16, y: 14 },
                    },
                    p5_2: {
                        artIndex: 5,
                        drawAt: { x: 18, y: 14 },
                    },
                    p5_3: {
                        artIndex: 5,
                        drawAt: { x: 20, y: 14 },
                    },
                    p5_4: {
                        artIndex: 5,
                        drawAt: { x: 22, y: 14 },
                    },
                    p5_5: {
                        artIndex: 5,
                        drawAt: { x: 24, y: 14 },
                    },
                    p5_6: {
                        artIndex: 5,
                        drawAt: { x: 26, y: 14 },
                    },
                    p5_7: {
                        artIndex: 5,
                        drawAt: { x: 28, y: 14 },
                    },
                    p5_8: {
                        artIndex: 5,
                        drawAt: { x: 30, y: 14 },
                    },
                    p5_9: {
                        artIndex: 5,
                        drawAt: { x: 32, y: 14 },
                    },
                    p5_10: {
                        artIndex: 5,
                        drawAt: { x: 34, y: 14 },
                    },
                },
                art: [
                    {
                        transparentCharacter: '%',
                        data: `
                            %%%%%▄▄▄▄▄▄▄▄▄▄▄▄▄%%%%
                            %%%%█             █%%%
                            %%%%█             █%%%
                            %%%%█ █▀▄  ▀  █▀▄ █%%%
                            %%%█  █▀▄  █  █▀   █%%
                            %%%█               █%%
                            %%▄█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█▄%
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `

                              ▄▀▀▀█▀▄ 
                             █RIP █ █ 
                            ▄█▄▄▄▄█▄█ 
                        `,
                    },
                    {
                        transparentCharacter: '%',
                        data: `
                                      
                            %%▄▀▀▀▄%%%
                            %%█   █%%%
                            %▄▀RIP▀▄%%
                            ▀▀▀▀▀▀▀▀▀%
                        `,
                    },
                    {
                        data: `
                            ▐▀▀▌
                            ▌  ▐
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▆▆
                        `,
                    },
                    {
                        automaskBlockCharacters: true,
                        data: `
                            ▗▖
                        `,
                    },
                ],
            },
        };

        const Portrait = {
            activeFrame: 0,
            timer: null,
            hide: () => {
                clearTimeout(Portrait.timer);
                document.getElementById('portraitArtOverlay').classList.add('hidden');
                document.getElementById('minimapContainer').classList.remove('invisible');
            },
            show: (portraitName) => {
                const $overlay = document.getElementById('portraitArtOverlay');
                if (!$overlay) {
                    console.error("Could not find portraitArtOverlay");
                    return;
                }

                const animation = Portrait.animations = window.PORTRAIT_ANIMATIONS[portraitName];
                if (typeof animation !== 'object') {
                    console.error("Could not find specified portrait", {
                        portraitName,
                    });
                    return;
                }

                document.getElementById('minimapContainer').classList.add('invisible');

                clearTimeout(Portrait.timer);
                Portrait.activeFrame = 0;
                $overlay.className = `portrait-art ${portraitName}`

                function drawFrame() {
                    const formattedFrame =
                        ('\n'.repeat(animation.padding.y)) +
                        (animation.frames[Portrait.activeFrame]
                            .split("\n")
                            .map((l) => " ".repeat(animation.padding.x || 0) + l)
                            .join('\n')
                    );

                    $overlay.innerText = formattedFrame;
                    Portrait.activeFrame++;

                    if (Portrait.activeFrame < animation.frames.length) {
                        Portrait.timer = setTimeout(
                            drawFrame,
                            animation.frameDelayMs
                        );
                    } else {
                        if (animation.playbackMode === "repeat") {
                            Portrait.activeFrame = 0;
                            Portrait.timer = setTimeout(
                                drawFrame,
                                animation.frameDelayMs
                            );
                        }
                    }
                }
                drawFrame();
            },
        };

        const SpeechSynthesizer = {
            isSpeaking: false,
            queue: [],
            pronunciationOverrides: {
                "gauge": "gayge",
                "ps2": "pee ess too",
                "lughead": "lug head",
                "the": "thuh",
                "goodbye": "good bye",
                "tasty": "tay stee",
                "consent": "cun sent",
                "date": "daytt",
                "id": "eye dee",
                "delivered": "deliv urd",
                "adventurer": "advent ur rehr",
                "motorcycles": "motor psy culls",
            },

            speak: (sentence, voiceOptions, onEnded) => {
                SpeechSynthesizer.queue = SpeechSynthesizer.queue.filter(
                    ([queuedSentence]) => queuedSentence !== sentence
                );
                // If already speaking, queue the next request
                if (SpeechSynthesizer.isSpeaking) {
                    SpeechSynthesizer.queue.push([sentence, voiceOptions, onEnded]);
                    return;
                }
                if (!speechEnabled) {
                    onEnded?.();
                    return;
                }

                let normalizedSentence = SpeechSynthesizer.normalizeNumbers(sentence);
                normalizedSentence = SpeechSynthesizer.expandAcronyms(normalizedSentence);
                normalizedSentence = SpeechSynthesizer.applyPronunciationOverrides(normalizedSentence);

                SpeechSynthesizer.isSpeaking = true;
                const options = structuredClone(voiceOptions);
                options.singmode = Math.random() < 0.5;
                options.reverb = {
                    wetGain: 0.05,
                    dryGain: 0.85,
                    delayTimeSeconds: 0.02,
                    decay: 0.3,
                    totalDelays: 5,
                    lowpassFilterCutoffHz: 1760,
                };
                options.onEnded = () => {
                    SpeechSynthesizer.isSpeaking = false;
                    onEnded?.();
                    // Play next in queue if present
                    if (SpeechSynthesizer.queue.length > 0) {
                        const [nextSentence, nextVoiceOptions, nextOnEnded] = SpeechSynthesizer.queue.shift();
                        SpeechSynthesizer.speak(nextSentence, nextVoiceOptions, nextOnEnded);
                    }
                };

                new SamJs(options).speak(normalizedSentence);
            },

            applyPronunciationOverrides: (text) => {
                return text.replace(/\b([\w']+)\b/g, (m, w) => {
                    const lower = w.toLowerCase();
                    if (Object.hasOwn(SpeechSynthesizer.pronunciationOverrides, lower)) {
                        const repl = SpeechSynthesizer.pronunciationOverrides[lower];
                        if (w === w.toUpperCase()) {
                            return /[\s-]/.test(repl) ? repl : repl.toUpperCase();
                        }
                        if (w[0] === w[0].toUpperCase()) {
                            return repl.charAt(0).toUpperCase() + repl.slice(1);
                        }
                        return repl;
                    }
                    return m;
                });
            },

            expandAcronyms: (text) => {
                // VOCAP: use known acronyms to avoid expanding common ones, such as "HAHA" (whoops).
                const knownAcronyms = [
                    "HP", "EXP", "BTC" // VOCAP: not currently much use for this feature but maybe in the future?
                ];
                return text.replace(/\b([A-Z]{2,6})\b/g, (m, w) => {
                    if (!knownAcronyms.includes(w)) return w;
                    const lower = w.toLowerCase();
                    if (Object.hasOwn(SpeechSynthesizer.pronunciationOverrides, lower)) return w;
                    if (/'/.test(w)) return w;
                    return w.split('').join(' ');
                });
            },

            normalizeNumbers: (text) => {
                // Pass 1: fractions
                let out = text.replace(/(^|[^A-Za-z0-9+/-])([+-]?)(\d+)\s*\/\s*(\d+)(?=$|[^A-Za-z0-9/])/g,
                    (full, pre, sign, numStr, denStr) => {
                        const num = Number(numStr);
                        const den = Number(denStr);
                        if (!Number.isSafeInteger(num) || !Number.isSafeInteger(den) || den === 0) return full;
                        if (numStr.length > 15 || denStr.length > 15) return full;
                        const words = SpeechSynthesizer.fractionToWords(
                            sign === '-' ? -1 : (sign === '+' ? 1 : 0),
                            num,
                            den
                        );
                        return pre + words;
                    });

                // Pass 2: decimals
                out = out.replace(/(^|[^A-Za-z0-9.])([+-]?)(\d{1,3}(?:,\d{3})*|\d+)\.(\d+)(?=$|[^0-9.])/g,
                    (full, pre, sign, intPart, fracPart) => {
                        const cleanInt = intPart.replace(/,/g, '');
                        if (cleanInt.length > 15 || fracPart.length > 30) return full;
                        if (!/^\d+$/.test(cleanInt) || !/^\d+$/.test(fracPart)) return full;
                        const intNum = Number(cleanInt);
                        if (!Number.isSafeInteger(intNum) || intNum > 999_999_999_999) return full;
                        return pre + SpeechSynthesizer.decimalToWords(sign, intNum, fracPart);
                    });

                // Pass 3: signed / unsigned integers
                out = out.replace(/(^|[^A-Za-z0-9])([+-]?)(\d{1,3}(?:,\d{3})*|\d{1,15})(?=$|[^0-9])/g,
                    (full, pre, sign, body) => {
                        const clean = body.replace(/,/g, '');
                        if (clean.length > 15) return full;
                        if (!/^\d+$/.test(clean)) return full;
                        const n = Number(clean);
                        if (!Number.isSafeInteger(n) || n > 999_999_999_999) return full;
                        return pre + SpeechSynthesizer.signedIntegerToWords(sign, n);
                    });

                return out;
            },

            signedIntegerToWords: (sign, n) => {
                if (n === 0) return "zero";
                const core = SpeechSynthesizer.numberToWordsLarge(n);
                if (sign === '-') return `negative ${core}`;
                if (sign === '+') return `positive ${core}`;
                return core;
            },

            decimalToWords: (sign, intNum, fracStr) => {
                const intWords = SpeechSynthesizer.numberToWordsLarge(intNum);
                const fracDigits = fracStr.split('').map(d => SpeechSynthesizer.numberToWordsSmall(Number(d)));
                const signWord = sign === '-' ? 'negative ' : (sign === '+' ? 'positive ' : '');
                return `${signWord}${intWords} point ${fracDigits.join(' ')}`.replace(/\s+/g, ' ').trim();
            },

            fractionToWords: (signFlag, numerator, denominator) => {
                // Reduce fraction
                const gcd = (a, b) => b ? gcd(b, a % b) : a;
                const g = gcd(numerator, denominator);
                numerator = numerator / g;
                denominator = denominator / g;

                const signWord = signFlag < 0 ? 'negative ' : (signFlag > 0 ? 'positive ' : '');
                const numWords = SpeechSynthesizer.numberToWordsLarge(numerator);
                const denomWords = SpeechSynthesizer.fractionDenominatorToWords(denominator, numerator !== 1);

                if (!denomWords) {
                    const denomFallback = SpeechSynthesizer.numberToWordsLarge(denominator);
                    return `${signWord}${numWords} over ${denomFallback}`.trim();
                }
                return `${signWord}${numWords} ${denomWords}`.trim();
            },

            fractionDenominatorToWords: (den, plural) => {
                const map = {
                    2: ['half', 'halves'],
                    3: ['third', 'thirds'],
                    4: ['fourth', 'fourths'],
                    5: ['fifth', 'fifths'],
                    6: ['sixth', 'sixths'],
                    7: ['seventh', 'sevenths'],
                    8: ['eighth', 'eighths'],
                    9: ['ninth', 'ninths'],
                    10: ['tenth', 'tenths'],
                    11: ['eleventh', 'elevenths'],
                    12: ['twelfth', 'twelfths'],
                }[den];
                if (!map) return null;
                return plural ? map[1] : map[0];
            },

            numberToWordsSmall: (n) => {
                const ones = [
                    "zero","one","two","three","four","five","six","seven","eight","nine","ten",
                    "eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"
                ];
                const tens = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
                if (n < 20) return ones[n];
                if (n < 100) {
                    const t = Math.floor(n / 10);
                    const o = n % 10;
                    return o ? `${tens[t]}-${ones[o]}` : tens[t];
                }
                const h = Math.floor(n / 100);
                const r = n % 100;
                return r ? `${ones[h]} hundred ${SpeechSynthesizer.numberToWordsSmall(r)}` : `${ones[h]} hundred`;
            },

            numberToWordsLarge: (n) => {
                if (n === 0) return "zero";
                const scales = ["", "thousand", "million", "billion", "trillion"];
                const parts = [];
                let scaleIndex = 0;
                while (n > 0 && scaleIndex < scales.length) {
                    const chunk = n % 1000;
                    if (chunk) {
                        const words = SpeechSynthesizer.numberToWordsSmall(chunk);
                        const scaleWord = scales[scaleIndex];
                        parts.unshift(scaleWord ? `${words} ${scaleWord}` : words);
                    }
                    n = Math.floor(n / 1000);
                    scaleIndex++;
                }
                return parts.join(' ').replace(/\s+/g, ' ').trim();
            },
        };

        const sceneRenderer = {
            displayWidth: 50,
            displayHeight: 28,
            maxViewDepth: 5,

            render: (x, y, direction, viewDepth, maxBrightness = 255) => {
                const maxPlayerVisibilityDepth = viewDepth || sceneRenderer.maxViewDepth;
                const view = sceneRenderer.getView(x, y, direction, maxPlayerVisibilityDepth);
                const layerClasses = sceneRenderer.getLayerClasses();
                let scene = '';

                for (let depth = view.length - 1; depth >= 0; depth--) {
                    let sceneLayer = Array.from({ length: sceneRenderer.displayHeight }, () =>
                        Array.from({ length: sceneRenderer.displayWidth }, () => ' ')
                    );

                    for (let i = 0; i < view[depth].length; i++) {
                        // Render the scene from the sides towards the middle
                        const index = i % 2 === 0 ? i - (i / 2) : view[depth].length - Math.floor(i / 2) - 1;
                        const isCentered = i === view[depth].length - 1;

                        for (let j=0; j<view[depth][index].length; j++) {
                            sceneLayer = sceneRenderer.draw(
                                sceneLayer,
                                view[depth][index][j],
                                depth,
                                maxPlayerVisibilityDepth,
                                index,
                                isCentered,
                                maxBrightness
                            );
                        }
                    }

                    scene +=
                        `<div class="${layerClasses}">` +
                            sceneLayer.map(row => row.join('')).join('\n') +
                        '</div>';
                }

                return scene;
            },

            getLayerClasses: () => {
                const layerClasses = ['layer'];
                if (player.enteringCombat) {
                    layerClasses.push('darkening');
                } else if (player.leavingCombat) {
                    layerClasses.push('lightening');
                } else if (player.inCombat) {
                    layerClasses.push('dark');
                }

                return layerClasses.join(' ');
            },

            getView: (x, y, direction, viewDepth) => {
                const fixedViewDepth = Math.min(viewDepth, sceneRenderer.maxViewDepth);
                const grid = [];

                const directionVectors = {
                    N: { dx: 0, dy: -1, lateral: { dx: 1, dy: 0 }, flip: 1 },
                    S: { dx: 0, dy: 1, lateral: { dx: 1, dy: 0 }, flip: -1 },
                    E: { dx: 1, dy: 0, lateral: { dx: 0, dy: 1 }, flip: 1 },
                    W: { dx: -1, dy: 0, lateral: { dx: 0, dy: 1 }, flip: -1 }
                };

                const dir = directionVectors[direction];
                if (!dir) {
                    console.error("Invalid direction");
                    return [];
                }

                for (let depth = 0; depth <= sceneRenderer.maxViewDepth; depth++) {
                    const row = [];
                    const offsetStart = depth === 0 ? -1 : -depth;
                    const offsetEnd = depth === 0 ? 1 : depth;

                    for (let offset = offsetStart; offset <= offsetEnd; offset++) {
                        const gridCell = [];
                        const lateralOffset = offset * dir.flip;
                        const tx =
                            x + dir.dx * depth + dir.lateral.dx * lateralOffset;
                        const ty =
                            y + dir.dy * depth + dir.lateral.dy * lateralOffset;

                        gridCell.push(
                            depth > fixedViewDepth
                                ? new MapCell('darkness')
                                : MAP.getCell(tx, ty)
                        );

                        // NPC check
                        if (vampire.isAt(tx, ty)) {
                            gridCell.push({ type: "vampire" });
                        } else if (pigeon.isAt(tx, ty)) {
                            gridCell.push({ type: "pigeon" });
                        } else if (roamingEnemies.isAt(tx, ty)) {
                            gridCell.push({ type: "roamingEnemy" });
                        }
                        // Trap check
                        if (boulder.isAt(tx, ty)) {
                            gridCell.push({ type: "boulder" });
                        }
                        row.push(gridCell);
                    }

                    grid.push(row);
                }

                return grid;
            },

            draw: (scene, subject, depth, maxPlayerVisibilityDepth, index, isCentered, maxBrightness) => {
                if (typeof subject?.isVisible === 'function' && !subject.isVisible()) {
                    return scene;
                }

                const entityName = sceneRenderer.getEntityName(subject);
                const sceneEntity = sceneArt[entityName];
                const key = `p${depth}_${index}`;
                const entry = sceneEntity?.positions?.[key] || null;
                if (!entry) {
                    return scene;
                }

                const indexedArt = sceneEntity.art[entry.artIndex] || null;
                if (!indexedArt) {
                    return scene;
                }

                const art = sceneRenderer.formatArt(indexedArt);
                const transparentCharacter = indexedArt.transparentCharacter || null;
                const className = `class="scene_character_${entityName}"`;
                const longestLine = Math.max(...art.split("\n").map((l) => l.length)) - 1;

                const drawOptions = {
                    flippedX: entry?.drawOptions?.flippedX || false,
                };

                let xPosition = entry.drawAt.x + (drawOptions.flippedX ? longestLine : 0);
                let yPosition = entry.drawAt.y;

                for (const character of art) {
                    if (character === "\n") {
                        xPosition = entry.drawAt.x + (drawOptions.flippedX ? longestLine : 0);
                        yPosition++;
                        continue;
                    }

                    // Draw only if in bounds
                    if (typeof scene[yPosition]?.[xPosition] !== 'undefined') {
                        if (character !== transparentCharacter) {
                            const automask =
                                (indexedArt?.automaskBlockCharacters || false) &&
                                [
                                    '▀', '▁', '▂', '▃', '▄', '▅', '▆', '▇', '█',
                                    '▉', '▊', '▋', '▌', '▍', '▎', '▏', '▐', '▔',
                                    '▕', '▖', '▗', '▘', '▙', '▚', '▛', '▜', '▝',
                                    '▞', '▟'
                                ].includes(character);


                            let characterStyle = '';

                            if (sceneEntity.relativeColor) {
                                const entityColor = sceneEntity.relativeColor;
                                // Make the spaces directly in front of the
                                // player fully bright
                                const adjustedDepth = depth - (isCentered ? 1 : 0);

                                const characterColor = {
                                    r: sceneRenderer.getCharacterColor(entityColor.r, adjustedDepth, maxPlayerVisibilityDepth, maxBrightness),
                                    g: sceneRenderer.getCharacterColor(entityColor.g, adjustedDepth, maxPlayerVisibilityDepth, maxBrightness),
                                    b: sceneRenderer.getCharacterColor(entityColor.b, adjustedDepth, maxPlayerVisibilityDepth, maxBrightness),
                                };
                                characterStyle += `color: rgb(${characterColor.r}, ${characterColor.g}, ${characterColor.b}); `;
                            }

                            // TODO: Fix this weird logic. This works best for
                            // walls, but isn't great for floors or much else
                            if (!automask) {
                                characterStyle += 'background-color: #000; ';
                            }
                            if (
                                ['treasureChest', 'healingTile', 'exit'].includes(entityName)
                            ) {
                                // Calculate brightness based on view distance (depth) for the chest, heatile, and exit
                                const adjustedDepth = depth - (isCentered ? 1 : 0);
                                const ratio = Math.max(0, Math.min(1, adjustedDepth / maxPlayerVisibilityDepth));
                                // Exponential falloff, tweak as needed
                                const brightness = 1 - ratio * 0.7;
                                characterStyle += `filter: brightness(${brightness}); `;
                            }

                            const styleHtml = characterStyle !== '' ? ` style="${characterStyle.trim()}"` : '';
                            scene[yPosition][xPosition] =
                                `<span ${className}${styleHtml}>${character}</span>`;
                        }
                    }

                    xPosition += drawOptions.flippedX ? -1 : 1;
                }

                return scene;
            },

            getCharacterColor: (value, depth, maxPlayerVisibilityDepth, maxBrightness = 255) => {
                if (depth <= 0) {
                    return Math.min(value, maxBrightness);
                }

                if (depth >= maxPlayerVisibilityDepth) {
                    return 0;
                }

                const brightnessFalloffRate = 4;
                const ratio = depth / maxPlayerVisibilityDepth;
                const brightnessFactor = Math.exp(-brightnessFalloffRate * ratio);
                const normalizedValue = (value / 255) * maxBrightness;
                const adjustedValue = Math.round(normalizedValue * brightnessFactor);

                return Math.max(0, Math.min(maxBrightness, adjustedValue));
            },

            getEntityName: (entity) => {
                if (entity?.type === 'mimic') {
                    return 'treasureChest';
                }

                return entity?.type || 'void';
            },

            formatArt: (art) => {
                // Trim any whitespace from the template literal
                const formattedArt = art.data.replace(/^ *\n|\n *$/g, '');
                const lines = formattedArt.split("\n");
                // Safely handle lines with no leading spaces
                const shortestLeadingWhitespace = Math.min(
                    ...lines
                        .filter(line => line.trim().length > 0)
                        .map(line => {
                            const match = line.match(/^ +/);
                            return match ? match[0].length : 0;
                        })
                );
                const trimmedArt = lines.map(line => line.substr(shortestLeadingWhitespace)).join("\n");

                return (
                    typeof art.spaceBoundaryCharacter !== 'undefined'
                        ? trimmedArt.replaceAll(art.spaceBoundaryCharacter, ' ')
                        : trimmedArt
                );
            },

            drawEnemyLayer: (enemyId) => {
                const indexedArt = window.ENEMY_ART[enemyId] || null;
                if (!indexedArt) {
                    console.error("Could not find enemy art entry", { enemyId });
                    return null;
                }

                let art = sceneRenderer.formatArt(indexedArt);

                // Apply horizontal offset if specified
                if (indexedArt.offsetX) {
                    art = art
                        .split('\n')
                        .map(line => ' '.repeat(indexedArt.offsetX) + line)
                        .join('\n');
                }

                // Apply vertical offset if specified
                if (indexedArt.offsetY) {
                    art = '\n'.repeat(indexedArt.offsetY) + art;
                }

                return `<div class="layer enemy">
                    <pre>${art}</pre>
                </div>`;
            },

            drawHealingLayer: () => '<div class="layer healing"></div>',
        };

        // === UI Hint Swapper ===
        (function(){
            const STATE = { last: 'keyboard' };

            function apply(){
                document.querySelectorAll('.control-list span[data-control]').forEach(el=>{
                    const html = el.dataset[STATE.last];
                    if (html) el.innerHTML = html;
                });
            }
            function set(device){
                if (STATE.last === device) return;
                STATE.last = device;
                apply();
            }

            // Keyboard activity
            window.addEventListener('keydown', ()=> set('keyboard'), { passive:true });

            // Gamepad connection events
            window.addEventListener('gamepadconnected', ()=> set('gamepad'));
            window.addEventListener('gamepaddisconnected', ()=>{
                // Fallback
                const pads = navigator.getGamepads?.() || [];
                if (!pads.some(p=>p)) set('keyboard');
            });

            // VOCAP: Expose for gamepad.js hook (called inside its processGamepad loop)
            window.InputDeviceManager = {
                setLast: d => set(d === 'gamepad' ? 'gamepad' : 'keyboard'),
                getLast: () => STATE.last
            };

            document.addEventListener('DOMContentLoaded', apply);
            apply();
        })();

        const GameControl = {
            mode: "title screen",
            enabled: true,
            awaitingPersuasionText: false,

            enableControls: () => {
                window._inputBlocked = false;
                GameControl.enabled = true;
                // Re-enable inventory sidebar buttons when controls are enabled
                if (typeof InventorySidebar !== 'undefined') {
                    InventorySidebar.setEnabled(true);
                }
                GameControl.update();
            },

            disableControls: () => {
                // Block input only if not awaiting persuasion text
                if (!GameControl.awaitingPersuasionText) {
                    window._inputBlocked = true;
                }
                GameControl.enabled = false;
                // Disable inventory sidebar buttons while controls are disabled
                if (typeof InventorySidebar !== 'undefined') {
                    InventorySidebar.setEnabled(false);
                }
                GameControl.update();
            },

            getMode: () => {
                if (TITLE_SCREEN.isActive) {
                    return "title screen";
                }

                return menu.isOpen()
                    ? "menu"
                    : (player.inCombat ? "combat" : "navigation");
            },

            updateMode: () => {
                const skipModeUpdate =
                    ! TITLE_SCREEN.isActive &&
                    ( GameControl.mode === "menu" && menu.isOpen()) ||
                    ! menu.isOpen() && (
                        ( GameControl.mode === "navigation" && !player.inCombat ) ||
                        ( GameControl.mode === "combat" && player.inCombat )
                    );

                if (skipModeUpdate) {
                    return;
                }

                GameControl.mode = GameControl.getMode();

                // Update the displayed buttons based on the mode
                document.querySelectorAll(`
                    #playerInput .section.navigation,
                    #mouseControl .navigation
                `).forEach($element => {
                    $element.classList.toggle(
                        "hidden",
                        GameControl.mode !== "navigation"
                    );
                });

                document.querySelectorAll(`
                    #playerInput .section.battle,
                    #mouseControl .combat
                `).forEach($element => {
                    $element.classList.toggle(
                        "hidden",
                        GameControl.mode !== "combat"
                    );
                });

                document.querySelectorAll(`
                    #playerInput .section.menu
                `).forEach($element => {
                    $element.classList.toggle(
                        "hidden",
                        GameControl.mode !== "menu"
                    );
                });

                // Update the keyboard control display based on the mode
                const $controlsExploration =
                    document.getElementById("controlsExploration");
                const $controlsCombat =
                    document.getElementById("controlsCombat");
                const $controlsMenu =
                    document.getElementById("controlsMenu");

                if (GameControl.mode === "menu") {
                    $controlsMenu.classList.remove("hidden");
                    $controlsExploration.classList.add("hidden");
                    $controlsCombat.classList.add("hidden");
                } else if (GameControl.mode === "combat") {
                    if (!GameControl.awaitingPersuasionText) {
                        $controlsCombat.classList.remove("hidden");
                        $controlsExploration.classList.add("hidden");
                        $controlsMenu.classList.add("hidden");
                    }
                } else {
                    $controlsExploration.classList.remove("hidden");
                    $controlsCombat.classList.add("hidden");
                    $controlsMenu.classList.add("hidden");
                }
            },

            update: () => {
                if (gameOver) {
                    const $mouseControl =
                        document.getElementById('mouseControl');
                    if ($mouseControl) {
                        $mouseControl.style.display = 'none';
                    }
                    return;
                } else {
                    const $mouseControl =
                        document.getElementById('mouseControl');
                    if ($mouseControl) {
                        $mouseControl.style.display = 'block';
                    }
                }

                GameControl.updateMode();

                switch (GameControl.mode) {
                    case "title screen":
                        // Nothing to do
                        break;
                    case "navigation":
                        GameControl.updateNavigationControls();
                        break;
                    case "menu":
                        GameControl.updateMenuControls();
                        break;
                    case "combat":
                        GameControl.updateCombatControls();
                        break;
                    default:
                        console.error(
                            "Unknown GameControl mode",
                            { mode: GameControl.mode }
                        );
                        break;
                }
            },

            updateNavigationControls: () => {
                const $playerInput = document.getElementById("playerInput");
                const $mouseControl = document.getElementById("mouseControl");

                // Move Forward
                const frontX = player.x + DX[player.dir];
                const frontY = player.y + DY[player.dir];
                const cellInFrontOfPlayer = MAP.getCell(frontX, frontY);
                const controlsEnabled =
                    GameControl.enabled &&
                    !player.movementDisabled;
                const touchEnabled =
                    controlsEnabled &&
                    typeof cellInFrontOfPlayer?.onTouch === "function";
                const moveForwardEnabled =
                    controlsEnabled &&
                    !touchEnabled &&
                    cellInFrontOfPlayer?.isSolid === false;

                // No "Touch" or "Interact" on the button menu yet since
                // it's the same as moving forward anyways
                if (moveForwardEnabled) {
                    $playerInput.querySelector('[name="forward"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="forward"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".touch")?.classList
                    .toggle("hidden", !touchEnabled);
                $mouseControl.querySelector(".forward")?.classList
                    .toggle("hidden", !moveForwardEnabled);

                // Move Left
                const leftX = player.x + DX[(player.dir + 3) % 4];
                const leftY = player.y + DY[(player.dir + 3) % 4];
                const cellLeftOfPlayer = MAP.getCell(leftX, leftY);
                const strafeLeftEnabled =
                    controlsEnabled &&
                    cellLeftOfPlayer?.isSolid === false;
                if (strafeLeftEnabled) {
                    $playerInput.querySelector('[name="strafe-left"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="strafe-left"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".strafe-left")?.classList
                    .toggle("hidden", !strafeLeftEnabled);

                // Move Right
                const rightX = player.x + DX[(player.dir + 1) % 4];
                const rightY = player.y + DY[(player.dir + 1) % 4];
                const cellRightOfPlayer = MAP.getCell(rightX, rightY);
                const strafeRightEnabled =
                    controlsEnabled &&
                    cellRightOfPlayer?.isSolid === false;
                if (strafeRightEnabled) {
                    $playerInput.querySelector('[name="strafe-right"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="strafe-right"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".strafe-right")?.classList
                    .toggle("hidden", !strafeRightEnabled);

                // Move Backward
                const backX = player.x - DX[player.dir];
                const backY = player.y - DY[player.dir];
                const cellBehindPlayer = MAP.getCell(backX, backY);
                const moveBackwardEnabled =
                    controlsEnabled &&
                    cellBehindPlayer?.isSolid === false;
                if (moveBackwardEnabled) {
                    $playerInput.querySelector('[name="backward"]')
                        ?.removeAttribute("disabled");
                } else {
                    $playerInput.querySelector('[name="backward"]')
                        ?.setAttribute("disabled", "true");
                }
                $mouseControl.querySelector(".backward")?.classList
                    .toggle("hidden", !moveBackwardEnabled);

                // Turn Left and Right - always enabled, never on SPD cooldown
                const turningEnabled = GameControl.enabled;
                $playerInput
                    .querySelectorAll('[name="turn-left"], [name="turn-right"]')
                    .forEach(($button) => turningEnabled
                        ? $button.removeAttribute("disabled")
                        : $button.setAttribute("disabled", "true")
                    );

                // Wait functionality - always enabled during exploration
                const waitEnabled = controlsEnabled;
                $playerInput.querySelector('[name="wait"]')
                    ?.removeAttribute("disabled");
                if (!waitEnabled) {
                    $playerInput.querySelector('[name="wait"]')
                        ?.setAttribute("disabled", "true");
                }
            },

            updateMenuControls: () => {
                const pagination = menu.getPagination();

                document
                    .querySelectorAll('#playerInput .section.menu [name]')
                    .forEach(($button) => {
                        let enabled = true;
                        switch ($button.getAttribute('name')) {
                            case "up":
                            case "down":
                                enabled = pagination.itemsOnCurrentPage > 1;
                                break;
                            case "previous-page":
                                enabled = pagination.hasPreviousPage;
                                break;
                            case "next-page":
                                enabled = pagination.hasNextPage;
                                break;
                        }

                        GameControl.enabled && enabled
                            ? $button.removeAttribute("disabled")
                            : $button.setAttribute("disabled", "true");
                    });
            },

            updateCombatControls: () => {
                const hasPersuasionAttempts =
                    currentEnemy?.id !== "vampire" &&
                    persuasionAttempts < getEffectiveStat('persuasionAttempts');

                const canRunAway = currentEnemy?.id !== "vampire";

                document
                    .querySelectorAll('#playerInput .section.battle [name]')
                    .forEach(($button) => {
                        const buttonName = $button.getAttribute('name');
                        let enabled = GameControl.enabled;

                        switch (buttonName) {
                            case "attack":
                                // Nothing to do
                                break;
                            case "persuade":
                                enabled = enabled && hasPersuasionAttempts;
                                if (enabled) {
                                    $button.dataset.tooltiphtml = `
                                        <div class="genericTooltip">
                                            Persuade the enemy to join your
                                            party
                                        </div>
                                    `;
                                } else {
                                    $button.dataset.tooltiphtml = `
                                        <div class="genericTooltip warning">
                                            Can't persuade the enemy to join
                                            your party!
                                        </div>
                                    `;
                                }
                                break;
                            case "run":
                                enabled = enabled && canRunAway;
                                if (enabled) {
                                    $button.dataset.tooltiphtml = `
                                        <div class="genericTooltip">
                                            Run away like a coward
                                        </div>
                                    `;
                                } else {
                                    $button.dataset.tooltiphtml = `
                                        <div class="genericTooltip warning">
                                            Can't run from this enemy!
                                        </div>
                                    `;
                                }
                                break;
                            default:
                                console.warn("Unknown button", { buttonName });
                                break;
                        }

                        enabled
                            ? $button.removeAttribute("disabled")
                            : $button.setAttribute("disabled", "true");
                    });
            },

            openPersuasionInputBox: () => {
                GameControl.awaitingPersuasionText = true;
                GameControl.disableControls();
                const $inputBox = document.getElementById("inputBox");
                const $input = document.getElementById("persuadeInput");
                $inputBox.style.display = "flex";
                $input.value = "";

                // Delay the focus to ensure it's applied after rendering
                setTimeout(() => $input.focus(), 10);
            },

            closePersuasionInputBox: () => {
                document.getElementById("inputBox").style.display = "none";
                setTimeout(() => {
                    GameControl.awaitingPersuasionText = false;
                    GameControl.enableControls();
                }, 200);
            },
        };

        const GameSettingsButton = {
            toggle: () => ! menu.isOpenInBreadcrumbs("gameSettings")
                ? GameSettingsButton.open()
                : GameSettingsButton.close(),
            open: () => {
                playSFX('uiSelect');
                menu.open('gameSettings');
            },
            close: () => {
                playSFX('uiCancel');
                menu.closeThrough('gameSettings');
            },
            opened: () => {
                const $button = document.getElementById("gameSettingsButton");
                $button.classList.add("opened");
                $button.dataset.tooltiphtml = `
                    <div class="genericTooltip">
                        Close Game Settings
                    </div>
                `;
            },
            closed: () => {
                const $button = document.getElementById("gameSettingsButton");
                $button.classList.remove("opened");
                $button.dataset.tooltiphtml = `
                    <div class="genericTooltip">
                        Open Game Settings
                    </div>
                `;
            },
        };

        // Definitions for all inventory items in the game, categorized
        const InventoryObjectDefinitions = Object.freeze({
            // Inventory object category: Consumable Items
            items: Object.freeze({
                canOfHamms: {
                    article: 'a',
                    name: "CAN OF HAMM'S",
                    description: "A warm can of beer. Delicious..? +1 LOAD, +5 HP",
                    use: () => {
                        player.heal(5);
                        updateBattleLog(
                            `You <span class="action">chug the can,</span> ` +
                            `filling your mouth with the flavor of ` +
                            `${waveText("boiled socks.", "END").outerHTML} ` +
                            `<span class="HP">+5 HP</span>`
                        );

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: 0.9,
                    chestDrop: true,
                    weight: 0.4,
                    price: 10,
                },
                cupOfLean: {
                    article: 'a',
                    name: "CUP OF LEAN",
                    description: "A crusty styrofoam cup filled with a strange purple syrup. +1.2 LOAD, +20 HP",
                    use: () => {
                        player.heal(20);
                        playSFX('lean');
                        updateBattleLog(
                            `Your stomach feels nauseous, but your head ` +
                            `feels great! <span class="HP">+20 HP</span>`
                        );

                        // Trigger visual effect
                        const $game = document.getElementById('game');
                        $game.classList.add('lean-effect');

                        // Remove effect after 20 seconds
                        setTimeout(() => {
                            $game.classList.remove('lean-effect');
                        }, 20000);

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: 0.6,
                    chestDrop: true,
                    weight: 0.8,
                    price: 20,
                },
                glassOfToiletWater: {
                    article: 'a',
                    name: "GLASS OF TOILET WATER",
                    description: "A glass filled to the rim with toilet water, extracted from the toilet bowl belonging to a Keeper. The glass has a rather badass sticker of a skeleton riding a motorcycle neatly applied...  +1.2 LOAD, +50 HP",
                    use: () => {
                        player.heal(50);
                        updateBattleLog(
                            `Sickeningly delicious...? You question your ` +
                            `current state of mind for a moment. ` +
                            `<span class="HP">+50 HP</span>`
                        );

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: .4,
                    chestDrop: true,
                    weight: 1.2,
                    price: 30,
                },
                alaskaRaisins: {
                    article: 'some',
                    name: "ALASKA RAISINS",
                    description: "Holy shit! It's the Alaska Raisins! +1.5 LOAD, +70 HP",
                    use: () => {
                        player.heal(70);
                        playSFX('raisins');
                        updateBattleLog(
                            `The Alaska Raisins sing a lovely song about how ` +
                            `epic igloos are as you pop them into your mouth ` +
                            `one by one. You can still hear them singing in ` +
                            `your stomach... <span class="HP">+70 HP</span>`
                        );

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: .35,
                    chestDrop: true,
                    weight: 1.5,
                    price: 45,
                },
                dowsingRod: {
                    article: 'a',
                    name: "DOWSING ROD",
                    description: "A Y-shaped stick. Reveals the exit of the current floor. +1.7 LOAD",
                    use: () => {
                        const location = MAP.locate("exit");
                        if (!location) {
                            console.error("No exit exists on this map!");
                            return false;
                        }

                        const alreadyRevealed = MAP.getCell(
                            location.x,
                            location.y
                        )?.isExplored;

                        if (alreadyRevealed) {
                            updateBattleLog(
                                `You should try looking a little bit closer ` +
                                `at your map, bub. <span class="action">The ` +
                                `exit is already visible!</span>`
                            );
                            return false;
                        }

                        MAP.revealSpot(location.x, location.y, 1);
                        updateBattleLog(
                            `<span class="friendly">The exit has been ` +
                            `revealed!</span>`
                        );
                        render();

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: 0.8,
                    chestDrop: true,
                    weight: 1.2,
                    price: 15,
                },
                torch: {
                    article: 'a',
                    name: "TORCH",
                    description: "An unlit torch. Using it will reveal the map of the current floor. +1.2 LOAD",
                    use: () => {
                        if (player.isHoldingTorch) {
                            updateBattleLog(
                                `Uh, do you not <em>SEE</em> the torch that ` +
                                `<span class="action">you are already ` +
                                `holding?</span>`
                            );
                            return false;
                        }
                        playSFX('torch');
                        MAP.reveal();
                        updateBattleLog(
                            `<span class="friendly">Lo, the way has been ` +
                            `made clear!</span>`
                        );
                        animTorchStart();
                        render();

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: 0.8,
                    chestDrop: true,
                    weight: 0.9,
                    price: 40,
                },
                brickOfC4: {
                    article: 'a',
                    name: "BRICK OF C-4",
                    description:
                        "An incendiary plastic explosive. Great for turning " +
                        "anything into nothing real quick! +3 LOAD",
                    use: () => {
                        setTimeout(() => playSFX('explosion'), 50);
                        explosionAnimation(() => {
                            if (player.inCombat) {
                                const dmg = Math.max(
                                    20,
                                    Math.round(Math.random() * 10) * 5
                                );
                                currentEnemy.hp -= dmg;

                                const enemyClassname =
                                    currentEnemy?.displayClassName || "enemy";
                                updateBattleLog(
                                    `You exploded the shit out of the ` +
                                    `<span class="${enemyClassname}">` +
                                    `${currentEnemy.name}</span> for ` +
                                    `<span class="HP">${dmg} HP</span>!!!`
                                );

                                if (currentEnemy.hp <= 0) {
                                    playSFX('scream');
                                    const nx = player.x + DX[player.dir];
                                    const ny = player.y + DY[player.dir];
                                    const setBloodyCrater =
                                        ['floor', 'rubble1', 'rubble2']
                                        .includes(MAP.getCell(nx, ny)?.type);
                                    if (setBloodyCrater) {
                                        MAP.setCell(nx, ny, "bloodyCrater");
                                    }
                                }
                                endOfPlayerTurn();
                            } else {
                                let xMin = player.x, xMax = player.x,
                                    yMin = player.y, yMax = player.y;

                                switch (DIRECTIONS[player.dir]) {
                                    case 'N':
                                        xMin--;
                                        xMax++;
                                        yMin -= 3;
                                        break;
                                    case 'E':
                                        yMin--;
                                        yMax++;
                                        xMax += 3;
                                        break;
                                    case 'S':
                                        xMin--;
                                        xMax++;
                                        yMax += 3;
                                        break;
                                    case 'W':
                                        yMin--;
                                        yMax++;
                                        xMin -= 3;
                                        break;
                                }

                                for (let y=yMin; y<=yMax; y++) {
                                    for (let x=xMin; x<=xMax; x++) {
                                        const cell = MAP.getCell(x, y);
                                        const isVisible =
                                            typeof cell.isVisible !==
                                                'function' ||
                                            cell.isVisible();

                                        if (isVisible) {
                                            cell?.onExplode?.(x, y);
                                        }
                                        cell.isExplored = true;

                                        // Temporary NPC hack until we handle
                                        // NPCs collectively
                                        if (pigeon.isAt(x, y)) {
                                            pigeon.onExplode(x, y);
                                        }
                                    }
                                }

                                GameControl.update();
                                updateBattleLog(
                                    '<span class="action">KABOOM!</span> The ' +
                                    'dungeon walls crumble like charred toast!'
                                );
                                render();
                            }
                        });

                        return true;
                    },
                    merchantStockChance: 0.7,
                    chestDrop: true,
                    weight: 2,
                    price: 120,
                },

                tromBone: {
                    article: 'a',
                    name: "TROM-BONE",
                    description: "A trom-BONE. It sounds like a trombone, looks like a trombone, but is somehow... on the bonier side of things. +1.3 LOAD",
                    use: () => {
                        if (tromboneIsPlaying) {
                            updateBattleLog(
                                `<span class="action">You're already playing ` +
                                `the fucking trom-BONE!</span>`
                            );
                            return false;
                        }

                        tromboneIsPlaying = true;
                        const tromboneShouldReenableMusic = music.isEnabled();
                        if (tromboneShouldReenableMusic) {
                            music.disable();
                        }

                        animTromboneStart();
                        sfx.tromBone.currentTime = 0;
                        sfx.tromBone.play();
                        sfx.tromBone.onended = () => {
                            tromboneIsPlaying = false;
                            animTromboneEnd();

                            if (tromboneShouldReenableMusic) {
                                music.enable();
                            }

                            if (player.inCombat) {
                                currentEnemy?.id === "vampire"
                                    ? music.play(
                                        "vampireBattleMainLoop",
                                        "battle"
                                    )
                                    : music.playRandom("battle");
                            } else {
                                music.resumeTag("exploration");
                            }
                        };
                        updateBattleLog("You play a trom-BONE. It sounds like a trombone, but somehow... bonier. Not very strong bone though. It shatters in your hands after you play your song. It was good while it lasted.");

                        if (player.inCombat) {
                            endOfPlayerTurn();
                        }

                        return true;
                    },
                    merchantStockChance: 1.0,
                    chestDrop: true,
                    weight: 1.3,
                    price: 5,
                },

                carrierPigeon: {
                    article: 'a',
                    name: "CARRIER PIGEON",
                    description: "A pigeon trained to carry messages. Sends a message to the next adventurer. +1 LOAD",
                    use: () => {
                        if (player.inCombat) {
                            updateBattleLog('<span class="enemy">You cannot send a carrier pigeon during combat.</span>');
                            return false;
                        }
                        if (typeof PigeonMessaging !== 'undefined' && PigeonMessaging.open) {
                            PigeonMessaging.open();
                            // Returning false prevents immediate consumption; item is removed after successful send (see pigeon.js)
                            return false;
                        }
                        updateBattleLog('<span class="enemy">Pigeon messaging module not loaded.</span>');
                        return false;
                    },
                    merchantStockChance: 1,
                    chestDrop: false,
                    weight: 1,
                    price: 10,
                },
            }),

            // Inventory object category: Weapons
            weapons: Object.freeze({
                fingerNail: {
                    article: 'a',
                    name: "FINGERNAIL",
                    description:
                        "Your very own fingernail! Careful not to break it!",
                    damage: { base: 1, randomMultiplier: 4 },
                    price: 0,
                    weight: 0,
                    requiredStr: 0,
                },
                pointyStick: {
                    article: 'a',
                    name: "POINTY STICK",
                    description:
                        "A stick that fell off of a tree somewhere",
                    damage: { base: 4, randomMultiplier: 6 },
                    price: 20,
                    weight: 3,
                    requiredStr: 7,
                },
                wiffleBallBat: {
                    article: 'a',
                    name: "WIFFLE BALL BAT",
                    description:
                        "A hollow bat made of plastic",
                    damage: { base: 6, randomMultiplier: 8 },
                    price: 30,
                    weight: 5,
                    requiredStr: 11,
                },
                nunchucks: {
                    article: '',
                    name: "NUNCHUCKS",
                    description:
                        "Two pieces of wood connected by a chain",
                    damage: { base: 9, randomMultiplier: 12 },
                    price: 70,
                    weight: 7,
                    requiredStr: 14,
                },
                atlatlSpear: {
                    article: 'an',
                    name: "ATLATL SPEAR",
                    description:
                        "A spear with a throwing lever",
                    damage: { base: 13, randomMultiplier: 16 },
                    price: 90,
                    weight: 10,
                    requiredStr: 17,
                },
                bludgeoningMace: {
                    article: 'a',
                    name:
                        "BLUDGEONING MACE",
                    description: "A stick with a spikey metal ball at the end",
                    damage: { base: 16, randomMultiplier: 19 },
                    price: 150,
                    weight: 12,
                    requiredStr: 20,
                },
                danceClub: {
                    article: 'a',
                    name: "DANCE CLUB",
                    description:
                        "A club long enough to pole dance on... maybe it is " +
                        "one? You don't know. Legend has it, an obscure " +
                        "forum user once wielded one...",
                    damage: { base: 20, randomMultiplier: 23 },
                    price: 200,
                    weight: 13,
                    requiredStr: 24,
                },
                cathodeRayTubeMonitor: {
                    article: 'a',
                    name: "CATHODE RAY TUBE MONITOR",
                    description:
                        "A CRT monitor. Heavy as piss.",
                    damage: { base: 30, randomMultiplier: 35 },
                    price: 400,
                    weight: 20,
                    requiredStr: 32,
                },
                magicPencil: {
                    article: 'a',
                    name: "MAGIC PENCIL",
                    description:
                        "SpongeBob SquarePants - Season 2, Episode 14B - " +
                        "Frankendoodle",
                    damage: { base: 12, randomMultiplier: 50 },
                    price: 700,
                    weight: 3,
                    requiredStr: 38,
                },
                goldenWang: {
                    article: 'a',
                    name: "GOLDEN WANG",
                    description:
                        "With the power of the Golden Wang, the Discordian " +
                        "parasite shall perish!",
                    damage: { base: 69, randomMultiplier: 69 },
                    price: 6900,
                    weight: 69,
                    requiredStr: 69,
                },
            }),

            // Inventory object category: Armor
            armor: Object.freeze({
                pectoralMass: {
                    article: 'a',
                    name: "PECTORAL MASS",
                    description:
                        "Your totally big, meaty pectorals! You're not fat " +
                        "at all...'",
                    defense: 1,
                    price: 0,
                    weight: 0,
                    requiredEnd: 0,
                },
                graphicTee: {
                    article: 'a',
                    name: "GRAPHIC TEE",
                    description:
                        "A t-shirt that says 'Normal people scare me'",
                    defense: 5,
                    price: 20,
                    weight: 3,
                    requiredEnd: 6,
                },
                barrelWithSuspenders: {
                    article: 'a',
                    name: "BARREL (with suspenders)",
                    description:
                        "An empty barrel that sort of covers your torso and " +
                        "legs. Smells like whisky too!",
                    defense: 8,
                    price: 50,
                    weight: 5,
                    requiredEnd: 10,
                },
                leatherArmor: {
                    article: '',
                    name: "LEATHER ARMOR",
                    description:
                        "The finest in leather, fitted with a tight top, " +
                        "codpiece, cat o' nine tails... (uh, are you sure " +
                        "this is actually armor?)",
                    defense: 13,
                    price: 100,
                    weight: 6,
                    requiredEnd: 14,
                },
                milaneseArmor: {
                    article: '',
                    name: "MILANESE ARMOR",
                    description:
                        "A classic suit of armor. Looks kind of like a " +
                        "Renaissance-era Robocop if you squint hard enough",
                    defense: 18,
                    price: 130,
                    weight: 8,
                    requiredEnd: 20,
                },
                blackPlateArmor: {
                    article: '',
                    name: "BLACK PLATE ARMOR",
                    description:
                        "Literally a giant black dinner plate. " +
                        "Deceptively protective.",
                    defense: 25,
                    price: 200,
                    weight: 13,
                    requiredEnd: 25,
                },
                nokiaMail: {
                    article: '',
                    name: "NOKIA MAIL",
                    description:
                        "A Nokia branded mail. No, not like an email... " +
                        "more like a chainmail. But Nokia.",
                    defense: 35,
                    price: 500,
                    weight: 15,
                    requiredEnd: 35,
                },
            }),

            // Inventory object category: Rings
            rings: Object.freeze({
                // Persuasion boosters
                ringOfSexyUnderwear: {
                    article: 'a',
                    name: "RING OF SEXY UNDERWEAR",
                    description:
                        "A ring with an engraving of a pair of strangely " +
                        "attractive undergarments. +5 PRS",
                    effects: { persuasion: 5 },
                    price: 60,
                    merchantStockChance: 0.5,
                    chestDrop: true,
                    weight: 1,
                },

                ringOfFrenchAccent: {
                    article: 'a',
                    name: "FRENCHLY ACCENTED RING",
                    description:
                        "A ring that somehow magically forces you to speak " +
                        "in a French accent. VERY sexy! +7 PRS",
                    effects: { persuasion: 7 },
                    price: 100,
                    merchantStockChance: 0.3,
                    chestDrop: true,
                    weight: 1,
                },

                // HP boosters
                ringValentines: {
                    article: 'a',
                    name: "VALENTINE'S DAY RING",
                    description:
                        "A ring that was given to somebody by their " +
                        "Valentine... and dumped down a hole. You see 'Amy' " +
                        "engraved onto a heart. How sad. +5 HP",
                    effects: { maxHp: 5 },
                    price: 60,
                    merchantStockChance: 0.5,
                    chestDrop: true,
                    weight: 1,
                },
                ringBloodstream: {
                    article: 'a',
                    name: "BLOODSTREAM NOSERING",
                    description:
                        "A nosering that injects blood into your veins. " +
                        "Sounds painful... +8 HP",
                    effects: { maxHp: 8 },
                    price: 100,
                    merchantStockChance: 0.3,
                    chestDrop: true,
                    weight: 1,
                },

                // Defense boosters
                ringOfHardening: {
                    article: 'a',
                    name: "COCKRING OF HARDENING",
                    description:
                        "A piercing for your cock that doubles as a sort of " +
                        "penis pill. One size fits all! +2 DEF",
                    effects: { defense: 2 },
                    price: 60,
                    merchantStockChance: 0.4,
                    chestDrop: true,
                    weight: 1,
                },
                ringPectoralPiercing: {
                    article: 'a',
                    name: "PECTORAL PIERCING",
                    description:
                        "A piercing that can fit anywhere on your big, " +
                        "juicy pectorals. +5 DEF",
                    effects: { defense: 5 },
                    price: 100,
                    merchantStockChance: 0.3,
                    chestDrop: true,
                    weight: 1,
                },

                // Speed boosters
                ringPinkyToe: {
                    article: 'a',
                    name: "PINKY TOE RING",
                    description:
                        "A ring for your pinky toe. The only way for this " +
                        "to work is by putting it directly through the " +
                        "toenail... kinda like that SpongeBob episode! +1 SPD",
                    effects: { speed: 1 },
                    price: 60,
                    merchantStockChance: 0.4,
                    chestDrop: true,
                    weight: 1,
                },
                ringCrack: {
                    article: 'a',
                    name: "CRACK INFUSED RING",
                    description:
                        "A ring infused with crack cocaine. +2 SPD",
                    effects: { speed: 2 },
                    price: 100,
                    merchantStockChance: 0.3,
                    chestDrop: true,
                    weight: 1,
                },

                // Luck boosters
                ringGamble: {
                    article: 'the',
                    name: "GAMBLER'S RING",
                    description:
                        "A cheap looking ring with a 240p image of a slot " +
                        "machine on it. +5 LUK",
                    effects: { luck: 5 },
                    price: 150,
                    merchantStockChance: 0.1,
                    chestDrop: true,
                    weight: 1,
                },
                ringEscobar: {
                    article: '',
                    name: "PABLO ESCOBAR'S GOLDEN RING",
                    description:
                        "A golden ring that once belonged to Pablo Escobar. " +
                        "It smells rather illegal, but who give a shit? +10 LUK",
                    effects: { luck: 10 },
                    price: 200,
                    merchantStockChance: 0.07,
                    chestDrop: true,
                    weight: 1,
                },

                // Special ability rings
                ringOfSightliness: {
                    article: 'a',
                    name: "RING OF SIGHTLINESS",
                    description:
                        "A ring with an eyeball so realistic looking, it " +
                        "could actually be real. Allows you to see better " +
                        "in the Tardspire",
                    effects: {},
                    price: 180,
                    merchantStockChance: 0.2,
                    chestDrop: false,
                    weight: 2,
                },
                ringOfStinky: {
                    article: 'a',
                    name: "RING OF STINKY",
                    description:
                        "A ring so stinky, SO putrid, that even monsters " +
                        "will reconsider confronting you. Causes enemies" +
                        "to move away from you more often.",
                    effects: {},
                    price: 200,
                    merchantStockChance: 0.2,
                    chestDrop: false,
                    weight: 2,
                },
                ringOfAmplifiedAudio: {
                    article: 'a',
                    name: "RING OF AMPLIFIED AUDIO",
                    description:
                        "A ring with a tiny, yet deceptively loud megaphone. " +
                        "Miniphone? idk. +10 PRS and a PRS attempt",
                    effects: { persuasion: 10 },
                    price: 130,
                    merchantStockChance: 0.2,
                    chestDrop: false,
                    weight: 2,
                },
            }),
        });

        const
            WIDTH = 30,
            HEIGHT = 11;
        const DIRECTIONS = ['N', 'E', 'S', 'W'];
        const DX = [0, 1, 0, -1];
        const DY = [-1, 0, 1, 0];
        let lastFloorBoostNotice = 0;

        const baseStats = {
            maxHp: 20,
            defense: 5,
            strength: 1,
            persuasion: 15,
            endurance: 0,
            speed: 12,
            luck: 17,
        };
        const player = {
            inventory: new Inventory(
                // Definitions
                InventoryObjectDefinitions,

                // Starting inventory
                {
                    items: {
                        canOfHamms: 2,
                        cupOfLean: 2,
                        torch: 2,
                        brickOfC4: 2,
                        dowsingRod: 2,
                    },
                    weapons: {
                        fingerNail: 1,
                    },
                    armor: {
                        pectoralMass: 1,
                    },
                },

                // Equipped gear
                {
                    weapon: "fingerNail",
                    armor: "pectoralMass",
                },
            ),
            x: 1,
            y: 1,
            bitcoins: 0,
            dir: 0,
            hp: baseStats.maxHp,
            maxHp: baseStats.maxHp,
            defense: baseStats.defense,
            strength: baseStats.strength,
            persuasion: baseStats.persuasion,
            endurance: baseStats.endurance,
            speed: baseStats.speed,
            luck: baseStats.luck,
            exp: 0,
            totalExp: 0,
            level: 1,
            stepsTakenOnCurrentFloor: 0,
            lastNearbyNPCs: new Set(),
            inCombat: false,
            isHoldingTorch: false,
            enteringCombat: false,
            leavingCombat: false,
            steppingOnHealingTile: false,
            movementDisabled: false,
            hasEncounteredVampire: false,
            getDisplayCharacter: () => ["↑", "→", "↓", "←"][player.dir] || "?",
            say: function(str) {
                const message = str.trim();
                if (message) {
                    updateBattleLog(
                        `<span class="player">&lt;YOU&gt;</span> "${message}"`
                    );
                    return;
                }

                if (Math.random() < 0.25) {
                    player.say(
                        "DUHHH BUH BUH DURRRR I AM A BIG FAT DUMB MORON " +
                        "BUUUUHHHHH"
                    );
                    return;
                }

                updateBattleLog(randomEntry([
                    "With glassy eyes and a slack jaw, you vacantly stare " +
                        "off into the distance",
                    "Shh... listen. <em>The wind!</em>",
                    "This message was intentionally left blank",
                ]));
            },
            // Resets event flags that are used during rendering
            // Invoked after every call to render()
            resetEventFlags: () => {
                player.enteringCombat = false;
                player.leavingCombat = false;
                player.steppingOnHealingTile = false;
            },
            enterCombat: () => {
                pauseAmbientSfx();
                persuasionAttempts = 0;
                maxPersuasionAttempts = getEffectiveStat("persuasionAttempts");
                player.enteringCombat = true;
                player.inCombat = true;
                player.party.prepareForBattle();
                GameControl.update();
                InventorySidebar.enterCombat();

                // Pause boulder movement during combat
                if (boulder.isActiveOnFloor) {
                    boulder.lastMoveTime = performance.now();
                }
            },
            leaveCombat: () => {
                player.leavingCombat = true;
                player.inCombat = false;
                currentEnemy = null;
                music.resumeTag("exploration");
                player.party.purgeDeadMembers();
                GameControl.update();
                InventorySidebar.leaveCombat();
                resumeAmbientSfx();

                // Resume boulder movement after combat
                if (boulder.isActiveOnFloor) {
                    boulder.lastMoveTime = performance.now();
                }
            },
            heal: (hp) => {
                player.hp = Math.min(getEffectiveStat('maxHp'), player.hp + hp);
                player.refreshStats();
                player.checkForDeath();
            },
            damage: (hp) => {
                player.hp = Math.max(player.hp - hp, 0);
                player.refreshStats();
                player.checkForDeath();
                animPlayerDamaged();
                if (window.GamepadSupport && typeof GamepadSupport.vibrate === 'function') {
                    GamepadSupport.vibrate(500, 0.25);
                }
            },
            setHp: (hp) => {
                player.hp = hp;
                player.refreshStats();
                player.checkForDeath();
            },
            checkForDeath: () => {
                if (player.hp <= 0) {
                    GameControl.disableControls();
                    gameOver = true;
                    animTorchEnd();
                    const deathPortrait = currentEnemy?.id === "vampire" ? "deathVampire" : "death";
                    Portrait.show(deathPortrait);
                }
            },
            getEffectiveStats: () => {
                const equippedArmor = player.inventory.getEquippedArmor();
                const equippedRings = player.inventory.getEquippedRings();

                function getRingEffect(stat) {
                    return (
                        (equippedRings?.leftHand?.effects?.[stat] || 0) +
                        (equippedRings?.rightHand?.effects?.[stat] || 0)
                    );
                }

                return {
                    hp: player.hp,
                    maxHp: player.maxHp + getRingEffect('maxHp'),
                    defense:
                        player.defense +
                        (equippedArmor?.defense || 0) +
                        getRingEffect('defense'),
                    strength: player.strength,
                    persuasion: getEffectiveStat('persuasion'),
                    maxPersuasionAttempts:
                        getEffectiveStat("persuasionAttempts"),
                    speed: player.speed + getRingEffect('speed'),
                    luck: player.luck + getRingEffect('luck'),
                    endurance: player.endurance,
                    carryWeight: player.inventory.getWeight(),
                    carryWeightLimit: player.getCarryWeightLimit(),
                };
            },
            refreshStats: () => {
                const stats = player.getEffectiveStats();

                const $hp = document.getElementById('statHp');
                $hp.setAttribute('value', stats.hp);
                $hp.setAttribute('max', stats.maxHp);

                const $exp = document.getElementById('statExp');
                $exp.setAttribute('value', player.exp);
                $exp.setAttribute('max', player.getExpRequiredForLevelUp());

                const $load = document.getElementById('statLoad');
                $load.setAttribute('value', stats.carryWeight.toFixed(1));
                $load.setAttribute('max', stats.carryWeightLimit.toFixed(1));

                const $strength = document.getElementById('statStrength');
                $strength.innerText = stats.strength;

                const $defense = document.getElementById('statDefense');
                $defense.innerText = stats.defense;

                const $persuasion = document.getElementById('statPersuasion');
                $persuasion.innerText = stats.persuasion;

                const $endurance = document.getElementById('statEndurance');
                $endurance.innerText = stats.endurance;

                const $speed = document.getElementById('statSpeed');
                $speed.innerText = stats.speed;

                const $luck = document.getElementById('statLuck');
                $luck.innerText = stats.luck;

                player.party.refresh();

                // Level up if we have enough experience outside of combat
                if (
                    !player.inCombat &&
                    typeof startLevelUpAllocation === 'function' &&
                    player.exp >= player.getExpRequiredForLevelUp()
                ) {
                    // Prevent re‑entering level allocation while it is already open
                    let statAllocationOpen = false;
                    if (typeof menu?.isOpen === 'function' && menu.isOpen() && typeof menu.getCurrentMenuData === 'function') {
                        const currentMenuData = menu.getCurrentMenuData();
                        const currentTitle = currentMenuData
                            ? (typeof currentMenuData.title === 'function'
                                ? currentMenuData.title()
                                : currentMenuData.title)
                            : '';
                        // Titles for the allocation menu can be "STAT ALLOCATION" or "LEVEL UP"
                        if (/^(STAT ALLOCATION|LEVEL UP)$/i.test(currentTitle || '')) {
                            statAllocationOpen = true;
                        }
                    }

                    if (!statAllocationOpen) {
                        startLevelUpAllocation();
                        return;
                    }
                }
            },
            getViewDepth: () => {
                if (player.inventory.hasEquippedRing("ringOfSightliness")) {
                    return 5;
                }

                if (player.isHoldingTorch) {
                    return 3;
                }

                return 2;
            },
            getMaxBrightness: () =>
                player.inventory.hasEquippedRing('ringOfSightliness') ||
                player.isHoldingTorch
                    ? 255
                    : 192,
            getExpRequiredForLevelUp: () => player.level * 10,
            levelUp: () => {
                const expRequired = player.getExpRequiredForLevelUp();
                const rolledOverExp = Math.max(0, player.exp - expRequired);
                player.totalExp += expRequired;
                player.level++;
                player.exp = rolledOverExp;
                player.hp = getEffectiveStat('maxHp');
                document.getElementById('playerLevel').innerText = player.level;
                TardAPI.updateProgress();
            },
            getInputDelayMs: () => {
                const minDelayMs = 1;
                const maxDelayMs = 2000;
                const baseDelayMs = maxDelayMs;

                // 5% reduction per speed point
                const speedModifier = getEffectiveStat('speed') * 0.05;

                return Math.max(
                    minDelayMs,
                    baseDelayMs * (1 - speedModifier)
                );
            },
            getCarryWeightLimit: () => {
                // Example: 35 base + 0.6 per END point
                return 35 + (player.endurance * 0.4);
            },
            // Returns "normal", "warning", or "danger" depending on load
            getWeightLevel: () => {
                const percentage =
                    player.inventory.getWeight() / player.getCarryWeightLimit();

                return percentage < 0.5
                    ? "normal"
                    : (percentage < 0.8 ? "warning" : "danger");
            },
            fallThroughFloorAndDie: () => {
                setTimeout(() => {
                    music.stop();
                    animTorchEnd();
                    Portrait.show('death');
                    GameControl.disableControls();

                    document.getElementById('game')
                        .classList.add("descendingIntoFloor");
                    document.getElementById('viewport')
                        .classList.add('playerFellIntoAPitAndDied');
                    updateBattleLog(
                        `<span class="action">AUUUUUGH!</span> You scream ` +
                        `out as the flimsy floor collapses beneath your feet ` +
                        `and you plunge into a pit of spikes waiting beneath!`
                    );
                    playSFX('floorBreakScreamDie');
                    player.damage(getEffectiveStat('maxHp'));
                    setTimeout(() => render(), 2000);
                }, 100);
            },
            giveBitcoins: (num) => {
                player.bitcoins += num;
                player.refreshBitcoins();
            },
            takeBitcoins: (num) => {
                player.bitcoins -= num;
                player.refreshBitcoins();
            },
            refreshBitcoins: () => {
                const $playerBitcoins = document.getElementById('playerBitcoins');
                $playerBitcoins.innerText = player.bitcoins.toLocaleString(undefined);
            },

            // Party members
            party: {
                maxMembers: 3,
                seenMembers: 0,
                members: [],
                isFull: () =>
                    player.party.members.length >= player.party.maxMembers,
                initializePartySection: () => {
                    const $partyMembers =
                        document.getElementById("partyMembers");

                    const placeholders = [];

                    for (let i=0; i<player.party.maxMembers; i++) {
                        $placeholder = player.party.getPartyMemberPlaceholder();
                        placeholders.push($placeholder);
                    }

                    $partyMembers.replaceChildren(...placeholders);
                },
                getPartyMemberPlaceholder: () => {
                    const $placeholder = document.createElement("div");
                    $placeholder.className = "party-member placeholder";
                    $placeholder.setAttribute('data-partyMemberId', "???");

                    const $name = document.createElement("div");
                    $name.className = "name";
                    $name.innerText = "Gabe Newell";
                    $placeholder.appendChild($name);

                    const $info = document.createElement("div");
                    $info.className = "info";

                    const $healthBar = document.createElement('progress-bar');
                    $healthBar.className = "health-bar";
                    $healthBar.setAttribute("placeholder", true);
                    $healthBar.setAttribute("height", 20);
                    $healthBar.setAttribute("value", 0);
                    $healthBar.setAttribute("max", 0);
                    $healthBar.setAttribute("cautionAtOrBelowPercentage", 25);
                    $healthBar.setAttribute("dangerAtOrBelowPercentage", 10);
                    $info.appendChild($healthBar);

                    const $talkButton = document.createElement("button");
                    $talkButton.disabled = true;
                    $talkButton.className = "talk";
                    $talkButton.textContent = "Talk";
                    $info.appendChild($talkButton);

                    const $releaseButton = document.createElement("button");
                    $releaseButton.disabled = true;
                    $releaseButton.className = "release";
                    $releaseButton.textContent = "Release";
                    $info.appendChild($releaseButton);

                    $placeholder.appendChild($info);
                    return $placeholder;
                },
                addPartyMemberPlaceholders: (totalNewPlaceholders) => {
                    const $partyMembers =
                        document.getElementById("partyMembers");

                    for (let i=0; i<totalNewPlaceholders; i++) {
                        $placeholder = player.party.getPartyMemberPlaceholder();
                        $partyMembers.appendChild($placeholder);
                    }
                },
                add: (enemyId, name, hp, maxHp) => {
                    const index = player.party.members.length;
                    const partyMemberId = player.party.seenMembers;
                    player.party.members.push({
                        id: partyMemberId,
                        enemyId,
                        name,
                        hp,
                        maxHp,
                        healedThisBattle: false,
                    });

                    const $partyMembers =
                        document.getElementById("partyMembers");
                    const $partyMember = $partyMembers.children.item(index);

                    $partyMember.setAttribute(
                        'data-partyMemberId',
                        partyMemberId
                    );

                    $partyMember.querySelector(".name").textContent = name;

                    const $healthBar =
                        $partyMember.querySelector("progress-bar");
                    $healthBar.setAttribute('value', hp);
                    $healthBar.setAttribute('max', maxHp);
                    $healthBar.removeAttribute("placeholder");

                    const $talkButton =
                        $partyMember.querySelector("button.talk");
                    $talkButton.disabled = false;
                    $talkButton.onclick =
                        () => player.party.talk(partyMemberId);

                    const $releaseButton =
                        $partyMember.querySelector("button.release");
                    $releaseButton.disabled = false;
                    $releaseButton.onclick =
                        () => player.party.release(partyMemberId);

                    $partyMember.classList.remove("placeholder");
                    player.party.seenMembers++;
                },
                refresh: () => {
                    for (let i=0; i<player.party.members.length; i++) {
                        const partyMember = player.party.members[i];
                        const selector =
                            `#partyMembers [data-partyMemberId="${partyMember.id}"]`;

                        const $partyMember = document.querySelector(selector);
                        if (!$partyMember) {
                            console.error(
                                "Could not find party member's element",
                                { partyMember }
                            );
                            continue;
                        }

                        if (partyMember.hp <= 0) {
                            $partyMember.querySelector('.name')
                                .classList.add('strikethrough');
                            player.party.disableButtons(partyMember.id);
                        }

                        const $healthBar = $partyMember
                            .querySelector(`progress-bar.health-bar`);
                        $healthBar.setAttribute('value', partyMember.hp);
                    }

                    player.party.refreshPartyCount();
                },
                purgeDeadMembers: () => {
                    const $partyMembers =
                        document.getElementById("partyMembers");
                    const aliveMembers = [];
                    const totalMembers = player.party.members.length;

                    for (let i=0; i<totalMembers; i++) {
                        const partyMember = player.party.members[i];

                        if (partyMember.hp > 0) {
                            aliveMembers.push(partyMember);
                            continue;
                        }

                        const id = partyMember.id;
                        const selector = `[data-partyMemberId="${id}"]`;

                        const $partyMember =
                            $partyMembers.querySelector(selector);
                        $partyMember.classList.add('sweepItUp');

                        $partyMember.addEventListener('transitionend', function onTransitionEnd(e) {
                            if (e.propertyName === 'height') {
                                $partyMember.removeEventListener('transitionend', onTransitionEnd);
                                $partyMember.remove();
                            }
                        });
                    }

                    const newPlaceholders = totalMembers - aliveMembers.length;
                    player.party.addPartyMemberPlaceholders(newPlaceholders);
                    player.party.members = aliveMembers;
                    player.party.refreshPartyCount();
                },
                talk: (partyMemberId) => {
                    const responder = partyMemberId === undefined
                        ? randomEntry(player.party.members)
                        : player.party.members.find((e) => e.id === partyMemberId );

                    if (!responder) {
                        console.warn("Party member not found", {
                            partyMembers: player.party.members,
                            partyMemberId,
                        });
                        return;
                    }

                    if (responder.hp <= 0) {
                        updateBattleLog(`${responder.name} is dead, bub`);
                        return;
                    }

                    const enemyDefinition = enemies.find(e => e.id === responder.enemyId);
                    const talkSlots = enemyDefinition?.talkSlots || [
                        ["You", "I", "What", "Hey", "Listen here, you", "They", "He", "She"],
                        ["are", "can't", "should", "will", "must", "need to", "need", "needs", "needed"],
                        ["go", "find a", "smack a", "kill the", "eat a", "snack on a", "pick my", "pick your", "obey my", "obey your"],
                        ["pot roast", "many pot roasts", "total dumbass", "gay", "friend", "sandwich", "nose", "orbital laser", "Burnout Revenge on the PS2", "one big dandruff"],
                        ["?", "!", "!!!", "?!", "...", ".",]
                    ];

                    // Sentence assembly - also removes the space before the punctuation slot
                    const chosen = talkSlots.map(slot => randomEntry(slot));
                    const sentence =
                        chosen.length > 1
                            ? chosen.slice(0, -1).join(" ") + chosen[chosen.length - 1]
                            : chosen[0];

                    updateBattleLog(
                        `<span class="friendly">&lt;${responder.name}&gt;</span> ` +
                        `<span class="player">--you pull out your translator--</span> ` +
                        `"${sentence}"`
                    );

                    player.party.disableButtons();

                    SpeechSynthesizer.speak(
                        sentence,
                        enemyDefinition.voice,
                        () => player.party.enableButtons()
                    );
                },
                say: (partyMemberId, message) => {
                    const responder = player.party.members
                        .find((e) => e.id === partyMemberId);

                    if (! responder) {
                        console.error(
                            "Party member not found",
                            { partyMemberId }
                        );
                        return;
                    }

                    if (responder.hp <= 0) {
                        console.error(
                            "Sorry, but you can't talk to ghosts",
                            { responder }
                        );
                        return;
                    }

                    const enemyDefinition =
                        enemies.find(e => e.id === responder.enemyId);
                    if (! enemyDefinition) {
                        console.error(
                            "Ally cannot speak; enemy definition not found",
                            { enemyId: responder.enemyId }
                        );
                        return;
                    }

                    updateBattleLog(
                        `<span class="friendly">&lt;${responder.name}&gt;` +
                        `</span> <span class="player">--you pull out your ` +
                        `translator--</span> "${message}"`
                    );

                    player.party.disableButtons();

                    SpeechSynthesizer.speak(
                        message,
                        enemyDefinition.voice,
                        () => player.party.enableButtons()
                    );
                },
                disableButtons: (partyMemberId) => {
                    const $container = document.getElementById("partyMembers");
                    const selector =
                        (typeof partyMemberId === "number"
                            ? `[data-partyMemberId="${partyMemberId}"] `
                            : ""
                        ) + "button";

                    $container.querySelectorAll(selector).forEach(
                        (button) => button.disabled = true
                    );
                },
                enableButtons: () => {
                    const $container = document.getElementById("partyMembers");

                    for (let i=0; i<player.party.members.length; i++) {
                        const partyMember = player.party.members[i];
                        if (partyMember.hp <= 0) {
                            continue;
                        }

                        const selector =
                            `[data-partyMemberId="${partyMember.id}"] button`;
                        $container.querySelectorAll(selector).forEach(
                            (button) => button.disabled = false
                        );
                    }
                },
                release: (partyMemberId) => {
                    const partyMember = player.party.members
                        .find((e) => e.id === partyMemberId);
                    if (!partyMember) {
                        console.error(
                            "Party member not found",
                            { partyMemberId }
                        );
                        return;
                    }

                    Modal.open(
                        `Release ${partyMember.name}?`,
                        `Are you sure you want to kick ` +
                            `<span class="friendly">${partyMember.name}` +
                            `</span> out of your party?`,
                        [
                            {
                                text: "Nah, keep the bastard",
                                type: "danger",
                                onclick: () => {
                                    const message = randomEntry([
                                        "Thanks for keeping me, boss.",
                                        "Oh joy.",
                                        "Whoopty doo.",
                                        "Yay. More sewer adventures!",
                                    ]);

                                    player.party.say(
                                        partyMember.id,
                                        message
                                    );
                                },
                            },
                            {
                                text: "Yes",
                                type: "primary",
                                onclick: () => {
                                    const message = randomEntry([
                                        "This field trip is over.",
                                        "I guess this is goodbye.",
                                        "Well fuck you too, asshole.",
                                        "Actually, I quit!",
                                        "But I love you!",
                                    ]);

                                    player.party.say(
                                        partyMember.id,
                                        message
                                    );

                                    const bye = randomEntry([
                                        "SEE YA!",
                                        "BYE!",
                                        "FUCK RIGHT THE FUCK OFF NOW!",
                                        "ADIOS!",
                                        "さようなら、哀れな生き物。",
                                    ]);

                                    updateBattleLog(
                                        `You booted <span class="friendly">` +
                                        `${partyMember.name}</span> to the ` +
                                        `curb. <span class="action">${bye}` +
                                        `</span>`
                                    );
                                    player.party.members =
                                        player.party.members
                                        .filter((e) => e.id !== partyMemberId);
                                    const selector =
                                        `#partyMembers [data-partyMemberId="` +
                                        `${partyMemberId}"]`;
                                    document.querySelector(selector).remove();
                                    player.party.addPartyMemberPlaceholders(1);
                                    player.party.refreshPartyCount();
                                },
                            },
                        ]
                    );
                },
                refreshPartyCount: () => {
                    document.getElementById("totalPartyMembers").innerText =
                        player.party.members.length.toLocaleString(undefined);
                    document.getElementById("maxPartyMembers").innerText =
                        player.party.maxMembers.toLocaleString(undefined);
                },
                get: () => player.party.members.filter((e) => e.hp > 0),
                prepareForBattle: () => player.party.members
                    .forEach(member => member.healedThisBattle = false),
            },
        };

        const merchant = {
            isAlive: true,
            isActiveOnFloor: false,
            items: [],
            consecutiveFloorsAbsent: 0,
            voice: {
                pitch: 48,
                speed: 45,
                mouth: 163,
                throat: 160,
            },
            say: function(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, merchant.voice);
                }
                updateBattleLog(
                    `<span class="merchant">&lt;MERCHANT&gt;</span> "${str}"`
                );
            },
            isAt: function(x, y) {
                return (
                    merchant.isAlive &&
                    merchant.isActiveOnFloor &&
                    MAP.getCell(x, y)?.type === 'merchant'
                );
            },
            location: function() {
                return merchant.isAlive && merchant.isActiveOnFloor
                    ? MAP.locate("merchant")
                    : null;
            },
            buy: function(category, id) {
                if (!Object.hasOwn(InventoryObjectDefinitions, category)) {
                    console.error(
                        "Inventory object category doesn't exist",
                        { category }
                    );
                    return;
                }

                const merchandise = InventoryObjectDefinitions[category]?.[id];
                if (!merchandise) {
                    console.error(
                        "Inventory entry doesn't exist",
                        { category, id }
                    );
                    return;
                }

                if (player.bitcoins < merchandise.price) {
                    merchant.say(
                        "Too bad, kid. Come back when you get some coin!"
                    );
                    return;
                }

                // Special handling for carrier pigeon: defer local grant until server approves
                // Purchase limit and inventory count is enforced server-side.
                // So even if you cheat the client, it won't be usable without a valid server purchase.
                if (category === "items" && id === "carrierPigeon") {
                    // === LIMIT TO 10 PIGEONS LOCALLY, ENFORCED SERVER SIDE ===
                    const pigeonCount = player.inventory.getItemCount("carrierPigeon");
                    if (pigeonCount >= 10) {
                        merchant.say("You've run out of space in your Pigeon Pouch!");
                        return;
                    }
                    const sessionId = sessionStorage.getItem("tardquestSID");
                    if (!sessionId) {
                        merchant.say("Can't buy pigeons without an ID, kid.");
                        return;
                    }

                    // Inform player we're attempting a server purchase
                    merchant.say("Hold on, checking the coop...");

                    fetch(`${TardAPI.API_BASE}/api/pigeon/purchase`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId })
                    })
                        .then(r => r.json().catch(()=>({})).then(data => ({ ok: r.ok, status: r.status, data })))
                        .then(({ ok, data }) => {
                            if (!ok || !data?.purchased) {
                                console.warn('🐦 Pigeon: Purchase rejected', { ok, data });
                                merchant.say(data?.error || "No pigeons for you right now!");
                                return;
                            }

                            // Only deduct bitcoins if there is a non-zero price
                            if (merchandise.price > 0) {
                                player.takeBitcoins(merchandise.price);
                                playSFX('kaching');
                            }

                            player.inventory.addItem(id);

                            merchant.say(randomEntry([
                                "Fresh from the loft!",
                                "Don't eat it all at once!",
                                "Treat it nice, it carries words.",
                            ]));

                            merchant.printTransactionMessage(
                                "bought",
                                merchandise,
                                merchandise.price
                            );

                            render();
                        })
                        .catch(err => {
                            console.error('🐦 Pigeon: Purchase error', err);
                            merchant.say("The coop collapsed. Try later.");
                        });

                    // Exit early; normal flow handled in async chain
                    return;
                }

                // Prevent buying equipment you already own
                const alreadyOwnedEquippable =
                    category !== "items" &&
                    (player.inventory.hasEntry(category, id));
                if (alreadyOwnedEquippable) {
                    merchant.say("You already own that, stupid!");
                    return;
                }

                player.takeBitcoins(merchandise.price);
                playSFX('kaching');

                // Disable equipment auto equip upon purchase
                switch(category) {
                    case "items":
                        player.inventory.addItem(id);
                        break;
                    case "weapons":
                        player.inventory.addWeapon(id);
                        break;
                    case "armor":
                        player.inventory.addArmor(id);
                        break;
                    case "rings":
                        player.inventory.addRing(id);
                        break;
                    default:
                        console.error("Unknown item category", { category });
                        break;
                }

                merchant.say(randomEntry([
                    "HAHA! You won't regret it!",
                    "Don't forget: NO REFUNDS!",
                    "You won't find a better deal than this!",
                ]));

                merchant.printTransactionMessage(
                    "bought",
                    merchandise,
                    merchandise.price
                );

                render();
            },
            set: function () {
                merchant.setWares();
                merchant.setPosition();
            },
            setWares: function(hasEverythingInStock = false) {
                const itemKeys = Object.keys(InventoryObjectDefinitions.items);
                const ringKeys = Object.keys(InventoryObjectDefinitions.rings);

                if (itemKeys.length === 0) {
                    console.error("No items available in the items object!");
                    return;
                }

                if (ringKeys.length === 0) {
                    console.error("No rings available in the rings object!");
                    return;
                }

                let attempts = 0;
                do {
                    merchant.items = [];
                    merchant.rings = [];

                    itemKeys.forEach((key) => {
                        const stockChance =
                            InventoryObjectDefinitions
                                .items[key]
                                .merchantStockChance || 0;

                        const merchantHasItem =
                            hasEverythingInStock || Math.random() < stockChance;

                        if (merchantHasItem) {
                            merchant.items.push(key);
                        }
                    });

                    ringKeys.forEach((key) => {
                        const stockChance =
                            InventoryObjectDefinitions
                                .rings[key]
                                .merchantStockChance || 0;

                        const merchantHasRing =
                            hasEverythingInStock || Math.random() < stockChance;

                        if (merchantHasRing) {
                            merchant.rings.push(key);
                        }
                    });

                    attempts++;
                    if (attempts > 100) {
                        console.error(
                            `Failed to generate merchant items`,
                            { attempts }
                        );
                        break;
                    }
                } while (
                    merchant.items.length === 0 ||
                    merchant.rings.length === 0
                );
            },

            setPosition: function() {
                const points =
                    shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];

                if (points) {
                    MAP.setCell(points.x, points.y, "merchant");
                }
            },

            getSalePrice: function(itemType, price) {
                if (typeof price !== 'number') {
                    console.error("Price is not a number", { itemType, price });
                    return 0;
                }
                const factors = {
                    weapon: 10,
                    armor: 10,
                    item: 5,
                    ring: 5,
                };

                // Default to 10% of the original price
                const factor = factors[itemType] || 10;
                if (!Object.hasOwn(factors, itemType)) {
                    console.error("Unknown item type", { itemType });
                }
                return Math.max(1, Math.floor(price / factor));
            },

            printTransactionMessage: function(
                transactionType,
                merchandise,
                priceBtc
            ) {
                if (!['bought', 'sold'].includes(transactionType)) {
                    console.error(
                        'Unknown transaction type', {
                            transactionType,
                            merchandise,
                            priceBtc
                        }
                    );
                    return;
                }

                // Add a space if an article is present
                const article =
                    merchandise?.article ? `${merchandise.article} ` : '';

                const message =
                    `You ${transactionType} ${article}` +
                    `<span class="friendly">${merchandise.name}</span> for ` +
                    `<span class="BTC">₿ ${priceBtc.toLocaleString(undefined)}</span>. `;
                updateBattleLog(message);
            },
        };

        const gambler = {
            isAlive: true,
            isActiveOnFloor: false,
            selectionIndex: 0,
            options: ['gamble', 'leave'],
            playPrice: 200,
            voice: {
                pitch: 26,
                speed: 55,
                mouth: 162,
                throat: 255,
            },
            say: function(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, gambler.voice);
                }
                updateBattleLog(
                    `<span class="gambler">&lt;GAMBLER&gt;</span> "${str}"`
                );
            },
            isAt: function(x, y) {
                return (
                    gambler.isAlive &&
                    gambler.isActiveOnFloor &&
                    player.bitcoins >= gambler.playPrice &&
                    MAP.getCell(x, y)?.type === 'gambler'
                );
            },
            location: function() {
                const gamblerExists =
                    gambler.isAlive &&
                    gambler.isActiveOnFloor &&
                    player.bitcoins < gambler.playPrice;

                return gamblerExists
                    ? MAP.locate("gambler")
                    : null;
            },
            set: function() {
                const points =
                    shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];

                if (points) {
                    MAP.setCell(points.x, points.y, "gambler");
                }
            }
        };

        const vampire = {
            displayName: "GAY COCKSUCKING VAMPIRE",
            displayClassName: "gay",
            isActiveOnFloor: false,
            baseHp: 100,
            playerStepsUntilActive: Infinity,
            x: null,
            y: null,
            level: 1,
            voice: {
                pitch: 92,
                speed: 80,
                mouth: 139,
                throat: 158,
            },
            steps: [],
            explorationMusicId: null, // Track to resume after the vampire loses
            isDoneMoving: function() {
                return vampire.steps.length === 0;
            },
            say: function(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, vampire.voice);
                }

                updateBattleLog(
                    `<span class="gay vampire">&lt;${vampire.displayName}&gt;` +
                    `</span> "${str}"`
                );
            },
            setPlayerStepsUntilActive: function(override = null) {
                if (typeof override === "number") {
                    vampire.playerStepsUntilActive = override;
                    return;
                }

                const mapEntrance = MAP.getEntrance();
                const mapExit = MAP.locate("exit");
                const optimalPathLength = MAP.findPath(
                    [ mapEntrance.x, mapEntrance.y ],
                    [ mapExit.x, mapExit.y ]
                )?.length || 0;

                if (optimalPathLength <= 0) {
                    console.error(
                        "Cannot determine the map's optimal path length",
                        { mapEntrance, mapExit }
                    );
                    vampire.playerStepsUntilActive = Infinity;
                    return;
                }

                const luckMod = getEffectiveStat('luck') * 0.01;
                const luckFloor = Math.max(luckMod - 0.5, 0);
                const luckBoost = luckFloor + (Math.random() * luckMod);
                const floorDeboost = floor * 0.05;
                const modifier = 1.5 - floorDeboost + luckBoost;
                const calculatedSteps =
                    Math.max(Math.round(optimalPathLength * modifier), 10);
                const steps = Math.max(calculatedSteps, optimalPathLength);

                vampire.playerStepsUntilActive = steps;
            },
            isAt: function(x, y) {
                return (
                    vampire.isActiveOnFloor &&
                    vampire.x === x &&
                    vampire.y === y
                );
            },
            initialize: function() {
                vampire.isActiveOnFloor = false;
                vampire.level = 1;
                vampire.setPlayerStepsUntilActive();
            },
            checkForActivation: function(callback) {
                vampire.isActiveOnFloor =
                    player.stepsTakenOnCurrentFloor >=
                    vampire.playerStepsUntilActive;

                if (vampire.isActiveOnFloor) {
                    vampire.resetToEntrance();
                    vampire.showFocalPoint({}, () => {
                        if (vampire.isAt(player.x, player.y)) {
                            updateBattleLog(
                                `<span class="action">OH SHIT!</span> That ` +
                                `pale-ass goblin motherfucker just spawned ` +
                                `on top of you!`
                            );

                            startEncounter(
                                "vampire",
                                vampire.getEncounterOverrides()
                            );
                        }
                    });

                    const printVampireIntroMessage =
                        vampire.level === 1 &&
                        ! vampire.isAt(player.x, player.y);

                    if (printVampireIntroMessage) {
                        updateBattleLog(
                            `Your nostrils are suddenly filled with a ` +
                            `stench of bleach and sulfur. ` +
                            `<span class="action">It would be a good ` +
                            `idea to find the exit as soon as possible.` +
                            `</span>`
                        );
                    }
                }

                callback?.();
            },
            resetToEntrance: function() {
                const entrance = MAP.getEntrance();
                if (entrance.x === null || entrance.y === null) {
                    console.error(
                        "Could not place the vampire because no " +
                        "entrance exists within in the map"
                    );
                    callback?.();
                    return;
                }

                vampire.x = entrance.x;
                vampire.y = entrance.y;
                render();
            },
            prepareMovement: function() {
                if (! vampire.isActiveOnFloor) {
                    return;
                }

                const totalSteps = vampire.level;
                vampire.steps = MAP.findPath(
                    [ vampire.x, vampire.y ],
                    [ player.x, player.y ]
                )?.slice(1, totalSteps + 1) ?? [];
            },
            playFlapSfx: function() {
                const deltaX = player.x - vampire.x;
                const deltaY = player.y - vampire.y;
                const distance = Math.round(Math.sqrt(
                    Math.pow(deltaX, 2) + Math.pow(deltaY, 2)
                ));

                const dryVolume = Math.max(10 - distance, 0) / 10;
                const wetVolume = Math.max(10 - distance - dryVolume, 0) / 10;

                playSFX("batWingFlapDry", dryVolume);
                playSFX("batWingFlapWet", wetVolume);
            },
            move: function() {
                if (! vampire.isActiveOnFloor) {
                    return;
                }

                if (vampire.steps.length === 0) {
                    return null;
                }

                vampire.playFlapSfx();

                const step = vampire.steps.shift();
                vampire.x = step[0];
                vampire.y = step[1];

                if (vampire.encounteredPlayer()) {
                    vampire.steps = [];
                    return () => vampire.encounter();
                }
            },
            encounteredPlayer: function() {
                return (
                    ! gameOver &&
                    vampire.isActiveOnFloor &&
                    vampire.x === player.x &&
                    vampire.y === player.y
                );
            },
            encounter: function() {
                player.hasEncounteredVampire = true;
                startEncounter("vampire", vampire.getEncounterOverrides());
            },
            getEncounterOverrides: function() {
                const baseAttack = enemies.find(e => e.id === "vampire").attack;
                const playerMod = Math.max(Math.round(player.strength / 2), 0);
                const lowMod = Math.max((vampire.level - 1) * 5, 0);
                const highMod = Math.max((vampire.level - 1) * 10, 0);

                return ({
                    musicTrackId: "vampireBattleIntro",
                    hp: Math.ceil(
                        vampire.baseHp + (10 * (floor - 1)) +
                        Math.max(Math.round(player.maxHp / 2), 0) +
                        (Math.max(vampire.level - 1, 0) * 100)
                    ),
                    attack: [
                        baseAttack[0] + playerMod + lowMod,
                        baseAttack[1] + playerMod + highMod,
                    ],
                });
            },
            defeated: function() {
                // Resume any previously-playing exploration music
                vampire.explorationMusicId
                    ? music.play(vampire.explorationMusicId, "exploration")
                    : music.playRandom("exploration");

                const mapEntrance = MAP.getEntrance();
                const hasEntrance =
                    Object.hasOwn(mapEntrance, 'x') &&
                    Object.hasOwn(mapEntrance, 'y');

                if (! hasEntrance) {
                    console.error(
                        "Could not find the map's entrance",
                        { mapEntrance }
                    );

                    vampire.isActiveOnFloor = false;
                    return;
                }

                const action = randomEntry([
                    "bitchslapped",
                    "butt-kicked",
                    "laughed all the way",
                    "blasted",
                    "spanked",
                    "b-b-b-booted"
                ]);

                updateBattleLog(
                    `<span class="${vampire.displayClassName}">` +
                    `${vampire.displayName}</span> has been ` +
                    `<span class="action">${action} back to the floor's ` +
                    `entrance!</span>`
                );

                vampire.level++;
                const stepsUntilReactivation =
                    Math.max(10 - (vampire.level * 2), 1);
                vampire.setPlayerStepsUntilActive(
                    player.stepsTakenOnCurrentFloor + stepsUntilReactivation
                );
                vampire.checkForActivation();
            },

            showFocalPoint: function(options, onAnimationEnd) {
                const $vampireFocalPoint =
                    document.getElementById("vampireFocalPoint");
                if (! $vampireFocalPoint) {
                    console.error("#vampireFocalPoint element was not found");
                    return;
                }

                const $desaturationOverlay = document.getElementById(
                    "vampireFocalPointDesaturationOverlay"
                );
                if (! $desaturationOverlay) {
                    console.error(
                        "#vampireFocalPointDesaturationOverlay element was " +
                        "not found"
                    );
                    return;
                }

                const selector = "#minimap > .vampire";
                const $minimapVampire = document.querySelector(selector);
                if (! $minimapVampire) {
                    console.error("Could not find the vampire on the minimap");
                    return;
                }

                const rect = $minimapVampire.getBoundingClientRect();
                const x = Math.round(rect.left + (rect.width / 2));
                const y = Math.round(rect.top + (rect.height / 2));

                const {
                    radiusStartPx = 2240,
                    radiusEndPx = 16,
                    durationMs = 2000,
                    easingCss =
                        'cubic-bezier(0.22, 1, 0.36, 1)'
                } = options || {};

                $vampireFocalPoint.style.setProperty('--center-x', `${x}px`);
                $vampireFocalPoint.style.setProperty('--center-y', `${y}px`);
                $vampireFocalPoint.style
                    .setProperty('--radius-start', `${radiusStartPx}px`);
                $vampireFocalPoint.style
                    .setProperty('--radius-end', `${radiusEndPx}px`);

                $desaturationOverlay.style.setProperty('--center-x', `${x}px`);
                $desaturationOverlay.style.setProperty('--center-y', `${y}px`);
                $desaturationOverlay.style.setProperty('--radius-start', `${radiusStartPx}px`);
                $desaturationOverlay.style.setProperty('--radius-end', `${radiusEndPx}px`);


                $vampireFocalPoint.style.animationDuration = `${durationMs}ms`;
                $vampireFocalPoint.style.animationTimingFunction = easingCss;
                $vampireFocalPoint.classList.remove('is-animating');
                $vampireFocalPoint.offsetWidth; // Force reflow
                $vampireFocalPoint.classList.add('is-animating');

                $desaturationOverlay.style.animationDuration = `${durationMs + 500}ms`;
                $desaturationOverlay.style.animationTimingFunction = easingCss;
                $desaturationOverlay.classList.remove('is-animating');
                $desaturationOverlay.offsetWidth; // Force reflow
                $desaturationOverlay.classList.add('is-animating');

                music.stop();
                playSFX("alert");
                setTimeout(
                    () => {
                        vampire.explorationMusicId =
                            music.getLastTaggedTrackId("exploration");
                        music.play("vampireLurking", "exploration");
                    },
                    2000
                );

                function handleAnimationEnd(event) {
                    if (event.target !== $desaturationOverlay) {
                        return;
                    }

                    $desaturationOverlay.removeEventListener(
                        "animationend",
                        handleAnimationEnd
                    );

                    $vampireFocalPoint.classList.remove("is-animating");
                    $desaturationOverlay.classList.remove("is-animating");

                    if (typeof onAnimationEnd === "function") {
                        onAnimationEnd();
                    }
                }

                $desaturationOverlay.addEventListener(
                    "animationend",
                    handleAnimationEnd
                );
            }
        };

        const erok = {
            isAlive: true,
            isActiveOnFloor: false,
            isPetting: false,
            voice: {
                pitch: 200,
                speed: 50,
                mouth: 124,
                throat: 144,
            },
            say: function(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, erok.voice);
                }
                updateBattleLog(
                    `<span class="erok">&lt;EROK&gt;</span> "${str}"`
                );
            },
            isAt: function(x, y) {
                return (
                    erok.isAlive &&
                    erok.isActiveOnFloor &&
                    MAP.getCell(x, y)?.type === 'erok'
                );
            },
            location: function() {
                return erok.isAlive && erok.isActiveOnFloor
                    ? MAP.locate("erok")
                    : null;
            },
            set: function() {
                const points =
                    shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];

                if (points) {
                    MAP.setCell(points.x, points.y, "erok");
                }
            }
        };

        const pigeon = {
            displayName: "Carrier Pigeon",
            isActiveOnFloor: false,
            // Homing state
            x: null,
            y: null,
            steps: [],
            voice: {
                pitch: 89,
                speed: 70,
                mouth: 152,
                throat: 191,
            },
            say(str, suppressSpeechSynthesis) {
                if (!suppressSpeechSynthesis) {
                    SpeechSynthesizer.speak(str, pigeon.voice);
                }
                updateBattleLog(
                    `<span class="pigeon">&lt;CARRIER PIGEON&gt;</span> "${str}"`
                );
            },
            isDoneMoving() {
                return this.steps.length === 0;
            },
            isAt(x, y) {
                return pigeon.isActiveOnFloor && this.x === x && this.y === y;
            },
            location() {
                return pigeon.isActiveOnFloor ? { x: this.x, y: this.y } : null;
            },
            checkForMessages() {
                return typeof PigeonMessaging?.hasPendingMessages === 'function'
                    ? PigeonMessaging.hasPendingMessages()
                    : false;
            },
            prepareMovement() {
                if (!this.isActiveOnFloor || this.x == null || this.y == null) {
                    return;
                }

                if (!this.checkForMessages()) {
                    return;
                }

                // One step per player move toward player
                const path =
                    MAP.findPath([this.x, this.y], [player.x, player.y]) || [];
                this.steps = path.slice(1, 2); // take only the next step
            },
            move() {
                if (!this.isActiveOnFloor || this.steps.length === 0) {
                    return null;
                }

                const [nx, ny] = this.steps.shift();
                this.x = nx;
                this.y = ny;

                return this.x === player.x && this.y === player.y
                    ? () => this.encounter()
                    : null;
            },
            encounter() {
                this.isActiveOnFloor = false;
                // Open pigeon menu then display message
                if (typeof menu?.open === 'function') {
                    setTimeout(() => {
                        menu.open('pigeon', () => npcMove());
                    }, 75);
                }
            },
            set() {
                const point =
                    shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];

                if (point) {
                    MAP.setCell(point.x, point.y);
                    this.x = point.x;
                    this.y = point.y;
                }
            },
            onExplode: function (x, y) {
                pigeon.isActiveOnFloor = false;

                const writableCellTypes = [
                    "floor", "rubble1", "rubble2", "crater", "tardspireBanner"
                ];

                const overwriteCell = writableCellTypes.includes(
                    MAP.getCell(x, y)?.type
                );

                if (overwriteCell) {
                    MAP.setCell(x, y, "bloodyCrater");
                }

                playSFX('scream');
                updateKillCounter();
                pigeon.say(
                    'I WAS ONLY THE MESSENGERRRRRrrrrrrrr... *fucking dies*',
                    true
                );
                updateBattleLog(
                    `The <span class="pigeon">carrier pigeon</span> has been ` +
                    `<span class="action">blown into a cloud of feathers ` +
                    `stained a dark red!</span>`
                );
            },
        };

        const boulder = {
            isActiveOnFloor: false,
            x: null,
            y: null,
            direction: null,
            movingDirection: 1,
            hallwayBounds: { start: null, end: null },
            lastMoveTime: 0,
            moveInterval: 500, // Time in ms between boulder movements

            isAt: function(x, y) {
                return boulder.isActiveOnFloor && boulder.x === x && boulder.y === y;
            },

            location: function() {
                return boulder.isActiveOnFloor ? { x: boulder.x, y: boulder.y } : null;
            },

            isOccupiedCell: function(x, y) {
                const cell = MAP.getCell(x, y);
                const mapEntrance = MAP.getEntrance();
                const isEntrance = mapEntrance.x === x && mapEntrance.y === y;

                return (
                    cell.isSolid ||
                    ! cell.canBeRolledOverByBouldingBall ||
                    isEntrance ||
                    merchant.isAt(x, y) ||
                    gambler.isAt(x, y) ||
                    erok.isAt(x, y) ||
                    vampire.isAt(x, y) ||
                    pigeon.isAt(x, y)
                );
            },

            findSuitableHallway: function() {
                const hallways = [];

                // Check player floor spawn position
                const playerSpawn = MAP.getEntrance();

                // Scan map for valid hallways
                for (let y = 1; y < HEIGHT - 1; y++) {
                    for (let x = 1; x < WIDTH - 1; x++) {
                        const cell = MAP.getCell(x, y);
                        if (cell?.type !== 'floor') continue;

                        let horizontalLength = 0;
                        let startX = x;

                        while (startX + horizontalLength < WIDTH - 1) {
                            const cx = startX + horizontalLength;
                            const occupied = boulder.isOccupiedCell(cx, y);
                            if (occupied) {
                                break;
                            }

                            horizontalLength++;
                        }

                        if (horizontalLength >= 4) { // Amount of spaces in a hallway required for a boulder to spawn
                            // Check if player spawn point is in this horizontal hallway
                            const playerInHallway = playerSpawn &&
                                playerSpawn.y === y &&
                                playerSpawn.x >= startX &&
                                playerSpawn.x < startX + horizontalLength;

                            if (!playerInHallway) {
                                let hasNPCs = false;
                                for (let checkX = startX; checkX < startX + horizontalLength; checkX++) {
                                    hasNPCs = boulder.isOccupiedCell(checkX, y);
                                    if (hasNPCs) {
                                        break;
                                    }
                                }

                                if (!hasNPCs) {
                                    hallways.push({
                                        direction: 'horizontal',
                                        start: { x: startX, y: y },
                                        end: { x: startX + horizontalLength - 1, y: y },
                                        length: horizontalLength
                                    });
                                }
                            }
                        }

                        let verticalLength = 0;
                        let startY = y;

                        while (startY + verticalLength < HEIGHT - 1) {
                            const cy = startY + verticalLength;
                            const occupied = boulder.isOccupiedCell(x, cy);
                            if (occupied) {
                                break;
                            }

                            verticalLength++;
                        }

                        if (verticalLength >= 4) { // Amount of spaces in a hallway required for a boulder to spawn
                            // Check if player spawn point is in this vertical hallway
                            const playerInHallway = playerSpawn &&
                                playerSpawn.x === x &&
                                playerSpawn.y >= startY &&
                                playerSpawn.y < startY + verticalLength;

                            if (!playerInHallway) {
                                let hasNPCs = false;
                                for (let checkY = startY; checkY < startY + verticalLength; checkY++) {
                                    hasNPCs = boulder.isOccupiedCell(x, checkY);
                                    if (hasNPCs) {
                                        break;
                                    }
                                }

                                if (!hasNPCs) {
                                    hallways.push({
                                        direction: 'vertical',
                                        start: { x: x, y: startY },
                                        end: { x: x, y: startY + verticalLength - 1 },
                                        length: verticalLength
                                    });
                                }
                            }
                        }
                    }
                }

                return hallways.length > 0 ? randomEntry(hallways) : null;
            },

            spawn: function() {
                const hallway = boulder.findSuitableHallway();
                if (!hallway) {
                    boulder.isActiveOnFloor = false;
                    return;
                }

                boulder.isActiveOnFloor = true;
                boulder.direction = hallway.direction;
                boulder.hallwayBounds = { start: hallway.start, end: hallway.end };
                boulder.movingDirection = 1;

                // Start at one end of the hallway
                boulder.x = hallway.start.x;
                boulder.y = hallway.start.y;
                boulder.lastMoveTime = performance.now();

                // Create bypass gaps in the walls adjacent to the boulder's path
                boulder.createBypassGaps(hallway);

                updateBattleLog('<span class="action">You sense the presence of a large object rolling about...</span>');
            },

            createBypassGaps: function(hallway) {
                const gapSize = 1; // How many wall tiles can be removed to create a gap

                if (hallway.direction === 'horizontal') {
                    // Create gaps for horizontal hallways
                    const midPoint = Math.floor((hallway.start.x + hallway.end.x) / 2);
                    for (let i = 0; i < gapSize; i++) {
                        const gapX = midPoint + i;
                        const gapY = hallway.start.y - 1;

                        if (gapX >= 0 && gapX < WIDTH && gapY >= 0 && gapY < HEIGHT) {
                            const cell = MAP.getCell(gapX, gapY);
                            // Check for void spaces
                            const beyondY = gapY - 1;
                            const beyondCell = MAP.getCell(gapX, beyondY);
                            const isSafeToRemove = beyondCell && beyondCell.type === 'floor';

                            if (cell?.isSolid && isSafeToRemove) {
                                MAP.setCell(gapX, gapY, 'floor');
                            }
                        }
                    }
                    for (let i = 0; i < gapSize; i++) {
                        const gapX = midPoint + i;
                        const gapY = hallway.start.y + 1;

                        if (gapX >= 0 && gapX < WIDTH && gapY >= 0 && gapY < HEIGHT) {
                            const cell = MAP.getCell(gapX, gapY);
                            // Check for void spaces
                            const beyondY = gapY + 1;
                            const beyondCell = MAP.getCell(gapX, beyondY);
                            const isSafeToRemove = beyondCell && beyondCell.type === 'floor';

                            if (cell?.isSolid && isSafeToRemove) {
                                MAP.setCell(gapX, gapY, 'floor');
                            }
                        }
                    }
                } else {
                    // Create gaps for vertical hallways
                    const midPoint = Math.floor((hallway.start.y + hallway.end.y) / 2);
                    for (let i = 0; i < gapSize; i++) {
                        const gapX = hallway.start.x - 1;
                        const gapY = midPoint + i;

                        if (gapX >= 0 && gapX < WIDTH && gapY >= 0 && gapY < HEIGHT) {
                            const cell = MAP.getCell(gapX, gapY);
                            // Check for void spaces
                            const beyondX = gapX - 1;
                            const beyondCell = MAP.getCell(beyondX, gapY);
                            const isSafeToRemove = beyondCell && beyondCell.type === 'floor';

                            if (cell?.isSolid && isSafeToRemove) {
                                MAP.setCell(gapX, gapY, 'floor');
                            }
                        }
                    }
                    for (let i = 0; i < gapSize; i++) {
                        const gapX = hallway.start.x + 1;
                        const gapY = midPoint + i;

                        if (gapX >= 0 && gapX < WIDTH && gapY >= 0 && gapY < HEIGHT) {
                            const cell = MAP.getCell(gapX, gapY);
                            // Check for void spaces
                            const beyondX = gapX + 1;
                            const beyondCell = MAP.getCell(beyondX, gapY);
                            const isSafeToRemove = beyondCell && beyondCell.type === 'floor';

                            if (cell?.isSolid && isSafeToRemove) {
                                MAP.setCell(gapX, gapY, 'floor');
                            }
                        }
                    }
                }
            },

            move: function() {
                if (!boulder.isActiveOnFloor) return null;

                const currentTime = performance.now();
                if (currentTime - boulder.lastMoveTime < boulder.moveInterval) {
                    return null;
                }

                boulder.lastMoveTime = currentTime;

                let nextX = boulder.x;
                let nextY = boulder.y;

                if (boulder.direction === 'horizontal') {
                    nextX += boulder.movingDirection;
                } else {
                    nextY += boulder.movingDirection;
                }

                // Check for obstacles at the next position
                const isObstacle = boulder.isOccupiedCell(nextX, nextY);
                if (isObstacle) {
                    boulder.movingDirection *= -1;
                    return null;
                }

                const enemyAtNextPosition = roamingEnemies.getEnemyAt(nextX, nextY);
                if (enemyAtNextPosition) {
                    roamingEnemies.removeEnemy(enemyAtNextPosition.id);
                    
                    const writableCellTypes = [
                        "floor", "rubble1", "rubble2", "crater", "tardspireBanner"
                    ];
                    
                    const overwriteCell = writableCellTypes.includes(
                        MAP.getCell(nextX, nextY)?.type
                    );
                    
                    if (overwriteCell) {
                        MAP.setCell(nextX, nextY, "bloodyCrater");
                    }
                    
                    // Calculate distance-based scream volume
                    const distance = Math.abs(player.x - nextX) + Math.abs(player.y - nextY);
                    const maxRange = 10; // Max distance range
                    const maxVolume = 1; // Max vol when closest
                    const minVolume = 0.1; // Min vol range

                    const volume = distance <= maxRange 
                        ? Math.max(minVolume, maxVolume - ((distance - 1) / (maxRange - 1)) * (maxVolume - minVolume))
                        : 0; // No sound if too far
                    
                    if (volume > 0) {
                        playSFX('scream', volume);
                        playSFX('boulderHit', volume);
                    }
                }

                // If no obstacle, move to the next position
                boulder.x = nextX;
                boulder.y = nextY;

                if (boulder.x === player.x && boulder.y === player.y) {
                    return () => boulder.hitPlayer();
                }

                return null;
            },

            hitPlayer: function() {
                const damage = Math.ceil(getEffectiveStat('maxHp') / 3);
                player.damage(damage);
                playSFX('boulderHit');
                animBoulderHit();

                updateBattleLog(
                    `<span class="action">YEOUCH!</span> A vicious, bloodthirsty, ` +
                    `Boulding Ball deals <span class="enemy">${damage} HP</span> to you!`
                );
                render();
            },
        };
        function startBoulderMovement() {
            if (boulderMovementInterval) {
                clearInterval(boulderMovementInterval);
            }

            boulderMovementInterval = setInterval(() => {
                // Don't move boulder during combat, animations, in menus, or game over
                if (player.inCombat || animationActive || window._inputBlocked || menu.isOpen() || gameOver) {
                    return;
                }

                if (boulder.isActiveOnFloor) {
                    const result = boulder.move();
                    if (typeof result === 'function') {
                        result();
                    }
                    render();
                }
            }, 100);
        }

        function stopBoulderMovement() {
            if (boulderMovementInterval) {
                clearInterval(boulderMovementInterval);
                boulderMovementInterval = null;
            }
        }

        const enemies = [
            {
                id: "snailSentinel",
                name: "SNAIL SENTINEL",
                displayClassName: "enemy",
                isWild: true,
                hp: 13,
                attack: [1, 5],
                bitcoins: 4,
                talkSlots: [
                    ["Sss...", "Hrk!", "Glorp", "Snail", "Halt!", "Beware"],
                    ["you", "I", "we", "that guy", "snail", "he", "she", "it", "has"],
                    ["am", "is", "are", "was", "snail", "violated", "trespassing", "guarding"],
                    ["slimy", "slow", "fast", "hungry", "snail", "the law", "Judge Joody", "my antennae", "the shell"],
                    ["?", "!", "!!!", "?!", "...", ".",]
                ],
                voice: {
                    pitch: 38,
                    speed: 153,
                    mouth: 213,
                    throat: 163,
                },
            },
            {
                id: "stupidDog",
                name: "STUPID DOG",
                displayClassName: "enemy",
                isWild: true,
                hp: 9,
                attack: [1, 5],
                bitcoins: 3,
                voice: {
                    pitch: 125,
                    speed: 86,
                    mouth: 165,
                    throat: 102,
                },
            },
            {
                id: "wangRat",
                name: "WANG RAT",
                displayClassName: "enemy",
                isWild: true,
                hp: 8,
                attack: [1, 5],
                bitcoins: 2,
                voice: {
                    pitch: 80,
                    speed: 94,
                    mouth: 152,
                    throat: 188,
                },
            },
            {
                id: "keeperOfTheToiletBowl",
                name: "KEEPER OF THE TOILET BOWL",
                displayClassName: "enemy",
                isWild: true,
                hp: 25,
                attack: [1, 5],
                bitcoins: 5,
                voice: {
                    pitch: 95,
                    speed: 66,
                    mouth: 102,
                    throat: 119,
                },
            },
            {
                id: "mysteriousScooter",
                name: "MYSTERIOUS SCOOTER",
                displayClassName: "enemy",
                isWild: true,
                hp: 17,
                attack: [1, 5],
                bitcoins: 4,
                voice: {
                    pitch: 33,
                    speed: 92,
                    mouth: 70,
                    throat: 105,
                },
            },
            {
                id: "badassFlamingSkeleton",
                name: "BADASS FLAMING SKELETON",
                displayClassName: "enemy",
                isWild: true,
                hp: 23,
                attack: [1, 5],
                bitcoins: 4,
                voice: {
                    pitch: 225,
                    speed: 93,
                    mouth: 148,
                    throat: 111,
                },
            },
            {
                id: "fridgeOfForgottenLeftovers",
                name: "FRIDGE OF FORGOTTEN LEFTOVERS",
                displayClassName: "enemy",
                isWild: true,
                hp: 27,
                attack: [1, 5],
                bitcoins: 3,
                voice: {
                    pitch: 174,
                    speed: 116,
                    mouth: 86,
                    throat: 146,
                },
            },
            {
                id: "lughead",
                name: "LUGHEAD",
                displayClassName: "enemy",
                isWild: true,
                hp: 28,
                attack: [1, 5],
                bitcoins: 4,
                talkSlots: [
                    ["Ugh", "LUG", "Arrgh", "UNG", "Borf", "AHHHHHHH", "Bunginga"],
                    ["smash", "eat", "touch", "rip", "grab", "friend", "befriend", "love", "rock", "dance", "pull teeth", "over there"],
                    ["now", "later", "soon", "maybe", "never", "happy", "punch", "kill", "death", "Phillips CD-i", "Bubsy 3D"],
                    ["?", "!", "!!!", "?!", "...", ".",]
                ],
                voice: {
                    pitch: 110,
                    speed: 127,
                    mouth: 99,
                    throat: 82,
                },
            },
            {
                id: "pissedOffPoultry",
                name: "PISSED-OFF POULTRY",
                displayClassName: "enemy",
                isWild: true,
                hp: 15,
                attack: [1, 5],
                bitcoins: 2,
                voice: {
                    pitch: 42,
                    speed: 79,
                    mouth: 128,
                    throat: 92,
                },
            },
            {
                id: "krampusElf",
                name: "KRAMPUS ELF",
                displayClassName: "enemy",
                isWild: true,
                hp: 14,
                attack: [1, 5],
                bitcoins: 4,
                voice: {
                    pitch: 36,
                    speed: 79,
                    mouth: 255,
                    throat: 194,
                },
            },
            {
                id: "mimic",
                name: "MIMIC",
                displayClassName: "enemy",
                isWild: false,
                hp: 140,
                attack: [1, 5],
                bitcoins: 100,
                voice: {
                    pitch: 142,
                    speed: 80,
                    mouth: 132,
                    throat: 170,
                },
            },
            {
                id: "vampire",
                name: vampire.displayName,
                displayClassName: vampire.displayClassName,
                isWild: false,
                hp: vampire.baseHp,
                attack: [1, 5],
                bitcoins: 40,
                voice: vampire.voice,
            },
        ];

        const roamingEnemies = {
            enemies: {},
            maxEnemies: 6,
            nextId: 0,
            enemiesKilledTotal: 0,
            respawnAfterKills: 3,

            // Check if a position is in a boulder's path
            isInBoulderPath: function(x, y) {
                if (!boulder.isActiveOnFloor) {
                    return false;
                }

                if (boulder.direction === 'horizontal') {
                    return y === boulder.y && x >= boulder.hallwayBounds.start.x && x <= boulder.hallwayBounds.end.x;
                } else {
                    return x === boulder.x && y >= boulder.hallwayBounds.start.y && y <= boulder.hallwayBounds.end.y;
                }
            },

            isPlayerInLineOfSight: function(enemy) {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                
                const dirIndex = DIRECTIONS.indexOf(enemy.facing);
                
                // Check if player is in the general direction the enemy is facing
                // Allow for a 90-degree cone of vision (45 degrees on each side)
                switch (enemy.facing) {
                    case 'N':
                        return dy < 0 && Math.abs(dx) <= Math.abs(dy);
                    case 'E':
                        return dx > 0 && Math.abs(dy) <= Math.abs(dx);
                    case 'S':
                        return dy > 0 && Math.abs(dx) <= Math.abs(dy);
                    case 'W':
                        return dx < 0 && Math.abs(dy) <= Math.abs(dx);
                    default:
                        return false;
                }
            },

            totalActiveEnemies: function() {
                return Object.keys(roamingEnemies.enemies).length;
            },

            canSpawnEnemy: function(isFloorInitialization) {
                const total = roamingEnemies.totalActiveEnemies();
                return (
                    (isFloorInitialization || total > 0) &&
                    total < roamingEnemies.maxEnemies
                );
            },

            spawnEnemy: function(isFloorInitialization) {
                if (! roamingEnemies.canSpawnEnemy(isFloorInitialization)) {
                    return;
                }

                const entrance = MAP.getEntrance();
                let spawnCoords;

                if (isFloorInitialization) {
                    // Initial spawn: spawn away from the entry point
                    const minDistanceFromEntrance = 2;
                    spawnCoords = MAP.getEmptyCellCoordinates().filter(coord =>
                        // Filter out positions that are in boulder paths
                        !roamingEnemies.isInBoulderPath(coord.x, coord.y) &&
                        (
                            Math.abs(coord.x - entrance.x) >= minDistanceFromEntrance ||
                            Math.abs(coord.y - entrance.y) >= minDistanceFromEntrance
                        )
                    );
                } else {   
                    const spawnRadius = 5; // Respawn enemies within radius
                    const minPlayerDistance = 3; // Safeguard for respawn distance
                    spawnCoords = MAP.getEmptyCellCoordinates().filter(coord => {
                        const distanceFromPlayer = Math.max(
                            Math.abs(coord.x - player.x),
                            Math.abs(coord.y - player.y)
                        );
                        
                        return (
                            distanceFromPlayer >= minPlayerDistance &&
                            distanceFromPlayer <= spawnRadius &&
                            !roamingEnemies.isInBoulderPath(coord.x, coord.y)
                        );
                    });
                }

                if (spawnCoords.length === 0) {
                    return;
                }

                const spawnPoint = randomEntry(spawnCoords);
                const id = `enemy_${roamingEnemies.nextId++}`;

                roamingEnemies.enemies[id] = {
                    id,
                    x: spawnPoint.x,
                    y: spawnPoint.y,
                    facing: randomEntry(DIRECTIONS),
                    lastMoveDirection: randomEntry(DIRECTIONS),
                    isPursuing: false
                };
            },

            removeEnemy: function(enemyId) {
                delete roamingEnemies.enemies[enemyId];
            },

            respawningEnabled: function() {
                return (
                    roamingEnemies.enemiesKilledTotal >=
                    roamingEnemies.respawnAfterKills
                );
            },

            killEnemy: function(enemyId) {
                roamingEnemies.removeEnemy(enemyId);
                updateKillCounter();
            },

            isAt: function(x, y) {
                return Object.values(roamingEnemies.enemies)
                    .some(enemy => enemy.x === x && enemy.y === y);
            },

            getEnemyAt: function(x, y) {
                return Object.values(roamingEnemies.enemies)
                    .find(enemy => enemy.x === x && enemy.y === y);
            },

            getEnemy: function(id) {
                return roamingEnemies.enemies[id];
            },

            moveEnemies: function() {
                const hasRingOfStinky = player.inventory.hasEquippedRing("ringOfStinky");

                Object.keys(roamingEnemies.enemies).forEach(enemyId => {
                    const enemy = roamingEnemies.enemies[enemyId];
                    const possibleMoves = [];
                    const awayFromPlayerMoves = [];
                    const towardPlayerMoves = [];

                    // Calculate distance to player
                    const distanceToPlayer = Math.abs(enemy.x - player.x) + Math.abs(enemy.y - player.y);
                    
                    // Torch increases enemy line of sight to 2
                    const enemySightRange = player.isHoldingTorch ? 2 : 1;
                    const isNearPlayer = distanceToPlayer <= enemySightRange;
                    
                    // Check if player is in line of sight
                    const playerInLineOfSight = roamingEnemies.isPlayerInLineOfSight(enemy);
                    
                    // Enemy can see player if they're close AND in line of sight, OR if already pursuing
                    const canSeePlayer = (isNearPlayer && playerInLineOfSight) || enemy.isPursuing;

                    // Ring of Stinky behavior: % chance to avoid when close
                    const shouldAvoidPlayer = hasRingOfStinky && canSeePlayer && Math.random() < 0.9;

                    // Pursuit behavior: chase player when they can see them (unless avoiding due to Ring of Stinky)
                    const shouldPursuePlayer = canSeePlayer && !shouldAvoidPlayer;

                    // Update pursuit state
                    if (shouldPursuePlayer) {
                        enemy.isPursuing = true;
                    } else if (distanceToPlayer > enemySightRange * 2) {
                        // Stop pursuing if player gets far enough away
                        enemy.isPursuing = false;
                    }

                    DIRECTIONS.forEach(direction => {
                        const dirIndex = DIRECTIONS.indexOf(direction);
                        const newX = enemy.x + DX[dirIndex];
                        const newY = enemy.y + DY[dirIndex];

                        const cell = MAP.getCell(newX, newY);
                        if (cell && !cell.isSolid && (cell.type === 'floor' || (newX === player.x && newY === player.y))) {
                            const moveData = { x: newX, y: newY, direction };
                            possibleMoves.push(moveData);

                            const currentDistance = Math.abs(enemy.x - player.x) + Math.abs(enemy.y - player.y);
                            const newDistance = Math.abs(newX - player.x) + Math.abs(newY - player.y);

                            if (newDistance < currentDistance) {
                                towardPlayerMoves.push(moveData);
                            } else if (newDistance > currentDistance) {
                                awayFromPlayerMoves.push(moveData);
                            }
                        }
                    });

                    if (possibleMoves.length === 0) return;

                    let selectedMove;

                    // Priority 1: Ring of Stinky avoidance (overrides pursuit)
                    if (shouldAvoidPlayer && awayFromPlayerMoves.length > 0) {
                        selectedMove = randomEntry(awayFromPlayerMoves);
                    }
                    // Priority 2: Pursuit behavior when can see player
                    else if (shouldPursuePlayer && towardPlayerMoves.length > 0) {
                        selectedMove = randomEntry(towardPlayerMoves);
                    }
                    // Priority 3: Normal random movement behavior
                    else {
                        // Prefer continuing in the same direction, otherwise pick randomly
                        selectedMove = possibleMoves.find(move => move.direction === enemy.lastMoveDirection);
                        if (!selectedMove || Math.random() < 0.3) { // % chance to change direction
                            selectedMove = randomEntry(possibleMoves);
                        }
                    }

                    enemy.x = selectedMove.x;
                    enemy.y = selectedMove.y;
                    enemy.lastMoveDirection = selectedMove.direction;

                    enemy.facing = selectedMove.direction;

                    if (enemy.x === player.x && enemy.y === player.y) {
                        roamingEnemies.encounterEnemy(enemy.id);
                        delete roamingEnemies.enemies[enemy.id];
                        return;
                    }
                });

                // Respawn logic: spawn full maxEnemies amount when threshold is met
                if (roamingEnemies.respawningEnabled()) {
                    const total = roamingEnemies.totalActiveEnemies();
                    
                    // If we have fewer than maxEnemies and the respawn threshold is met
                    if (total < roamingEnemies.maxEnemies) {
                        // Spawn enough enemies to reach maxEnemies
                        const enemiesToSpawn = roamingEnemies.maxEnemies - total;
                        
                        for (let i = 0; i < enemiesToSpawn; i++) {
                            roamingEnemies.spawnEnemy(false);
                        }
                    }
                }
            },

            encounterEnemy: function(id) {
                const enemy = roamingEnemies.getEnemy(id);
                if (!enemy) {
                    return;
                }
                roamingEnemies.removeEnemy(id);
                startEncounter();
            },

            initialize: function() {
                roamingEnemies.enemies = {};

                for (let i = 0; i < roamingEnemies.maxEnemies; i++) {
                    roamingEnemies.spawnEnemy(true);
                }
            }
        };

        function getEffectiveStat(stat) {
            if (stat === "persuasionAttempts") {
                return player.inventory.hasEquippedRing("ringOfAmplifiedAudio")
                    ? 3 : 2;
            }

            if (stat === 'speed') {
                const baseSpd = player.speed;
                const carryWeight = player.inventory.getWeight();
                const carryLimit = player.getCarryWeightLimit();
                if (carryWeight <= 0) {
                    return baseSpd;
                }
                const percent = carryWeight / carryLimit;
                if (percent <= 0.5) {
                    return baseSpd; // Debuff: 5% at 50%, up to 100% at 100%
                }

                // Linear from 5% to 100%
                const debuff = Math.min(1, (percent - 0.5) * 2) * 0.95 + 0.05;
                return Math.max(0, Math.floor(baseSpd * (1 - debuff)));
            }

            const ringsEquipped = Object.values(
                player.inventory.getEquippedRings()
            ).filter(Boolean);

            return player[stat] + ringsEquipped.reduce((sum, ring) => sum + (ring.effects?.[stat] || 0), 0);
        }

        const sfx = {
            footstep: new Audio('audio/sfx/footsteps.mp3'),
            footstepsDescending: new Audio('audio/sfx/footsteps-descending.mp3'),
            turn: new Audio('audio/sfx/turn.mp3'),
            attack: new Audio('audio/sfx/attack.mp3'),
            run: new Audio('audio/sfx/run.mp3'),
            persuade: new Audio('audio/sfx/persuade.mp3'),
            explosion: new Audio('audio/sfx/explosion.mp3'),
            scream: new Audio('audio/sfx/scream.mp3'),
            breathe1: new Audio('audio/sfx/breathe1.mp3'),
            breathe2: new Audio('audio/sfx/breathe2.mp3'),
            kaching: new Audio('audio/sfx/kaching.mp3'),
            torch: new Audio('audio/sfx/torch.mp3'),
            gamble: new Audio('audio/sfx/gamble.mp3'),
            inventoryOpen: new Audio('audio/sfx/inventoryOpen.mp3'),
            uiOption: new Audio('audio/sfx/uiOption.mp3'),
            uiSelect: new Audio('audio/sfx/uiSelect.mp3'),
            uiCancel: new Audio('audio/sfx/uiCancel.mp3'),
            raisins: new Audio('audio/sfx/raisins.mp3'),
            floorCrackSlight: new Audio('audio/sfx/floorCrackSlight.mp3'),
            floorBreakScreamDie: new Audio('audio/sfx/floorBreakScreamDie.mp3'),
            healTile: new Audio('audio/sfx/healTile.mp3'),
            tromBone: new Audio('audio/sfx/tromBONE.mp3'),
            attacked: new Audio('audio/sfx/attacked.mp3'),
            battleStart: new Audio('audio/sfx/battleStart.mp3'),
            battleEnd: new Audio('audio/sfx/battleEnd.mp3'),
            ash: new Audio('audio/sfx/ash.mp3'),
            alert: new Audio('audio/sfx/alert.ogg'),
            batWingFlapDry: new Audio('audio/sfx/bat-wings-dry.ogg'),
            batWingFlapWet: new Audio('audio/sfx/bat-wings-wet.ogg'),
            lean: new Audio('audio/sfx/lean.mp3'),
            merchantNear: new Audio('audio/sfx/merchant-near.ogg'),
            erokNear: new Audio('audio/sfx/erok-near.ogg'),
            boulderNear: new Audio('audio/sfx/boulder-near.ogg'),
            boulderHit: new Audio('audio/sfx/boulder-hit.ogg'),
        };

        const sfxAmb = {
            rat1: new Audio('audio/ambient/rat1.ogg'),
            howl1 : new Audio('audio/ambient/howl1.ogg'),
            chain1: new Audio('audio/ambient/chain1.ogg'),
            run1: new Audio('audio/ambient/run1.ogg'),
        };

        let ambientSfxTimeout = null;
        let ambientSfxPaused = false;
        let ambientSfxScheduledTime = null;
        let ambientSfxStartTime = null;
        let npcProximityTimers = new Map();
        let npcProximityIntervals = new Map();
        let boulderProximityTimer = null;
        let boulderProximityAudio = null;
        let lastBoulderDistance = null;
        let currentEnemy = null;
        let gameOver = false;
        let persuasionAttempts = 0;
        let maxPersuasionAttempts = 2;
        let speakingOutsideCombat = false;
        let animationActive = false;
        let currentBreathing = null;
        let floor = 1;
        let boulderMovementInterval = null;
        const gravestoneData = {}; // keyed by floor: { x, y, entry }
        const gravestoneMessages = [
            "Attempted to pillage the TardSpire, but was pillaged in the ass by a refrigerator instead. RIP",
            "Stayed up all night for this score. Worth it?",
            "A shining example of refined incompetence.",
            "You see a trom-BONE lodged sticking out of the ground. Musical genius, or a victim to amusia? No one will know.",
            "They shit their pants... it was REAL bad.",
            "They tried.",
            "Rumors say they bore witness to the Pico's School incident...",
            "This one was a registered Gex offender, straight up.",
            "782 hours logged in Bubsy 3D. 'Nuff said.",
            "Maybe they shouldn't have killed Erok...",
            "This gravestone has been vandalized by teenagers. Those very teenagers now reside beneath this stone, due to unknown forces.",
            "They tried to stay ALIVE on OPPOSITE DAY. Poor sucker..."
        ];

        const MAP = new GameMap();
        MAP.setMinimap(document.getElementById("minimap"));

        MAP.setCellTypes({
            floor: {
                displayName: "Floor",
                mapCharacter: ".",
            },
            healingTile: {
                displayName: "Healing Tile",
                mapCharacter: "H",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function (x, y) {
                    player.steppingOnHealingTile = true;

                    // Heal player
                    const healAmount = Math.ceil(getEffectiveStat('maxHp') * 0.3);
                    player.heal(healAmount);

                    // Heal party
                    let healedAllies = [];
                    player.party.members.forEach(member => {
                        if (member.hp > 0) {
                            const allyHeal = Math.ceil(member.maxHp * 0.1);
                            member.hp = Math.min(member.maxHp, member.hp + allyHeal);
                            healedAllies.push(`<span class="friendly">${member.name}</span> <span class="healingTile">+${allyHeal} HP</span>`);
                        }
                    });

                    let logMsg =
                        `An oddly colored, perfectly square floor ` +
                        `tile <span class="friendly">heals you for ` +
                        `<span class="healingTile">${healAmount} HP</span></span>`;
                    if (healedAllies.length) {
                        logMsg += `<br>Some of that magic was also shared with your party: ${healedAllies.join(', ')}`;
                    }

                    updateBattleLog(logMsg);
                    MAP.setCell(x, y);
                },
            },
            wall: {
                displayName: "Wall",
                mapCharacter: "#",
                isSolid: true,
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            iceWall: {
                displayName: "Wall",
                mapCharacter: '#',
                isSolid: true,
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            crackedFloorSlight: {
                displayName: "Slightly-Cracked Floor",
                mapCharacter: '✕',
                canBeRolledOverByBouldingBall: false,
                onEnter: async function (x, y) {
                    const weightLevel = player.getWeightLevel();

                    if (weightLevel === "normal") {
                        MAP.setCell(x, y, "crackedFloor");
                        playSFX("floorCrackSlight");
                        if (window.GamepadSupport && typeof GamepadSupport.vibrate === 'function') {
                            GamepadSupport.vibrate(500, 0.25);
                        }
                        updateBattleLog(
                            '<span class="action">The floor cracks under ' +
                            'your feet!</span>'
                        );
                    } else if (weightLevel === "warning") {
                        MAP.setCell(x, y, "crackedFloorSevere");
                        playSFX("floorCrackSlight");
                        if (window.GamepadSupport && typeof GamepadSupport.vibrate === 'function') {
                            GamepadSupport.vibrate(500, 0.5);
                        }
                        updateBattleLog(
                            '<span class="action">The floor trembles under ' +
                            'your feet!</span> You might want to lighten ' +
                            'your load and avoid stepping here again!'
                        );
                    } else if (weightLevel === "danger") {
                        player.fallThroughFloorAndDie();
                    }
                },
            },
            crackedFloor: {
                displayName: "Cracked Floor",
                mapCharacter: '✕',
                canBeRolledOverByBouldingBall: false,
                onEnter: async function (x, y) {
                    const weightLevel = player.getWeightLevel();

                    if (weightLevel === "normal") {
                        MAP.setCell(x, y, "crackedFloorSevere");
                        playSFX("floorCrackSlight");
                        if (window.GamepadSupport && typeof GamepadSupport.vibrate === 'function') {
                            GamepadSupport.vibrate(500, 0.5);
                        }
                        updateBattleLog(
                            '<span class="action">The floor cracks under ' +
                            'your feet!</span> It would be a good idea to ' +
                            'avoid stepping here again'
                        );
                    } else if (["warning", "danger"].includes(weightLevel)) {
                        player.fallThroughFloorAndDie();
                    }
                },
            },
            crackedFloorSevere: {
                displayName: "Severely-Cracked Floor",
                mapCharacter: '✖',
                canBeRolledOverByBouldingBall: false,
                onEnter: async function (x, y) {
                    player.fallThroughFloorAndDie();
                },
            },
            rubble1: {
                displayName: "Floor",
                mapCharacter: ".",
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "rubble2");
                },
            },
            rubble2: {
                displayName: "Floor",
                mapCharacter: ".",
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "rubble1");
                },
            },
            gloryWall: {
                displayName: "Wall",
                mapCharacter: "#",
                isSolid: true,
                onTouch: function() {
                    player.say("Uh, no thanks. I'm not THAT brave");
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            noboWall: {
                displayName: "Wall",
                mapCharacter: "#",
                isSolid: true,
                onTouch: function () {
                    player.say(
                        "Who's that? ... Just some nobody, I guess"
                    );
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, randomEntry(["rubble1", "rubble2"]));
                },
            },
            crater: {
                displayName: "Floor",
                mapCharacter: ".",
            },
            bloodyCrater: {
                displayName: "Floor",
                mapCharacter: ".",
            },
            exit: {
                displayName: "Exit",
                mapCharacter: "E",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function() {
                    descend();
                }
            },
            merchant: {
                displayName: "Merchant",
                mapCharacter: "M",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function(x, y) {
                    music.play("merchantTheme");
                    menu.open('merchant', () => npcMove());
                },
                isVisible: function() {
                    return (
                        merchant.isAlive &&
                        merchant.isActiveOnFloor
                    );
                },
                onExplode: function (x, y) {
                    merchant.isAlive = false;
                    merchant.isActiveOnFloor = false;
                    updateKillCounter();
                    MAP.setCell(x, y, "bloodyCrater");
                    playSFX('scream');
                    merchant.say('AIEEEEEEEEEEEEEE!', true);
                    updateBattleLog(
                        'HOLY SHIT! The <span class="friendly">' +
                        'merchant</span> has been ' +
                        '<span class="action">vaporized</span> into ' +
                        'a bloody red mist!'
                    );
                },
            },
            gambler: {
                displayName: "Gambler",
                mapCharacter: "G",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function(x, y) {
                    menu.open('gambler', () => npcMove());
                },
                isVisible: function () {
                    return (
                        gambler.isAlive &&
                        gambler.isActiveOnFloor &&
                        player.bitcoins >= gambler.playPrice
                    );
                },
                onExplode: function (x, y) {
                    gambler.isAlive = false;
                    gambler.isActiveOnFloor = false;
                    updateKillCounter();
                    MAP.setCell(x, y, "bloodyCrater");

                    // Award between 50 and 100 BTC for the slaughter. I guess that's one way to win
                    const rewardBtc = (5 + Math.round(Math.random() * 5)) * 10;
                    player.giveBitcoins(rewardBtc);
                    playSFX('scream');
                    gambler.say('AUGH!!', true);
                    updateBattleLog(
                        `The <span class="gambler">gambler</span> ` +
                        `has been reduced to a confetti of shrapnel ` +
                        `and bone! You find <span class="BTC">` +
                        `${rewardBtc} BTC</span> among the remains. ` +
                        `Awesome!`
                    );
                },
            },
            erok: {
                displayName: "Erok",
                mapCharacter: "D",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function(x, y) {
                    menu.open('erok', () => npcMove());
                },
                isVisible: function() {
                    return (
                        erok.isAlive &&
                        erok.isActiveOnFloor
                    );
                },
                onExplode: function (x, y) {
                    erok.isAlive = false;
                    erok.isActiveOnFloor = false;
                    updateKillCounter();
                    MAP.setCell(x, y, "bloodyCrater");
                    playSFX('scream');
                    erok.say('i died oh noes', true);

                    // You better believe there's a price to pay
                    const previousLuck = player.luck;
                    player.luck = Math.max(player.luck - 10, 1);
                    const badLuck = previousLuck - player.luck;

                    updateBattleLog(
                        `OH NO! <span class="friendly">Erok</span> has been ` +
                        `<span class="action">blown the fuck up!</span> ` +
                        `You monster... ` +
                        `<strong class="enemy">-${badLuck} LUCK</strong>`
                    );
                },
            },
            tardspireBanner: {
                displayName: "Floor",
                mapCharacter: ".",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function (x, y) {
                    MAP.setCell(x, y);
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y);
                },
            },
            treasureChest: {
                displayName: "Treasure Chest",
                mapCharacter: "T",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function(x, y) {
                    menu.open("chest");
                },
                onExplode: function (x, y) {
                    MAP.setCell(x, y, "crater");
                    updateBattleLog(
                        '<span class="action">Gee willikers, you ' +
                        'just destroyed a perfectly good treasure ' +
                        'chest! Oh well...</span><br>'
                    );
                },
            },
            mimic: {
                displayName: "Treasure Chest",
                mapCharacter: "T",
                canBeRolledOverByBouldingBall: false,
                onEnter: async function (x, y) {
                    menu.open("chest");
                },
                onExplode: function (x, y) {
                    updateKillCounter();
                    MAP.setCell(x, y, "bloodyCrater");

                    // Calculate scaled BTC reward
                    const baseMimic = enemies.find(e => e.id === "mimic");
                    const scaledMimic = scaleMimicStats(baseMimic);
                    const mimicBTC = scaledMimic.bitcoins;

                    player.giveBitcoins(mimicBTC); // Reward the player
                    updateBattleLog(
                        `<span class="action">WHAT THE FUCK? That ` +
                        `was a mimic?!</span> You obtained ` +
                        `<span class="BTC">₿ ${mimicBTC}</span> ` +
                        `from the intestines spilled from its gaping ` +
                        `maw.`
                    );
                    playSFX('scream');
                },
            },
            roamingEnemy: {
                displayName: "Monster",
                mapCharacter: "☠︎︎",
                canBeRolledOverByBouldingBall: false,
                isVisible: function() {
                    return true;
                },
            },
            gravestone: {
                displayName: "Gravestone",
                mapCharacter: "†",
                canBeRolledOverByBouldingBall: false,
                isSolid: false,
                onEnter: function(x, y) {
                    const data = gravestoneData[floor];
                    if (!data || data.x !== x || data.y !== y || !data.entry) {
                        render();
                        return;
                    }

                    const entry = data.entry;
                    const name = entry.name || entry.player || entry.displayName || "Unknown";
                    const floorVal = entry.floor ?? entry.floor_reached ?? entry.max_floor ?? null;
                    const levelVal = entry.level ?? entry.level_reached ?? entry.max_level ?? null;
                    const displayScore = (floorVal !== null || levelVal !== null)
                        ? `Floor ${floorVal ?? '??'} - Level ${levelVal ?? '??'}`
                        : `Score: ${entry.score ?? entry.points ?? entry.total ?? '??'}`;

                    const message = randomEntry(gravestoneMessages);

                    updateBattleLog(
                        `<span class="friendly">${name}</span> - ` +
                        `<span class="BTC">${displayScore}</span> ` +
                        `<span class="action">${message}</span>`
                    );

                    data.explored = true;
                    const cell = MAP.getCell(x, y);
                    if (cell) cell.isExplored = true;
                    MAP.refreshMinimap();
                    render();
                },
            },
        });

        const music = new Music(
            TARDQUEST_MUSIC_TRACKS,
            {
                play: (trackId, info) => {
                    const $nowPlaying = document.getElementById('nowPlaying');
                    if (! $nowPlaying) {
                        console.error("Now Playing section not found");
                        return;
                    }

                    $nowPlaying.classList.remove("stopped");
                    $nowPlaying.querySelector(".track-info").textContent =
                        `${info.title} - ${info.artist}`;
                },

                stop: () => {
                    const $nowPlaying = document.getElementById('nowPlaying');
                    if (! $nowPlaying) {
                        console.error("Now Playing section not found");
                        return;
                    }

                    $nowPlaying.classList.add("stopped");
                    $nowPlaying.querySelector(".track-info").textContent =
                        "No music playing";
                },
            }
        );

        let tromboneIsPlaying = false;
        let sfxEnabled = true;
        let speechEnabled = true;
        let skipTitleScreen = false;
        let eatRatAnimationEnabled = true;
        let battleTransitionAnimationsEnabled = true;
        let cachedLeaderboardEntries = null;

        // Taken from https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle
        function shuffle(array) {
            if (!Array.isArray(array)) {
                console.error(
                    "Cannot shuffle something that isn't an array",
                    { array }
                );

                return array;
            }

            for (let i = array.length - 1; i >= 1; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Returns a random integer between a minimum and maximum, inclusive
        function numberBetween(min, max) {
            if (typeof min !== "number" || typeof max !== "number") {
                console.error(
                    "The min and max values must be numbers",
                    { min, max }
                );

                return 0;
            }

            if (min > max) {
                [min, max] = [max, min];
            }

            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Returns a random entry from an object or array
        function randomEntry(list) {
            if (Array.isArray(list)) {
                if (list.length < 1) {
                    return null;
                }

                return list[numberBetween(0, list.length - 1)];
            }

            if (typeof list === "object") {
                const key = shuffle(Object.keys(list))?.[0];
                return key ? list[key] : null;
            }

            console.error("Input list is not an array or object", { list });
            return null;
        }
        async function spawnGravestone() {
            // Only spawn one per floor
            if (gravestoneData[floor]) return;

            if (typeof TardAPI === 'undefined' || typeof TardAPI.getLeaderboard !== 'function') {
                console.warn("spawnGravestone: TardAPI.getLeaderboard not available - skipping spawn");
                return;
            }

            try {
                // Use cached entries if available, otherwise fetch
                let entries = cachedLeaderboardEntries;
                
                if (!entries) {
                    const res = await TardAPI.getLeaderboard({ force: false });
                    if (!res || !res.success || !Array.isArray(res.leaderboard) || res.leaderboard.length === 0) {
                        console.debug("spawnGravestone: leaderboard empty or failed", res);
                        return;
                    }
                    entries = res.leaderboard;
                    cachedLeaderboardEntries = entries; // Cache for future floors
                }

                if (!Array.isArray(entries) || entries.length === 0) return;

                // Only consider leaderboard entries from the current floor
                const floorEntries = entries.filter(e => {
                    const entryFloor = Number(e.floor ?? e.floor_reached ?? e.max_floor ?? NaN);
                    return Number.isFinite(entryFloor) && entryFloor === floor;
                });

                if (floorEntries.length === 0) {
                    console.debug("spawnGravestone: no leaderboard entries for current floor", { floor, totalEntries: entries.length });
                    return;
                }

                // Collate top scores per unique name (preserve full entry)
                const topByName = {};
                floorEntries.forEach(e => {
                    const name = e.name || e.player || e.displayName || `Player${e.id ?? ''}`;
                    const score = Number(e.score ?? e.points ?? e.total ?? NaN);
                    const floorVal = Number(e.floor ?? e.floor_reached ?? e.max_floor ?? NaN);
                    const levelVal = Number(e.level ?? e.level_reached ?? e.max_level ?? NaN);
                    const metric = !Number.isNaN(score)
                        ? score
                        : ((!Number.isNaN(floorVal) || !Number.isNaN(levelVal))
                            ? ((Number.isFinite(floorVal) ? floorVal : 0) * 1000 + (Number.isFinite(levelVal) ? levelVal : 0))
                            : 0);

                    const existing = topByName[name];
                    if (!existing || metric > existing.__metric) {
                        topByName[name] = { ...e, name, __metric: metric };
                    }
                });
                const uniqueEntries = Object.values(topByName);
                if (uniqueEntries.length === 0) return;

                // Choose random unique entry
                const entry = randomEntry(uniqueEntries);

                // Choose a coordinate - floor cell and not near player/boulder/merchant/gambler etc
                const spawnCandidates = MAP.getEmptyCellCoordinates().filter(coord => {
                    const distanceFromPlayer = Math.max(Math.abs(coord.x - player.x), Math.abs(coord.y - player.y));
                    if (distanceFromPlayer < 4) return false;
                    if (roamingEnemies.isInBoulderPath(coord.x, coord.y)) return false;
                    if (merchant.isAt(coord.x, coord.y) || gambler.isAt(coord.x, coord.y) || erok.isAt(coord.x, coord.y) || vampire.isAt(coord.x, coord.y) || pigeon.isAt(coord.x, coord.y)) return false;
                    const cell = MAP.getCell(coord.x, coord.y);
                    return cell && (cell.type === 'floor' || cell.type === 'rubble1' || cell.type === 'rubble2' || cell.type === 'crater' || cell.type === 'bloodyCrater');
                });

                if (spawnCandidates.length === 0) return;

                const chosenCell = randomEntry(spawnCandidates);
                const { x, y } = chosenCell;

                MAP.setCell(x, y, 'gravestone');
                gravestoneData[floor] = { x, y, entry, explored: false };

                MAP.setEntities({});
                MAP.refreshMinimap();
                render();

            } catch (err) {
                console.warn("Could not spawn gravestone: leaderboard fetch failed", err);
            }
        }

        function generateMap() {
            MAP.setEntities({
                player: {
                    x: player.x,
                    y: player.y,
                },
            });
            MAP.generate(WIDTH, HEIGHT, player.x, player.y);

            if (pigeon.checkForMessages()) {
                pigeon.isActiveOnFloor = true;
                pigeon.set();
            } else {
                pigeon.isActiveOnFloor = false;
                pigeon.x = pigeon.y = null;
            }

            if (floor === 1) {
                placeWelcomeBanner();
            }

            if (merchant.isAlive) {
                // Always spawn on the first floor, or after 3 floors of absence
                if (floor === 1 || merchant.consecutiveFloorsAbsent >= 3) {
                    merchant.isActiveOnFloor = true;
                    merchant.consecutiveFloorsAbsent = 0;
                } else {
                    merchant.isActiveOnFloor = Math.random() < 0.35;
                    merchant.consecutiveFloorsAbsent +=
                        ! merchant.isActiveOnFloor;
                }

                if (merchant.isActiveOnFloor) {
                    merchant.set();
                }
            } else {
                merchant.isActiveOnFloor = false;
            }

            if (floor === 40) {
                placeNoboWall();
            }

            gambler.isActiveOnFloor = gambler.isAlive && Math.random() < 0.35;
            if (gambler.isActiveOnFloor) {
                gambler.set();
            }

            erok.isActiveOnFloor = erok.isAlive; // Spawns on every floor because he is a good boy
            if (erok.isActiveOnFloor) {
                erok.set();
            }

            spawnTreasureChests();
            spawnHealingTiles();
            spawnCrackedFloors();

            if (Math.random() < 0.6) { // % chance to spawn boulder
                boulder.spawn();
            } else {
                boulder.isActiveOnFloor = false;
            }

            // Initialize roaming enemies after all other map elements are placed
            roamingEnemies.initialize();
            // spawn gravestone for this floor
            spawnGravestone();

            document.getElementById('dungeonFloor').textContent =
                floor.toLocaleString(undefined);

            vampire.initialize();
        }

        function updateKillCounter(initialValue) {
            // Automatically update the counter by 1 unless an override is given
            roamingEnemies.enemiesKilledTotal = Number.isInteger(initialValue)
                ? initialValue
                : roamingEnemies.enemiesKilledTotal + 1;

            const $killCounter = document.getElementById('killCounter');
            if (! $killCounter) {
                console.error("The kill counter element doesn't exist");
                return;
            }

            const total = roamingEnemies.enemiesKilledTotal;
            $killCounter.textContent = total.toLocaleString(undefined);

            const message = (function () {
                switch (total) {
                    case 69:
                        return "Nice";
                    case 420:
                        return "dude weed kills lmao";
                    case 1337:
                    case 31337:
                        return "Literal hacker";
                    case 5555:
                        return "You daft punk";
                    case 6969:
                        return "Double nice";
                    case 42069:
                        return "Party time";
                }

                const totalString = total.toString();
                if (totalString.match(/^(\d)\1+$/)) {
                    switch (totalString.length) {
                        case 2: return "Nice dubs!";
                        case 3: return "Sick trips!";
                        case 4: return "Quality quads!!";
                        case 5: return "Quixotic quints!!!";
                        default: return "Check 'em!";
                    }
                }

                return "Total Kills";
            }());

            $killCounter.setAttribute(
                'data-tooltipHtml',
                `<div class="genericTooltip">${message}</div>`
            );
        }

        let autoDicerollEnabled = false;
        let preloaderEnabled = true;

        function loadSettings() {
            // Music settings
            JSON.parse(localStorage.getItem("musicEnabled")) ?? true
                ? music.enable()
                : music.disable();
            music.setDisabledTracks(
                JSON.parse(localStorage.getItem("disabledTracks")) ?? {}
            );

            const eatRat = localStorage.getItem("eatRatAnimationEnabled");
            if (eatRat !== null) eatRatAnimationEnabled = eatRat === "true";
            const sfx = localStorage.getItem("sfxEnabled");
            if (sfx !== null) sfxEnabled = sfx === "true";
            const speech = localStorage.getItem("speechEnabled");
            if (speech !== null) speechEnabled = speech === "true";
            const skipTitle = localStorage.getItem("skipTitleScreen");
            if (skipTitle !== null) skipTitleScreen = skipTitle === "true";
            const battleTransitions = localStorage.getItem("battleTransitionAnimationsEnabled");
            if (battleTransitions !== null) battleTransitionAnimationsEnabled = battleTransitions === "true";
            const autoDiceroll = localStorage.getItem("autoDicerollEnabled");
            if (autoDiceroll !== null) autoDicerollEnabled = autoDiceroll === "true";
            const preloader = localStorage.getItem("preloaderEnabled");
            if (preloader !== null) preloaderEnabled = preloader === "true";
        }

        function saveSettings() {
            // Music settings
            localStorage.setItem("musicEnabled", music.isEnabled());
            localStorage.setItem(
                "disabledTracks",
                JSON.stringify(music.getDisabledTracks())
            );

            localStorage.setItem("eatRatAnimationEnabled", eatRatAnimationEnabled);
            localStorage.setItem("sfxEnabled", sfxEnabled);
            localStorage.setItem("speechEnabled", speechEnabled);
            localStorage.setItem("skipTitleScreen", skipTitleScreen);
            localStorage.setItem("battleTransitionAnimationsEnabled", battleTransitionAnimationsEnabled);
            localStorage.setItem("autoDicerollEnabled", autoDicerollEnabled);
            localStorage.setItem("preloaderEnabled", preloaderEnabled);
        }

        loadSettings();

        function placeWelcomeBanner() {
            if (MAP.getCell(player.x, player.y - 1)?.type === 'floor') {
                // North of player
                MAP.setCell(player.x, player.y - 1, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('N');
            } else if (MAP.getCell(player.x, player.y + 1)?.type === 'floor') {
                // South of player
                MAP.setCell(player.x, player.y + 1, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('S');
            } else if (MAP.getCell(player.x - 1, player.y)?.type === 'floor') {
                // West of player
                MAP.setCell(player.x - 1, player.y, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('W');
            } else if (MAP.getCell(player.x + 1, player.y)?.type === 'floor') {
                // East of player
                MAP.setCell(player.x + 1, player.y, 'tardspireBanner');
                player.dir = DIRECTIONS.indexOf('E');
            }

            // If there's a wall behind the player, turn it into a glory wall
            const gx = player.x - DX[player.dir];
            const gy = player.y - DY[player.dir];

            if (MAP.getCell(gx, gy)?.type === 'wall') {
                MAP.setCell(gx, gy, 'gloryWall');
            }
        }

        function placeNoboWall() {
            const points = shuffle(MAP.getMapDissolvePoints()).slice(0, 1)?.[0];
            if (points) {
                MAP.setCell(points.x, points.y, "noboWall");
            }
        }

        function spawnTreasureChests() {
            const chestCount = numberBetween(1, 4);

            shuffle(MAP.getEmptyCellCoordinates())
                .slice(0, chestCount)
                .forEach((c) => {
                    // 20% chance for mimic
                    const isMimic = Math.random() < 0.2;
                    MAP.setCell(c.x, c.y, isMimic ? 'mimic' : 'treasureChest');
                });
        }

        function spawnHealingTiles() {
            const healingTileCount = numberBetween(1, 6);

            shuffle(MAP.getEmptyCellCoordinates())
                .slice(0, healingTileCount)
                .forEach((c) => MAP.setCell(c.x, c.y, "healingTile"));
        }

        function spawnCrackedFloors() {
            const crackedFloorCount = numberBetween(1, 4);

            shuffle(MAP.getEmptyCellCoordinates())
                .slice(0, crackedFloorCount)
                .forEach((c) => MAP.setCell(c.x, c.y, "crackedFloorSlight"));
        }

        function getRandomItem() {
            const items = InventoryObjectDefinitions.items;
            return randomEntry(
                Object
                    .keys(items)
                    .filter(itemId => items[itemId].merchantStockChance > 0)
            );
        }

        function getRandomChestItem() {
            const items = InventoryObjectDefinitions.items;
            const chestEligibleItems = Object.keys(items)
                .filter(itemId => items[itemId].chestDrop);

            return chestEligibleItems.length > 0 ? randomEntry(chestEligibleItems) : null;
        }

        function updateSeenTiles() {
            player.inventory.hasEquippedRing('ringOfSightliness')
                ? MAP.revealFieldOfView(player.x, player.y, 2)
                : MAP.revealSpot(player.x, player.y, 1);
        }

        function updateBattleLog(entry) {
            const $battleLog = document.getElementById("battleLog");
            const line = document.createElement('div');
            line.innerHTML = entry;
            $battleLog.prepend(line);

            // Clear special animations after 2 lines
            // Special animations currently include "waveText" and "gay"
            const $waveTextElements = document.getElementById("battleLog")
                .children?.[2]?.querySelectorAll(".waveText, .gay") || [];

            for (let i=0; i<$waveTextElements.length; i++) {
                const classList = $waveTextElements[i].classList;
                classList.remove("waveText");
                if (classList.contains("gay")) {
                    classList.remove("gay");
                    classList.add("enemy");
                }
            }
        }

        // Returns the input message as a DOM element that will create wavy text
        function waveText(message, className = "") {
            const $message = document.createElement("span");
            $message.classList.add("waveText");
            if (className) {
                $message.classList.add(className);
            }

            for (let i=0; i<message.length; i++) {
                const $character = document.createElement("span");
                $character.style.setProperty("--i", i);
                $character.textContent = message[i];
                $message.appendChild($character);
            }

            return $message;
        }

        function playSFX(name, volume = 1.0) {
            if (!sfxEnabled || volume < 0) {
                return;
            }

            if (!sfx[name]) {
                console.error("SFX not found", { name });
                return;
            }

            sfx[name].currentTime = 0;
            sfx[name].volume = Math.min(1.0, volume);
            sfx[name].play();
        }

        function updateViewportHeader() {
            document.querySelector('#viewport .ui-header').textContent =
                menu.getFullTitle() ?? "Viewport";
        }

        function refreshMinimap() {
            const entities = {};

            // Set the vampire first so it takes precedence over the player
            if (vampire.isActiveOnFloor) {
                entities.vampire = {
                    x: vampire.x,
                    y: vampire.y,
                    displayName: player.hasEncounteredVampire
                        ? `<span class="gay vampire">${vampire.displayName}</span>`
                        : `<em>A Menacing... Fruit Bat?</em>`,
                    isExplored: true,
                    isVisible: true,
                    mapCharacter: " ", // Handled by the #minimap .vampire class
                    type: "vampire",
                };
            }

            if (pigeon.isActiveOnFloor) {
                entities.pigeon = {
                    x: pigeon.x,
                    y: pigeon.y,
                    displayName: pigeon.displayName,
                    isVisible: true,
                    mapCharacter: "P",
                    type: "pigeon",
                };
            }

            if (boulder.isActiveOnFloor) {
                entities.boulder = {
                    x: boulder.x,
                    y: boulder.y,
                    displayName: "Boulding Ball",
                    isVisible: true,
                    mapCharacter: " ", // Handled by the #minimap .boulder class
                    type: "boulder",
                };
            }

            if (gravestoneData[floor]) {
                const g = gravestoneData[floor];
                if (g.explored && (g.x !== player.x || g.y !== player.y)) {
                    entities.gravestone = {
                        x: g.x,
                        y: g.y,
                        displayName: "Gravestone",
                        isVisible: true,
                        mapCharacter: "†",
                        type: "gravestone",
                    };
                }
            }

            Object.values(roamingEnemies.enemies).forEach(enemy => {
                const directionArrows = {
                    'N': '↑',
                    'E': '→', 
                    'S': '↓',
                    'W': '←'
                };
                
                entities[`roamingEnemy_${enemy.id}`] = {
                    x: enemy.x,
                    y: enemy.y,
                    displayName: "Monster",
                    isVisible: true,
                    mapCharacter: directionArrows[enemy.facing] || "☠︎",
                    type: "roamingEnemy",
                };
            });

            entities.player = {
                forceRefresh: true,
                x: player.x,
                y: player.y,
                displayName:
                    `You <span class="player lets-go">ヽ(°٢° )ノ</span>`,
                isExplored: true,
                isVisible: true,
                mapCharacter: player.getDisplayCharacter(),
                type: "player",
            };

            MAP.setEntities(entities);
            updateSeenTiles();
            MAP.refreshMinimap();
        }

        function render() {
            refreshMinimap();
            updateBreathingSFX();
            updateSkyboxPosition();
            checkNPCProximity();
            checkBoulderProximity();

            // @TODO: Keep this out of render()
            // Stat updates should update the appropriate sections on their own
            player.refreshStats();

            let output = sceneRenderer.render(
                player.x,
                player.y,
                DIRECTIONS[player.dir],
                player.getViewDepth(),
                player.getMaxBrightness()
            );

            if (player.inCombat) {
                output += sceneRenderer.drawEnemyLayer(currentEnemy.id) || '';
            }

            if (player.steppingOnHealingTile) {
                output += sceneRenderer.drawHealingLayer();
                playSFX('healTile');
            }

            if (gameOver) {
                GameControl.disableControls();
                
                const deathPortrait = currentEnemy?.id === "vampire" ? "deathVampire" : "death";
                Portrait.show(deathPortrait);
                
                updateBattleLog(`Good job! <span class="action">You died</span> on <span class="action">floor ${floor}</span>`);
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }

            document.getElementById('game').innerHTML = output;
            player.resetEventFlags();
            setTorchOverlayVisibility();
        }


        function isEmpty(obj) {
            for (let i in obj) {
                return false;
            }
            return true;
        }

        function animBattleTransitionStart(
            callback,
            playBattleStartSFX = false,
            playBattleEndSFX = false,
            musicTrackId = null
        ) {
            refreshMinimap();
            const $battleTransition = document.getElementById('animBattleTransition');

            // Block input during transition
            window._inputBlocked = true;
            GameControl.disableControls();

            // Only called when a battle begins
            if (playBattleStartSFX) {
                playSFX('battleStart');
            }
            // Only called when a battle ends
            if (playBattleEndSFX) {
                playSFX('battleEnd');
            }

            $battleTransition.classList.remove('offscreen');
            $battleTransition.classList.add('active');

            setTimeout(() => {
                // Wait 1 second at the bottom before starting reveal
                setTimeout(() => {
                    $battleTransition.classList.remove('active');
                    $battleTransition.classList.add('reveal');

                    // Start battle music and show enemy when curtain begins to roll up
                    if (playBattleStartSFX && !tromboneIsPlaying) {
                        musicTrackId
                            ? music.play(musicTrackId, "battle")
                            : music.playRandom("battle");
                    }
                    if (typeof callback === 'function') {
                        callback();
                    }

                    // After the reveal animation completes, hide the element and unblock input
                    setTimeout(() => {
                        $battleTransition.classList.remove('reveal');
                        $battleTransition.classList.add('offscreen');
                        GameControl.enableControls();
                        window._inputBlocked = false;
                    }, 300); // Match duration of curtain rolling down (0.3s)
                }, 1000); // Wait 1s at the bottom
            }, 300); // Match duration of curtain rolling up (0.3s)
        }

        function animEatRat(callback) {
            // Skip animation entirely if a menu is open; run callback immediately
            if (typeof menu?.isOpen === 'function' && menu.isOpen()) {
                if (typeof callback === 'function') callback();
                return;
            }

            const container = document.getElementById('viewport');
            if (!container) {
                return;
            }

            GameControl.disableControls();

            let overlay = document.getElementById('animEatRat');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'animEatRat';
                container.appendChild(overlay);
            }
            overlay.innerHTML = '';
            const ratVideo = document.createElement('video');
            ratVideo.disablePictureInPicture = true;
            ratVideo.src = 'assets/fp-anim/rat-chomp.webm';
            ratVideo.autoplay = true;
            ratVideo.playsInline = true;

            const gameLayers = container.querySelectorAll('.layer');
            gameLayers.forEach(layer => {
                layer.classList.remove('lightening', 'darkening', 'dark');
                layer.classList.add('dark');
            });

            let finished = false;
            function cleanup() {
                if (finished) return;
                finished = true;
                // Lighten the scene
                gameLayers.forEach(layer => {
                    layer.classList.remove('dark');
                    layer.classList.add('lightening');
                });
                setTimeout(() => {
                    gameLayers.forEach(layer => {
                        layer.classList.remove('lightening');
                    });
                }, 600);

                overlay.style.display = 'none';
                overlay.innerHTML = '';
                GameControl.enableControls();
                if (typeof callback === 'function') callback();
                ratVideo.remove();
            }

            // Fallback: always cleanup after 3.5 seconds, in case the .webm has some sort of playback error
            let fallbackTimeout = setTimeout(cleanup, 3500);

            ratVideo.addEventListener('ended', () => {
                clearTimeout(fallbackTimeout);
                cleanup();
            });
            ratVideo.addEventListener('error', () => {
                clearTimeout(fallbackTimeout);
                cleanup();
            });

            overlay.appendChild(ratVideo);
            overlay.style.display = 'flex';
        }

        function animPlayerDamaged() {
            const $interface = document.getElementById('interface');
            if ($interface) {
                $interface.classList.add('shake');

                setTimeout(() => $interface.classList.remove('shake'), 168); // VOCAP: match the damage animation duration
            }

            const $flash = document.getElementById('animDamageTaken');
            if ($flash) {
                $flash.classList.add('active');
                setTimeout(() => $flash.classList.remove('active'), 168); // VOCAP: match the damage animation duration
            }
        }

        const origKeydown = document.onkeydown;
        document.addEventListener('keydown', function(e) {
            const $titleScreen = document.getElementById('titleScreen');
            if (
                window._inputBlocked &&
                $titleScreen?.style?.display !== 'none' &&
                (e.key === 'Enter' || e.key === ' ')
            ) {
                return;
            }
            if (window._inputBlocked) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
            if (typeof origKeydown === 'function') origKeydown(e);
        }, true);

        function setTorchOverlayVisibility() {
            // Hide torch in combat, resume after battle
            const $torch = document.getElementById('animTorch');
            player.isHoldingTorch && !player.inCombat
                ? $torch.classList.add('onscreen')
                : $torch.classList.remove('onscreen');
        }

        // Update animTorchStart to always use setTorchOverlayVisibility
        function animTorchStart() {
            player.isHoldingTorch = true;
            setTorchOverlayVisibility();
            playSFX('torch');
            document.getElementById('game').classList.add('torch');
        }

        function animTorchEnd() {
            player.isHoldingTorch = false;
            setTorchOverlayVisibility();
            document.getElementById('game').classList.remove('torch');
        }

        function animTromboneStart() {
            const $trombone = document.getElementById('animTrombone');
            $trombone.classList.add('onscreen');
        }

        function animTromboneEnd() {
            const $trombone = document.getElementById('animTrombone');
            $trombone.classList.remove('onscreen');
        }

        function animBoulderHit() {
            const $boulderHit = document.getElementById('animBoulderHit');
            if (!$boulderHit) {
                console.error('Boulder hit animation element not found');
                return;
            }

            $boulderHit.classList.add('onscreen');

            setTimeout(() => {
                $boulderHit.classList.remove('onscreen');
            }, 3000); // Slide anim back out of viewport after this duration
        }

        function shakeScreen() {
            const $children = document.getElementById('viewport').children;

            // Randomly pick a small vertical offset: -2, -1, 0, 1, or 2px
            const offset = randomEntry([-2, -1, 0, 1, 2]);
            for (let $child of $children) {
                if ($child.classList.contains('ui-header')) continue;
                const childIsVisible =
                    !$child.classList.contains('hidden') &&
                    !$child.classList.contains('offscreen') &&
                    !$child.classList.contains('fixed');

                if (!childIsVisible) {
                    continue;
                }

                $child.style.transition = 'transform 0.08s cubic-bezier(.36,.07,.19,.97)';
                $child.style.transform = `translateY(${offset}px)`;
                setTimeout(() => {
                    $child.style.transform = '';
                }, 80);
            }
        }

        function slideScreen(direction) {
            const $children = document.getElementById('viewport').children;
            const offset = direction === 'left' ? -2 : 2; // Slide effect pixel amount (-x is left, x is right)
            for (let $child of $children) {
                if ($child.classList.contains('ui-header')) continue;
                const childIsVisible =
                    !$child.classList.contains('hidden') &&
                    !$child.classList.contains('offscreen') &&
                    !$child.classList.contains('fixed');

                if (!childIsVisible) {
                    continue;
                }

                $child.style.transition = 'transform 0.12s cubic-bezier(.36,.07,.19,.97)';
                $child.style.transform = `translateX(${offset}px)`;
                setTimeout(() => {
                    $child.style.transform = '';
                }, 120);
            }
        }

        function updateSkyboxPosition() {
            const $viewport = document.getElementById('viewport');
            if (! $viewport) {
                return;
            }

            const sectionWidth = 368;
            const xOffset = -(player.dir * sectionWidth);

            $viewport.style.backgroundPosition = `${xOffset}px 0px`;
        }

        function sleepMs(durationMs) {
            return new Promise((resolve) => {
                setTimeout(resolve, durationMs);
            });
        }

        async function endOfPlayerMove() {
            const startMs = performance.now();

            await npcMove();

            const elapsedMs = performance.now() - startMs;
            const remainingMs = Math.max(0, player.getInputDelayMs() - elapsedMs);

            if (remainingMs > 0) {
                await sleepMs(remainingMs);
            }
        }

        // After the player has moved, the NPCs may need to move too
        async function npcMove() {
            render();

            // VOCAP: unchanged logic, but do not early-return so pigeon can still act
            if (!vampire.isActiveOnFloor) {
                vampire.checkForActivation();
            } else {
                vampire.prepareMovement();

                const stepsThisTurn = vampire.steps.length;
                const stepDurationMs = 120;
                const callables = [];

                for (let i = 0; i < stepsThisTurn; i++) {
                    await sleepMs(stepDurationMs);
                    const result = vampire.move();
                    if (typeof result === "function") {
                        callables.push(result);
                    }
                    render();
                    if (vampire.isDoneMoving()) break;
                }
                for (let i = 0; i < callables.length; i++) {
                    callables[i]();
                }
            }

            // PIGEON HOMING (one step per player move if a message is pending)
            if (pigeon.isActiveOnFloor && pigeon.checkForMessages()) {
                pigeon.prepareMovement();
                const result = pigeon.move();
                render();
                if (typeof result === 'function') {
                    result();
                    render();
                }
            }

            // Roaming Enemy movement
            if (!player.inCombat && !gameOver) {
                roamingEnemies.moveEnemies();
                render();
            }
        }

        async function move(direction) {
            if (player.inCombat || gameOver || player.movementDisabled) {
                return;
            }
            player.movementDisabled = true;

            playSFX('footstep');
            let nx, ny;
            if (direction === 'forward') {
                nx = player.x + DX[player.dir];
                ny = player.y + DY[player.dir];
                shakeScreen();
            } else if (direction === 'strafeLeft') {
                nx = player.x + DX[(player.dir + 3) % 4];
                ny = player.y + DY[(player.dir + 3) % 4];
                slideScreen('left');
            } else if (direction === 'strafeRight') {
                nx = player.x + DX[(player.dir + 1) % 4];
                ny = player.y + DY[(player.dir + 1) % 4];
                slideScreen('right');
            } else {
                nx = player.x - DX[player.dir];
                ny = player.y - DY[player.dir];
                shakeScreen();
            }

            const tile = MAP.getCell(nx, ny);
            if (!tile.isSolid) {
                player.x = nx;
                player.y = ny;
                player.stepsTakenOnCurrentFloor++;

                const enemy = roamingEnemies.getEnemyAt(player.x, player.y);
                if (enemy) {
                    roamingEnemies.encounterEnemy(enemy.id);
                    player.movementDisabled = false;
                    GameControl.update();
                    return;
                }

                // @TODO: Make the map system support onEnter for entities
                //        and move this logic there
                if (boulder.isAt(player.x, player.y)) {
                    boulder.hitPlayer();
                }

                if (vampire.encounteredPlayer()) {
                    vampire.encounter();
                }

                const fireOnEnter =
                    typeof tile.onEnter === "function" &&
                    (typeof tile.isVisible !== "function" || tile.isVisible());

                if (fireOnEnter) {
                    const maybePromise = tile.onEnter(nx, ny);
                    const isAsync =
                        maybePromise &&
                        typeof maybePromise.then === "function";

                    if (isAsync) {
                        await maybePromise;
                    }
                }

                GameControl.update();

                // @TODO: Handle NPC movement after the menu has closed
                const shouldSkipNpc = player.inCombat || menu.isOpen();

                if (!shouldSkipNpc) {
                    await endOfPlayerMove();
                } else {
                    const timeDelayMs = player.getInputDelayMs();
                    await sleepMs(timeDelayMs);
                }
            } else if (typeof tile.onTouch === "function") {
                tile.onTouch();
                // Don't increment steps or handle NPC movement when touching walls
            }

            player.movementDisabled = false;
            GameControl.update();
        }

        function turnLeft() {
            if (player.inCombat || gameOver) {
                return;
            }
            playSFX('turn');
            slideScreen('left');
            player.dir = (player.dir + 3) % 4;
            updateSkyboxPosition();
            GameControl.update();
            render();
        }

        function turnRight() {
            if (player.inCombat || gameOver) {
                return;
            }
            playSFX('turn');
            slideScreen('right');
            player.dir = (player.dir + 1) % 4;
            updateSkyboxPosition();
            GameControl.update();
            render();
        }

        async function wait() {
            if (player.inCombat || gameOver || player.movementDisabled) {
                return;
            }
            player.movementDisabled = true;
            player.stepsTakenOnCurrentFloor++;

            updateBattleLog("You kneel down and rest for but a moment, pondering your thoughts and awaiting a response from the spire...");

            GameControl.update();

            // Process NPC movement during wait
            const shouldSkipNpc = player.inCombat || menu.isOpen();

            if (!shouldSkipNpc) {
                await endOfPlayerMove();
            } else {
                const timeDelayMs = player.getInputDelayMs();
                await sleepMs(timeDelayMs);
            }

            player.movementDisabled = false;
            GameControl.update();
        }

        function updateBreathingSFX() {
            // Pause breathing SFX if in battle or killed
            if (player.inCombat || player.hp <= 0) {
                if (currentBreathing) {
                    sfx[currentBreathing].pause();
                    sfx[currentBreathing].currentTime = 0;
                    currentBreathing = null;
                }
                return;
            }

            const weightLevel = player.getWeightLevel();

            // Stop all breathing sounds if below 50%
            if (weightLevel === "normal") {
                if (currentBreathing) {
                    sfx[currentBreathing].pause();
                    sfx[currentBreathing].currentTime = 0;
                    currentBreathing = null;
                }
                return;
            }

            // 50%-80%: Only breathe1, looped
            if (weightLevel === "warning") {
                if (currentBreathing !== "breathe1") {
                    if (currentBreathing) {
                        sfx[currentBreathing].pause();
                        sfx[currentBreathing].currentTime = 0;
                    }
                    sfx.breathe1.loop = true;
                    sfx.breathe1.currentTime = 0;
                    sfx.breathe1.play();
                    currentBreathing = "breathe1";
                }
                return;
            }

            // 80%+: Only breathe2, looped
            if (weightLevel === "danger") {
                if (currentBreathing !== "breathe2") {
                    if (currentBreathing) {
                        sfx[currentBreathing].pause();
                        sfx[currentBreathing].currentTime = 0;
                    }
                    sfx.breathe2.loop = true;
                    sfx.breathe2.currentTime = 0;
                    sfx.breathe2.play();
                    currentBreathing = "breathe2";
                }
                return;
            }
        }

        function startEncounter(enemyId, enemyOverrides = {}) {
            if (enemyId) {
                const enemy = enemies.find((e) => e.id === enemyId);
                if (! enemy) {
                    console.error(
                        "Cannot start an encounter because the specified " +
                        "enemy was not found",
                        { enemyId }
                    );
                    return;
                }

                currentEnemy = structuredClone({
                    ...enemy,
                    ...enemyOverrides,
                });
            } else {
                // Select wild enemies from the enemy pool
                const randomEnemies = enemies.filter(enemy => enemy.isWild);
                if (randomEnemies.length === 0) {
                    console.error(
                        "Cannot start an encounter because no enemies were " +
                        "found in the enemy pool"
                    );
                    return;
                }

                // Pick a random enemy
                currentEnemy = structuredClone({
                    ...randomEntry(randomEnemies),
                    ...enemyOverrides,
                });
            }

            // Scale enemy stats based on floor
            const floorBoost = Math.floor(floor / 2); // Scale every 2 floors
            if (floorBoost > 0) {
                currentEnemy.hp += floorBoost * 7; // +7 HP per scaling
                currentEnemy.attack = [
                    currentEnemy.attack[0] + (floorBoost * 2), // Adjust attack range based on floor scaling
                    currentEnemy.attack[1] + (floorBoost * 2)  // Adjust attack range based on floor scaling
                ];
                currentEnemy.bitcoins += floorBoost; // Increase Bitcoin drop based on floor scaling
            }

            const combatMessage = [
                enemyId === "vampire" ? "The" : "A",
                enemyId ? "" : "wild",
                `<span class="${currentEnemy?.displayClassName || "enemy"}">` +
                    `${currentEnemy.name}</span>`,
                randomEntry([
                    "appears!",
                    "wants to fight!",
                    "is ready to rumble!",
                    "sniffed up some trouble!",
                    "wants to give you a lesson in pain!",
                    "flexes at you menacingly!",
                    "ominously slides into view!",
                    "crawls out of a nearby gutter!",
                    "approaches rudely!",
                    "just insulted your mom!",
                    "is foaming at the mouth! " +
                        "(But I don't think that's foam...)",
                ])
            ].filter(m => m).join(" ");

            const startCombat = () => {
                player.enterCombat();
                updateBattleLog(combatMessage);
                render();
            };
            
            if (battleTransitionAnimationsEnabled) {
                animBattleTransitionStart(
                    () => startCombat(),
                    true, //battleStart
                    false, // battleEnd
                    enemyOverrides?.musicTrackId
                );
            } else {
                // No animation, start battle immediately
                playSFX('battleStart');
                if (!tromboneIsPlaying) {
                    enemyOverrides?.musicTrackId
                        ? music.play(enemyOverrides?.musicTrackId, "battle")
                        : music.playRandom("battle");
                }

                startCombat();
            }
        }

        let playerAttackCooldown = false;

        function playerAttack() {
            if (
                !player.inCombat ||
                GameControl.awaitingPersuasionText ||
                playerAttackCooldown ||
                window._inputBlocked // Add this check
            ) {
                return;
            }

            // +0.1% critical chance per point of luck
            const critChance = getEffectiveStat('luck') * 0.01;
            const isCriticalHit = Math.random() < critChance;
            const damageMultiplier = isCriticalHit ? 1.2 : 1;

            playerAttackCooldown = true; // VOCAP: Prevent spamming attacks

            playSFX('attack');
            animEnemyDamaged();

            const weaponDamage =
                player.inventory.getEquippedWeapon()?.damage ||
                { base: 1, randomMultiplier: 4 };
            const damagePoints = Math.ceil(
                player.strength + (
                    Math.floor(Math.random() * weaponDamage.randomMultiplier) +
                    weaponDamage.base
                ) * damageMultiplier
            );

            const enemyClassname = currentEnemy?.displayClassName || "enemy";

            if (isCriticalHit) {
                updateBattleLog(
                    `${waveText("CRITICAL HIT!", "LUK").outerHTML} ` +
                    `<span class="friendly">You</span> dealt ` +
                    `<span class="action">${damagePoints} HP</span> ` +
                    `to the <span class="${enemyClassname}">` +
                    `${currentEnemy.name}</span>`
                );
            } else {
                updateBattleLog(
                    `<span class="friendly">You</span> deal ` +
                    `<span class="action">${damagePoints} HP</span> ` +
                    `to the <span class="${enemyClassname}">` +
                    `${currentEnemy.name}</span>`
                );
            }

            currentEnemy.hp -= damagePoints;

            setTimeout(() => {
                // Only reset cooldown if battle is still ongoing
                if (player.inCombat && currentEnemy && currentEnemy.hp > 0) {
                    playerAttackCooldown = false;
                }
                endOfPlayerTurn();
            }, 420); // VOCAP: blaze it lmao
        }

        function endOfPlayerTurn() {
            // Can't end a turn if you're not in combat
            if (!player.inCombat) {
                return;
            }

            if (currentEnemy.hp <= 0) {
                // When enemy dies, block input until battle is fully over
                playerAttackCooldown = true;
                animAsh(currentEnemy.id, () => {
                    if (currentEnemy.isWild && currentEnemy.id !== "vampire") {
                        updateKillCounter();
                    }
                    
                    if (currentEnemy.id === "mimic") {
                        updateBattleLog(`The <span class="enemy">MIMIC</span> has been defeated! You find <span class="BTC">₿ ${currentEnemy.bitcoins}</span> in its remains!`);
                        player.giveBitcoins(currentEnemy.bitcoins);
                    } else {
                        const baseExp = 3;
                        const floorBoost = Math.floor(floor / 2);
                        const exp = baseExp + (floorBoost * 3);
                        const bitcoinsEarned = currentEnemy.bitcoins;
                        const randomMsg = randomEntry([
                            "was beaten to a fucking pulp!",
                            "had their bollocks slammed against the hard " +
                                "concrete wall!",
                            "got their face scraped along the floor!",
                            "died from a nosebleed. Alright then?",
                            "was pulverized before they could activate their " +
                                "anti-retard orbital laser.",
                            "pancaked their diaper and died from " +
                                "embarrassment. <em>Gross.</em>",
                            "left the server.",
                            "picked their nose, and died picking their nose.",
                            "got bored and jumped down a 'bottomless' hole. " +
                                "You heard a scream, and the sound was " +
                                "absolutely not faint."
                        ]);

                        const enemyClassname =
                            currentEnemy?.displayClassName || "enemy";

                        updateBattleLog(
                            `The <span class="${enemyClassname}">` +
                            `${currentEnemy.name}</span> ${randomMsg}`
                        );

                        updateBattleLog(
                            `<span class="friendly">You</span> gained ` +
                            `<span class="EXP">+${exp} EXP</span> and ` +
                            `<span class="BTC">₿ ${bitcoinsEarned}.</span>`
                        );
                        player.giveBitcoins(bitcoinsEarned);
                        player.exp += exp;

                        if (currentEnemy.id === "vampire") {
                            vampire.defeated();
                        }
                    }

                    const willLevelUp =
                        player.exp >= player.getExpRequiredForLevelUp();

                    if (willLevelUp) {
                        playerAttackCooldown = false; // Reset for level up screen
                        player.leaveCombat();
                        setTorchOverlayVisibility();
                        startLevelUpAllocation(() => render());
                    } else {
                        player.leaveCombat();
                        setTorchOverlayVisibility();
                        if (battleTransitionAnimationsEnabled) {
                            playerAttackCooldown = false;
                            animBattleTransitionStart(() => {
                                render();
                            }, false, true);
                        } else {
                            playSFX('battleEnd');
                            playerAttackCooldown = false; // Reset when battle fully ends
                            render();
                        }
                    }
                });
                return; // Prevent running the rest of the function until animation is done
            } else {
                // Enemy is still alive - reset cooldown for continued combat
                playerAttackCooldown = false;
                enemyAttack();
                render();
                setTorchOverlayVisibility();
            }
        }

        function enemyAttack() {
            // Base damage + boost damage, boost damage scaled every 2 floors
            const damage = numberBetween(
                currentEnemy?.attack?.[0] || 1,
                currentEnemy?.attack?.[1] || 5
            ) + Math.floor(floor / 2);

            // Calculate damage based on player's defense
            const defense = getEffectiveStat('defense');
            const totalDamage = Math.max(1, Math.floor(damage - defense / 5));
            const ally = randomEntry(player.party.get());
            const target = ally && Math.random() < 0.5 ? "ally" : "player";

            target === "ally"
                ? ally.hp = Math.max(ally.hp - totalDamage, 0)
                : player.damage(totalDamage);

            const targetLine = target === "ally"
                ? `your <span class="friendly">${ally.name}</span>`
                : `<span class="friendly">you</span>`;

            const enemyClassname = currentEnemy?.displayClassName || "enemy";
            updateBattleLog(
                `The <span class="${enemyClassname}">${currentEnemy.name}` +
                `</span> deals <span class="enemy">${totalDamage} HP</span> ` +
                `to ${targetLine}!`
            );

            if (ally && ally.hp <= 0) {
                const allyFate = randomEntry([
                    "eviscerated",
                    "butt-blasted into oblivion",
                    "given a fatal atomic wedgie",
                    "spanked into the stratosphere",
                    "knocked into next Tuesday",
                    "given a lesson in pain",
                    "told to quit and go home. And it listened",
                ]);

                updateBattleLog(
                    `Your <span class="friendly">${ally.name}</span> ` +
                    `has been <span class="action">${allyFate}</span>...`
                );
            }
        }


        function animEnemyDamaged() {
            const $enemyLayer = document.querySelector('.layer.enemy');
            if ($enemyLayer) {
                $enemyLayer.classList.add('damaged');
                setTimeout(() => $enemyLayer.classList.remove('damaged'), 168); // VOCAP: match the attack animation duration
            }
        }

        function animPlayerDamaged() {
            playSFX('attacked');
            playerAttackCooldown = true;

            const $interface = document.getElementById('interface');
            if ($interface) {
                $interface.classList.add('shake');
                setTimeout(() => $interface.classList.remove('shake'), 168); // VOCAP: match the damage animation duration
            }

            const $flash = document.getElementById('animDamageTaken');
            if ($flash) {
                $flash.classList.add('active');
                setTimeout(() => $flash.classList.remove('active'), 168); // VOCAP: match the damage animation duration
            }

            setTimeout(() => {
                playerAttackCooldown = false;
            }, 168); // Reset after animation
        }


        function animAsh(enemyId, onDone) {
            GameControl.disableControls(); // Block input during animation
            const $enemyLayer = document.querySelector('.layer.enemy');
            if (!$enemyLayer) return;

            const $enemyPre = $enemyLayer.querySelector('pre');
            if (!$enemyPre) return;

            // Get the ASCII art for the enemy
            const indexedArt = window.ENEMY_ART?.[enemyId];
            if (!indexedArt) { console.warn(`animAsh: No art found for enemyId "${enemyId}"`); return; }

            // Format art and apply offsets (just like drawEnemyLayer)
            let art = sceneRenderer.formatArt(indexedArt);

            // Apply horizontal offset if specified
            if (indexedArt.offsetX) {
                art = art
                    .split('\n')
                    .map(line => ' '.repeat(indexedArt.offsetX) + line)
                    .join('\n');
            }

            // Apply vertical offset if specified
            if (indexedArt.offsetY) {
                art = '\n'.repeat(indexedArt.offsetY) + art;
            }

            // Prepare the art as a 2D array
            let artLines = art.split('\n');
            let width = Math.max(...artLines.map(l => l.length));
            let height = artLines.length;

            // Pad lines to equal width
            artLines = artLines.map(l => l.padEnd(width, ' '));

            // Each cell: {char, y}
            let fragments = [];
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let c = artLines[y][x];
                    if (c !== ' ') {
                        fragments.push({ x, y, char: c });
                    }
                }
            }

            // Speed multiplier
            const SPEED_MULTIPLIER = 1.5;

            // Animation loop
            let frame = 0;
            // Reduce required frames proportionally to speed
            let maxFrames = Math.max(1, Math.round((height + 8) / SPEED_MULTIPLIER));
            function draw() {
                // Build empty grid
                let grid = Array.from({ length: height }, () => Array(width).fill(' '));

                // Drop fragments (use float y internally, round for collisions / drawing)
                for (let frag of fragments) {
                    // ensure frag.y is numeric (it starts as integer)
                    if (typeof frag.y !== 'number') frag.y = Number(frag.y);

                    const proposedY = Math.round(frag.y + SPEED_MULTIPLIER);
                    // check if there's a fragment occupying the target integer row below
                    const blocked = proposedY < height && fragments.some(f => f.x === frag.x && Math.round(f.y) === proposedY);

                    if (proposedY < height && !blocked) {
                        frag.y += SPEED_MULTIPLIER;
                        if (frag.y > height - 1) frag.y = height - 1;
                    }

                    // draw at rounded position
                    const drawY = Math.round(frag.y);
                    grid[drawY][frag.x] = frag.char;
                }

                // Draw grid in the original <pre>
                $enemyPre.textContent = grid.map(row => row.join('')).join('\n');

                frame++;
                if (frame < maxFrames) {
                    requestAnimationFrame(draw);
                } else {
                    setTimeout(() => {
                        if (typeof onDone === 'function') onDone();
                        if (battleTransitionAnimationsEnabled === false || isLevelUpAllocation) {
                            GameControl.enableControls();
                        }
                    }, Math.round(500 / SPEED_MULTIPLIER)); // time spent on final frame
                }
            }

            playSFX('ash');
            draw();
        }

        function playRandomAmbientSfx() {
            // Checks for title screen + menu interactions
            const shouldScheduleAmbientSfx =
                !sfxEnabled ||
                player.inCombat ||
                gameOver ||
                ambientSfxPaused ||
                TITLE_SCREEN.isActive ||
                menu.isOpen();
            if (shouldScheduleAmbientSfx) {
                scheduleNextAmbientSfx();
                return;
            }

            const ambientSounds = Object.keys(sfxAmb);
            const randomSound = randomEntry(ambientSounds);

            if (randomSound && sfxAmb[randomSound]) {
                const ambientVolume = 0.6; // Ambient audio volume
                sfxAmb[randomSound].currentTime = 0;
                sfxAmb[randomSound].volume = ambientVolume;
                sfxAmb[randomSound].play().catch(() => {
                });
            }

            scheduleNextAmbientSfx();
        }

        function scheduleNextAmbientSfx() {
            if (ambientSfxTimeout) {
                clearTimeout(ambientSfxTimeout);
            }
            if (ambientSfxPaused || TITLE_SCREEN.isActive || menu.isOpen()) {
                return;
            }

            let delay;
            if (ambientSfxScheduledTime !== null) {
                delay = ambientSfxScheduledTime;
                ambientSfxScheduledTime = null;
                ambientSfxStartTime = null;
            } else {
                // Play next sfxAmb anytime between these two intervals
                const minDelayMs = 40000;
                const maxDelayMs = 60000;
                delay = numberBetween(minDelayMs, maxDelayMs);
            }

            ambientSfxStartTime = performance.now();
            ambientSfxTimeout = setTimeout(playRandomAmbientSfx, delay);
        }

        function pauseAmbientSfx() {
            if (ambientSfxTimeout && !ambientSfxPaused) {
                if (ambientSfxStartTime !== null) {
                    const elapsed = performance.now() - ambientSfxStartTime;
                    const originalDelay = 40000; // Use minimum delay as fallback
                    ambientSfxScheduledTime = Math.max(1000, originalDelay - elapsed);
                }

                clearTimeout(ambientSfxTimeout);
                ambientSfxTimeout = null;
                ambientSfxPaused = true;
            }
            Object.values(sfxAmb).forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
        }

        function resumeAmbientSfx() {
            if (ambientSfxPaused) {
                ambientSfxPaused = false;
                if (!player.inCombat && !TITLE_SCREEN.isActive && !menu.isOpen()) {
                    scheduleNextAmbientSfx();
                }
            }
        }

        function checkNPCProximity() {
            if (!sfxEnabled || player.inCombat || gameOver || menu.isOpen()) {
                clearAllProximityTimers();
                return;
            }

            const currentNearbyNPCs = new Map();
            const proximityRange = 8; // How many spaces away to trigger NPC audio cue

            // Check Merchant proximity
            if (merchant.isAlive && merchant.isActiveOnFloor) {
                const merchantLocation = merchant.location();
                if (merchantLocation) {
                    const distance = Math.abs(player.x - merchantLocation.x) + Math.abs(player.y - merchantLocation.y);
                    if (distance <= proximityRange) {
                        currentNearbyNPCs.set('merchant', { distance, location: merchantLocation });
                    }
                }
            }

            // Check Erok proximity
            if (erok.isAlive && erok.isActiveOnFloor) {
                const erokLocation = erok.location();
                if (erokLocation) {
                    const distance = Math.abs(player.x - erokLocation.x) + Math.abs(player.y - erokLocation.y);
                    if (distance <= proximityRange) {
                        currentNearbyNPCs.set('erok', { distance, location: erokLocation });
                    }
                }
            }

            currentNearbyNPCs.forEach((npcData, npcName) => {
                const wasNearby = player.lastNearbyNPCs.has(npcName);

                if (!wasNearby) {
                    // First time entering proximity - play immediately and start interval
                    playProximitySound(npcName, npcData.distance);
                    startProximityInterval(npcName);
                } else {
                    const existingTimer = npcProximityTimers.get(npcName);
                    if (existingTimer) {
                        existingTimer.distance = npcData.distance;
                    }
                }
            });

            player.lastNearbyNPCs.forEach(npcName => {
                if (!currentNearbyNPCs.has(npcName)) {
                    clearProximityTimer(npcName);
                }
            });

            player.lastNearbyNPCs = new Set(currentNearbyNPCs.keys());
        }

        function playProximitySound(npcName, distance) {
            const soundName = `${npcName}Near`;
            if (sfx[soundName]) {
                const maxRange = 8; // Max amount of steps away to near NPC sound
                const maxVolume = 1; // Max volume when closest to NPC
                const minVolume = 0.1; // Min volume when farthest away from NPC
                const volume = maxVolume - ((distance - 1) / (maxRange - 1)) * (maxVolume - minVolume);
                const clampedVolume = Math.max(minVolume, Math.min(maxVolume, volume));

                sfx[soundName].currentTime = 0;
                sfx[soundName].volume = clampedVolume;
                sfx[soundName].play().catch(() => {
                });
            }
        }

        function startProximityInterval(npcName) {
            clearProximityTimer(npcName);
            const timerData = {
                distance: 0,
                intervalId: null
            };

            timerData.intervalId = setInterval(() => {
                if (player.lastNearbyNPCs.has(npcName) &&
                    sfxEnabled &&
                    !player.inCombat &&
                    !gameOver &&
                    !menu.isOpen()) {
                    playProximitySound(npcName, timerData.distance);
                } else {
                    clearProximityTimer(npcName);
                }
            }, numberBetween(10000, 20000)); // Time intervals between playing the NPC sound in seconds

            npcProximityTimers.set(npcName, timerData);
        }

        function clearProximityTimer(npcName) {
            const timerData = npcProximityTimers.get(npcName);
            if (timerData && timerData.intervalId) {
                clearInterval(timerData.intervalId);
            }
            npcProximityTimers.delete(npcName);
        }

        function clearAllProximityTimers() {
            npcProximityTimers.forEach((timerData, npcName) => {
                if (timerData.intervalId) {
                    clearInterval(timerData.intervalId);
                }
            });
            npcProximityTimers.clear();
            player.lastNearbyNPCs.clear();
        }

        function checkBoulderProximity() {
            if (!sfxEnabled || player.inCombat || gameOver || menu.isOpen()) {
                clearBoulderProximity();
                return;
            }

            if (!boulder.isActiveOnFloor) {
                clearBoulderProximity();
                return;
            }

            const boulderLocation = boulder.location();
            if (!boulderLocation) {
                clearBoulderProximity();
                return;
            }

            const distance = Math.abs(player.x - boulderLocation.x) + Math.abs(player.y - boulderLocation.y);
            const boulderProximityRange = 8; // Boulder proximity range

            if (distance <= boulderProximityRange) {
                if (!boulderProximityAudio) {
                    startBoulderProximityAudio(distance);
                } else {
                    updateBoulderProximityVolume(distance);
                }
                lastBoulderDistance = distance;
            } else {
                clearBoulderProximity();
            }
        }

        function startBoulderProximityAudio(distance) {
            if (!sfx.boulderNear) return;

            boulderProximityAudio = sfx.boulderNear;
            boulderProximityAudio.loop = true;
            boulderProximityAudio.currentTime = 0;
            updateBoulderProximityVolume(distance);

            boulderProximityAudio.play().catch(() => {
            });

            boulderProximityTimer = setInterval(() => {
                if (!boulder.isActiveOnFloor || player.inCombat || gameOver || menu.isOpen()) {
                    clearBoulderProximity();
                    return;
                }

                const boulderLocation = boulder.location();
                if (boulderLocation) {
                    const currentDistance = Math.abs(player.x - boulderLocation.x) + Math.abs(player.y - boulderLocation.y);
                    if (currentDistance <= 5) {
                        updateBoulderProximityVolume(currentDistance);
                    } else {
                        clearBoulderProximity();
                    }
                } else {
                    clearBoulderProximity();
                }
            }, 500);
        }

        function updateBoulderProximityVolume(distance) {
            if (!boulderProximityAudio) return;

            const maxRange = 8; // Boulder proximity range
            const maxVolume = 1; // Max volume when closest
            const minVolume = 0.1; // Min volume when furthest away

            const volume = maxVolume - ((distance - 1) / (maxRange - 1)) * (maxVolume - minVolume);
            const clampedVolume = Math.max(minVolume, Math.min(maxVolume, volume));

            boulderProximityAudio.volume = clampedVolume;
        }

        function clearBoulderProximity() {
            if (boulderProximityTimer) {
                clearInterval(boulderProximityTimer);
                boulderProximityTimer = null;
            }

            if (boulderProximityAudio) {
                boulderProximityAudio.pause();
                boulderProximityAudio.currentTime = 0;
                boulderProximityAudio.loop = false;
                boulderProximityAudio = null;
            }

            lastBoulderDistance = null;
        }

        async function tryRun() {
            if (!player.inCombat || GameControl.awaitingPersuasionText) {
                return;
            }

            if (currentEnemy?.id === "vampire") {
                vampire.say(randomEntry([
                    "I'm not letting my tasty snack get away that easily!",
                    "You're not going anywhere, big boy!",
                    "I won't take no for an answer!",
                    "Let's not turn this date into a consent accident!",
                ]));
                return;
            }

            playSFX('run');
            if (Math.random() < 0.3) {
                player.say("Gee willikers, I'm outta here!");
                player.leaveCombat();
                await npcMove();
            } else {
                updateBattleLog("Couldn't escape!");
                enemyAttack();
            }
            render();
        }

        function tryPersuade(e) {
            e?.preventDefault();
            playSFX('persuade');
            GameControl.openPersuasionInputBox();
        }

        document.getElementById("persuadeInput").addEventListener("keydown", e => {
            if (e.key === "Escape") {
                GameControl.closePersuasionInputBox();
                render();
                return;
            }

            if (e.key === "Enter") {
                submitPersuasion();
            }
        });

        function submitPersuasion() {
            const $input = document.getElementById("persuadeInput");
            const message = $input.value;

            // ======== CHEAT COMMANDS ========
            if (message.startsWith("/")) {
                handleCheatCommand(message);
                $input.value = "";
                GameControl.closePersuasionInputBox();
                render();
                return;
            }

            // === Carrier Pigeon message mode ===
            if (typeof PigeonMessaging !== "undefined" && PigeonMessaging.isActive && PigeonMessaging.isActive()) {
                $input.value = "";
                GameControl.closePersuasionInputBox();
                // Only send if not empty
                if (message.trim().length === 0) {
                    updateBattleLog('<span class="enemy">Empty pigeon message aborted.</span>');
                    return;
                }
                // Send via pigeon.js
                PigeonMessaging.send(message.trim());
                return;
            }

            $input.value = "";
            GameControl.closePersuasionInputBox();

            // ======== Persuasion During Combat ========
            if (player.inCombat) {
                persuasionAttempts++;

                if (currentEnemy?.id === "vampire") {
                    if (Math.random() < 0.5) {
                        updateBattleLog(randomEntry([
                            `<span class="action">Your words pass right ` +
                                `through his ears.</span> His reptilian eyes ` +
                                `are completely fixated on your groin.`,
                            `<span class="action">Your speech is totally ` +
                                `ineffective.</span> He starts to hungrily ` +
                                `lick his fangs in <em>eager</em> ` +
                                `anticipation.`,
                            `<span class="action">Your feeble persuasion ` +
                                `attempt fails.</span> The vampire is ` +
                                `entranced, having spotted his next meal. ` +
                                `<span class="enemy">Tardwurst is on the ` +
                                `menu!</span>`,
                            `<span class="action">The vampire ignores your ` +
                                `words.</span> His mouth is ` +
                                `<em>salivating</em> for <span class="enemy">` +
                                `your blood sausage!</span> (Yes, this is a ` +
                                `euphemism!)`,
                        ]));
                    } else {
                        vampire.say(randomEntry([
                            "My fangs will join your wang!",
                            "Blood is life, but cummy is yummy!",
                            "Unzip, unzip! I will sip your tippy tip!",
                            "I vant to zuck your cock!",
                        ]));
                    }
                    enemyAttack();
                    render();
                    return;
                }

                // Check limit FIRST
                if (persuasionAttempts > maxPersuasionAttempts) {
                    updateBattleLog(
                        `Your words are no longer being heard... ` +
                        `<span class="action">you have run out of persuasion ` +
                        `attempts.</span>`
                    );
                    enemyAttack();
                    render();
                    return;
                }

                const playerMessage = message.trim() || randomEntry([
                    "You're about as ugly as homemade soup!",
                    "Don't you DARE take the name of Texas in vain",
                    "You may be stupid, but you're also dumb",
                    "Join me, and together we can rule the TardSpire as " +
                        "father and son!",
                    "Cake or death?!",
                    "Your mother was a hamster and your father smelt of " +
                        "elderberries!",
                ]);

                player.say(playerMessage);

                // Chances cap out at 100%. So a stat of 12 would be a 12%
                // chance of success, etc
                const totalChance = getEffectiveStat('persuasion') / 100;

                if (Math.random() < totalChance) {
                    if (!player.party.isFull()) {
                        const enemy = enemies.find((e) => e.id === currentEnemy.id);
                        if (!enemy) {
                            console.error('Could not find enemy by id', {
                                currentEnemy,
                            });
                            return;
                        }

                        const enemyHp = Math.max(Math.floor(currentEnemy.hp / 2), 1);
                        // Scale every two floors
                        // @see startEncounter() for the origin of this logic
                        const floorBoost = Math.floor(floor / 2);
                        const maxEnemyHp = Math.max(Math.floor((enemy.hp + (floorBoost * 7)) / 2), 1);

                        player.party.add(
                            currentEnemy.id,
                            currentEnemy.name,
                            enemyHp,
                            maxEnemyHp
                        );
                        updateBattleLog(
                            `The <span class="friendly">${currentEnemy.name}` +
                            `</span> is now following your trail of sweat.`
                        );
                    } else {
                        updateBattleLog(
                            `The <span class="enemy">${currentEnemy.name}` +
                            `</span> was <span class="friendly">spared` +
                            `</span> and went back home.`
                        );
                    }
                    player.leaveCombat();
                } else {
                    updateBattleLog(
                        `The <span class="enemy">${currentEnemy.name}</span> ` +
                        `really, quite genuinely, does not care.`
                    );

                    // If this was the last attempt, show a message
                    if (persuasionAttempts >= maxPersuasionAttempts) {
                        updateBattleLog(
                            `<span class="action">You've used your last ` +
                            `persuasion attempt for this fight.</span>`
                        );
                    }
                    enemyAttack();
                }
                render();
                return;
            }

            // ======== Speaking Outside Combat ========
            if (speakingOutsideCombat) {
                player.say(message);
                speakingOutsideCombat = false;

                if (player.party.get().length > 0 && message.trim()) {
                    player.party.talk();
                }

                render();
            }
        }

        function handleCheatCommand(cmd) {
            if (cmd === "/spawn m") {
                let found = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        merchant.isAlive = true;
                        merchant.isActiveOnFloor = true;
                        MAP.setCell(nx, ny, 'merchant');
                        merchant.set();
                        updateBattleLog('<span class="merchant">CHEAT: Merchant spawned</span>');
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    updateBattleLog('<span class="merchant">CHEAT: Merchant not spawned. Try a different spot.</span>');
                }
                return;
            }
            if (cmd === "/spawn g") {
                let found = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        gambler.isAlive = true;
                        gambler.isActiveOnFloor = true;
                        player.bitcoins = Math.max(player.bitcoins, gambler.playPrice);
                        player.refreshBitcoins();
                        MAP.setCell(nx, ny, 'gambler');
                        updateBattleLog('<span class="gambler">CHEAT: Gambler spawned</span>');
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    updateBattleLog('<span class="gambler">CHEAT: Gambler not spawned. Try a different spot.</span>');
                }
                return;
            }
            if (cmd === "/spawn d") {
                let found = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        erok.isAlive = true;
                        erok.isActiveOnFloor = true;
                        MAP.setCell(nx, ny, 'erok');
                        updateBattleLog('<span class="erok">CHEAT: Erok spawned</span>');
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    updateBattleLog('<span class="erok">CHEAT: Erok not spawned. Try a different spot.</span>');
                }
                return;
            }
            if (cmd.startsWith("/givebtc ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.giveBitcoins(amount);
                    updateBattleLog(`<span class="BTC">CHEAT: Added ₿ ${amount} to your worn out Kamen Rider wallet</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid BTC amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/giveexp ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.exp += amount;
                    updateBattleLog(`<span class="EXP">CHEAT: Added ${amount} EXP to your character</span>`);
                    player.refreshStats();
                } else {
                    updateBattleLog(`<span class="action">Invalid EXP amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/k")) {
                // Instead of calling gameOver directly due to side effects (?)
                player.hp = 0;
                player.checkForDeath();
                updateBattleLog(`<span class="action">CHEAT: You have been killed.</span>`);
                return;
            }
            if (cmd.startsWith("/sethp ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.maxHp = amount;
                    player.hp = amount;
                    updateBattleLog(`<span class="HP">CHEAT: Max HP set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid HP amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setdef ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.defense = amount;
                    updateBattleLog(`<span class="DEF">CHEAT: Defense set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid DEF amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setstr ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.strength = amount;
                    updateBattleLog(`<span class="STR">CHEAT: Strength set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid STR amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setprs ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.persuasion = amount;
                    updateBattleLog(`<span class="PRS">CHEAT: Persuasion set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid PRS amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setend ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.endurance = amount;
                    updateBattleLog(`<span class="END">CHEAT: Endurance set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid END amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setspd ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.speed = amount;
                    updateBattleLog(`<span class="SPD">CHEAT: Speed set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid SPD amount.</span>`);
                }
                return;
            }
            if (cmd.startsWith("/setluk ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount >= 0) {
                    player.luck = amount;
                    updateBattleLog(`<span class="LUK">CHEAT: Luck set to ${amount}</span>`);
                } else {
                    updateBattleLog(`<span class="action">Invalid LUK amount.</span>`);
                }
                return;
            }

            if (cmd.startsWith("/setlv ")) {
                const amount = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(amount) && amount > 0) {
                    player.level = amount;
                    player.exp = 0;
                    updateBattleLog(`<span class="LV">CHEAT: Level set to ${amount}. Cheater.</span>`);
                    render();
                } else {
                    updateBattleLog(`<span class="action">Invalid level number.</span>`);
                }
                return;
            }

            if (cmd === "/debug") {
                const yeahBoiii = 69999;
                player.maxHp = yeahBoiii;
                player.hp = yeahBoiii;
                player.defense = yeahBoiii;
                player.strength = yeahBoiii;
                player.persuasion = yeahBoiii;
                player.endurance = yeahBoiii;
                player.speed = yeahBoiii;
                player.luck = yeahBoiii;
                player.bitcoins = yeahBoiii;
                player.refreshBitcoins();

                let merchantSpawned = false;
                for (let i = 0; i < 4; i++) {
                    const nx = player.x + DX[i];
                    const ny = player.y + DY[i];
                    if (MAP.getCell(nx, ny)?.type === 'floor') {
                        merchant.isAlive = true;
                        merchant.isActiveOnFloor = true;
                        merchant.setWares(true);
                        MAP.setCell(nx, ny, 'merchant');
                        merchantSpawned = true;
                        break;
                    }
                }

                let gamblerSpawned = false;
                if (merchantSpawned) {
                    for (let i = 0; i < 4; i++) {
                        const merchantPosition = merchant.location();
                        if (merchantPosition === null) {
                            break;
                        }
                        const gx = merchantPosition.x + DX[i];
                        const gy = merchantPosition.y + DY[i];
                        const notPlayer = gx !== player.x || gy !== player.y;
                        const notMerchant = gx !== merchantPosition.x || gy !== merchantPosition.y;
                        if (
                            MAP.getCell(gx, gy)?.type === 'floor' &&
                            notPlayer &&
                            notMerchant
                        ) {
                            gambler.isAlive = true;
                            gambler.isActiveOnFloor = true;
                            MAP.setCell(gx, gy, 'gambler');
                            gamblerSpawned = true;
                            break;
                        }
                    }
                }
                updateBattleLog(
                    `<span class="action">CHEAT: Debug mode activated! All stats and BTC set to ${yeahBoiii}. Merchant${merchantSpawned ? "" : " (FAILED)"} and Gambler${gamblerSpawned ? "" : " (FAILED)"} spawned next to you.</span>`
                );
                render();
                return;
            }


            if (cmd.startsWith("/setfloor ")) {
                const floorNumber = parseInt(cmd.split(" ")[1], 10);
                if (!isNaN(floorNumber) && floorNumber > 0) {
                    floor = floorNumber;
                    updateBattleLog(`<span class="action">CHEAT: Moved to Floor ${floorNumber}</span>`);
                    generateMap();
                    render();
                } else {
                    updateBattleLog(`<span class="action">Try an actual floor number, retard.</span>`);
                }
                return;
            }

            if (cmd === "/spawn v") {
                vampire.isActiveOnFloor = true;
                vampire.resetToEntrance();
                vampire.showFocalPoint({}, () => {
                    if (vampire.isAt(player.x, player.y)) {
                        startEncounter(
                            "vampire",
                            vampire.getEncounterOverrides()
                        );
                    }
                });
                updateBattleLog('<span class="gay vampire">CHEAT: Vampire spawned at entrance</span>');
                return;
            }

            updateBattleLog(`<span class="action">RETARD ALERT! INVALID CHEAT: ${cmd}</span>`);
        }

        function gamble() {
            player.takeBitcoins(gambler.playPrice);
            updateBattleLog(`You hand the gambler <span class="BTC">₿ ${gambler.playPrice}</span>. Let's hope it was worth it`);

            document.getElementById('menu').classList.add('hidden');

            // LUK affects chance to roll a 12
            // LUK now works like PRS: 0-100% chance to win (roll a 12)
            // example; 32 LUK = 32% chance at success
            const winChance = getEffectiveStat('luck') / 100;

            let roll12 = Math.random() < winChance;

            let dice;
            if (roll12) {
                dice = [6, 6];
            } else {
                // Roll normally, but avoid double sixes
                do {
                    dice = [
                        numberBetween(1, 6),
                        numberBetween(1, 6),
                    ];
                } while (dice[0] === 6 && dice[1] === 6);
            }

            gambleAnimation(dice, () => {
                gambleOutcome(dice);
            });
            playSFX('gamble');
        }

        function gambleOutcome(dice) {
            const sum = dice[0] + dice[1];
            const win = sum === 12;
            const sumClass = win ? 'friendly' : 'enemy';

            updateBattleLog(
                'You rolled a ' +
                `<span class="gambler">${dice[0]}</span> and a ` +
                `<span class="gambler">${dice[1]}</span> ` +
                `for a sum of <span class="${sumClass}">${sum}</span>`
            );

            if (win) {
                const stat = randomEntry(['hp', 'defense', 'persuasion']);

                switch (stat) {
                    case 'hp': {
                        const healthBoost = 5 + (Math.floor((Math.random() * 2)) * 5);
                        player.maxHp += healthBoost;
                        player.heal(healthBoost);
                        updateBattleLog(
                            `<span class="LV">You scored a health boost! ` +
                            `+${healthBoost} HP!</span>`
                        );
                        break;
                    }
                    case 'defense': {
                        const defenseBoost = 1 + Math.floor((Math.random() * 2));
                        player.defense += defenseBoost;
                        updateBattleLog(
                            `<span class="LV">You won a defense boost! ` +
                            `+${defenseBoost} DEF!</span>`
                        );
                        break;
                    }
                    case 'persuasion': {
                        const persuasionBoost = 1 + Math.floor((Math.random() * 2));
                        player.persuasion += persuasionBoost;
                        updateBattleLog(
                            `<span class="LV">You won a persuasion boost! ` +
                            `+${persuasionBoost} PRS!</span> (Actually the ` +
                            `gambler just handed you a beat-up copy of ` +
                            `"How to Win Friends and Influence People", ` +
                            `but whatever)`
                        );
                        break;
                    }
                }
                gambler.say('Ah, whatever. Fucker. You win this time...');
            } else {
                gambler.say('Tough luck, kid! Heh heh heh!');
            }

            gambler.isActiveOnFloor = false;
            updateBattleLog('The gambler escapes into the shadows');
            render();

            menu.close();
        }

        /**
         * This animates the hand throwing dice when gambling
         *
         * The animation works by calling the gambleFrames in sequence. The
         * number of defined frames is actually more than the number of the
         * available frames in the animation. This is because the final frame is
         * held and displays random digits to emphasize the roll
         */
        function gambleAnimation(dice, callback, frame) {
            const maxFrames = 24;
            const frameNumber = frame || 0;
            const displayFrame = Math.min(frameNumber, gambleFrames.length - 1);
            const isFinalFrame = frameNumber >= maxFrames - 1;

            if (frameNumber === 0) {
                animationActive = true;
                document.getElementById('animation').classList.remove('hidden');
                document.getElementById('menu').classList.add('hidden');
            }

            // Set random dice digits before displaying the actual outcome
            const d = isFinalFrame ? dice : [
                numberBetween(1, 6),
                numberBetween(1, 6),
            ];

            if (frameNumber < maxFrames) {
                // Add some padding to center the animation
                let frameText = gambleFrames[displayFrame].replace(/^/gm, '       ');
                if (frameNumber >= gambleFrames.length - 4) {
                    // Draw digits on the bones
                    frameText = frameText.replace(
                        /(^[ |]+\n^ +\|   ) {5}( +\| +\|   ) {5}(.+\n^ +\|   ) {5}( +\| +\|   ) {5}(.+\n^ +\|   ) {5}( +\| +\|   ) {5}/m,
                        `$1${dieDigit[d[0] - 1][0]}$2${dieDigit[d[1] - 1][0]}$3${dieDigit[d[0] - 1][1]}$4${dieDigit[d[1] - 1][1]}$5${dieDigit[d[0] - 1][2]}$6${dieDigit[d[1] - 1][2]}`,
                    );
                }

                document.getElementById("animation").textContent = frameText;
                setTimeout(() => gambleAnimation(dice, callback, frameNumber + 1), !isFinalFrame ? 50 : 3000);
            } else {
                document.getElementById('animation').classList.add('hidden');
                document.getElementById('menu').classList.remove('hidden');
                animationActive = false;
                typeof callback === 'function' && callback();
            }
        }

        function drawCircle(screen, centerX, centerY, radius, character) {
            const height = sceneRenderer.displayHeight;
            const width = Math.round(sceneRenderer.displayWidth / 2);

            let x = radius;
            let y = 0;
            let decisionOver2 = 1 - x;   // Decision criterion divided by 2

            while (y <= x) {
                const points = [
                    [centerY + y, centerX + x],
                    [centerY + x, centerX + y],
                    [centerY + x, centerX - y],
                    [centerY + y, centerX - x],
                    [centerY - y, centerX - x],
                    [centerY - x, centerX - y],
                    [centerY - x, centerX + y],
                    [centerY - y, centerX + x]
                ];

                // Set pixels if they are within bounds
                for (const [py, px] of points) {
                    if (py >= 0 && py < height && px >= 0 && px < width) {
                        screen[py][px] = character;
                    }
                }

                y++;
                if (decisionOver2 <= 0) {
                    decisionOver2 += 2 * y + 1;
                } else {
                    x--;
                    decisionOver2 += 2 * (y - x) + 1;
                }
            }
        }

        function explosionAnimation(callback, frame) {
            const maxFrames = 32;
            const frameNumber = frame || 0;
            const isCallbackFrame = frameNumber === 4;
            const $animation = document.getElementById('animation');
            $animation.classList.add('explosion');

            if (frameNumber === 0) {
                animationActive = true;
                $animation.classList.remove('hidden');
            }

            let screen = Array.from(
                { length: sceneRenderer.displayHeight },
                () => Array(Math.round(sceneRenderer.displayWidth / 2)).fill(' ')
            );

            const centerX = Math.round(sceneRenderer.displayWidth / 4);
            const centerY = Math.round(sceneRenderer.displayHeight / 2);
            const totalCircles = 8;
            const characters = ['░', '▒', '▓'];

            for (let i=0; i<totalCircles; i++) {
                const radius = frame - i;
                if (radius > 0 && radius <= 18) {
                    drawCircle(screen, centerX, centerY, radius, characters[i % characters.length]);
                }
            }

            let text = '';

            for (let y=0; y<screen.length; y++) {
                for (let x=0; x<screen[y].length; x++) {
                    text += screen[y][x] + screen[y][x];
                }

                if (y < screen.length) {
                    text += "\n";
                }
            }

            $animation.innerText = text;

            const displayFrame = Math.min(frameNumber, gambleFrames.length - 1);

            if (isCallbackFrame && typeof callback === 'function') {
                callback();
            }

            if (frameNumber < maxFrames) {
                setTimeout(() => explosionAnimation(callback, frameNumber + 1), 10);
            } else {
                $animation.classList.add('hidden');
                $animation.classList.remove('explosion');
                animationActive = false;
            }
        }

        async function openChest() {
            const cellType = MAP.getCell(player.x, player.y)?.type;

            if (cellType === 'mimic') {
                // Mimic detected, start a battle
                playSFX('scream');

                // Remove the mimic from the map
                MAP.setCell(player.x, player.y);

                // Spawn mimic and apply scaling
                const baseMimic = enemies.find(e => e.id === "mimic");
                currentEnemy = scaleMimicStats(baseMimic);

                updateBattleLog(
                    `Holy shit! It was actually a ` +
                    `<span class="enemy">MIMIC</span>!!!`
                );
                player.enterCombat();
                music.playRandom("battle");
            } else if (cellType === 'treasureChest') {
                const CHEST_LOOT_CHANCES = {
                    btc: 50,    // % chance for BTC
                    items: 25,  // % chance for items
                    rings: 25   // % chance for rings
                };

                // Roll for loot type
                const roll = Math.random() * 100;
                let chestContents;

                if (roll < CHEST_LOOT_CHANCES.btc) {
                    // BTC reward
                    chestContents = {
                        type: 'BTC',
                        amount: Math.floor(Math.random() * 10) + 3
                    };
                } else if (roll < CHEST_LOOT_CHANCES.btc + CHEST_LOOT_CHANCES.items) {
                    // Item reward
                    const item = getRandomChestItem();
                    if (item) {
                        chestContents = { type: 'item', item: item };
                    } else {
                        // Fallback to BTC if no items are available for chests
                        chestContents = {
                            type: 'BTC',
                            amount: Math.floor(Math.random() * 10) + 3
                        };
                    }
                } else {
                    // Ring reward
                    const rings = InventoryObjectDefinitions.rings;
                    const ownedRings = Object.keys(player.inventory.getRings());
                    const unownedRings = Object.keys(rings).filter(r => !ownedRings.includes(r));
                    const eligibleRings = unownedRings.filter(ringId =>
                        rings[ringId].chestDrop === true
                    );

                    if (eligibleRings.length > 0) {
                        const ringId = randomEntry(eligibleRings);
                        chestContents = { type: 'ring', ring: ringId };
                    } else {
                        // Fallback to BTC if no rings available
                        chestContents = {
                            type: 'BTC',
                            amount: Math.floor(Math.random() * 10) + 3
                        };
                    }
                }

                // Handle the loot (existing code remains the same)
                if (chestContents.type === 'BTC') {
                    let bonus = Math.floor(chestContents.amount * (getEffectiveStat('luck') * 0.02));
                    let total = chestContents.amount + bonus;
                    player.giveBitcoins(total);
                    updateBattleLog(
                        `You found <span class="BTC">₿ ${total}</span> in the chest!`
                    );
                } else if (chestContents.type === 'item') {
                    const key = chestContents.item;
                    player.inventory.addItem(key);
                    const itemName = InventoryObjectDefinitions.items[key].name;
                    updateBattleLog(
                        `You found <span class="friendly">${itemName}</span> ` +
                        `in the chest!`
                    );
                } else if (chestContents.type === 'ring') {
                    const key = chestContents.ring;
                    player.inventory.addRing(key);
                    const ringName = InventoryObjectDefinitions.rings[key].name;
                    updateBattleLog(
                        `You found <span class="friendly">${ringName}</span> ` +
                        `in the chest!`
                    );
                }

                // Remove the chest from the map
                MAP.setCell(player.x, player.y);
                await npcMove();
            }

            render();
        }

        function scaleMimicStats(baseMimic) {
            const floorBoost = Math.floor(floor / 2); // Scale every 2 floors
            const scaledMimic = structuredClone(baseMimic);

            if (floorBoost > 0) {
                scaledMimic.hp += floorBoost * 5; // +5 HP per scaling
                scaledMimic.attack = [
                    scaledMimic.attack[0] + (floorBoost * 3), // Adjust attack range
                    scaledMimic.attack[1] + (floorBoost * 3)
                ];
                scaledMimic.bitcoins += floorBoost * 10; // Increase BTC reward
            }

            return scaledMimic;
        }

        document.addEventListener('keydown', e => {
            const key = e.key.toLowerCase();

            if (gameOver) {
                return;
            }
            if (Modal.isOpen) {
                if (key === 'escape') {
                    playSFX("uiCancel");
                    Modal.close();
                }
                return;
            }
            if (!player.inCombat && key === 't' && !GameControl.awaitingPersuasionText && !menu.isOpen()) {
                speakingOutsideCombat = true;
                tryPersuade(e);
                return;
            }
            if (GameControl.awaitingPersuasionText) {
                return;
            }

            if (menu.isOpen()) {
                if (! animationActive) {
                    menu.handleInput(key);
                }
            } else if (key === 'escape' && !GameControl.awaitingPersuasionText) {
                menu.open('gameSettings');
            } else if (key === 'i') {
                playSFX('inventoryOpen');
                menu.open('inventory');
            } else if (player.inCombat) {
                switch (key) {
                    case 'a':
                        playerAttack();
                        break;
                    case 'r':
                        tryRun();
                        break;
                    case 'p':
                        tryPersuade(e);
                        break;
                }
            } else {
                switch (key) {
                    case 'w':
                    case 'arrowup':
                        e.preventDefault();
                        move('forward');
                        break;
                    case 's':
                    case 'arrowdown':
                        e.preventDefault();
                        move('backward');
                        break;
                    case 'a':
                    case 'arrowleft':
                        e.preventDefault();
                        turnLeft();
                        break;
                    case 'd':
                    case 'arrowright':
                        e.preventDefault();
                        turnRight();
                        break;
                    case 'q':
                        e.preventDefault();
                        move('strafeLeft');
                        break;
                    case 'e':
                        e.preventDefault();
                        move('strafeRight');
                        break;
                    case ' ': // Spacebar
                        e.preventDefault();
                        wait();
                        break;
                    case 't':
                        speakingOutsideCombat = true;
                        tryPersuade(e);
                        break;
                }
            }
        });


        function descend() {
            GameControl.disableControls();
            floor++;
            player.stepsTakenOnCurrentFloor = 0;
            updateBattleLog(`Descending into floor ${floor}...`);
            playSFX("footstepsDescending");
            music.fadeOut(1000, () => {
                render();
                music.playRandom("exploration");
            });

            document.getElementById("game")
                .classList.add("descendingToNextFloor");

            const floorBoost = Math.floor(floor / 2);
            if (floorBoost > lastFloorBoostNotice) {
                updateBattleLog(
                    `<span class="action">As you descend deeper into the ` +
                    `dungeon, you sense greater danger than before.</span>`
                );
                lastFloorBoostNotice = floorBoost;
            }

            if (Math.random() < 0.5) {
                updateBattleLog(randomEntry([
                    "The stale air fills your nostrils.",
                    "You feel like you're being watched.",
                    "A chill creeps down your spine.",
                    "Your torch flickers strangely in the windless corridor.",
                    "A draft carries the scent of mildew, ash, and Lemon " +
                        "Pledge.",
                    "You hear a dog yipping in the distance.",
                    "An empty snail shell lies cracked on the stairs.",
                    "A growl echoes through the hallway.",
                    "A faint smell of urinal cake wafts up from below.",
                    "You hear a toilet flush in the distance.",
                    "There's graffiti on the wall: \"Beware the snail!\"",
                    "You smell something pungent. Possibly ancient evil. " +
                        "<em>Possibly cheese.</em>",
                    "You hear a groan, as if the dungeon itself is aware of " +
                        "your presence.",
                    "Somewhere ahead, something clanks. You sincerely hope " +
                        "it's plumbing.",
                    "You hear a plunger plunging menacingly.",
                ]));
            }

            generateMap();
            animTorchEnd();
            PigeonMessaging.ensurePolling();
            TardAPI.updateProgress();
        }

        document.getElementById("game").addEventListener("animationend", e => {
            const removeClass =
                e.target.classList.contains("descendingToNextFloor") &&
                e.animationName === "descendFromCeiling";

            if (removeClass) {
                e.target.classList.remove("descendingToNextFloor");
                GameControl.enableControls();
            }
        });

        const menu = new Menu();
        menu.setMenuElement(document.getElementById("menu"));
        menu.setDefaultItemsPerPage(15);
        menu.setOnOpen(() => {
            document.getElementById("game").classList.add("hidden");
            InventorySidebar.close();
            GameControl.update();
            updateViewportHeader();
            pauseAmbientSfx();
        });
        menu.setOnPageChange(() => GameControl.update());
        menu.setOnHighlight(() => playSFX("uiOption"));
        menu.setOnSelect(() => {
            playSFX("uiSelect");
            GameControl.update();
            updateViewportHeader();
        });
        menu.setOnCancel(() => {
            playSFX("uiCancel");
            GameControl.update();
            updateViewportHeader();
        });
        menu.setOnClose(() => {
            document.getElementById("game").classList.remove("hidden");
            InventorySidebar.open("main");
            GameControl.update();
            updateViewportHeader();
            render();
            if (!player.inCombat && !TITLE_SCREEN.isActive) {
                resumeAmbientSfx();
            }
        });

        menu.setMenus({
            gameSettings: {
                title: "GAME SETTINGS",
                onOpen: () => {
                    GameSettingsButton.opened();
                    Portrait.show('settings');
                },
                onClose: () => {
                    GameSettingsButton.closed();
                    Portrait.hide();
                },
                getOptions: () => [
                    {
                        id: "_back",
                        displayText: "Return to the game",
                        description: "Continue your quest",
                    },
                    {
                        id: "toggleMusic",
                        displayText: music.isEnabled()
                            ? "Disable music"
                            : "Enable music",
                        description: tromboneIsPlaying
                            ? "Wait for the trom-BONE to stop playing first"
                            : `Turn ${music.isEnabled() ? "off" : "on"} the ` +
                                `in-game music`,
                        className: tromboneIsPlaying ? "muted" : undefined,
                    },
                    {
                        id: "musicSettings",
                        displayText: "Music selection",
                        description: "Choose which music tracks are able to play at random",
                    },
                    {
                        id: "toggleSFX",
                        displayText: sfxEnabled ? "Disable SFX" : "Enable SFX",
                        description: sfxEnabled
                            ? "Disable sound effects"
                            : "Enable sound effects",
                    },
                    {
                        id: "toggleSpeech",
                        displayText: speechEnabled ? "Disable speech" : "Enable speech",
                        description:
                            `${speechEnabled ? 'Disable' : 'Enable'} the ` +
                            `party member and NPC speaking voices`,
                    },
                    {
                        id: "toggleSkipTitleScreen",
                        displayText: skipTitleScreen ? "Disable quickstart" : "Enable quickstart",
                        description: skipTitleScreen
                            ? "Enable the title screen upon starting the game (enables preloader by default)"
                            : "Skip the title screen automatically upon starting the game (disables preloader by default)",
                    },
                    {
                        id: "toggleEatRatAnimation",
                        displayText: eatRatAnimationEnabled
                            ? "Disable level up animation"
                            : "Enable level up animation",
                        description: eatRatAnimationEnabled
                            ? "Disable rat consumption animation on level up"
                            : "Enable rat consumption animation on level up",
                    },
                    {
                        id: "toggleBattleTransitionAnimations",
                        displayText: battleTransitionAnimationsEnabled
                            ? "Disable battle transitions"
                            : "Enable battle transitions",
                        description: battleTransitionAnimationsEnabled
                            ? "Disable the curtain animation when entering/leaving battles"
                            : "Enable the curtain animation when entering/leaving battles",
                    },
                    {
                        id: "toggleAutoDiceroll",
                        displayText: autoDicerollEnabled ? "Disable auto diceroll" : "Enable auto diceroll",
                        description: autoDicerollEnabled ? "Disable automatic random stat allocation" : "Automatically roll stats on character creation and level up",
                    },
                    {
                        id: "togglePreloader",
                        displayText: preloaderEnabled ? "Disable preloader" : "Enable preloader",
                        description: preloaderEnabled ? "Disable preloading assets (not recommended)" : "Enable preloading assets (recommended)" ,
                    },
                    {
                        id: "resetGame",
                        displayText: "Reset the game",
                        description:
                            "Abandon your current game and return to the " +
                            "title screen",
                    },
                ],
                select: (selectedOptionId) => {
                    switch (selectedOptionId) {
                        case "toggleMusic":
                            if (tromboneIsPlaying) {
                                break;
                            }
                            music.toggle();
                            saveSettings();
                            menu.render();
                            break;
                        case "musicSettings":
                            menu.open("musicSettings");
                            break;
                        case "toggleSFX":
                            sfxEnabled = !sfxEnabled;
                            saveSettings();
                            menu.render();
                            break;
                        case "toggleSpeech":
                            speechEnabled = !speechEnabled;
                            saveSettings();
                            menu.render();
                            break;
                        case "toggleSkipTitleScreen":
                            skipTitleScreen = !skipTitleScreen;
                            preloaderEnabled = !skipTitleScreen;
                            saveSettings();
                            menu.render();
                            break;
                        case "toggleEatRatAnimation":
                            eatRatAnimationEnabled = !eatRatAnimationEnabled;
                            saveSettings();
                            menu.render();
                            break;
                        case "toggleBattleTransitionAnimations":
                            battleTransitionAnimationsEnabled = !battleTransitionAnimationsEnabled;
                            saveSettings();
                            menu.render();
                            break;
                        case "toggleAutoDiceroll":
                            autoDicerollEnabled = !autoDicerollEnabled;
                            saveSettings();
                            menu.render();
                            break;
                        case "togglePreloader":
                            preloaderEnabled = !preloaderEnabled;
                            saveSettings();
                            menu.render();
                            break;
                        case "resetGame":
                            menu.open("resetGameConfirmation");
                            break;
                    }
                },
            },

            musicSettings: {
                title: "MUSIC SETTINGS",
                getOptions: () => [
                    {
                        id: "explorationMusicSettings",
                        displayText: "Exploration music",
                        description: "Pick which songs play during exploration",
                    },
                    {
                        id: "battleMusicSettings",
                        displayText: "Battle music",
                        description: "Pick which songs play during battle",
                    },
                    {
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to game settings",
                    },
                ],
                select: (selectedMenuId) => menu.open(selectedMenuId),
            },

            explorationMusicSettings: {
                title: "EXPLORATION MUSIC",
                landingHtml: () =>
                    "Select which exploration tracks to include in rotation",
                getOptions: () => {
                    const tracks = music.getTracks("exploration");
                    const options = tracks.map(track => {
                        const verb = track.enabled ? "disable" : "enable";
                        const description = `Select to ${verb} this track`
                        const className = track.enabled ? undefined : "muted";

                        return {
                            id: track.id,
                            displayText: `${track.title} - ${track.artist}`,
                            description,
                            className,
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to music settings",
                    });

                    return options;
                },
                select: (trackId) => {
                    music.tagToggle("exploration", trackId);
                    saveSettings();
                    menu.render();
                },
            },

            battleMusicSettings: {
                title: "BATTLE MUSIC",
                landingHtml: () => "Select which battle tracks to include in rotation",
                getOptions: () => {
                    const options = music.getTracks("battle").map(track => {
                        const verb = track.enabled ? "disable" : "enable";
                        const description = `Select to ${verb} this track`
                        const className = track.enabled ? undefined : "muted";

                        return {
                            id: track.id,
                            displayText: `${track.title} - ${track.artist}`,
                            description,
                            className,
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to music settings",
                    });

                    return options;
                },
                select: (trackId) => {
                    music.tagToggle("battle", trackId);
                    saveSettings();
                    menu.render();
                },
            },


            resetGameConfirmation: {
                title: "RESET GAME",
                landingHtml: () =>
                    "Are you sure you want to reset the game?",
                getOptions: () => [
                    {
                        id: "_back",
                        displayText: "NO! Do not reset the game!",
                        description: "Go back to the previous menu",
                    },
                    {
                        id: "reset",
                        displayText: "Yes, waste my progress",
                        description:
                            "Abandon the current game and start again " +
                            "from the first floor",
                    },
                ],
                select: () => window.location.reload(),
            },
            inventory: {
                title: "INVENTORY",
                landingHtml: () => {
                    return player.inventory.isEmpty()
                        ? 'You own nothing. Klaus Schwab would be proud'
                        : null;
                },
                getOptions: () => [
                    {
                        id: "inventoryItems",
                        displayText: "Items",
                        description: "View your consumable items.",
                    },
                    {
                        id: "inventoryEquipment",
                        displayText: "Equipment",
                        description:
                            "View and change your equipped weapon and armor.",
                        className: player.inCombat ? "tooExpensive" : undefined,
                    },
                    {
                        id: "_back",
                        displayText: "[Back]",
                        description: "Get back to playing the game",
                    }
                ],
                select: (selectedOptionId) => {
                    // When in battle, disable equipment submenus
                    const submenuDisabled =
                        selectedOptionId === "inventoryEquipment" &&
                        player.inCombat;

                    if (submenuDisabled) {
                        updateBattleLog(
                            `Your foe's <span class="action">deathly ` +
                            `stare</span> prevents you from wanting to strip ` +
                            `down into a new set of equipment!`
                        );
                        return;
                    }
                    menu.open(selectedOptionId);
                },
                onOpen: () => {
                    Portrait.show('inventory');
                },
                onClose: () => {
                    Portrait.hide();
                },
            },
            inventoryItems: {
                title: "ITEMS",
                landingHtml: () => {
                    return !player.inventory.hasItems()
                        ? 'You own nothing. Klaus Schwab would be proud'
                        : null;
                },
                getOptions: () => {
                    const items = Object.values(player.inventory.getItems());
                    const options =
                        items.map((item) => ({
                            id: item.id,
                            displayText: item.name,
                            description: item.description,
                            trailText: item.count,
                        }));

                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to the inventory menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    const itemUsed = player.inventory.useItem(selectedOptionId);
                    if (!itemUsed) {
                        console.error(
                            "Tried to use an item that the player doesn't have",
                            { selectedOptionId }
                        );
                    }

                    menu.closeAll(); // Close all menus after using an item
                },
            },
            inventoryEquipment: {
                title: "EQUIPMENT",
                getOptions: () => {
                    const weapon = player.inventory.getEquippedWeapon();
                    const armor = player.inventory.getEquippedArmor();
                    const rings = player.inventory.getEquippedRings();

                    return [
                        {
                            id: "equipHand",
                            displayText: `Hand:   ${weapon?.name || "None"}`,
                            description: "View and equip your weapons.",
                        },
                        {
                            id: "equipBody",
                            displayText: `Body:   ${armor?.name || "None"}`,
                            description: "View and equip your armor.",
                        },
                        {
                            id: "equipRings",
                            // The second line is deliberately offset because
                            // the cursor adds two spaces to the first line
                            displayText:
                                `Rings:  ${rings.leftHand?.name || "None"}\n` +
                                `        ${rings.rightHand?.name || "None"}`,
                            description: "View and equip your rings.",
                        },
                        {
                            id: "_back",
                            displayText: "[Back]",
                            description: "Return to the inventory menu",
                        }
                    ];
                },
                select: (selectedOptionId) => {
                    menu.open(selectedOptionId);
                },
            },
            equipHand: {
                title: "EQUIP WEAPON",
                getOptions: () => {
                    const equippedWeaponId =
                        player.inventory.getEquippedWeapon()?.id || null;
                    const ownedWeapons =
                        Object.values(player.inventory.getWeapons());

                    return ownedWeapons.map((weapon) => {
                        const isEquipped = weapon.id === equippedWeaponId;
                        const requiredStrength = weapon.requiredStr || 0;
                        const playerMeetsReqirements =
                            player.strength >= requiredStrength;
                        const requirementClass =
                            playerMeetsReqirements ? "friendly" : "enemy";
                        const requiredStrengthHtml =
                            `<span class="${requirementClass}">` +
                            `STR ${requiredStrength}</span>`;

                        return {
                            id: weapon.id,
                            displayText:
                                weapon.name + (isEquipped ? " (Equipped)" : ""),
                            description:
                                `${weapon.description}\n` +
                                `Base Damage: ${weapon.damage.base}, ` +
                                `Random Multiplier: ` +
                                    `${weapon.damage.randomMultiplier}\n` +
                                `LOAD: ${weapon.weight}\n` +
                                `Stat Requirement: ${requiredStrengthHtml}`,
                            className: playerMeetsReqirements
                                ? (isEquipped ? "friendly" : undefined)
                                : "tooExpensive",
                        };
                    }).concat([{
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to equipment menu",
                    }]);
                },
                select: (selectedOptionId) => {
                    const weapon =
                        InventoryObjectDefinitions.weapons[selectedOptionId];
                    if (!weapon) {
                        console.error(
                            "Selected an inventory weapon that does not exist",
                            { selectedOptionId }
                        );
                        return;
                    }

                    const requiredStrength = weapon.requiredStr || 0;
                    if (player.strength < requiredStrength) {
                        updateBattleLog(
                            `You <span class="enemy">require</span> ` +
                            `<span class="STR">${requiredStrength} STR` +
                            `</span> to handle this weapon!`
                        );
                        return;
                    }

                    player.inventory.equipWeapon(selectedOptionId);
                    menu.close();
                    render();
                },
            },

            equipBody: {
                title: "EQUIP ARMOR",
                getOptions: () => {
                    const equippedArmorId =
                        player.inventory.getEquippedArmor()?.id || null;
                    const ownedArmor =
                        Object.values(player.inventory.getArmor());

                    return ownedArmor.map((armor) => {
                        const isEquipped = armor.id === equippedArmorId;
                        const requiredEndurance = armor.requiredEnd || 0;
                        const meetsRequirements =
                            player.endurance >= requiredEndurance;
                        const requirementClass = meetsRequirements
                            ? "friendly" : "enemy";
                        const requiredEnduranceHtml =
                            `<span class="${requirementClass}">END ` +
                            `${requiredEndurance}</span>`;
                        return {
                            id: armor.id,
                            displayText:
                                armor.name +
                                (isEquipped ? " (Equipped)" : ""),
                            description:
                                `${armor.description}\n` +
                                `Defense: ${armor.defense}\n` +
                                `LOAD: ${armor.weight}\n` +
                                `Stat Requirement: ${requiredEnduranceHtml}`,
                            className: !meetsRequirements
                                ? "tooExpensive"
                                : (isEquipped ? "friendly" : undefined),
                        };
                    }).concat([{
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to equipment menu",
                    }]);
                },
                select: (selectedOptionId) => {
                    const armor =
                        InventoryObjectDefinitions.armor[selectedOptionId];
                    if (!armor) {
                        console.error(
                            "Selected inventory armor that does not exist",
                            { selectedOptionId }
                        );
                        return;
                    }

                    const requiredEndurance = armor.requiredEnd || 0;
                    if (player.endurance < requiredEndurance) {
                        updateBattleLog(
                            `You need <span class="END">${requiredEndurance} ` +
                            `END</span> to wear this garment!`
                        );
                        return;
                    }

                    player.inventory.equipArmor(selectedOptionId);
                    menu.close();
                    render();
                },
            },

            equipRings: {
                title: "EQUIP RINGS",
                getOptions: () => {
                    const rings = player.inventory.getEquippedRings();
                    const leftHandText = "Left Hand:  " + (rings.leftHand
                        ? rings.leftHand.name
                        : "None"
                    );
                    const rightHandText = "Right Hand: " + (rings.rightHand
                        ? rings.rightHand.name
                        : "None"
                    );

                    return [
                        {
                            id: "ringLeftHand",
                            displayText: leftHandText,
                            description: "Equip a ring on your left hand",
                        },
                        {
                            id: "ringRightHand",
                            displayText: rightHandText,
                            description: "Equip a ring on your right hand",
                        },
                        {
                            id: "_back",
                            displayText: "[Back]",
                            description: "Return to equipment menu",
                        }
                    ];
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "ringLeftHand") {
                        menu.open("ringLeftHandSelect");
                    } else if (selectedOptionId === "ringRightHand") {
                        menu.open("ringRightHandSelect");
                    } else {
                        if (player.hp > getEffectiveStat('maxHp')) {
                            player.hp = getEffectiveStat('maxHp');
                        }
                        menu.close();
                        render();
                    }
                },
            },

            ringLeftHandSelect: {
                title: "LEFT HAND",
                getOptions: () => {
                    const ownedRings =
                        Object.values(player.inventory.getRings());
                    const options = ownedRings.map((ring) => {
                        const isEquipped =
                            player.inventory.hasEquippedRing(ring.id);
                        const displayText =
                            ring.name + (isEquipped ? " (Equipped)" : "");
                        const className = isEquipped
                            ? (isEquipped ? "friendly" : "muted")
                            : undefined;

                        return {
                            id: ring.id,
                            displayText,
                            description: ring.description,
                            className,
                        };
                    });

                    options.unshift({
                        id: null,
                        displayText: "None",
                        description: "Unequip this ring slot",
                    });

                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to rings menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    const handId = "leftHand";

                    if (!selectedOptionId) {
                        // Only update if a ring has been equipped
                        if (!player.inventory.hasEquippedRing(null, handId)) {
                            player.inventory.unequipRing(handId);
                        }

                        menu.close();
                        render();
                        return;
                    }

                    const ring =
                        InventoryObjectDefinitions.rings[selectedOptionId];
                    if (!ring) {
                        console.error(
                            "Selected an inventory ring that does not exist",
                            { selectedOptionId }
                        );
                        return;
                    }

                    const ringIsAlreadyEquippedOnOppositeHand =
                        player.inventory.hasEquippedRing(
                            selectedOptionId,
                            "rightHand"
                        );
                    if (ringIsAlreadyEquippedOnOppositeHand) {
                        const articleText = ring.article ? "the " : "";
                        updateBattleLog(
                            `You are <span class="action">already wearing` +
                            `</span> ${articleText}<span class="friendly">` +
                            `${ring.name}</span> on your right hand, fool!`
                        );
                        return;
                    }

                    player.inventory.equipRing(
                        handId,
                        selectedOptionId
                    );

                    menu.close();
                    render();
                },
            },

            ringRightHandSelect: {
                title: "RIGHT HAND",
                getOptions: () => {
                    const ownedRings =
                        Object.values(player.inventory.getRings());
                    const options = ownedRings.map((ring) => {
                        const isEquipped =
                            player.inventory.hasEquippedRing(ring.id);
                        const displayText =
                            ring.name + (isEquipped ? " (Equipped)" : "");
                        const className = isEquipped
                            ? (isEquipped ? "friendly" : "muted")
                            : undefined;

                        return {
                            id: ring.id,
                            displayText,
                            description: ring.description,
                            className,
                        };
                    });

                    options.unshift({
                        id: null,
                        displayText: "None",
                        description: "Unequip this ring slot",
                    });

                    options.push({
                        id: "_back",
                        displayText: "[Back]",
                        description: "Return to rings menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    const handId = "rightHand";

                    if (!selectedOptionId) {
                        // Only update if a ring has been equipped
                        if (!player.inventory.hasEquippedRing(null, handId)) {
                            player.inventory.unequipRing(handId);
                        }

                        menu.close();
                        render();
                        return;
                    }

                    const ring =
                        InventoryObjectDefinitions.rings[selectedOptionId];
                    if (!ring) {
                        console.error(
                            "Selected an inventory ring that does not exist",
                            { selectedOptionId }
                        );
                        return;
                    }

                    const ringIsAlreadyEquippedOnOppositeHand =
                        player.inventory.hasEquippedRing(
                            selectedOptionId,
                            "leftHand"
                        );
                    if (ringIsAlreadyEquippedOnOppositeHand) {
                        const articleText = ring.article ? "the " : "";
                        updateBattleLog(
                            `You are <span class="action">already wearing` +
                            `</span> ${articleText}<span class="friendly">` +
                            `${ring.name}</span> on your left hand. DUH!`
                        );

                        return;
                    }

                    player.inventory.equipRing(
                        handId,
                        selectedOptionId
                    );

                    menu.close();
                    render();
                },
            },

            merchant: {
                title: "MERCHANT",
                onOpen: () => {
                    Portrait.show('merchant');
                    merchant.say('Welcome to SlobMart!');
                },
                onClose: () => {
                    merchant.say('Thank you. Come again!');
                    Portrait.hide();
                    music.resumeTag("exploration");
                },
                landingHtml: () => {
                    return player.bitcoins > 0
                        ?
                            `You have <span class="BTC">` +
                            `₿ ${player.bitcoins.toLocaleString(undefined)}` +
                            `</span> in your wallet`
                        :
                            "Your wallet is emptier than a lughead's skull. " +
                            "But you can still look around";
                },
                getOptions: () => [
                    {
                        id: "merchantItems",
                        displayText: "Items",
                        description:
                            "See what consumable items are for sale",
                    },
                    {
                        id: "merchantWeapons",
                        displayText: "Weapons",
                        description:
                            "Look at some weapon upgrades",
                    },
                    {
                        id: "merchantArmor",
                        displayText: "Armor",
                        description:
                            "Get some thicker skin",
                    },
                    {
                        id: "merchantRings",
                        displayText: "Rings",
                        description:
                            "Jewelry that will probably turn you gay",
                    },
                    {
                        id: "merchantSell",
                        displayText: "Sell",
                        description:
                            "Sell your items, filthy garb, and dangerous arms",
                    },
                    {
                        id: "_back",
                        displayText: "Leave",
                        description:
                            "Get back to spelunking",
                    },
                ],
                select: (selectedOptionId) => {
                    menu.open(selectedOptionId);
                },
            },
            merchantItems: {
                title: "ITEMS",
                landingHtml: () => {
                    return player.bitcoins > 0
                        ?
                            `You have <span class="BTC">` +
                            `₿ ${player.bitcoins.toLocaleString(undefined)}` +
                            `</span> in your wallet`
                        :
                            "Your wallet is emptier than a lughead's skull. " +
                            "But you can still look around";
                },
                getOptions: () => {
                    const items = InventoryObjectDefinitions.items;
                    const options = merchant.items.map((itemId) => {
                        let displayText = items[itemId].name;
                        let className = items[itemId].price > player.bitcoins
                            ? 'tooExpensive'
                            : undefined;
                        if (itemId === "carrierPigeon" && player.inventory.getItemCount("carrierPigeon") >= 10) {
                            displayText = `${displayText}`;
                            className = "muted";
                        }
                        return {
                            id: itemId,
                            displayText,
                            description: items[itemId].description,
                            trailText: `₿ ${items[itemId].price}`,
                            className,
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy("items", selectedOptionId);
                },
            },
            merchantWeapons: {
                title: "WEAPONS",
                landingHtml: () => {
                    const message = player.bitcoins > 0
                        ?
                            `You have <span class="BTC">` +
                            `₿ ${player.bitcoins.toLocaleString(undefined)}` +
                            `</span> in your wallet`
                        :
                            "Your wallet is emptier than a lughead's skull. " +
                            "But you can still look around";

                    const currentWeapon = player.inventory.getEquippedWeapon();
                    const article = currentWeapon?.article
                        ? `${currentWeapon.article} `
                        : '';
                    const currentWeaponDisplay = article + currentWeapon.name;
                    const wieldingMessage =
                        `You are currently wielding ${currentWeaponDisplay}`;

                    return `${message}\n\n${wieldingMessage}`;
                },
                getOptions: () => {
                    const weapons = InventoryObjectDefinitions.weapons;
                    const weaponKeys = Object.keys(weapons);
                    const options = weaponKeys.map((weaponId) => {
                        const weapon = weapons[weaponId];
                        const tooExpensive = weapon.price > player.bitcoins;
                        const alreadyOwned =
                            player.inventory.hasWeapon(weaponId);
                        const requiredStrength = weapon.requiredStr || 0;
                        const requirementClass =
                            player.strength >= requiredStrength
                                ? "friendly"
                                : "enemy";
                        const requiredStrengthHtml =
                            `<span class="${requirementClass}">STR ` +
                            `${requiredStrength}</span>`;

                        return {
                            id: weaponId,
                            displayText: weapon.name,
                            description:
                                `${weapon.description}\n` +
                                `Base Damage: ${weapon.damage.base}, ` +
                                `Random Multiplier: ` +
                                    `${weapon.damage.randomMultiplier}\n` +
                                `LOAD: ${weapon.weight}\n` +
                                `Stat Requirement: ${requiredStrengthHtml}`,
                            trailText:
                                `₿ ${weapon.price.toLocaleString(undefined)}`,
                            className: alreadyOwned
                                ? 'muted'
                                : (tooExpensive ? 'tooExpensive' : undefined),
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy("weapons", selectedOptionId);
                },
            },
            merchantArmor: {
                title: "ARMOR",
                landingHtml: () => {
                    const message = player.bitcoins > 0
                        ?
                            `You have <span class="BTC">` +
                            `₿ ${player.bitcoins.toLocaleString(undefined)}` +
                            `</span> in your wallet`
                        :
                            "Your wallet is emptier than a lughead's skull. " +
                            "But you can still look around";

                    const currentArmor = player.inventory.getEquippedArmor();
                    const article =
                        currentArmor?.article ? `${currentArmor.article} ` : '';
                    const armorName =
                        currentArmor?.name || "NOTHING. Have you no shame?";
                    const currentArmorDisplay = article + armorName;
                    const wearingMessage =
                        `You are currently wearing ${currentArmorDisplay}`;

                    return `${message}\n\n${wearingMessage}`;
                },
                getOptions: () => {
                    const armor = InventoryObjectDefinitions.armor;
                    const options = Object.keys(armor).map((armorId) => {
                        const armor = InventoryObjectDefinitions.armor[armorId];
                        const tooExpensive = armor.price > player.bitcoins;
                        const alreadyOwned = player.inventory.hasArmor(armorId);
                        const requiredEndurance = armor.requiredEnd || 0;
                        const requirementClass =
                            player.endurance >= requiredEndurance
                                ? "friendly"
                                : "enemy";
                        const requiredEnduranceHtml =
                            `<span class="${requirementClass}">END ` +
                            `${requiredEndurance}</span>`;
                        return {
                            id: armorId,
                            displayText: armor.name,
                            description:
                                `${armor.description}\n` +
                                `Defense: ${armor.defense}\n` +
                                `LOAD: ${armor.weight}\n` +
                                `Stat Requirement: ${requiredEnduranceHtml}`,
                            trailText: `₿ ${armor.price}`,
                            className: alreadyOwned
                                ? 'muted'
                                : (tooExpensive ? 'tooExpensive' : undefined),
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy("armor", selectedOptionId);
                },
            },
            merchantRings: {
                title: "RINGS",
                landingHtml: () => {
                    return player.bitcoins > 0
                        ? `You have <span class="BTC">` +
                            `₿ ${player.bitcoins.toLocaleString(undefined)}` +
                            `</span> in your wallet`
                        : "Your wallet is emptier than a lughead's skull. " +
                            "But you can still look around";
                },
                getOptions: () => {
                    const options = (merchant.rings || []).map((ringId) => {
                        const ring = InventoryObjectDefinitions.rings[ringId];
                        const tooExpensive = ring.price > player.bitcoins;
                        const alreadyOwned = player.inventory.hasRing(ringId);

                        return {
                            id: ringId,
                            displayText: ring.name,
                            description: ring.description,
                            trailText:
                                `₿ ${ring.price.toLocaleString(undefined)}`,
                            className: alreadyOwned
                                ? 'muted'
                                : (tooExpensive ? 'tooExpensive' : undefined),
                        };
                    });

                    options.push({
                        id: "_back",
                        displayText: "Back",
                        description: "Return to the merchant menu",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    merchant.buy("rings", selectedOptionId);
                },
            },

            merchantSell: {
                title: "SELL",
                landingHtml: () =>
                    `Sell your unwanted inventory for a small sum.\n\n` +
                    `You have <span class="BTC">` +
                    `₿ ${player.bitcoins.toLocaleString(undefined)}</span> ` +
                    `in your wallet.`,
                getOptions: () => {
                    const itemOptions = Object
                        .values(player.inventory.getItems())
                        .map(item => {
                            const sellPrice = Math
                                .max(1, Math.floor(item.price / 5))
                                .toLocaleString(undefined);

                            return {
                                id: `sell_item_${item.id}`,
                                displayText: `[I] ${item.name}`,
                                description:
                                    `Sell for <span class="BTC">₿ ${sellPrice}` +
                                    `</span>`,
                                trailText:
                                    item.count.toLocaleString(undefined),
                            };
                        });

                    const weaponOptions = Object
                        .values(player.inventory.getWeapons())
                        .map(weapon => {
                            const sellPrice = Math
                                .max(1, Math.floor(weapon.price / 10))
                                .toLocaleString(undefined);
                            const isEquipped =
                                player.inventory.hasEquippedWeapon(weapon.id);

                            return {
                                id: `sell_weapon_${weapon.id}`,
                                displayText: `[W] ${weapon.name}`,
                                description:
                                    `Sell for ` +
                                    `<span class="BTC">₿ ${sellPrice}</span>`,
                                trailText:
                                    weapon.count.toLocaleString(undefined),
                                className: isEquipped ? "muted" : undefined,
                            };
                        });

                    const armorOptions = Object
                        .values(player.inventory.getArmor())
                        .map(armor => {
                            const sellPrice = Math
                                .max(1, Math.floor(armor.price / 10))
                                .toLocaleString(undefined);
                            const isEquipped =
                                player.inventory.hasEquippedArmor(armor.id);

                            return {
                                id: `sell_armor_${armor.id}`,
                                displayText: `[A] ${armor.name}`,
                                description:
                                    `Sell for ` +
                                    `<span class="BTC">₿ ${sellPrice}</span>`,
                                trailText:
                                    armor.count.toLocaleString(undefined),
                                className: isEquipped ? "muted" : undefined,
                            };
                        });

                    const ringOptions = Object
                        .values(player.inventory.getRings())
                        .map(ring => {
                            const sellPrice = Math
                                .max(1, Math.floor(ring.price / 5))
                                .toLocaleString(undefined);
                            const isEquipped =
                                player.inventory.hasEquippedRing(ring.id);

                            return {
                                id: `sell_ring_${ring.id}`,
                                displayText: `[R] ${ring.name}`,
                                description:
                                    `Sell for <span class="BTC">₿ ${sellPrice}` +
                                    `</span>`,
                                trailText: ring.count.toLocaleString(undefined),
                                className: isEquipped ? "muted" : undefined,
                            }
                        });

                    return [
                        ...weaponOptions,
                        ...armorOptions,
                        ...ringOptions,
                        ...itemOptions,
                        {
                            id: "_back",
                            displayText: "[Back]",
                            description: "Return to the merchant menu",
                        }
                    ];
                },
                select: (selectedOptionId) => {
                    const { items, weapons, armor, rings } =
                        InventoryObjectDefinitions;

                    const [_, type, id] = selectedOptionId.split("_");
                    let soldObject, value = 0;

                    if (type === "weapon") {
                        if (player.inventory.hasEquippedWeapon(id)) {
                            merchant.say(
                                "You sure you wanna point that thing at me? " +
                                "I've got a 12 gauge hidden under my sleeve, " +
                                "you know..."
                            );
                            return;
                        }

                        if (player.inventory.hasWeapon(id)) {
                            soldObject = weapons[id];
                            value = merchant.getSalePrice(
                                'weapon',
                                weapons[id].price
                            );

                            player.inventory.deductWeapon(id)
                                ? player.giveBitcoins(value)
                                : console.error(
                                    "Could not deduct weapon during sale",
                                    { id }
                                );
                        } else {
                            console.error(
                                "Tried to sell an item that the player does " +
                                "not have",
                                { id }
                            );
                            return;
                        }
                    } else if (type === "armor") {
                        if (player.inventory.hasEquippedArmor(id)) {
                            merchant.say(
                                "What are you, a Lughead? You gotta strip " +
                                "down before you go selling that!"
                            );
                            return;
                        }

                        if (player.inventory.hasArmor(id)) {
                            soldObject = armor[id];
                            value = merchant.getSalePrice(
                                'armor',
                                armor[id].price
                            );

                            player.inventory.deductArmor(id)
                                ? player.giveBitcoins(value)
                                : console.error(
                                    "Could not deduct armor during sale",
                                    { id }
                                );
                        } else {
                            console.error(
                                "Tried to sell armor that the player does " +
                                "not have",
                                { id }
                            );
                            return;
                        }
                    } else if (type === "ring") {
                        if (player.inventory.hasEquippedRing(id)) {
                            merchant.say(
                                "I don't swing that way, kid, but if you " +
                                "really wanna propose you gotta take the " +
                                "damn ring off."
                            );
                            return;
                        }

                        if (player.inventory.hasRing(id)) {
                            soldObject = rings[id];
                            value = merchant.getSalePrice(
                                'ring',
                                rings[id].price
                            );

                            player.inventory.deductRing(id)
                                ? player.giveBitcoins(value)
                                : console.error(
                                    "Could not deduct armor during sale",
                                    { id }
                                );
                        } else {
                            console.error(
                                "Tried to sell a ring that the player does " +
                                "not have",
                                { id }
                            );
                            return;
                        }
                    } else if (type === "item") {
                        if (player.inventory.hasItem(id)) {
                            const items = InventoryObjectDefinitions.items;
                            soldObject = items[id];
                            value = merchant.getSalePrice(
                                'item',
                                items[id].price
                            );

                            player.inventory.deductItem(id)
                                ? player.giveBitcoins(value)
                                : console.error(
                                    "Could not deduct item during sale",
                                    { id }
                                );
                        } else {
                            console.error(
                                "Tried to sell an item that the player does " +
                                "not have",
                                { id }
                            );
                            return;
                        }
                    } else {
                        console.error(
                            "Could not sell: unknown type",
                            { type, selectedOptionId }
                        );
                        return;
                    }

                    playSFX('kaching');
                    merchant.printTransactionMessage('sold', soldObject, value);
                    menu.render();
                    render();
                },
            },

            gambler: {
                title: "GAMBLER",
                onOpen: () => {
                    Portrait.show('gambler');
                    gambler.say(
                        player.inventory.hasEquippedRing("ringGamble")
                            ? 'Cheesed to meet you!'
                            : 'Place yer bets!'
                    );
                    music.play("gamblerTheme");
                },
                onClose: () => {
                    gambler.isActiveOnFloor = false;
                    const gamblerPosition = gambler.location();
                    if (gamblerPosition) {
                        MAP.setCell(gamblerPosition.x, gamblerPosition.y);
                    }
                    music.resumeTag("exploration");
                    Portrait.hide();
                },
                landingHtml: () => {
                    return (
                        `<span class="gambler">&lt;GAMBLER&gt;</span> ` +
                        `"Welcome, dungeon dweller! ` +
                        `<span class="friendly">Roll a 12</span> and ` +
                        `<span class="BTC">boost one of yer stats.</span> ` +
                        `Just <span class="tooExpensive">` +
                        `₿ ${gambler.playPrice}</span> to play!"\n\n` +
                        `You have <span class="BTC">₿ ` +
                        `${player.bitcoins.toLocaleString(undefined)}</span> ` +
                        `in your wallet`
                    );
                },
                getOptions: () => {
                    return [
                        {
                            id: "play",
                            displayText: "Play the game",
                            trailText: `₿ ${gambler.playPrice}`,
                            description: "Take your chance with the gambler",
                        },
                        {
                            id: "_back",
                            displayText: "Leave",
                            description: "Leave this crusty fool",
                        },
                    ];
                },
                select: () => {
                    gamble();
                },
            },

            erok: {
                title: "EROK",
                escapeDisabled: () => erok.isPetting,
                onOpen: () => {
                    if (!erok.isPetting) {
                        Portrait.show('erokIdle');
                    }

                    music.play("erokTheme");
                    erok.say('oh my god oh my god hi stranger i love motorcycles');
                },
                onClose: () => {
                    erok.say('I am barking happily, stranger!');
                    Portrait.hide();
                    music.resumeTag("exploration");
                    erok.isActiveOnFloor = false;
                    const erokPosition = erok.location();
                    if (erokPosition) {
                        MAP.setCell(erokPosition.x, erokPosition.y);
                    }
                },
                landingHtml: () => {
                    return `You've approached a dog named Erok... seems friendly enough, for a dog!`;
                },
                getOptions: () => [
                    {
                        id: "pet",
                        displayText: "give the dog motivation to give you motivation",
                        description: ":)",
                        className: erok.isPetting ? "muted" : undefined,
                    },
                    {
                        id: "leave",
                        displayText: "make the dog sad",
                        description: "... :(",
                        className: erok.isPetting ? "muted" : undefined,
                    },
                ],
                select: (selectedOptionId) => {
                    if (erok.isPetting) {
                        return;
                    }

                    if (selectedOptionId === "pet") {
                        erok.isPetting = true;
                        Portrait.show('erokPet');
                        erok.say('holy crap oh my god pet me pet me oh my god holy shit oh god oh fuck oh god');
                        setTimeout(() => {
                            erok.isPetting = false;
                            if (menu.isOpen() && menu.getCurrentMenuData()?.title === "EROK") {
                                Portrait.show('erokIdle');
                            }
                            menu.render();
                        }, 2000);
                    } else if (selectedOptionId === "leave") {
                        menu.close();
                    }
                },
            },

            pigeon: {
                title: "CARRIER PIGEON",
                onOpen: () => {
                    Portrait.show('pigeon');
                    pigeon.say("Coo coo! " + (
                        pigeon.checkForMessages()
                            ? 'You have a message from another adventurer!'
                            : 'No adventurers have sent out any messages...'
                        )
                    );
                },
                onClose: () => {
                    Portrait.hide();
                    pigeon.isActiveOnFloor = false;
                    const pigeonPosition = pigeon.location();
                    if (pigeonPosition) {
                        MAP.setCell(pigeonPosition.x, pigeonPosition.y);
                    }
                },
                landingHtml: () => pigeon.checkForMessages()
                    ? `You see a sealed letter below the carrier pigeon's big stinky feet...`
                    : `You notice a carrier pigeon... it seems lost.`,
                getOptions: () => {
                    const options = [];

                    if (pigeon.checkForMessages()) {
                        options.push({
                            id: "readMessages",
                            displayText: "Read the letter",
                            description: "Read the letter sent out by a fellow adventurer",
                        });
                    }

                    options.push({
                        id: "leave",
                        displayText: "Back away from the beast",
                        description: "Let the beast roam free",
                    });

                    return options;
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "readMessages") {
                        if (typeof PigeonMessaging !== 'undefined' && typeof PigeonMessaging.displayDeliveredMessage === 'function') {
                            // displayDeliveredMessage() will use the pending delivered message (if any)
                            PigeonMessaging.displayDeliveredMessage();
                        } else {
                            updateBattleLog('<span class="enemy">Pigeon messaging system not available.</span>');
                        }
                    }
                    menu.close();
                },
            },

            chest: {
                title: "TREASURE CHEST",
                defaultCloseOption: "resistTemptation",
                onOpen: () => {
                    Portrait.show('chest');
                },
                onClose: () => {
                    Portrait.hide();
                },
                landingHtml: () => {
                    return `\n\n\nYou found a treasure chest! Do you want to open it?`;
                },
                getOptions: () => {
                    return [
                        {
                            id: "open",
                            displayText: "Hell yeah! Fondle that booty!",
                            description: "Claim your succulent reward!",
                        },
                        {
                            id: "resistTemptation",
                            displayText: "Resist your burning temptation...",
                            description: "DON'T claim your succulent reward!",
                        },
                    ];
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "open") {
                        openChest();
                    } else if (selectedOptionId === "resistTemptation") {
                        npcMove();
                    }
                    menu.close();
                    render();
                },
            },
            statAllocation: {
                itemsPerPage: 12,
                // Prevent menu from being closed with the Escape key
                escapeDisabled: true,
                title: () => isLevelUpAllocation ? "LEVEL UP" : "STAT ALLOCATION",
                landingHtml: () => {
                    return isLevelUpAllocation
                        ? `You leveled up! Allocate <span class="action">${player.remainingPoints}</span> points to your stats.`
                        : `Build your character using the <span class="action">${player.remainingPoints}</span> points you have been allotted. Use them wisely...`;
                },
                getOptions: () => {
                    // Helper to determine if a stat should be red
                    function isStatCapped(statKey) {
                        return isLevelUpAllocation && levelUpStatPointsAllocated[statKey] >= 2;
                    }
                    return [
                        {
                            id: "rollDice",
                            displayText: "[Diceroll]",
                            description: "Randomly allocate your points.",
                        },
                        {
                            id: "hp",
                            displayText: `HP: ${player.maxHp}`,
                            className: isStatCapped("maxHp") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases Health Points.",
                        },
                        {
                            id: "defense",
                            displayText: `DEF: ${player.defense}`,
                            className: isStatCapped("defense") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases defense against enemy attacks.",
                        },
                        {
                            id: "strength",
                            displayText: `STR: ${player.strength}`,
                            className: isStatCapped("strength") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your base ATK by 1 and allows you to equip higher grade weapons.",
                        },
                        {
                            id: "persuasion",
                            displayText: `PRS: ${player.persuasion}`,
                            className: isStatCapped("persuasion") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your chances at persuading monsters to join your party.",
                        },
                        {
                            id: "endurance",
                            displayText: `END: ${player.endurance}`,
                            className: isStatCapped("endurance") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your carry load and allows you to equip higher grade armor.",
                        },
                        {
                            id: "speed",
                            displayText: `SPD: ${player.speed}`,
                            className: isStatCapped("speed") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases your movement speed. Each point allows you to move 5% faster.",
                        },
                        {
                            id: "luck",
                            displayText: `LUK: ${player.luck}`,
                            className: isStatCapped("luck") ? 'tooExpensive' : (player.remainingPoints < 1 ? 'tooExpensive' : undefined),
                            description: "Increases crit rates and BTC rewards from chests.",
                        },
                        {
                            id: "reset",
                            displayText: "[Reset]",
                            description: isLevelUpAllocation
                                ? "Reset your level up stat allocation."
                                : "Reset your stat allocation.",
                        },
                        {
                            id: "confirm",
                            displayText: "[Confirm]",
                            className: player.remainingPoints > 0 ? 'tooExpensive' : undefined,
                            description: isLevelUpAllocation
                                ? "Finish your level up and continue your adventure!"
                                : "Begin YOUR TardQuest!",
                        },
                    ];
                },
                select: (selectedOptionId) => {
                    if (selectedOptionId === "confirm") {
                        if (player.remainingPoints > 0) {
                            updateBattleLog("You must allocate all points before continuing!");
                            return;
                        }
                        if (isLevelUpAllocation) {
                            isLevelUpAllocation = false;
                            updateBattleLog("Stats increased! You consume an unsuspecting rat to restore your health. Poor feller...");
                        } else {
                            updateBattleLog(
                                `Stat allocation complete! You consume an ` +
                                `unsuspecting rat to ensure you are in good ` +
                                `health, and <span class="friendly">your ` +
                                `adventure begins</span>...`
                            );
                        }
                        menu.close();
                        render();
                        if (eatRatAnimationEnabled) {
                            GameControl.disableControls();
                            animEatRat(() => GameControl.enableControls());
                        }
                    } else if (selectedOptionId === "reset") {
                        if (isLevelUpAllocation) {
                            player.hp = player.maxHp = levelUpAllocatedStats.base.maxHp;
                            player.defense = levelUpAllocatedStats.base.defense;
                            player.strength = levelUpAllocatedStats.base.strength;
                            player.persuasion = levelUpAllocatedStats.base.persuasion;
                            player.endurance = levelUpAllocatedStats.base.endurance;
                            player.speed = levelUpAllocatedStats.base.speed;
                            player.luck = levelUpAllocatedStats.base.luck;
                            player.remainingPoints = 6;
                            // Reset the per-stat allocation tracker
                            levelUpStatPointsAllocated = {
                                maxHp: 0,
                                defense: 0,
                                strength: 0,
                                persuasion: 0,
                                endurance: 0,
                                speed: 0,
                                luck: 0
                            };
                            updateBattleLog("Level up stat allocation has been reset.");
                        } else {
                            resetStats();
                        }
                        menu.render();
                        render();
                    } else if (selectedOptionId === "rollDice") {
                        if (isLevelUpAllocation) {
                            rollDiceForLevelUp();
                        } else {
                            rollDiceForStats();
                        }
                        menu.render();
                        render();
                    } else if (player.remainingPoints > 0) {
                        // Only restrict during level up, not initial allocation
                        if (isLevelUpAllocation) {
                            let statKey = null;
                            switch (selectedOptionId) {
                                case "hp": statKey = "maxHp"; break;
                                case "defense": statKey = "defense"; break;
                                case "strength": statKey = "strength"; break;
                                case "persuasion": statKey = "persuasion"; break;
                                case "endurance": statKey = "endurance"; break;
                                case "speed": statKey = "speed"; break;
                                case "luck": statKey = "luck"; break;
                            }
                            if (statKey && levelUpStatPointsAllocated[statKey] >= 2) {
                                updateBattleLog(`<span class="action">You are only allowed 2 points per stat at a time!</span>`);
                                return;
                            }
                            if (statKey) {
                                player[statKey] += 1;
                                levelUpStatPointsAllocated[statKey]++;
                                if (statKey === "maxHp") player.hp = player.maxHp;
                                player.remainingPoints--;
                                menu.render();
                                render();
                                return;
                            }
                        } else {
                            switch (selectedOptionId) {
                                case "hp":
                                    player.maxHp += 1;
                                    player.hp = player.maxHp;
                                    break;
                                case "defense":
                                case "strength":
                                case "persuasion":
                                case "endurance":
                                case "speed":
                                case "luck":
                                    player[selectedOptionId]++;
                                    break;
                            }
                            player.remainingPoints--;
                            menu.render();
                            render();
                        }
                    } else {
                        updateBattleLog("No points remaining to allocate!");
                    }
                },
            }
        });

        // Manages the inventory sidebar on the right side of the viewport
        const InventorySidebar = {
            // Whether sidebar buttons are interactive
            enabled: true,
            // Sections of the sidebar, keyed by name
            sections: {
                main: {
                    title: "Inventory",
                    showCloseButton: false,
                    allowScrolling: false,
                },
                items: {
                    title: "Items",
                    showCloseButton: true,
                    allowScrolling: true,
                },
                weapons: {
                    title: "Weapons",
                    showCloseButton: true,
                    allowScrolling: true,
                },
                armor: {
                    title: "Armor",
                    showCloseButton: true,
                    allowScrolling: true,
                },
                rings: {
                    title: "Rings",
                    showCloseButton: true,
                    allowScrolling: true,
                },
            },

            scrollAmount: 58,

            // Enable/disable all buttons within the sidebar without hiding it
            setEnabled: (enabled) => {
                InventorySidebar.enabled = !!enabled;

                const buttons = [
                    ...document.querySelectorAll('#inventory button'),
                    document.getElementById('inventorySidebarCloseButton'),
                    document.getElementById('inventorySidebarScrollUp'),
                    document.getElementById('inventorySidebarScrollDown'),
                ].filter(Boolean);

                buttons.forEach(btn => {
                    if (InventorySidebar.enabled) {
                        btn.removeAttribute('disabled');
                    } else {
                        btn.setAttribute('disabled', 'true');
                    }
                });
            },

            scrollUp: () => {
                document.querySelector(`#inventory [name]:not(.hidden)`)
                    .scrollTop -= InventorySidebar.scrollAmount;
            },

            scrollDown: () => {
                document.querySelector(`#inventory [name]:not(.hidden)`)
                    .scrollTop += InventorySidebar.scrollAmount;
            },

            showScrollButtons: () => {
                document
                    .getElementById("inventorySidebarScrollUp")
                    .classList
                    .remove("hidden");

                document
                    .getElementById("inventorySidebarScrollDown")
                    .classList
                    .remove("hidden");
            },

            hideScrollButtons: () => {
                document
                    .getElementById("inventorySidebarScrollUp")
                    .classList
                    .add("hidden");

                document
                    .getElementById("inventorySidebarScrollDown")
                    .classList
                    .add("hidden");
            },

            // Conceals buttons that should not be available during a fight
            enterCombat: () => {
                const currentMenu = document
                    .querySelector(`#inventory [name]:not(.hidden)`)
                    ?.getAttribute("name") || null;

                // If the player is on an equipment submenu, close it
                if (! ["main", "items"].includes(currentMenu)) {
                    InventorySidebar.open("main");
                }

                document
                    .querySelectorAll(`#inventory [name="main"] > button`)
                    .forEach($button => {
                        const hideButton =
                            $button.classList.contains("weapons") ||
                            $button.classList.contains("armor") ||
                            $button.classList.contains("rings");

                        if (hideButton) {
                            $button.classList.add("hidden");
                        }
                    });

                InventorySidebar.updateScrollButtons(currentMenu);
            },

            // Reveals all buttons concealed during battle
            leaveCombat: () => {
                document
                    .querySelectorAll(
                        `#inventory [name="main"] > button.hidden`
                    )
                    .forEach($button => {
                        $button.classList.remove("hidden");
                    });

                player.movementDisabled = false;

                const $currentlyOpenedSection =
                    InventorySidebar?.getCurrentSectionElement();
                const currentSectionName =
                    $currentlyOpenedSection?.getAttribute("name");

                InventorySidebar.updateScrollButtons(currentSectionName);
            },

            updateScrollButtons: (sectionName) => {
                InventorySidebar.sections[sectionName]?.allowScrolling || false
                    ? InventorySidebar.showScrollButtons()
                    : InventorySidebar.hideScrollButtons();
            },

            // Changes the title text of the inventory sidebar
            changeTitle: (sectionName) => {
                document.getElementById("inventorySidebarTitle").innerText =
                    InventorySidebar.sections[sectionName]?.title ||
                    "[ ? ? ? ]";
            },

            // Shows/hides the close button depending on the requested section
            updateCloseButton: (sectionName) => {
                const $closeButton =
                    document.getElementById("inventorySidebarCloseButton");

                const showCloseButton =
                    InventorySidebar.sections[sectionName]?.showCloseButton ||
                    false;

                showCloseButton
                    ? $closeButton.classList.remove("hidden")
                    : $closeButton.classList.add("hidden");
            },

            // Returns the currently-opened section's element
            getCurrentSectionElement: () =>
                document.querySelector("#inventory > [name]:not(.hidden)"),

            // Returns the requested section's element
            getSectionElement: (sectionName) =>
                document.querySelector(`#inventory > [name="${sectionName}"]`),

            close: () => {
                InventorySidebar
                    .getCurrentSectionElement()
                    ?.classList
                    .add("hidden");

                document
                    .getElementById("inventorySidebarCloseButton")
                    .classList
                    .add("hidden");

                InventorySidebar.hideScrollButtons();
            },

            // Shows the requested section in the sidebar
            open: (sectionName) => {
                InventorySidebar.changeTitle(sectionName);
                InventorySidebar.updateCloseButton(sectionName);
                InventorySidebar.updateScrollButtons(sectionName);

                const $currentlyOpenedSection =
                    InventorySidebar?.getCurrentSectionElement();
                if ($currentlyOpenedSection) {
                    const currentSectionName =
                        $currentlyOpenedSection.getAttribute("name");

                    if (currentSectionName === sectionName) {
                        return;
                    }

                    $currentlyOpenedSection.classList.add("hidden");
                }

                const $section =
                    InventorySidebar.getSectionElement(sectionName);
                if (!$section) {
                    console.error(
                        "Could not find the requested sidebar section",
                        { sectionName }
                    );
                    return;
                }

                playSFX(sectionName === "main" ? "uiCancel" : "inventoryOpen");
                $section.classList.remove("hidden");
            },

            // Refreshes the items in a given section, or all sections if no
            // name was provided
            refresh: (sectionName) => {
                if (!sectionName) {
                    Object.keys(InventorySidebar.sections).forEach(name => {
                        InventorySidebar.refresh(name);
                    });

                    return;
                }

                switch (sectionName) {
                    case "main":
                        // The main section never changes
                        return;
                    case "items":
                        InventorySidebar.refreshItems();
                        return;
                    case "weapons":
                        InventorySidebar.refreshWeapons();
                        return;
                    case "armor":
                        InventorySidebar.refreshArmor();
                        return;
                    case "rings":
                        InventorySidebar.refreshRings();
                        return;
                }

                console.error(
                    "Inventory sidebar tried to refresh an unknown section",
                    { sectionName }
                );
            },

            setButtonTooltip: ($button, definition) => {
                $button.setAttribute(
                    'data-tooltipHtml',
                    `<div class="inventoryTooltip">
                        <div class="header">
                            <div class="name">${definition.name}</div>
                            <div class="friendly">${definition.equippedText || ""}</div>
                        </div>
                        <div class="details">
                            ${definition.description}
                        </div>
                    </div>`
                );
                $button.setAttribute('data-tooltipPosition', 'left');
                $button.setAttribute('data-tooltipGroupId', 'inventorySidebar');
            },

            createButton: (sectionName, definition) => {
                const $button = document.createElement("button");
                $button.className = `${sectionName}-${definition.id}`;
                $button.dataset.id = definition.id;
                InventorySidebar.setButtonTooltip($button, definition);

                // Reflect current enabled state on creation
                if (!InventorySidebar.enabled) {
                    $button.setAttribute('disabled', 'true');
                }

                const $container = document.createElement("div");
                $container.className = "container";

                const $icon = document.createElement("div");
                $icon.className = "icon";

                const $label = document.createElement("div");
                $label.className = "label";
                $label.innerText = sectionName === "items"
                    ? `${definition.count.toLocaleString(undefined)}x`
                    : "";

                $container.appendChild($icon);
                $container.appendChild($label);
                $button.appendChild($container);
                Tooltip.initialize($button);

                return $button;
            },

            refreshItems: () => {
                const playerItems = player.inventory.getItems();
                const $items =
                    document.querySelector(`#inventory [name="items"]`);

                // Create and update item buttons
                Object.values(playerItems).forEach(item => {
                    const $item =
                        $items.querySelector(`[data-id="${item.id}"]`);

                    if (!$item) {
                        // Create the item entry in the list
                        const $button =
                            InventorySidebar.createButton("items", item);

                        $button.onclick = function () {
                            playSFX("uiSelect");
                            player.inventory.useItem(item.id);
                            // Stop Enter from hitting the button again
                            this.blur();

                            if (! player.inventory.hasItem(item.id)) {
                                const id = $button?.dataset?.tooltipid;
                                if (id) {
                                    document.getElementById(id)?.remove();
                                }
                            }
                        };

                        $items.appendChild($button);
                    } else {
                        // Update the count of the item entry in the list
                        $item.querySelector(".label").innerText =
                            `${item.count.toLocaleString(undefined)}x`;
                    }
                });

                // Delete item buttons that no longer have a reference
                $items.querySelectorAll("button[data-id]").forEach($item => {
                    if (!Object.hasOwn(playerItems, $item.dataset.id)) {
                        $item.remove();
                    }
                });
            },

            refreshWeapons: () => {
                const playerWeapons = player.inventory.getWeapons();
                const equippedWeaponId = player.inventory.getEquippedWeaponId();
                const $weapons =
                    document.querySelector(`#inventory [name="weapons"]`);

                // Create weapon buttons
                Object.values(playerWeapons).forEach(weapon => {
                    const $weapon =
                        $weapons.querySelector(`[data-id="${weapon.id}"]`);

                    const equippedText = weapon.id === equippedWeaponId
                        ? "Equipped"
                        : null;
                    const definition = { ...weapon, equippedText };

                    if (!$weapon) {
                        const equippedText = weapon.id === equippedWeaponId
                            ? "Equipped"
                            : null;

                        // Create the weapon entry in the list
                        const $button = InventorySidebar.createButton(
                            "weapons",
                            definition
                        );

                        $button.onclick = function () {
                            const requiredStrength = weapon.requiredStr || 0;
                            const playerMeetsReqirements =
                                player.strength >= requiredStrength;

                            if (playerMeetsReqirements) {
                                playSFX("uiSelect");
                                player.inventory.equipWeapon(weapon.id);
                            } else {
                                updateBattleLog(
                                    `You <span class="enemy">require</span> ` +
                                    `<span class="STR">${requiredStrength} ` +
                                    `STR</span> to handle this weapon!`
                                );
                            }

                            // Stop Enter from hitting the button again
                            this.blur();
                        };

                        $weapons.appendChild($button);
                    } else {
                        InventorySidebar.setButtonTooltip($weapon, definition);
                        Tooltip.refresh($weapon);
                    }
                });

                // Delete weapon buttons that no longer have a reference
                $weapons
                    .querySelectorAll("button[data-id]")
                    .forEach($weapon => {
                        if (!Object.hasOwn(playerWeapons, $weapon.dataset.id)) {
                            $weapon.remove();
                        }
                    });

                // Remove equipped highlighting
                $weapons.querySelectorAll(".equipped").forEach($button => {
                    $button.classList.remove("equipped");
                });

                // Highlight the equipped weapon
                if (!equippedWeaponId) {
                    return;
                }

                $weapons
                    .querySelector(`[data-id="${equippedWeaponId}"]`)
                    ?.classList
                    .add("equipped");
            },

            refreshArmor: () => {
                const playerArmor = player.inventory.getArmor();
                const equippedArmorId = player.inventory.getEquippedArmorId();
                const $armor =
                    document.querySelector(`#inventory [name="armor"]`);

                // Create armor buttons
                Object.values(playerArmor).forEach(armor => {
                    const $armorPiece =
                        $armor.querySelector(`[data-id="${armor.id}"]`);

                    const equippedText = armor.id === equippedArmorId
                        ? "Equipped"
                        : null;
                    const definition = { ...armor, equippedText };

                    if (!$armorPiece) {
                        // Create the armor entry in the list
                        const $button = InventorySidebar.createButton(
                            "armor",
                            definition
                        );

                        $button.onclick = function () {
                            playSFX("uiSelect");

                            const requiredEndurance = armor.requiredEnd || 0;
                            const playerMeetsReqirements =
                                player.endurance >= requiredEndurance;

                            if (playerMeetsReqirements) {
                                player.inventory.equipArmor(armor.id);
                            } else {
                                updateBattleLog(
                                    `You <span class="enemy">require</span> ` +
                                    `<span class="END">${requiredEndurance} ` +
                                    `END</span> to wear this armor!`
                                );
                            }

                            // Stop Enter from hitting the button again
                            this.blur();
                        };

                        $armor.appendChild($button);
                    } else {
                        InventorySidebar.setButtonTooltip(
                            $armorPiece,
                            definition
                        );
                        Tooltip.refresh($armorPiece);
                    }
                });

                // Delete armor buttons that no longer have a reference
                $armor
                    .querySelectorAll("button[data-id]")
                    .forEach($armorPiece => {
                        const removeButton = !Object.hasOwn(
                            playerArmor,
                            $armorPiece.dataset.id
                        );

                        if (removeButton) {
                            $armorPiece.remove();
                        }
                    });

                // Remove equipped highlighting
                $armor.querySelectorAll(".equipped").forEach($button => {
                    $button.classList.remove("equipped");
                });

                // Highlight equipped armor
                if (!equippedArmorId) {
                    return;
                }

                $armor
                    .querySelector(`[data-id="${equippedArmorId}"]`)
                    ?.classList
                    .add("equipped");
            },

            refreshRings: () => {
                const playerRings = player.inventory.getRings();
                const playerRingIds = Object.keys(playerRings);
                const hands = player.inventory.getEquippedRingIds();
                const equippedRingIds = Object.values(hands).filter(r => r);
                const $rings =
                    document.querySelector(`#inventory [name="rings"]`);

                // Create ring buttons
                Object.values(playerRings).forEach(ring => {
                    const $ring =
                        $rings.querySelector(`[data-id="${ring.id}"]`);
                    const isEquipped = equippedRingIds.includes(ring.id);
                    const equippedText = isEquipped
                        ? "Equipped, " + (
                            hands.leftHand === ring.id
                                ? "left hand"
                                : "right hand"
                        )
                        : null;
                    const definition = { ...ring, equippedText };

                    if (!$ring) {
                        // Create the ring entry in the list
                        const $button =
                            InventorySidebar.createButton(
                                "rings",
                                definition
                            );

                        $button.onclick = function () {
                            playSFX("uiSelect");

                            if (player.inventory.hasEquippedRing(ring.id)) {
                                const hands =
                                    player.inventory.getEquippedRingIds();
                                const equippedHand = hands.leftHand === ring.id
                                    ? "leftHand"
                                    : "rightHand";
                                const handText =
                                    equippedHand.replace(/Hand$/, " hand");
                                const article = (ring.article ? "the " : "");
                                const titleText =
                                    `Unequip ${article}${ring.name}?`;

                                const modalMessageHtml =
                                    `Do you want to <span class="action">` +
                                    `unequip</span> ${article}` +
                                    `<span class="friendly">${ring.name}` +
                                    `</span> from your ` +
                                    `<span class="friendly">${handText}` +
                                    `</span>?`;

                                Modal.open(
                                    titleText,
                                    modalMessageHtml,
                                    [
                                        {
                                            text: "No",
                                            type: "danger",
                                        },
                                        {
                                            text: "Yes",
                                            type: "primary",
                                            onclick: () => {
                                                player
                                                    .inventory
                                                    .unequipRing(equippedHand);
                                                render();
                                            },
                                        },
                                    ]
                                );

                                return;
                            }

                            const playerRings =
                                player.inventory.getEquippedRings();

                            const leftArticle =
                                playerRings.leftHand &&
                                playerRings.leftHand.article
                                    ? "the " : "";

                            const leftHtml = playerRings.leftHand
                                ?
                                    `Your <span class="friendly">left ` +
                                    `hand</span> is currently wearing ` +
                                    `${leftArticle}` +
                                    `<span class="action">` +
                                    `${playerRings.leftHand.name}</span>`
                                : "";

                            const rightArticle =
                                playerRings.leftHand &&
                                playerRings.leftHand.article
                                    ? "the " : "";

                            const rightHtml = playerRings.rightHand
                                ?
                                    `Your <span class="friendly">right ` +
                                    `hand</span> is currently wearing ` +
                                    `${rightArticle}` +
                                    `<span class="action">` +
                                    `${playerRings.rightHand.name}</span>`
                                : "";

                            const currentlyEquippedHtml =
                                [leftHtml, rightHtml].join("<br>");

                            const titleText = "Equip " +
                                (ring.article ? "the " : "") + ring.name;

                            const ringHtml = (ring.article ? "the " : "") +
                                `<span class="friendly">${ring.name}</span>`;

                            const modalMessageHtml =
                                `<p>Which hand should wear ${ringHtml}?` +
                                (
                                    currentlyEquippedHtml
                                        ? `<p>${currentlyEquippedHtml}</p>`
                                        : ""
                                );

                            Modal.open(
                                titleText,
                                modalMessageHtml,
                                [
                                    {
                                        text: "Left Hand",
                                        onclick: () => {
                                            player
                                                .inventory
                                                .equipRing("leftHand", ring.id);
                                            render();
                                        }
                                    },
                                    {
                                        text: "Right Hand",
                                        onclick: () => {
                                            player
                                                .inventory
                                                .equipRing(
                                                    "rightHand", ring.id
                                                );
                                            render();
                                        }
                                    },
                                ]
                            );

                            // Stop Enter from hitting the button again
                            this.blur();
                        };

                        $rings.appendChild($button);
                    } else {
                        InventorySidebar.setButtonTooltip($ring, definition);
                        Tooltip.refresh($ring);
                    }
                });

                // Delete unheld rings, update highlighting
                $rings
                    .querySelectorAll("button[data-id]")
                    .forEach($ring => {
                        if (! playerRingIds.includes($ring.dataset.id)) {
                            $ring.remove();
                        } else {
                            equippedRingIds.includes($ring.dataset.id)
                                ? $ring.classList.add("equipped")
                                : $ring.classList.remove("equipped");
                        }
                    });
            },
        };

        player.inventory.setHandlers({
            onEquip: () => {
                if (player.hp > getEffectiveStat('maxHp')) {
                    player.hp = getEffectiveStat('maxHp');
                }

                const $game = document.getElementById('game');
                player.inventory.hasEquippedRing('ringOfSightliness')
                    ? $game.classList.add('sightliness')
                    : $game.classList.remove('sightliness');
            },
            onWeaponEquip: (weapon) => {
                updateBattleLog(
                    `You now wield a mighty <span class="friendly">` +
                    `${weapon.name}</span>!`
                );
                InventorySidebar.refresh("weapons");
            },
            onArmorEquip: (armor) => {
                const articleText = armor.article
                    ? `${armor.article} `
                    : "";

                updateBattleLog(
                    `You are now wearing ${articleText}` +
                    `<span class="friendly">${armor.name}</span>!`
                );

                if (player.hp > getEffectiveStat('maxHp')) {
                    player.hp = getEffectiveStat('maxHp');
                }

                InventorySidebar.refresh("armor");
            },
            onRingEquip: (hand, ring) => {
                const handText = hand.replace(/Hand$/, "");

                if (ring) {
                    const articleText = ring.article
                        ? `${ring.article} `
                        : "";

                    updateBattleLog(
                        `You are now wearing ${articleText}` +
                        `<span class="friendly">${ring.name}</span> on ` +
                        `your <span class="friendly">${handText} hand</span>!`
                    );
                } else {
                    updateBattleLog(
                        `You pull the ring off your <span class="friendly">` +
                        `${handText} hand</span>. How unfashionable of you.`
                    );
                }

                InventorySidebar.refresh("rings");
            },
            onItemCountChange: () => InventorySidebar.refresh("items"),
            onWeaponCountChange: () => InventorySidebar.refresh("weapons"),
            onArmorCountChange: () => InventorySidebar.refresh("armor"),
            onRingCountChange: () => InventorySidebar.refresh("rings"),
        });

        InventorySidebar.refresh();
        generateMap();
        startBoulderMovement();
        updateSeenTiles();
        music.playRandom("exploration");
        scheduleNextAmbientSfx();
        render();

        let isLevelUpAllocation = false;
        let levelUpAllocatedStats = {};
        let levelUpStatPointsAllocated = {};

        function startLevelUpAllocation(callback) {
            isLevelUpAllocation = true;
            levelUpAllocatedStats = {};
            player.remainingPoints = 6;
            levelUpAllocatedStats.base = {
                maxHp: player.maxHp,
                defense: player.defense,
                strength: player.strength,
                endurance: player.endurance,
                persuasion: player.persuasion,
                speed: player.speed,
                luck: player.luck
            };
            // Track how many points have been allocated to each stat this level-up
            levelUpStatPointsAllocated = {
                maxHp: 0,
                defense: 0,
                strength: 0,
                persuasion: 0,
                endurance: 0,
                speed: 0,
                luck: 0
            };
            player.levelUp();

            // If auto diceroll enabled
            if (autoDicerollEnabled) {
                rollDiceForLevelUp();
                isLevelUpAllocation = false;
                updateBattleLog("Stats increased! You consume an unsuspecting rat to restore your health. Poor feller...");
                if (eatRatAnimationEnabled) {
                    GameControl.disableControls();
                    animEatRat(() => {
                        GameControl.enableControls();
                        if (typeof callback === "function") {
                            callback();
                        }
                    });
                } else {
                    // Enable controls immediately if animation is disabled
                    GameControl.enableControls();
                    if (typeof callback === "function") {
                        callback();
                    }
                }

                render();
            } else {
                menu.open("statAllocation", callback);
            }
        }

        function trySkipPreload() {
            const loadingBarText = document.getElementById('loadingBarText');
            if (loadingBarText) loadingBarText.textContent = "Preloader Disabled";
            if (typeof window.skipPreload === "function") {
                window.skipPreload('query-param');
            } else {
                setTimeout(trySkipPreload, 100);
            }
        }

        if (!preloaderEnabled) {
            trySkipPreload();
        } else {
            if (typeof window.preloader === "function") {
                window.preloader();
            }
        }

        player.remainingPoints = 15; //Points to allocate at start of game

        function resetStats() {
            player.remainingPoints = 15;
            player.maxHp = baseStats.maxHp;
            player.hp = player.maxHp;
            player.defense = baseStats.defense;
            player.strength = baseStats.strength;
            player.persuasion = baseStats.persuasion;
            player.endurance = baseStats.endurance;
            player.speed = baseStats.speed;
            player.luck = baseStats.luck;
            updateBattleLog("Stat allocation has been reset. Start over!");
        }

        function rollDiceForStats() {
            resetStats();
            const stats = [
                "hp", "defense", "strength", "persuasion", "endurance",
                "speed", "luck"
            ];

            while (player.remainingPoints > 0) {
                const stat = randomEntry(stats);
                switch (stat) {
                    case "hp":
                        player.maxHp++;
                        player.hp = player.maxHp;
                        break;
                    case "defense":
                    case "strength":
                    case "persuasion":
                    case "endurance":
                    case "speed":
                    case "luck":
                        player[stat]++;
                        break;
                }
                player.remainingPoints--;
            }
            updateBattleLog("Points have been randomly allocated. Good luck!");
        }

        function rollDiceForLevelUp() {
            player.hp = player.maxHp = levelUpAllocatedStats.base.maxHp;
            player.defense = levelUpAllocatedStats.base.defense;
            player.strength = levelUpAllocatedStats.base.strength;
            player.persuasion = levelUpAllocatedStats.base.persuasion;
            player.endurance = levelUpAllocatedStats.base.endurance;
            player.speed = levelUpAllocatedStats.base.speed;
            player.luck = levelUpAllocatedStats.base.luck;
            player.remainingPoints = 6;

            levelUpStatPointsAllocated = {
                maxHp: 0,
                defense: 0,
                strength: 0,
                persuasion: 0,
                endurance: 0,
                speed: 0,
                luck: 0
            };

            const stats = ["hp", "defense", "strength", "persuasion", "endurance", "speed", "luck"];

            while (player.remainingPoints > 0) {
                const availableStats = stats.filter(stat => {
                    const statKey = stat === "hp" ? "maxHp" : stat;
                    return levelUpStatPointsAllocated[statKey] < 2;
                });

                if (availableStats.length === 0) break;

                const stat = randomEntry(availableStats);
                const statKey = stat === "hp" ? "maxHp" : stat;

                if (stat === "hp") {
                    player.maxHp++;
                    player.hp = player.maxHp;
                } else {
                    player[stat]++;
                }

                levelUpStatPointsAllocated[statKey]++;
                player.remainingPoints--;
            }
            updateBattleLog("Level up points have been randomly allocated. Good luck!");
        }

        if (autoDicerollEnabled) {
            rollDiceForStats();
            updateBattleLog(
                `Stat allocation complete! You consume an ` +
                `unsuspecting rat to ensure you are in good ` +
                `health, and <span class="friendly">your ` +
                `adventure begins</span>...`
            );
            if (eatRatAnimationEnabled) {
                GameControl.disableControls();
                animEatRat(() => GameControl.enableControls());
            }
        } else {
            menu.open("statAllocation");
        }

        const gambleFrames = [
    `



                  _____
                 /     -.
                 \\____.--


    `,

    `



              _,--.
             ( ;.  \`-.
             (  '    _
              \`-___-'

    `,

    `



           _,-.-.
          (_;.   \`-.
         (__:
          (__.'    _
           \`-____-'

    `,

    `


       _,-.-.
      (_;.   \`-.
      (__:
      (__'
      (__.'    _
       \`-____-'

    `,

    `


     _,--.---.
    (_;-.__   \`-.
    (______)
    (______)
    (_____)     _
     \`-_______-'

    `,

    `

          ____
     ____'._  '.
    (____)_ \`.  \`-.
    (______)\\
     (______)
      (_____)     _
       \`-_______-'

    `,

    `

            ..__
    ________\`.  '-
   (__)______ \`.  '-.
    (__)__/_\\
      (____)
       (___)        _
         \`-_______-'

    `,

    `

              ..__
    __________\`.  '-
   (___________ \`.  '-.
    (______..--.
      (__)_||__|
        (_)_          _
           \`-_______-'

    `,

    `

                ..__
      __________\`.  '-
     (___________ \`.  '-.
      (__________
       (________
       .-'--._ .----_   _
       | |  | |\` ___'.-'
       \`.|..' ' \`    |
               \`|____'

    `,

    `

                      ..__
            __________\`.  '-
           (___________ \`.  '-.
            (__________
             (________
               (____          _
                    \`-______-'
       .-----       .----.
      / \`.   \`.    /      \\
     /    '.___\`. /________\\
     \`.   /    /  \\        /
       \`./____/    \\      /
                    \`----'
    `,

    `

                          ..__
                __________\`.  '-
               (___________ \`.  '-.
                (__________
                 (________
                   (____
                        \`-______-


    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

    `


                         _________
                        (_________
                          (_______
                           (______
                             (____



    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

    `


                                 _
                                (_






    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

    `










    .----------.   .----------.
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |          |   |          |
    |__________|   |__________|
    `,

];
    const dieDigit = [
        ['▗▄▋  ', ' ▐▋  ', '▝▀▀▘ '], // 1
        ['▄▀▀▄ ', ' ▄▀  ', '▀▀▀▀▘'], // 2
        ['▄▀▀▄ ', '  ▀▄ ', '▀▄▄▀ '], // 3
        ['█  █ ', '▀▀▀█ ', '   ▀ '], // 4
        ['█▀▀▀ ', '▀▀▀▄ ', '▀▄▄▀ '], // 5
        ['▄▀▀▀ ', '█▀▀▄ ', '▀▄▄▀ '], // 6
    ];



        // --- TITLE SCREEN LOGIC ---
        const $titleScreen = document.getElementById('titleScreen');

        function hideTitleScreen() {
            music.stop();
            TardAPI.createSession();
            PigeonMessaging.ensurePolling();

            // @TODO Refactor this since it's duplicated in gamepad.js
            // @see https://github.com/packardbell95/tardquest/issues/162
            TITLE_SCREEN.startGame(
                $titleScreen,
                () => {
                    const $interface = document.getElementById("interface");
                    $interface.classList.remove("hidden");
                    $interface.classList.add("reveal");

                    setTimeout(() => {
                        $interface.classList.remove("reveal");
                        GameControl.enableControls();
                        music.playRandom("exploration");
                        render();
                    }, 500);
                }
            );
        }

        document.querySelectorAll("#inventory > div[name]").forEach(($e) => {
            const isScrollable = ["items", "weapons", "armor", "rings"]
                .includes($e.getAttribute("name"));

            if (! isScrollable) {
                return;
            }

            addEventListener(
                "wheel",
                function (e) {
                    $e.scrollTop += e.deltaY;
                }
            );
        });

        document.addEventListener('keydown', function titleScreenHandler(e) {
            if (TITLE_SCREEN.isActive && (e.key === 'Enter' || e.key === ' ')) {
                hideTitleScreen();
                document.removeEventListener('keydown', titleScreenHandler);
                e.preventDefault();
                e.stopImmediatePropagation();
            }
        }, true);

        if (skipTitleScreen) {
            const onGameReady = () => {
                document.getElementById("interface").classList.remove("hidden");
                hideTitleScreen();
            };

            if (!preloaderEnabled) {
                onGameReady();
            } else {
                window.onTardquestLoaded = onGameReady;
            }
        } else {
            music.play("title");
            TITLE_SCREEN.initialize($titleScreen, hideTitleScreen);
        }

        player.party.initializePartySection();
        GameControl.update();
    </script>
</body></html>
